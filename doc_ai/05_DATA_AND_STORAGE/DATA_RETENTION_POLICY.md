# DATA_RETENTION_POLICY.md
# Полная политика хранения данных для системы 2.0
# Telemetry • Commands • Events • Logs • Backups • Archiving • Legal & Safety

Документ описывает полную стратегию хранения, архивации и очистки данных
в системе гидропонного комплекса 2.0.

---

# 1. Цели и задачи политики хранения

Политика хранения данных обеспечивает:

- оптимальный объём базы данных,
- долгосрочное хранение важных данных,
- быстрое реагирование на аварийные ситуации,
- соблюдение требований безопасности,
- корректную работу AI-моделей,
- минимальные накладные расходы на инфраструктуру.

---

# 2. Классификация данных

Все данные делятся на 6 уровней:

```
L0 — Critical Control Data
L1 — Recent Telemetry
L2 — Historical Telemetry (compressed)
L3 — Events & Alerts
L4 — Logs (System, Node, AI)
L5 — Backup Archives
```

---

# 3. Хранение телеметрии

Telemetry хранится в двух формах:

## 3.1. Hot Telemetry (L1)
Используется для:

- контроллеров,
- AI,
- UI графиков в реальном времени,
- safety-алгоритмов.

Срок хранения:

```
7–30 дней
```

Частота данных:

```
1–10 секунд
```

Таблицы:

```
telemetry_last
telemetry_raw
```

## 3.2. Warm Telemetry (L2)
Данные агрегируются и сжимаются:

- усреднение: 1 минута,
- медиана pH/EC,
- min/max per interval,
- дневные суммарные показатели.

Срок хранения:

```
6–12 месяцев
```

Таблицы:

```
telemetry_agg_1m
telemetry_agg_1h
telemetry_daily
```

## 3.3. Cold Telemetry (архив)
Формат:

- CSV/Parquet,
- хранение в S3-совместимом хранилище.

Срок хранения:

```
5 лет
```

---

# 4. Хранение команд

Команды важны для:

- аудита,
- восстановления алгоритмов AI,
- диагностики проблем.

Сроки:

```
commands: 90 дней hot
commands_archive: 3 года
```

Команды включают:

- cmd_id,
- параметры,
- статус (sent/ack/error),
- trace_id,
- response.

---

# 5. Хранение событий (Events)

Events имеют ключевое значение для анализа проблем.

Сроки:

```
zone_events: 180 дней hot
zone_events_archive: 5 лет
```

Типы:

- IRRIGATION_CYCLE
- DOSING
- ALERT
- NODE_OFFLINE
- CONTROLLER_ERROR
- AI_RECOMMENDATION

---

# 6. Хранение алертов

Alerts важны для истории безопасности.

Срок:

```
alerts: 365 дней
```

Удаляются автоматически, если:

- resolved,
- acknowledged,
- older than retention limit.

---

# 7. Хранение логов

## 7.1. Hot Logs
Срок:

```
7–30 дней
```

Таблицы:

```
system_logs
node_logs
ai_logs
scheduler_logs
```

## 7.2. Warm Logs
Сжатые архивы:

```
tar.gz
```

Срок:

```
1 год
```

## 7.3. Cold Logs
Хранятся на S3/Backblaze:

```
до 5 лет
```

---

# 8. Бэкапы

Система создаёт 3 типа резервных копий:

## 8.1. Daily Backup
- полный дамп БД,
- хранение 14–30 дней.

## 8.2. Weekly Backup
- инкрементальные архивы,
- хранение 3–6 месяцев.

## 8.3. Monthly Backup (long-term)
- шифрованные архивы,
- хранение 3–5 лет.

Формат:

```
pg_dump + compression + encryption
```

---

# 9. Оптимизация размера базы

Еженедельные задачи:

- очистка старых telemetry_raw,
- очистка логов,
- VACUUM FULL,
- уплотнение архивных таблиц,
- анализ больших таблиц.

---

# 10. Архивирование (Archiving Engine)

Архивация выполняется Python Scheduler:

```
raw → agg_1m → agg_1h → daily → cold archive
```

Ротация выполняется автоматически.

---

# 11. AI‑интеграция

AI получает доступ к:

- hot данные → обучение контроллеров,
- aggregate данные → прогнозы,
- архивные данные → обучение крупных моделей.

ИИ НЕ получает:

- личные данные пользователей,
- токены,
- конфигурации безопасности,
- закрытые ключи.

---

# 12. Политика удаления данных

При удалении зоны или узла:

```
telemetry_last — удаляется
telemetry_raw — удаляется
agg/daily — анонимизируется
events — архивируются
logs — архивируются
```

При удалении пользователя:

```
команды анонимизируются
логи API очищаются
session tokens уничтожаются
```

---

# 13. Правила для ИИ

ИИ может:

- анализировать историю данных,
- оптимизировать retention уровни,
- предлагать новые схемы агрегации.

ИИ НЕ может:

- увеличивать срок хранения команд > 3 лет,
- отключать архивирование,
- удалять события,
- сокращать retention безопасности.

---

# 14. Чек‑лист Retention перед релизом

1. Hot telemetry очищается? 
2. Aggregation работает? 
3. Архивирование включено? 
4. Логи ротации работают? 
5. Бэкапы выполняются? 
6. Данные доступны AI? 
7. Удаление зон/узлов корректное? 
8. Нет переполнения базы? 

---

# Конец файла DATA_RETENTION_POLICY.md
