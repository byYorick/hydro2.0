# HARDWARE_ARCH_FULL.md
# Полная аппаратная архитектура системы 2.0 (узлы, сенсоры, питание, защита, топология)

Документ описывает все аппаратные аспекты системы 2.0: структуру узлов ESP32, размещение сенсоров,
питание, линии ввода-вывода, схемы защиты, шины данных, требования к разводке и электробезопасности.


Compatible-With: Protocol 2.0, Backend >=3.0, Python >=3.0, Database >=3.0, Frontend >=3.0.
Breaking-change: legacy форматы/алиасы удалены, обратная совместимость не поддерживается.

---

# 1. Общая концепция аппаратной архитектуры 2.0

В системе используется модульный подход:

- **Каждая функция — отдельный узел**: pH, EC, климат, полив, насосы, уровень, расход.
- Узлы ESP32 связаны через **Wi‑Fi** и **MQTT**.
- Аппаратная логика deliberately простая, детерминированная.
- Вся бизнес‑логика — на Backend.

Стандартные узлы:

- **PH Node** — pH датчик + перистальтические насосы (acid/base).
- **EC Node** — EC датчик + питательные насосы.
- **Climate Node** — SHT31, CO₂, вентиляторы, нагреватель.
- **Irrigation Node** — расходомер, уровень воды, клапаны, рециркуляция.
- **Light Node** — освещение PWM/реле.

---

# 2. Аппаратная структура узла ESP32

Каждый узел состоит из:

1. **ESP32-S3** модуль (WROOM/WROVER)
2. **Питание 5V → 3.3V**
3. **Датчики**:
 - pH (аналоговый через модуль)
 - EC (аналоговый проводимость)
 - t°/RH (SHT3x)
 - CO₂ (CCS811/SGP30)
 - уровень (ultrasonic/float)
 - расход (Hall flow sensor)
4. **Актуаторы**:
 - перистальтические насосы
 - реле/клапаны
 - вентиляторы
 - PWM-управление
5. **Защита**:
 - TVS-диоды
 - RC-фильтры
 - опторазвязка (для высоких токов)
 - диоды flyback
6. **Интерфейсы**:
 - I²C
 - ADC
 - PWM
 - GPIO
7. **Силовые цепи**:
 - отдельная земля GND-PWR
 - фильтрация источника питания
 - раздельное питание сенсоров и насосов

---

# 3. Питание узлов

## 3.1. Источник питания
- 5V DC (адаптер или БП 5A+)
- допускается 12V → DC-DC step-down 5V

## 3.2. Схема питания
```
12V → DC-DC → 5V → 
 → ESP32 (AMS1117-3.3)
 → насосы (через драйвер)
 → реле/клапаны
```

## 3.3. Требования
- Развязать линии земли:
 - GND силовая
 - GND логическая
- Параллельно каждому насосному каналу:
 - **диод 1N4007 / FR107** от выбросов
- Добавить **0.1 µF** керамику у каждого чипа
- Добавить **100–470 µF** электролит по питанию узла

---

# 4. Сенсоры

## 4.1. pH модуль
Делается через:

- калибровку
- аналоговый вход ESP32
- желательно внешний ADC ADS1115

Схема:

```
pH_probe → pH_board → ADS1115 → I²C → ESP32
```

## 4.2. EC модуль
Требует стабилизации сигнала.

Схема аналогична pH.

## 4.3. SHT31
Стандартный I²C.

Фильтры:

- подтяжки 10k
- длина кабеля ≤ 50 см

## 4.4. CO₂ CCS811
Требуется прогрев.

## 4.5. Flow sensor
Hall-effect датчик:

- подключение к GPIO с PCNT
- защита от дребезга

## 4.6. Level sensor
Ультразвук:
- необходимо экранирование
- питание 5V, логические 3.3V через divider

Поплавок:
- простой контакт, защита от дребезга

---

# 5. Актуаторы

## 5.1. Перистальтические насосы
Лучшее управление:

```
GPIO → L9110 driver → pump motor
```

Добавить:

- диод flyback
- фильтр 0.1 µF
- снаббер (если большие помехи)

## 5.2. Клапаны 12V
Управляются через:

- MOSFET N‑channel (IRLZ44N)
- опторазвязка желательно

## 5.3. Вентиляторы
PWM 25 kHz.

## 5.4. Реле
Use opto-isolated relay module 5V.

---

# 6. Шина I²C

## 6.1. Структура
```
ESP32-S3
 SCL → все сенсоры
 SDA → все сенсоры
```

## 6.2. Требования:

- подтяжки 4.7k–10k
- кабели ≤ 1 м
- избегать параллельных силовых линий

---

# 7. ADC линии

Требования:

- использовать ADS1115 (16 bit)
- экранировать кабель pH/EC
- не допускать шумов от насосов

---

# 8. Защита от помех

## 8.1. Датчики pH/EC
- экранированный кабель
- заземление только с одной стороны
- размещать вдали от насосов

## 8.2. Насосы

- диоды
- RC-фильтры
- развязка питания

### 8.2.1. Общая схема питания насосов

- У всех насосов на ноде общий **плюс питания**.
- Каждый насос включается по **минусу** через свой MOSFET (low-side ключ).
- Управление MOSFET-ами идёт через оптопары, чтобы развязать цифровую часть и силовую.
- На входах оптопар — выходы ESP32 (через резисторы и при необходимости транзисторные каскады).

Такая топология упрощает разводку и обеспечивает приличную помехоустойчивость,
при этом вся силовая часть отделена от логики.

### 8.2.2. Контроль тока насосов (один INA209 на ноду, I²C)

Для каждой ноды насосов используется **один** датчик тока INA209, включённый
в разрыв общего питания насосов (общий плюс):

- INA209 измеряет суммарный ток всех насосов на ноде;
- при включении одного или нескольких насосов ток возрастает;
- при выключенных насосах ток должен быть близок к нулю.

Базовые требования:

- шунт и INA209 включаются в цепь общего плюса питания насосов;
- линия I²C (SCL/SDA) от ESP32 к INA209 прокладывается короткой, с минимальным
  захватом помех от силовых дорожек;
- адрес INA209 и параметры шунта фиксируются в NodeConfig ноды;
- измеренный ток может публиковаться как отдельный сенсорный канал (например,
  `pump_bus_current`) и используется логикой узла для проверки факта включения насосов.

Особенности из-за одного датчика на ноду:

- узел видит **суммарный** ток по шине, а не по каждому насосу отдельно;
- рекомендуется по возможности **не включать несколько насосов одновременно** на одной ноде,
  чтобы диагностика была однозначной (ожидаемый ток для одного насоса проще контролировать);
- при необходимости можно задавать ожидаемые окна тока для разных режимов
  (например, “работает только pump_in” vs “работает только pump_nutrient”).

В случае аномалий по току (нет тока при ожидаемом включении, слишком большой ток)
узел обязан:

- по возможности отключить все насосы на ноде;
- сформировать `command_response` со статусом `ERROR` и кодом ошибки;
- при необходимости опубликовать диагностическую telemetry по каналу тока.

## 8.3. Реле
## 8.3. Реле

- оптроны
- отдельный источник питания желательно

---

# 9. Типовые схемы узлов

## 9.1. PH Node
```
ADS1115 → pH metering
2× pumps via L9110
SHT31 optional
```

## 9.2. EC Node
```
ADS1115 → EC
3× nutrient pumps
Temp probe
```

## 9.3. Climate Node
```
SHT31
Fan (PWM)
Heater (relay/MOSFET)
CO₂
```

## 9.4. Irrigation Node
```
Flow sensor → PCNT
Level sensor
Valve
Recirculation pump
```

---

# 10. Монтаж в теплице

- корпуса IP65
- провода в гофре
- разнесение силовых и сигнальных линий
- защита от конденсата
- кабели с маркировкой
- раздельные блоки питания

---

# 11. ЭМС‑требования

- Все силовые кабели должны иметь ферриты
- Широкие дорожки GND
- Минимизировать петли заземления
- Слабосигнальные линии вести отдельно

---

# 12. Тепловой режим

Допустимые температуры узлов:
- −20… +60°C 
Рекомендуемые:
- +5… +40°C

---

# 13. Будущие улучшения

- CAN bus
- модуль RS485
- модульный rack‑mount блок питания
- резервное питание 12V UPS
- датчики давления и дебита

---

# Конец файла HARDWARE_ARCH_FULL.md
