# FIRMWARE_STRUCTURE.md
# Полная структура прошивки 2.0 для ESP32

Документ описывает архитектуру прошивки на C/C++ для ESP32/ESP32-S3,
используемую в узлах системы 2.0.

Цели:

- разделить код на понятные модули;
- обеспечить предсказуемую работу FreeRTOS-задач;
- упростить работу ИИ-агентов с кодом.

---

## 1. Общая архитектура

Основные подсистемы прошивки:

1. **Core / RTOS** — инициализация, задачи, очереди, таймеры.
2. **Wi-Fi & MQTT** — подключение к сети и брокеру.
3. **Config (NVS)** — хранение конфигурации узла.
4. **Sensors** — драйверы датчиков (pH, EC, SHT, освещённость и т.п.).
5. **Actuators** — управление насосами, реле, вентиляторами, светом.
6. **Telemetry Engine** — формирование и отправка телеметрии.
7. **Command Engine** — обработка команд из MQTT.
8. **OTA** — обновление прошивки.
9. **Diagnostics / Logging** — диагностика и статусы.
10. **OLED UI** — локальный интерфейс (см. `NODE_OLED_UI_SPEC.md`).

Пример структуры каталога:

```text
firmware/
 main/
 main.c
 app_main.c
 core/
 app_tasks.c
 app_events.c
 net/
 wifi_manager.c
 mqtt_client.c
 config/
 nvs_config.c
 sensors/
 ph_sensor.c
 ec_sensor.c
 temp_sensor.c
 humidity_sensor.c
 actuators/
 pumps.c
 relays.c
 fans.c
 lights.c
 telemetry/
 telemetry_engine.c
 commands/
 command_engine.c
 ota/
 ota_engine.c
 ui/
 oled_ui.c
 utils/
 log.c
 time_sync.c
```

---

## 2. FreeRTOS-задачи

Рекомендуемый набор задач:

- `task_main` — координация, FSM узла.
- `task_wifi` — управление подключением Wi-Fi.
- `task_mqtt` — обработка входящих и исходящих MQTT-сообщений.
- `task_sensors` — опрос датчиков.
- `task_actuators` — управление актуаторами по событиям.
- `task_ui` — обновление дисплея/обработка кнопок.
- `task_ota` — OTA-обновления.

Между задачами используются очереди/очереди событий:

- `queue_commands` — команды от MQTT → actuators;
- `queue_telemetry` — данные от sensors → mqtt;
- `queue_ui_events` — события UI.

---

## 3. Конфигурация узла (NodeConfig)

NodeConfig хранится в NVS и включает:

- `node_uid` — UID узла;
- `zone_uid` — привязка к зоне;
- `gh_uid` — теплица;
- список каналов и их типы;
- параметры Wi-Fi (SSID, пароль или SmartConfig);
- параметры MQTT (host, порт, client_id);
- флаги калибровки (pH, EC).

Отдельный модуль `nvs_config.c`:

- читает конфиг при старте;
- предоставляет API для обновления конфигурации по командам из MQTT.

---

## 4. Telemetry Engine

Задачи:

- по расписанию опрашивать датчики;
- формировать сообщения телеметрии;
- отправлять их через MQTT.

Период опроса зависит от типа узла и задаётся конфигом.

---

## 5. Command Engine

Задачи:

- подписка на ` /command`-топики;
- парсинг JSON-payload;
- проверка TTL, типов команд;
- постановка задач в `queue_commands`.

Команды не должны содержать тяжёлой логики — только простые действия:

- `SET_STATE`;
- `SET_PWM`;
- `DOSE` и т.п.

---

## 6. OTA Engine

- Реализует протокол из `OTA_UPDATE_PROTOCOL.md`.
- Отвечает за скачивание, проверку и применение новой прошивки.

---

## 7. OLED UI

- Работает как отдельная задача (`task_ui`).
- Не блокирует работу сети.
- Все данные берёт из общей модели состояния, а не напрямую из сенсоров.

---

## 8. Правила для ИИ-агентов

1. Не выносить бизнес-логику (рецепты, агрономические решения) в прошивку.
2. Соблюдать модульность и не смешивать слои (сетевой код не должен лазить в датчики напрямую).
3. Любые изменения в протоколах/форматах MQTT должны быть согласованы с `MQTT_NAMESPACE.md`.

Этот документ — основной ориентир при развитии прошивки узлов ESP32 в рамках версии 2.0.
