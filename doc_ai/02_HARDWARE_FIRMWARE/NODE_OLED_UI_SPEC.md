# NODE_OLED_UI_SPEC.md
# Спецификация локального UI на OLED 128×64 для узлов ESP32

Документ определяет единый интерфейс локального дисплея узла (OLED 128×64, I²C).

Цели:

- дать оператору минимальный, но полезный локальный UI;
- сохранить единообразный UX для всех типов узлов (pH, EC, климат, свет);
- не перегружать MCU и шину I²C.

---

## 1. Общие принципы

- Один UI-движок для всех узлов (разные режимы в зависимости от `node_type`).
- Дисплей работает **неблокирующе**, обновление идёт по таймеру.
- Управление вводом:
 - энкодер (вращение + нажатие);
 - опционально одна кнопка.
- UI не управляет железом напрямую — только через события/команды в общую очередь.

---

## 2. Состояния UI

1. `BOOT` — загрузка узла.
2. `WIFI_SETUP` — настройка Wi-Fi (первый запуск/ошибка).
3. `NORMAL` — нормальная работа.
4. `ALERT` — критическая ошибка.
5. `CALIBRATION` — калибровка датчиков (pH, EC и т.п.).
6. `SERVICE` — сервисное меню (отладка, версия, тесты).

Переходы между состояниями управляются прошивкой (FSM) и событиями пользователя.

---

## 3. Основные экраны

### 3.1. BOOT

- Логотип проекта (по желанию).
- Строка состояния:
 - `Booting ` → `WiFi: Connecting` → `MQTT: Connecting`.

### 3.2. WIFI_SETUP

- Режим точки доступа (AP):
 - отображается SSID AP и пароль/QR-код (если возможно).
 - строка: `Connect to: HYDRO-SETUP`.
- Подсказка: «Откройте Android-приложение для настройки».
- Состояние меняется на `NORMAL` после успешной настройки.

### 3.3. NORMAL (основной режим)

Экран по умолчанию показывает:

- верхняя строка:
 - статус Wi-Fi (иконка/символ);
 - статус MQTT;
 - `node_uid` (сокращённо);
- основной блок:
 - в зависимости от типа узла:
 - pH-узел: текущее pH, температура раствора;
 - EC-узел: EC, температура раствора;
 - климат-узел: температура воздуха, влажность;
 - свет: текущий уровень, режим;
- нижняя строка:
 - краткое состояние (OK / ALERT / PAUSED).

Вращение энкодера переключает **страницы**:

1. «Основная» — текущие значения.
2. «Каналы» — список каналов и их состояний.
3. «Зона» — краткая информация о зоне/рецепте (при наличии).

### 3.4. ALERT

- Яркий экран (по возможности инверсия):
 - крупный текст `ALERT`;
 - краткий код ошибки (например, `PH_PROBE_DISCONNECTED`);
 - подсказка «см. приложение».
- Нажатие кнопки может «подтвердить» локально, но логика подтверждения — на backend.

### 3.5. CALIBRATION

Режим для калибровки, инициируется:

- командой из backend/UI;
- локальным событием (например, удержание кнопки).

Экран по шагам:

1. «Опустите датчик в буфер pH 7.0 → нажмите кнопку».
2. «Буфер pH 4.0 → нажмите кнопку».

Узел публикует статус калибровки в MQTT (`event`/`status`).

---

## 4. Интеграция с прошивкой

Модуль `oled_ui.c` должен предоставлять API:

- `ui_init(node_type, node_uid)`;
- `ui_set_state(UI_STATE_xxx)`;
- `ui_update_model(struct UiModel *model)`;
- обработчики событий ввода (`ui_handle_encoder`, `ui_handle_button`).

`UiModel` содержит:

- текущие измерения (pH, EC, температуру);
- статус соединений (Wi-Fi/MQTT);
- флаги alert/paused;
- краткую информацию о зоне/рецепте (если нужна).

UI-задача раз в N миллисекунд:

1. обновляет локальное представление модели;
2. перерисовывает изменившиеся элементы экрана.

---

## 5. Правила для ИИ-агентов

1. Не добавлять сложных анимаций и тяжёлых шрифтов.
2. Сохранять неизменным набор состояний UI и базовых экранов.
3. Все новые элементы должны быть опциональными и не ломать существующие сценарии.
4. Если меняется формат текстов/статусов — документ должен быть обновлён.

Этот документ задаёт единый стандарт локального UI для всех узлов ESP32 версии 2.0.
