# NODE_CHANNELS_REFERENCE.md
# Полный справочник каналов узлов 2.0 (ESP32)

Документ описывает типы каналов, ключи, единицы измерения и типичные payload-ы.
Он дополняет `../03_TRANSPORT_MQTT/MQTT_NAMESPACE.md` и `../05_DATA_AND_STORAGE/DATA_MODEL_REFERENCE.md`.


Compatible-With: Protocol 2.0, Backend >=3.0, Python >=3.0, Database >=3.0, Frontend >=3.0.
Breaking-change: legacy форматы/алиасы удалены, обратная совместимость не поддерживается.

---

## 1. Общие принципы

Каждый канал описывается:

- полем `channels.key` в БД;
- типом (`SENSOR`, `ACTUATOR`, `VIRTUAL`);
- типом данных (`float`, `int`, `bool`);
- единицами измерения (для сенсоров);
- допустимым диапазоном значений.

Все каналы используют MQTT-паттерн:

```text
hydro/{gh}/{zone}/{node}/{channel}/{message_type}
```

---

## 2. Сенсорные каналы (SENSOR)

### 2.1. pH

- Ключ: `ph_main`
- Тип: `SENSOR`
- Единицы: pH
- Диапазон: 3.0–9.0
- Telemetry payload:

```json
{
 "value": 5.78,
 "metric": "PH",
 "ts": 1737355600456
}
```

### 2.2. EC (электропроводность)

- Ключ: `ec_main`
- Тип: `SENSOR`
- Единицы: mS/cm или µS/cm (фиксируется в конфиге зоны)
- Telemetry payload:

```json
{
 "value": 1.6,
 "metric": "EC",
 "ts": 1737355600456
}
```

### 2.3. Температура воздуха

- Ключ: `temp_air`
- Тип: `SENSOR`
- Единицы: °C

### 2.4. Температура раствора

- Ключ: `temp_water`
- Тип: `SENSOR`
- Единицы: °C

### 2.5. Влажность воздуха

- Ключ: `humidity_air`
- Тип: `SENSOR`
- Единицы: %

### 2.6. Освещённость

- Ключ: `lux_main`
- Тип: `SENSOR`
- Единицы: lux или PPFD (фиксируется в конфиге).

---

## 3. Актуаторные каналы (ACTUATOR)

Актуаторы управляют физическими исполнительными устройствами (насосы, клапаны,
вентиляторы, освещение и т.п.). Все команды к ним приходят через MQTT-топики `.../{channel}/command`,
а факт исполнения подтверждается через `command_response` (см. `../03_TRANSPORT_MQTT/MQTT_SPEC_FULL.md` и
`DEVICE_NODE_PROTOCOL.md`).

### 3.1. Насосы pH

- `pump_acid` — насос дозирования кислоты;
- `pump_base` — насос дозирования щёлочи.

Тип: `ACTUATOR`.

Базовые команды (JSON-payload):

1. Дозирование по объёму:

```json
{
  "cmd_id": "cmd-19292",
  "cmd": "dose",
  "params": {
    "ml": 1.0,
    "ttl_ms": 5000
  }
}
```

2. Прямое управление состоянием (например, сервисные режимы):

```json
{
  "cmd_id": "cmd-19293",
  "cmd": "set_relay",
  "params": {
    "state": true
  }
}
```

### 3.2. Насосы питательного раствора / подачи

- `pump_nutrient` — насос питательного раствора;
- `pump_in` — насос/клапан подачи/наполнения;
- при необходимости могут добавляться другие насосы, все они описываются аналогично.

Тип: `ACTUATOR`.

Команды аналогичны:

```json
{
  "cmd_id": "cmd-20101",
  "cmd": "dose",
  "params": {
    "ml": 5.0,
    "ttl_ms": 10000
  }
}
```

или

```json
{
  "cmd_id": "cmd-20102",
  "cmd": "set_relay",
  "params": {
    "state": true
  }
}
```

### 3.3. Другие актуаторы

- `valve_irrigation` — клапан полива;
- `fan_air` — вентилятор;
- `heater_air` — нагреватель воздуха;
- `white_light` — основное освещение;
- `uv_light` — УФ-лампы.

Тип: `ACTUATOR`.

Пример команды включения/выключения:

```json
{
  "cmd_id": "cmd-30001",
  "cmd": "set_relay",
  "params": {
    "state": true
  }
}
```

Для ШИМ-управления (если канал поддерживает PWM):

```json
{
  "cmd_id": "cmd-30002",
  "cmd": "set_pwm",
  "params": {
    "value": 255
  }
}
```

### 3.4. Канал суммарного тока насосов (SENSOR + связь с актуаторами)

Так как на ноде используется **один датчик тока INA209**, включённый в цепь общего питания насосов,
вводится один сенсорный канал, отражающий суммарный ток по “шине насосов”.

Рекомендуемый ключ канала:

- `pump_bus_current` — суммарный ток по линии питания насосов данной ноды.

Характеристики:

- Тип: `SENSOR`
- Тип данных: `float`
- Единицы: mA
- Источник данных: INA209 по I²C (адрес и параметры шунта задаются в NodeConfig).
- Канал логически привязан ко всей ноде насосов, а не к отдельному насосу.

Типичный payload telemetry для `pump_bus_current`:

```json
{
  "node_id": "nd-pump-1",
  "channel": "pump_bus_current",
  "metric_type": "PUMP_CURRENT",
  "value": 220.5,
  "timestamp": 1710005555
}
```

Логика использования:

- при включении любого насосного канала (`pump_acid`, `pump_base`, `pump_nutrient`, `pump_in`)
  ожидается рост тока по `pump_bus_current` выше заданного порога `min_bus_current_on`;
- в NodeConfig могут быть заданы разные ожидаемые окна тока для разных режимов (например,
  “работает только один насос”);
- при отсутствии тока при активной команде насосам, либо при аномально большом токе,
  узел формирует `command_response` со статусом `ERROR` и соответствующим `error_code`,
  а также может публиковать дополнительную диагностическую telemetry.

---

## 4. Виртуальные каналы (VIRTUAL)

---

## 4. Виртуальные каналы (VIRTUAL)

---

## 4. Виртуальные каналы (VIRTUAL)

Примеры:

- `zone_ph_avg` — средний pH по зоне;
- `zone_ec_avg` — средний EC;
- `zone_irrigation_state` — состояние полива зоны.

Они **не соответствуют физическим пинам**, а рассчитываются Python-сервисом.

---

## 5. Правила расширения справочника

1. Любой новый канал должен быть добавлен:
 - сюда;
 - в `../05_DATA_AND_STORAGE/DATA_MODEL_REFERENCE.md` (таблица `channels`);
 - при необходимости — в NodeConfig прошивки.
2. Нельзя использовать один и тот же ключ для разных физических значений.
3. Для ИИ-агентов:
 - не придумывать произвольные ключи;
 - согласовывать новые каналы через доменную модель.

Этот справочник должен использоваться **как источник правды**
при разработке прошивки, Python-контроллеров и backend-логики.
