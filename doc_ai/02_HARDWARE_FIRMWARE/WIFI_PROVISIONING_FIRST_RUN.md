# WIFI_PROVISIONING_FIRST_RUN.md
# Первичная настройка Wi-Fi узла
# AP-режим • Web-портал • NVS • Повторный сброс

Документ дополняет `WIFI_CONNECTIVITY_ENGINE.md` 
и описывает **режим первой настройки (provisioning)** для узлов ESP32.

---

# 1. Общая идея

При первом запуске (или после сброса Wi-Fi-настроек) узел:

1. Понимает, что **нет валидного Wi-Fi-конфига** в NVS.
2. Переходит в режим **Access Point** с открытой или защищённой сетью.
3. Поднимает минимальный **HTTP-сервер конфигурирования**.
4. Пользователь через Android-приложение или браузер:
 - подключается к AP,
 - вводит SSID/пароль Wi-Fi,
 - опционально — токен/ID теплицы/зоны.
5. Узел сохраняет конфиг в NVS и перезагружается в нормальный режим.

---

# 2. Состояния provisioning

Расширение машины состояний Wi-Fi-движка:

- `WIFI_STATE_UNPROVISIONED`
- `WIFI_STATE_AP_SETUP`
- `WIFI_STATE_WAITING_CONFIG`
- `WIFI_STATE_TRY_CONNECT`
- `WIFI_STATE_ONLINE`

Переходы:

- Если при старте **нет действующего конфига** в NVS → `UNPROVISIONED → AP_SETUP`.
- После успешного получения конфига → `WAITING_CONFIG → TRY_CONNECT`.
- При успешном подключении к Wi-Fi → `TRY_CONNECT → ONLINE`.
- При явном сбросе Wi-Fi (см. input-controls) → обратно в `UNPROVISIONED`.

---

# 3. Параметры AP-режима

Рекомендуемая схема:

- SSID: `HYDRO-NODE-XXXX`, где `XXXX` — последние 4 байта MAC или short-ID.
- Пароль:
 - вариант 1: фиксированный заводской (например, печатается на стикере);
 - вариант 2: открытый AP, если используется безопасный физический доступ (по месту установки).
- IP узла в AP-режиме: `192.168.4.1` (по умолчанию).
- DHCP: включен, выдаёт клиентам адреса `192.168.4.2+`.

AP-режим должен автоматически выключаться через **тайм-аут**, 
если конфиг не был получен (например, через 15–30 минут), с последующей попыткой рестарта.

---

# 4. Web-портал / HTTP API

Минимальный набор:

- `GET /` — простая HTML-страница с формой:
 - поля: `ssid`, `password`,
 - опционально: `greenhouse_token`, `zone_id`, `node_name`.
- `POST /configure` — приём JSON или form-data.

Пример JSON-payload:

```json
{
 "ssid": "MyHomeWiFi",
 "password": "strongpass123",
 "greenhouse_token": "gh-1234",
 "zone_id": "zn-1",
 "node_name": "PH TANK A"
}
```

Ответ:

- 200 OK, если валидация успешна (SSID не пустой и т.п.);
- 400 с сообщением об ошибке — при неверных данных.

После успешной валидации:

1. Конфиг записывается в NVS,
2. На экран выводится короткое подтверждение,
3. Узел запускает **мягкий перезапуск**.

---

# 5. Хранение конфига в NVS

В NVS должен быть отдельный namespace, например `wifi_config`:

- `wifi_ssid` — строка;
- `wifi_password` — строка;
- `greenhouse_token` — строка/опционально;
- `zone_id` — строка/опционально;
- `node_name` — строка/опционально.

Дополнительно можно хранить:

- `provisioned_at` — timestamp/строка;
- версию схемы (`config_schema_version`).

При старте прошивки:

- если `wifi_ssid` существует и валиден → пытаемся подключиться к Wi-Fi;
- если нет → `WIFI_STATE_UNPROVISIONED`.

---

# 6. Повторный сброс Wi-Fi

Сценарий:

- оператор делает **длинное нажатие** на кнопку (см. `NODE_INPUT_CONTROLS.md`),
- в нормальном режиме (`UI_STATE_NORMAL`) инициируется:
 - запрос подтверждения на дисплее,
 - при подтверждении — очистка Wi-Fi-конфига в NVS,
 - переход в `WIFI_STATE_UNPROVISIONED`,
 - перезапуск → AP-режим.

Очистка должна затрагивать только сеть и привязку к теплице/зоне, 
а не калибровочные данные сенсоров.

---

# 7. Интеграция с Android-приложением

Android-приложение может работать в двух моделях:

1. **Через локальный Web-портал**:
 - открывает браузер/встроенный WebView на `http://192.168.4.1`,
 - отдаёт данные формы.

2. **Через прямой HTTP-клиент**:
 - подключается к AP,
 - отправляет `POST /configure` программно.

Интеграция описывается в `ANDROID_APP_API_INTEGRATION.md`.

---

# 8. Требования к ИИ-агенту

1. ИИ не должен менять базовые состояния Wi-Fi-движка, может только расширять их.
2. При добавлении новых полей в конфиг:
 - обновить обработку HTTP-формы,
 - обновить структуру NVS,
 - обновить документацию.
3. Нельзя использовать небезопасные схемы хранения пароля
 (например, логировать его в открытом виде).
4. Любые изменения в логике сброса Wi-Fi должны оставаться консистентны
 с `NODE_INPUT_CONTROLS.md` и `NODE_OLED_UI_SPEC.md`.
