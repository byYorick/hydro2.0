# Обработка config_report от ноды

**Дата:** 2025-11-23

---

## Изменение логики привязки ноды

### Новая логика:
Нода считается привязанной к зоне **только после получения config_report** от ноды, который содержит актуальный NodeConfig.

---

## Поток привязки ноды

1. **Пользователь привязывает ноду к зоне** через UI
   - `NodeService::update()` устанавливает `zone_id`
   - Нода остается в состоянии `REGISTERED_BACKEND`

2. **Нода подключается и отправляет `config_report`**
   - Топик: `hydro/{gh}/{zone}/{node}/config_report`
   - Содержит полный NodeConfig из прошивки/NVS

3. **history-logger обрабатывает `config_report`**
   - Сохраняет конфиг в `nodes.config`
   - Синхронизирует `node_channels` из payload
   - Если нода в `REGISTERED_BACKEND` и есть `zone_id`/`pending_zone_id` → переводит в `ASSIGNED_TO_ZONE` через Laravel API

4. **Нода переводится в `ASSIGNED_TO_ZONE`**
   - Только после успешного подтверждения от ноды
   - Нода считается привязанной к зоне

---

## Измененные файлы

### 1. history-logger/main.py
- ✅ Добавлена подписка на `hydro/+/+/+/config_report`
- ✅ Создан обработчик `handle_config_report()`
- ✅ Сохранение `nodes.config` и синхронизация `node_channels`

### 2. Laravel / UI
- ✅ Отключена публикация конфига с сервера (`/api/nodes/{id}/config/publish` возвращает 410)
- ✅ UI переведён в режим просмотра конфига (read-only)

---

## Преимущества

1. ✅ **Единый источник** — конфиг формируется в прошивке, сервер только хранит
2. ✅ **Надежность** — привязка подтверждается фактом получения config_report
3. ✅ **Согласованность** — каналы синхронизируются из реального payload ноды
4. ✅ **Безопасность** — сервер не редактирует и не отправляет конфиг

---

## Метрики

Отдельные метрики для `config_report` пока не заведены.

---

## Важные замечания

- Если нода не отправила `config_report`, она не будет переведена в `ASSIGNED_TO_ZONE`
- Нода должна быть в состоянии `REGISTERED_BACKEND` и иметь `zone_id`/`pending_zone_id` для перевода
