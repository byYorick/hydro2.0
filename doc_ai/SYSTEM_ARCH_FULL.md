# SYSTEM_ARCH_FULL.md
# Полная архитектура системы hydro 2.0

Этот документ даёт обзор всей системы 2.0 сверху вниз и связывает между собой
остальные .md-файлы в репозитории структуры.

---

## 1. Цели системы 2.0

- Управлять гидропонными/тепличными зонами с высокой степенью автоматизации.
- Масштабироваться от одной маленькой теплицы до фермы с десятками зон.
- Иметь чёткую разделённую архитектуру:
 - ESP32-ноды — «железо»;
 - Python — логика зон и MQTT;
 - Laravel — конфигурация, пользователи, API;
 - Frontend/Android — UI и мобильный доступ;
 - AI/Digital Twin — анализ и оптимизация.

---

## 2. Общая картинка

Уровни сверху вниз:

1. **Пользователь / Оператор**
 - Web UI (Vue 3 + Inertia);
 - Android-приложение.

2. **Backend (Laravel + PostgreSQL)**
 - конфигурация теплиц/зон/узлов/каналов;
 - рецепты и фазы;
 - пользователи и права;
 - REST/WS API.

3. **Python-сервис**
 - MQTT-router;
 - контроллеры зон (pH, EC, климат, полив, свет);
 - запись телеметрии и событий в БД;
 - отправка команд на узлы.

4. **MQTT Broker**
 - единая шина сообщений `hydro/ `.

5. **ESP32-ноды**
 - узлы pH, EC, климат, освещение, полив;
 - телеметрия и выполнение команд;
 - локальный OLED UI.

6. **AI / Digital Twin / Simulation**
 - сервисы, читающие данные из БД;
 - создающие рекомендации и сценарии.

---

## 3. Логическая модель (Теплица → Зоны → Ноды → Каналы)

Подробно описано в `01_SYSTEM/LOGIC_ARCH.md`, здесь только суть:

- **Greenhouse** — контейнер верхнего уровня.
- **Zone** — основная единица агрономии (рецепты, цели, графики).
- **DeviceNode (ESP32)** — физический узел.
- **Channel** — сенсор или актуатор узла.

Решения по pH/EC/климату принимаются **на уровне зоны**, 
узлы лишь выполняют команды и измеряют параметры.

---

## 4. Потоки данных

1. **Конфигурация**:
 - создаётся/редактируется в Laravel UI;
 - хранится в PostgreSQL;
 - периодически выгружается Python-сервисом;
 - NodeConfig узлов синхронизируется через MQTT/provisioning.

2. **Телеметрия**:
 - ESP32 → `hydro/{gh}/{zone}/{node}/{channel}/telemetry`;
 - Python-сервис → таблицы `telemetry_samples` и `telemetry_last`;
 - Laravel/Frontend → графики и дашборды.

3. **Команды**:
 - Пользователь/AI/Python → запись намерения/команды в БД;
 - Python-сервис → публикация ` /command` в MQTT;
 - ESP32 → исполнение + `status`/`event`.

4. **AI / Digital Twin**:
 - читают историю из БД;
 - считают рекомендации;
 - складывают результаты обратно в БД/отдают через API.

---

## 5. Ключевые компоненты и ссылки на документы

- **Логика системы**: `01_SYSTEM/LOGIC_ARCH.md`
- **Жизненный цикл узла и provisioning**: `01_SYSTEM/NODE_LIFECYCLE_AND_PROVISIONING.md`
- **MQTT namespace**: `03_TRANSPORT_MQTT/MQTT_NAMESPACE.md`
- **Прошивка ESP32**: `02_HARDWARE_FIRMWARE/FIRMWARE_STRUCTURE.md`
- **Каналы узлов**: `02_HARDWARE_FIRMWARE/NODE_CHANNELS_REFERENCE.md`
- **OTA-обновление**: `02_HARDWARE_FIRMWARE/OTA_UPDATE_PROTOCOL.md`
- **Телеметрический pipeline**: `05_DATA_AND_STORAGE/TELEMETRY_PIPELINE.md`
- **Backend-архитектура**: `04_BACKEND_CORE/BACKEND_ARCH_FULL.md`
- **REST/API-спеки**:
 - `04_BACKEND_CORE/API_SPEC_FRONTEND_BACKEND_FULL.md`
 - `04_BACKEND_CORE/REST_API_REFERENCE.md`
- **Frontend**: `07_FRONTEND/FRONTEND_ARCH_FULL.md`, `07_FRONTEND/FRONTEND_UI_UX_SPEC.md`
- **Android**: `12_ANDROID_APP/ANDROID_APP_ARCH.md`, `12_ANDROID_APP/ANDROID_APP_API_INTEGRATION.md`
- **AI / Digital Twin**:
 - `09_AI_AND_DIGITAL_TWIN/AI_OPTIMIZATION_ENGINE.md`
 - `09_AI_AND_DIGITAL_TWIN/DIGITAL_TWIN_ENGINE.md`
 - `09_AI_AND_DIGITAL_TWIN/ZONE_SIMULATION_ENGINE.md`
- **Гайды для ИИ-агентов**:
 - `10_AI_DEV_GUIDES/*`

---

## 6. Принципы архитектуры 2.0

1. **Чёткие границы между слоями** 
 - ESP32 — только железо;
 - Python — контроллеры зон + MQTT;
 - Laravel — конфиг/история/пользователи;
 - UI — отображение и UX;
 - AI — рекомендации и аналитика.

2. **MQTT как шина для железа** 
 - Всё взаимодействие с узлами — через `hydro/ `;
 - Frontend/Android туда не ходят.

3. **PostgreSQL как единая БД** 
 - Все сервисы читают/пишут в одну схему;
 - миграции → через Laravel.

4. **Документация как контракт** 
 - Любое изменение в протоколах/схеме должно быть отражено в .md-файлах.

---

## 7. Для чего этот документ ИИ-агентам

- Быстро понять общую картину системы 2.0.
- Найти нужный детальный документ по ссылкам.
- Не плодить противоречивые решения в разных местах.

Если ИИ-агент вносит изменения в архитектуру, он обязан:
- обновить соответствующие разделы;
- сохранить целостность картины в этом файле.
