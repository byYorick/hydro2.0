# ENERGY_OPTIMIZATION_ENGINE.md
# Полная архитектура энергосберегающего движка системы 2.0
# Power Scheduling • Smart Loads • Predictive Demand • AI Optimization • Cost Reduction

Документ описывает полный энергосберегающий модуль системы 2.0.
Он оптимизирует потребление энергии теплицей и всеми узлами.

---

# 1. Назначение Energy Optimization Engine

Энергетический движок отвечает за:

- прогноз энергопотребления,
- оптимизацию расписаний нагрузки,
- управление освещением, вентиляцией, нагревателями,
- прогноз стоимости электроэнергии,
- работу по тарифам «день/ночь»,
- прогноз тепловых потерь,
- предотвращение пиков,
- ИИ-оптимизацию нагрузки.

---

# 2. Источники данных

Energy Engine использует:

- историю команд (насосы, свет, климат),
- телеметрию климата (температура, влажность),
- график работы света,
- мощность устройств,
- данные о потреблении от умных розеток/датчиков,
- внешние данные: погода, тарифы, прогноз облачности,
- Digital Twin прогнозы.

---

# 3. Модель энергопотребления зоны

Потребление делится на группы:

```
Lighting_energy
Climate_energy
Irrigation_energy
Mixing_energy
Electronics_energy
```

Формула:

```
TotalEnergy = Σ(device_power * device_runtime)
```

Twin использует точные модели:

- свет → тепло → влияние на климат,
- вентиляция → охлаждение,
- нагреватель → достижение target_temp.

---

# 4. Lighting Optimization

Основная логика:

- уменьшение интенсивности света при высокой температуре,
- перенос максимальной нагрузки на ночные часы,
- адаптивная регулировка света в зависимости от облачности,
- компенсация солнечного света (если есть датчики PAR).

Оптимизация:

```
target_PPFD = base + compensation - overheating_factor
```

---

# 5. Climate Optimization

### Heater optimization

```
on only when temp < target - delta
```

### Fan optimization

AI рассчитывает:

```
fan_duty = f(VPD, temp, humidity, day_phase)
```

### Dehumidifier scheduling

Если влажность высокая ночью → включение ночью, 
чтобы не перегружать сеть днём.

---

# 6. Irrigation Energy Optimization

Насосы полива потребляют мало, но:

- можно переносить полив на периоды минимальной нагрузки,
- можно избегать одновременного запуска нескольких насосов,
- можно выполнять ночной автоперемес (mixing).

---

# 7. Predictive Load Model

Модель прогнозирует потребление:

```
Energy(t+1) = f(light_schedule, climate_need, outdoor_weather)
```

Использует:

- Digital Twin,
- ML-модели (LGBM/NN).

---

# 8. AI Optimization Pipeline

AI подбирает:

- оптимальное время работы света,
- оптимальный VPD-профиль,
- оптимальную температуру,
- оптимальные интервалы полива,
- оптимальное время запуска оборудования.

Целевая функция:

```
cost = energy_cost + stress_penalty + growth_penalty
```

---

# 9. Peak Shaving (сглаживание пиков)

Система предотвращает резкие скачки нагрузки:

Алгоритм:

```
если текущая мощность > max_allowed:
 задержать или снизить часть нагрузки
```

Приоритеты:

1. климат
2. свет
3. полив
4. вспомогательные нагрузки

---

# 10. Работа с тарифами «день/ночь»

Если доступна информация о тарифах:

- свет переносится на ночные часы,
- нагрев работает на ночь,
- днём ограничивается мощность.

---

# 11. Smart Load Scheduling

Система планирует, когда включать:

- mixing pump,
- circulation pump,
- dehumidifier,
- extra lights.

Простейшая форма:

```
run_task(task) only if (current_load + task_load) < threshold
```

---

# 12. Monitoring & Diagnostics

Energy Engine измеряет:

- фактическую мощность,
- прогнозируемую мощность,
- ошибки между прогнозом и реальностью,
- эффективность света,
- эффективность климата.

Если отклонение > 15% → ALARM:

```
ENERGY_MODEL_DIVERGENCE
```

---

# 13. Energy Safety Logic

Система блокирует:

- запуск нагревателя при перегреве,
- включение освещения при аварии по нагрузке,
- одновременный запуск всех насосов.

---

# 14. Интеграция с Digital Twin

Twin прогнозирует:

- теплопотери,
- воду в циркуляции,
- поведение климата,
- эффективность световой системы.

Energy Engine использует Twin:

```
optimized_schedule = twin->simulate_energy(day)
```

---

# 15. API Energy Engine

Доступно через:

```
GET /api/energy/current
GET /api/energy/stats
POST /api/energy/optimize
POST /api/energy/schedule
```

---

# 16. UI Energy Dashboard

На панели отображается:

- текущее потребление (W)
- дневной/недельный прогноз
- максимальные пики
- оптимизированный график света
- экономия энергии
- эффективность климатической системы
- рекомендации AI

---

# 17. Правила для ИИ

ИИ может:

- создавать новые модели энергии,
- улучшать оптимизатор,
- добавлять адаптивные профили VPD,
- предложить новые расписания света.

ИИ НЕ может:

- выключать защитные ограничения нагрузки,
- изменять параметры безопасности,
- отключать проверки климатических ограничений.

---

# 18. Чек-лист перед релизом

1. Прогноз энергии точный? 
2. Peak Shaving работает? 
3. Smart Load Scheduling безопасен? 
4. AI даёт стабильные рекомендации? 
5. Twin интегрирован? 
6. UI показывает все графики? 
7. Ограничение нагрузки работает корректно? 
8. Ошибки моделирования отображаются? 

---

# Конец файла ENERGY_OPTIMIZATION_ENGINE.md
