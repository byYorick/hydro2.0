# AI_ARCH_FULL.md
# Полная архитектура AI‑слоя 2.0 (аналитика, рекомендации, диагностика, автокоррекция)

Этот документ описывает все компоненты и логику **AI‑слоя системы управления теплицами 2.0**.
AI‑слой не управляет оборудованием напрямую — он расширяет Backend интеллектуальными функциями:
аналитикой, рекомендациями, прогнозами, авто‑диагностикой и высокоуровневым пояснением действий.

---

# 1. Роль AI в системе

AI‑слой выполняет:

1. **Диагностику зон** 
 *Обнаружение отклонений pH, EC, t°, RH, расхода, уровня.*

2. **Рекомендации оператору** 
 *Как скорректировать рецепт, дозировки, интервалы, стратегии.*

3. **Прогнозирование параметров** 
 *Какой будет pH/EC при текущем тренде через 1–3 часа.*

4. **Объяснение состояния зоны в естественном языке** 
 *Почему зона ушла в ALARM, что делать, какие риски.*

5. **Анализ активности узлов** 
 *Определение “шумных” сенсоров, неэффективных насосов, плохого Wi‑Fi.*

6. **Оптимизацию поливов** 
 *Адаптивные интервалы на основе истории потребления.*

7. **Логику “AI‑assistant” в UI** 
 *Пользователь общается с AI для управления системой.*

---

# 2. Архитектура AI‑слоя

```
 Frontend (UI + AI Chat)
 │
 ▼
 AI API Gateway
 │
 ┌───────────┴───────────┐
 │ │
 Analytics Engine AI Reasoning Engine
 │ │
 └───────────┬───────────┘
 ▼
 Data Layer
 (DB + TSDB + Cache)
```

Компоненты:

- **AI API Gateway** — API входа для фронтенда. 
- **Analytics Engine** — математический и ML анализ данных. 
- **AI Reasoning Engine** — LLM‑основанная логика объяснений и рекомендаций. 
- **Data Layer** — база данных и хранилище телеметрии.

---

# 3. Источники данных для AI

AI‑слой собирает:

- последние telemetry значения 
- историю параметров (30 мин / 24 часа / 7 дней) 
- состояние зон/узлов 
- статус рецептов и фаз 
- историю команд 
- события и alert’ы 
- статус узлов (RSSI, heap, uptime)

---

# 4. Analytics Engine

### 4.1. Методы анализа

- moving averages 
- median filters 
- peak detection 
- anomaly detection 
- trend slope analysis 
- rolling variance 
- event correlation 
- pump efficiency scoring 
- Wi‑Fi quality scoring 

### 4.2. Типы анализов

#### a) Анализ pH
- тренд за 1 час 
- частота корректировок 
- нестабильность значения 
- выходы за порог 

#### b) Анализ EC
- корректность дозировок 
- потребление раствора 
- провалы (слишком сильное разбавление) 

#### c) Климат
- влажность слишком высокая → риск грибка 
- t° нестабильна → слабый обогрев 

#### d) Полив
- фактическая подача воды 
- расходомерные пики 

#### e) Узлы
- RSSI ниже −75 → нестабильно 
- heap ниже 40k → possible leak 
- ADC шумный → кабель/EMI 

---

# 5. AI Reasoning Engine

Использует LLM локально или в облаке.

Функции:

- превращает аналитические метрики в текстовые пояснения, 
- предлагает варианты действий, 
- генерирует рекомендации к рецепту, 
- объясняет поведение зоны, 
- подсказывает пользователю, что делать при ALARM.

Пример вывода:
```
PH последние 2 часа медленно растёт +0.15/час.
Вероятно, раствор разбавляется чрезмерно.
Рекомендация: уменьшить частоту долива или поднять EC.
```

---

# 6. AI задания (Tasks)

### 6.1. AI‑Diagnostics Task
Каждые 5 минут:

- анализирует все зоны
- формирует список проблем
- создаёт DIAG_REPORT

### 6.2. AI‑Recommendation Task
Запускается по запросу:

- Оптимизация интервалов полива
- Регулировка pH цели
- Предложение фаз рецептов

### 6.3. AI‑Explain Task
Генерирует:
- “Почему зона в ALARM?”
- “Что произошло за последние 2 часа?”

---

# 7. AI API

### 7.1. POST /api/ai/explain_zone
```json
{ "zone_id": "zn-3" }
```

### 7.2. POST /api/ai/recommend
```json
{
 "zone_id": "zn-3",
 "context": "ph_high"
}
```

### 7.3. POST /api/ai/diagnostics
Возвращает полный отчёт по теплице.

---

# 8. Взаимодействие AI → Backend

AI не пишет в MQTT. 
Все действия AI = рекомендации → Backend решает, применять или нет.

---

# 9. Безопасность AI

AI **не имеет права**:

- влиять на насосы напрямую 
- изменять рецепты без подтверждения 
- менять конфигурации узлов 

Все действия → только через Backend.

---

# 10. Будущее развитие AI‑слоя

- автоматическая адаптация рецептов 
- прогноз развития растений 
- анализ изображений (камеры) 
- раннее выявление болезней 
- predicitive irrigation 
- прогноз отказов узлов (RTT, RSSI, heap, uptime)

---

# Конец файла AI_ARCH_FULL.md
