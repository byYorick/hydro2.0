# Реализация отвязки ноды от зоны

**Дата:** 2025-11-23

---

## Реализованная функциональность

### Backend

1. **NodeService::detach()**
   - Отвязывает ноду от зоны (`zone_id = null`)
   - Сбрасывает `lifecycle_state` в `REGISTERED_BACKEND`
   - Нода становится доступной для повторной привязки
   - Логирует операцию

2. **NodeService::update()**
   - Добавлена обработка отвязки через `update` (если `zone_id` установлен в `null`)
   - При отвязке также сбрасывает `lifecycle_state` в `REGISTERED_BACKEND`

3. **NodeController::detach()**
   - Endpoint `POST /api/nodes/{node}/detach`
   - Возвращает обновленную ноду
   - Обрабатывает ошибки

4. **Роут**
   - `POST /api/nodes/{node}/detach` добавлен в `routes/api.php`

### Frontend

1. **Devices/Show.vue**
   - Добавлена кнопка "Отвязать от зоны" в карточке привязки к зоне
   - Кнопка отображается только если нода привязана к зоне
   - Подтверждение через `confirm()` перед отвязкой
   - Показывает состояние загрузки во время отвязки
   - Toast уведомления об успехе/ошибке
   - Автоматическая перезагрузка страницы после успешной отвязки

---

## Поток отвязки

1. Пользователь нажимает "Отвязать от зоны" на странице ноды
2. Показывается подтверждение
3. Отправляется запрос `POST /api/nodes/{node}/detach`
4. Backend:
   - Устанавливает `zone_id = null`
   - Сбрасывает `lifecycle_state` в `REGISTERED_BACKEND`
   - Сохраняет изменения
   - Генерирует событие `NodeConfigUpdated` (но `PublishNodeConfigOnUpdate` пропустит публикацию, так как `zone_id = null`)
5. Frontend получает ответ и перезагружает страницу
6. Нода появляется в списке новых нод (`/devices/add`) для повторной привязки

---

## Особенности

- ✅ При отвязке нода сбрасывается в `REGISTERED_BACKEND` - считается новой
- ✅ Нода появляется в списке новых нод (`unassigned=true`)
- ✅ `PublishNodeConfigOnUpdate` автоматически пропускает публикацию конфига при `zone_id = null`
- ✅ Все изменения логируются
- ✅ Кеш очищается после отвязки

---

## Проверка

- ✅ Линтер: нет ошибок
- ✅ Синтаксис: корректен
- ✅ Логика: корректна

---

## Статус

✅ **Функциональность отвязки реализована и готова к использованию**


