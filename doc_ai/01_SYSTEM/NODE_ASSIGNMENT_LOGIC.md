# Логика привязки ноды к зоне

**Дата:** 2025-11-23

---

## Изменение логики

### Старая логика:
1. При установке `zone_id` нода сразу переводилась в `ASSIGNED_TO_ZONE`
2. Конфиг публиковался асинхронно через событие
3. Если публикация не удалась, нода все равно считалась привязанной

### Новая логика:
1. При установке `zone_id` нода остается в `REGISTERED_BACKEND`
2. Нода отправляет `config_report` при подключении
3. **Только после получения `config_report`** нода переводится в `ASSIGNED_TO_ZONE`
4. Сервер не публикует конфиги на ноды

---

## Измененные файлы

### 1. NodeService::update()
- Убрана автоматическая установка `ASSIGNED_TO_ZONE` при привязке к зоне
- Нода остается в `REGISTERED_BACKEND` до получения `config_report`

### 2. history-logger::handle_config_report
- Обрабатывает `config_report` от ноды
- Сохраняет `nodes.config`, синхронизирует `node_channels`
- Переводит ноду в `ASSIGNED_TO_ZONE` через Laravel API

### 3. NodeRegistryService::registerNodeFromHello()
- Убрана автоматическая установка `ASSIGNED_TO_ZONE`
- Всегда оставляет ноду в `REGISTERED_BACKEND`

### 4. NodeSwapService
- Убрана автоматическая установка `ASSIGNED_TO_ZONE` при swap
- Нода остается в `REGISTERED_BACKEND` до получения `config_report`

### 5. Frontend (Add.vue)
- Обновлено сообщение об успешной привязке
- Показывает ожидание `config_report` от ноды

---

## Поток привязки ноды

1. Пользователь привязывает ноду к зоне через UI
2. `NodeService::update()` устанавливает `zone_id`, но оставляет `lifecycle_state = REGISTERED_BACKEND`
3. Нода подключается и отправляет `config_report` в `hydro/{gh}/{zone}/{node}/config_report`
4. **history-logger обрабатывает `config_report`:**
   - сохраняет NodeConfig и синхронизирует каналы
   - переводит ноду в `ASSIGNED_TO_ZONE`
5. Нода считается привязанной

---

## Преимущества

1. ✅ Нода считается привязанной только после `config_report`
2. ✅ Сервер использует актуальный конфиг, присланный нодой
3. ✅ Нет риска рассинхронизации из-за публикации конфига с сервера
4. ✅ Привязка подтверждается фактическим подключением ноды

---

## Важные замечания

- Нода должна быть в состоянии `REGISTERED_BACKEND` для привязки к зоне
