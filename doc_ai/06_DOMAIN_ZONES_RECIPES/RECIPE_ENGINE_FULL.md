# RECIPE_ENGINE_FULL.md
# Полная архитектура Recipe Engine 2.0

Recipe Engine — это подсистема, которая управляет рецептами выращивания:
фазами, целевыми значениями pH/EC/климата/света и переходами между фазами.

---

## 1. Назначение Recipe Engine

Recipe Engine отвечает за:

- хранение и версионирование рецептов;
- хранение фаз (этапов роста);
- определение целей (targets) для каждой фазы;
- управление переходами между фазами;
- предоставление контроллерам зон информации о текущих целях.

---

## 2. Модель данных (упрощённо)

Основные сущности:

- `recipes` — рецепт (для культуры/сорта).
- `recipe_phases` — фазы рецепта.
- `zones` — зоны, которым назначен рецепт.
- `zone_recipe_state` — состояние рецепта в конкретной зоне (активная фаза, прогресс).

Пример `recipe_phases` (логика, не SQL):

- `id` — PK;
- `recipe_id` — FK на `recipes`;
- `name` — название фазы (`SEED`, `VEG`, `FLOWER`);
- `order` — порядок;
- `duration_hours` — длительность;
- `target_ph`;
- `target_ec`;
- `target_temp_air`;
- `target_humidity`;
- `target_light_hours`;
- дополнительные ограничения (скорости изменения и т.п.).

---

## 3. Логика работы по зоне

1. Оператор назначает рецепт зоне через backend (`/api/zones/{id}/attach-recipe`). 
2. Создаётся запись `zone_recipe_state`:
 - `zone_id`;
 - `recipe_id`;
 - `current_phase_id`;
 - `started_at`;
 - `phase_started_at`;
 - `phase_progress` (опционально).

3. Python-контроллер зоны:
 - читает активную фазу;
 - получает целевые значения pH/EC/климата/света;
 - использует их в контроллерах (pH/EC/irrigation/light).

4. Переходы фаз:

 - Автоматические: по `duration_hours` или другим условиям (например, масса/высота растений — в будущем).
 - Ручные: оператор может «форсировать» переход.

Backend фиксирует переход в истории (лог рецепта/зоны).

---

## 4. Связь с контроллерами

Контроллеры (Python-сервис):

- запрашивают для зоны **текущую фазу** и её цели;
- вычисляют отклонение реальных значений от target;
- генерируют команды на узлы через MQTT.

Пример: pH-контроллер получает:

```json
{
 "target_ph": 5.8,
 "ph_tolerance": 0.1,
 "max_correction_per_hour_ml": 5.0
}
```

На основе телеметрии и ограничений он принимает решение о дозировках.

---

## 5. Правила для ИИ-агентов

1. Не добавлять логику контроллеров в сам Recipe Engine — он лишь хранит цели и фазы.
2. Любые новые поля в рецептах/фазах должны быть отражены в:
 - `DATA_MODEL_REFERENCE.md`;
 - `DATABASE_SCHEMA_AI_GUIDE.md`.
3. Не хранить в рецептах ничего, что специфично только для одной зоны (для этого есть `zone_recipe_state`).

Recipe Engine — это **декларативное описание целей**, а не «автомат» управления железом.
