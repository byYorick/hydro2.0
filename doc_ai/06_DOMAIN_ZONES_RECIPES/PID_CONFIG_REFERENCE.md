# PID_CONFIG_REFERENCE.md
# Справочник по настройке PID контроллеров

Этот документ описывает параметры PID-конфигурации для контроллеров pH и EC в системе Hydro 2.0.

---

## 1. Общая информация

PID (Proportional-Integral-Derivative) контроллеры используются для автоматической корректировки параметров pH и EC в зонах теплицы. Каждая зона может иметь индивидуальные настройки PID для pH и EC.

### Хранение конфигурации

- Конфигурации хранятся в таблице `zone_pid_configs`
- Одна конфигурация на зону и тип (pH или EC)
- Если конфигурация не задана, используются дефолтные значения из `AutomationSettings`

---

## 2. Структура конфигурации

```json
{
  "target": float,              // Целевое значение
  "dead_zone": float,           // Мертвая зона (без коррекции)
  "close_zone": float,          // Ближняя зона
  "far_zone": float,            // Дальняя зона
  "zone_coeffs": {
    "close": {
      "kp": float,              // Пропорциональный коэффициент
      "ki": float,              // Интегральный коэффициент
      "kd": float               // Дифференциальный коэффициент
    },
    "far": {
      "kp": float,
      "ki": float,
      "kd": float
    }
  },
  "max_output": float,          // Максимальный выход (мл)
  "min_interval_ms": int,      // Минимальный интервал между дозировками (мс)
  "enable_autotune": bool,     // Включить автонастройку
  "adaptation_rate": float      // Скорость адаптации (0-1)
}
```

---

## 3. Описание полей

### 3.1. target (Целевое значение)

**Описание:** Целевое значение параметра (pH или EC), к которому стремится контроллер.

**Диапазоны:**
- pH: 0.0 - 14.0
- EC: 0.0 - 10.0 (mS/cm)

**Дефолтные значения:**
- pH: 6.0
- EC: 2.0

**Примечание:** Обычно переопределяется из рецепта зоны, но может быть задано вручную.

---

### 3.2. Зоны (dead_zone, close_zone, far_zone)

**Описание:** Зоны определяют, как контроллер реагирует на отклонение от целевого значения.

**dead_zone (Мертвая зона):**
- Диапазон: 0.0 - 2.0
- Дефолт: 0.2
- Если отклонение ≤ dead_zone, коррекция не выполняется
- Коэффициенты PID всегда равны 0.0

**close_zone (Ближняя зона):**
- Диапазон: 0.0 - 5.0
- Дефолт: 0.5
- Если dead_zone < отклонение ≤ close_zone, используются коэффициенты для близкой зоны
- Должна быть больше dead_zone

**far_zone (Дальняя зона):**
- Диапазон: 0.0 - 10.0
- Дефолт: 1.0
- Если отклонение > close_zone, используются коэффициенты для дальней зоны
- Должна быть больше close_zone

**Пример:**
- Если target = 6.0, dead_zone = 0.2, close_zone = 0.5, far_zone = 1.0:
  - Текущее значение 5.9 (отклонение 0.1) → dead zone, коррекция не нужна
  - Текущее значение 5.6 (отклонение 0.4) → close zone, используются коэффициенты close
  - Текущее значение 5.0 (отклонение 1.0) → far zone, используются коэффициенты far

---

### 3.3. zone_coeffs (Коэффициенты PID)

**Описание:** Коэффициенты PID для каждой зоны определяют, как контроллер вычисляет дозу коррекции.

**Пропорциональный коэффициент (Kp):**
- Диапазон: 0.0 - 1000.0
- Влияет на скорость реакции на текущую ошибку
- Высокий Kp → быстрая реакция, но возможны колебания
- Низкий Kp → медленная реакция, но более стабильно

**Интегральный коэффициент (Ki):**
- Диапазон: 0.0 - 100.0
- Устраняет статическую ошибку (постоянное отклонение)
- Высокий Ki → быстрее устраняет остаточную ошибку, но может вызвать перерегулирование
- Обычно используется 0.0 для гидропоники (система достаточно быстрая)

**Дифференциальный коэффициент (Kd):**
- Диапазон: 0.0 - 100.0
- Предсказывает будущую ошибку на основе скорости изменения
- Помогает уменьшить колебания
- Обычно используется 0.0 для гидропоники

**Дефолтные значения для pH:**
- close: kp=10.0, ki=0.0, kd=0.0
- far: kp=12.0, ki=0.0, kd=0.0

**Дефолтные значения для EC:**
- close: kp=100.0, ki=0.0, kd=0.0
- far: kp=120.0, ki=0.0, kd=0.0

---

### 3.4. max_output (Максимальный выход)

**Описание:** Максимальное количество жидкости (мл), которое может быть дозировано за один цикл.

**Диапазоны:**
- pH: 0.0 - 1000.0 мл
- EC: 0.0 - 1000.0 мл

**Дефолтные значения:**
- pH: 50.0 мл
- EC: 200.0 мл

**Примечание:** Защита от передозирования. Даже если PID вычисляет больше, выход ограничивается этим значением.

---

### 3.5. min_interval_ms (Минимальный интервал)

**Описание:** Минимальное время (в миллисекундах) между двумя дозировками.

**Диапазон:** 1000 - 3600000 мс (1 секунда - 1 час)

**Дефолтные значения:**
- pH: 60000 мс (1 минута)
- EC: 60000 мс (1 минута)

**Примечание:** Защита от слишком частых дозировок. Даже если PID вычисляет дозу, она не будет применена, если с предыдущей дозировки прошло меньше времени.

**Рекомендации:**
- Для pH: 45-120 секунд (45000-120000 мс)
- Для EC: 60-300 секунд (60000-300000 мс)
- Не рекомендуется ставить меньше 30 секунд (30000 мс) без особой необходимости

---

### 3.6. enable_autotune (Автонастройка)

**Описание:** Включает автоматическую адаптацию коэффициентов PID на основе поведения системы.

**Тип:** boolean

**Дефолт:** false

**Как работает:**
- Если ошибка растет → увеличивается Kp, уменьшается Ki
- Если ошибка уменьшается → уменьшается Kp, увеличивается Ki
- Коэффициенты ограничиваются разумными пределами

**Рекомендации:**
- Включать только после стабилизации системы
- Требует мониторинга для предотвращения нестабильности

---

### 3.7. adaptation_rate (Скорость адаптации)

**Описание:** Скорость изменения коэффициентов при включенной автонастройке.

**Диапазон:** 0.0 - 1.0

**Дефолт:** 0.05 (5% за шаг)

**Примечание:** Используется только если `enable_autotune = true`. Высокие значения могут привести к нестабильности.

---

## 4. Дефолтные конфигурации

### 4.1. pH контроллер

```json
{
  "target": 6.0,
  "dead_zone": 0.2,
  "close_zone": 0.5,
  "far_zone": 1.0,
  "zone_coeffs": {
    "close": {"kp": 10.0, "ki": 0.0, "kd": 0.0},
    "far": {"kp": 12.0, "ki": 0.0, "kd": 0.0}
  },
  "max_output": 50.0,
  "min_interval_ms": 60000,
  "enable_autotune": false,
  "adaptation_rate": 0.05
}
```

### 4.2. EC контроллер

```json
{
  "target": 2.0,
  "dead_zone": 0.2,
  "close_zone": 0.5,
  "far_zone": 1.0,
  "zone_coeffs": {
    "close": {"kp": 100.0, "ki": 0.0, "kd": 0.0},
    "far": {"kp": 120.0, "ki": 0.0, "kd": 0.0}
  },
  "max_output": 200.0,
  "min_interval_ms": 60000,
  "enable_autotune": false,
  "adaptation_rate": 0.05
}
```

---

## 5. Безопасные диапазоны

### 5.1. Рекомендуемые значения

**Для pH:**
- target: 5.5 - 6.5 (большинство культур)
- dead_zone: 0.1 - 0.3
- close_zone: 0.3 - 0.7
- far_zone: 0.8 - 1.5
- kp (close): 5.0 - 20.0
- kp (far): 8.0 - 25.0
- max_output: 30.0 - 80.0 мл
- min_interval_ms: 45000 - 120000 мс

**Для EC:**
- target: 1.0 - 3.0 (зависит от культуры)
- dead_zone: 0.1 - 0.3
- close_zone: 0.3 - 0.7
- far_zone: 0.8 - 1.5
- kp (close): 50.0 - 200.0
- kp (far): 80.0 - 250.0
- max_output: 100.0 - 300.0 мл
- min_interval_ms: 60000 - 300000 мс

### 5.2. Опасные значения

**Не рекомендуется:**
- kp > 500 для любой зоны (слишком агрессивная коррекция)
- min_interval_ms < 30000 (слишком частые дозировки)
- dead_zone >= close_zone (невалидная конфигурация)
- close_zone >= far_zone (невалидная конфигурация)

**Система предупреждает:**
- При kp > 500 или min_interval_ms < 30000 требуется подтверждение перед сохранением

---

## 6. Рекомендации по настройке

### 6.1. Начальная настройка

1. Начните с дефолтных значений
2. Наблюдайте за поведением системы в течение 24-48 часов
3. Анализируйте логи PID_OUTPUT
4. Корректируйте параметры постепенно

### 6.2. Тонкая настройка

**Если система медленно реагирует:**
- Увеличьте kp на 10-20%
- Уменьшите dead_zone (но не ниже 0.1)

**Если система колеблется:**
- Уменьшите kp на 10-20%
- Увеличьте dead_zone
- Увеличьте min_interval_ms

**Если постоянное отклонение:**
- Включите autotune (осторожно!)
- Или увеличьте ki (но не более 0.5 для начала)

### 6.3. Примеры конфигов для разных культур

**Салат (pH 6.0, EC 1.5):**
```json
{
  "target": 6.0,
  "dead_zone": 0.15,
  "close_zone": 0.4,
  "far_zone": 0.8,
  "zone_coeffs": {
    "close": {"kp": 8.0, "ki": 0.0, "kd": 0.0},
    "far": {"kp": 10.0, "ki": 0.0, "kd": 0.0}
  },
  "max_output": 40.0,
  "min_interval_ms": 90000
}
```

**Томаты (pH 5.8, EC 2.5):**
```json
{
  "target": 5.8,
  "dead_zone": 0.2,
  "close_zone": 0.5,
  "far_zone": 1.0,
  "zone_coeffs": {
    "close": {"kp": 12.0, "ki": 0.0, "kd": 0.0},
    "far": {"kp": 15.0, "ki": 0.0, "kd": 0.0}
  },
  "max_output": 60.0,
  "min_interval_ms": 120000
}
```

---

## 7. Мониторинг и диагностика

### 7.1. События PID

**PID_OUTPUT:**
- Создается при каждом вычислении дозы (output > 0)
- Содержит: zone_state, output, error, current, target, dt_seconds

**PID_CONFIG_UPDATED:**
- Создается при изменении конфигурации
- Содержит: old_config, new_config, updated_by

### 7.2. Анализ логов

**Проверьте:**
- Частоту дозировок (не должно быть слишком часто)
- Размер ошибки (должна уменьшаться со временем)
- Зону работы (большую часть времени должна быть dead или close)
- Стабильность output (не должно быть резких скачков)

---

## 8. API для работы с конфигами

### 8.1. Получить конфиг

```
GET /api/zones/{zone}/pid-configs/{type}
```

### 8.2. Обновить конфиг

```
PUT /api/zones/{zone}/pid-configs/{type}
Body: { "config": {...} }
```

### 8.3. Получить логи

```
GET /api/zones/{zone}/pid-logs?type=ph&limit=50&offset=0
```

---

## 9. Интеграция с Python-сервисом

Python-сервис автоматически:
1. Читает конфиги из БД при инициализации PID
2. Кеширует конфиги в памяти (TTL 60 сек)
3. Инвалидирует кеш при обнаружении события PID_CONFIG_UPDATED
4. Использует дефолтные значения, если конфиг не найден

---

## 10. Безопасность

- Валидация всех полей на backend
- Rate limiting: максимум 10 изменений в минуту на зону
- Аудит: запись updated_by для всех изменений
- Safeguard: подтверждение при агрессивных настройках

---

**Последнее обновление:** 2025-01-28

