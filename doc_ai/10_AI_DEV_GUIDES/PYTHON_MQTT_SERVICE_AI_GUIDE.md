# PYTHON_MQTT_SERVICE_AI_GUIDE.md
# Инструкция для ИИ-агентов по Python MQTT-сервису

Документ описывает, как ИИ-агенты должны работать с Python-сервисом,
который обрабатывает MQTT-сообщения, управляет зонами и пишет телеметрию в БД.

---

## 1. Роль Python-сервиса

Python-сервис выполняет:

- подписку на MQTT-топики (`hydro/#`);
- запись телеметрии в PostgreSQL;
- выполнение контроллеров зон (pH, EC, климат, полив, свет);
- генерацию команд для узлов;
- маршрутизацию событий и алертов в backend.

Он **не** отвечает за авторизацию пользователей и UI — это задача Laravel.

---

## 2. Структура проекта (рекомендация)

```text
python-service/
 main_mqtt.py
 mqtt/
 client.py
 handlers.py
 controllers/
 ph_controller.py
 ec_controller.py
 climate_controller.py
 irrigation_controller.py
 light_controller.py
 db/
 models.py
 telemetry_writer.py
 commands/
 sender.py
 config/
 settings.py
 utils/
 logging.py
```

---

## 3. MQTT Listener (main_mqtt.py)

Основные обязанности:

- подключиться к брокеру;
- подписаться на `hydro/#` и `hydro/system/#`;
- при получении сообщений:
 - разобрать топик по схеме `../03_TRANSPORT_MQTT/MQTT_NAMESPACE.md`;
 - передать управление соответствующему обработчику;
 - логировать важные события.

---

## 4. Работа с БД

- Python-сервис использует read/write доступ к тем же таблицам, что и Laravel.
- Схема БД описана в `../05_DATA_AND_STORAGE/DATA_MODEL_REFERENCE.md` и `DATABASE_SCHEMA_AI_GUIDE.md`.
- Нельзя создавать свои «теневые» таблицы конфигурации без серьёзной причины.

---

## 5. Контроллеры зон

Каждый контроллер:

- получает состояние зоны и её цели (из Recipe Engine);
- анализирует телеметрию;
- решает, нужно ли отправить команду на узлы;
- выполняет **простые**, детерминированные действия (включить/выключить, дозировать определённый объём и т.п.).

Сложные ML-решения должны быть вынесены в AI-сервисы.

---

## 6. Правила для ИИ-агентов

1. Не менять базовый формат MQTT-топиков (см. `../03_TRANSPORT_MQTT/MQTT_NAMESPACE.md`).
2. Не внедрять логику уровнем UI в Python-сервис (например, текстовое форматирование).
3. Все изменения должны быть:
 - логируемыми;
 - устойчивыми к перезапуску сервиса;
 - совместимыми с текущей схемой БД.

Python-слой — это «сердце» realtime-управления, но он всё равно должен оставаться простым и предсказуемым.
