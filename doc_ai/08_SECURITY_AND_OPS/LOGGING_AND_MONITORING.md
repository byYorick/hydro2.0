# LOGGING_AND_MONITORING.md
# Система логирования и мониторинга 2.0

Документ описывает, как система 2.0 должна собирать логи, метрики и алерты.

---

## 1. Цели

- видеть текущее состояние сервисов и узлов;
- быстро находить причины ошибок;
- получать уведомления о критических событиях;
- иметь историю для анализа и улучшений.

---

## 2. Компоненты Observability

1. **Логи приложений** (Python-сервис, Laravel).
2. **Метрики сервисов** (CPU, RAM, количество сообщений MQTT и т.п.).
3. **Метрики домена** (количество алертов, успешных команд и т.п.).
4. **Алертинг** (e-mail, Telegram).

---

## 3. Логи

Каждый сервис пишет структурированные логи (JSON):

```json
{
 "ts": "2025-11-15T10:00:00Z",
 "service": "python_scheduler",
 "level": "INFO",
 "zone_id": 2,
 "node_id": 11,
 "event": "COMMAND_SENT",
 "details": {
 "command_type": "DOSE",
 "channel": "pump_acid",
 "ml": 1.0
 }
}
```

Требования:

- уровни: DEBUG, INFO, WARNING, ERROR, CRITICAL;
- наличие минимальных полей: `ts`, `service`, `level`, `event`;
- отсутствие чувствительных данных в логах (пароли, токены).

---

## 4. Метрики

Сервисы публикуют метрики в систему мониторинга (Prometheus/иное):

- системные:
 - загрузка CPU;
 - использование памяти;
 - количество активных подключений к БД;
- доменные:
 - количество алертов по зонам;
 - количество команд в минуту;
 - количество сообщений MQTT в минуту.

Графики строятся в Grafana.

---

## 5. Алертинг

Примеры алертов:

- недоступен брокер MQTT;
- Python-сервис не пишет телеметрию > N минут;
- количество ошибок команды OTA выше порога;
- слишком много алертов по одной зоне.

Алерты могут отправляться в:

- e-mail;
- Telegram-чат;
- панель UI.

---

## 6. Правила для ИИ-агентов

1. Не удалять существующие логи и метрики без замены.
2. При добавлении новой важной логики — добавить логирование ключевых событий.
3. Не логировать секретные данные.

Наблюдаемость — это «глаза и уши» системы. Без неё любое сложное поведение превращается в «чёрный ящик».
