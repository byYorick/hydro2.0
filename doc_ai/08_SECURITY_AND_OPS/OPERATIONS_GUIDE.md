# OPERATIONS_GUIDE.md
# Руководство по эксплуатации системы hydro2.0

Документ описывает ежедневные, еженедельные и ежемесячные операции для поддержания системы в рабочем состоянии.

---

## 1. Ежедневные операции

### 1.1. Проверка бэкапов (утром, после 3:30)

**Цель:** Убедиться, что ночной бэкап выполнился успешно.

**Действия:**
```bash
# Проверка списка бэкапов
php artisan backup:list

# Проверка последнего бэкапа
BACKUP_DIR=/backups/full/$(ls -t /backups/full | head -1)
ls -lh $BACKUP_DIR

# Проверка manifest
cat $BACKUP_DIR/manifest.json | jq .
```

**Критерии успеха:**
- Последний бэкап создан сегодня после 3:00
- Все компоненты успешно забэкаплены (status: "success" в manifest)
- Размеры бэкапов соответствуют ожидаемым

**Действия при ошибке:**
- Проверить логи: `docker-compose logs laravel | grep backup`
- Запустить бэкап вручную: `php artisan backup:full`
- Проверить свободное место на диске

### 1.2. Мониторинг системы

**Цель:** Проверить здоровье всех компонентов системы.

**Действия:**
```bash
# Проверка статуса контейнеров
docker-compose ps

# Проверка здоровья сервисов
curl http://localhost:8080/api/system/health
curl http://localhost:9000/metrics  # MQTT bridge
curl http://localhost:9401/metrics  # Automation engine
curl http://localhost:9402/metrics  # Scheduler

# Проверка Grafana (если доступна)
curl http://localhost:3000/api/health
```

**Критерии успеха:**
- Все контейнеры в статусе "Up"
- Health endpoints возвращают 200 OK
- Метрики собираются корректно

**Действия при ошибке:**
- Проверить логи проблемного сервиса
- Перезапустить сервис: `docker-compose restart <service>`
- См. соответствующий раздел в RUNBOOKS.md

### 1.3. Проверка алертов

**Цель:** Проверить наличие активных алертов.

**Действия:**
- Открыть UI: http://localhost:8080/alerts
- Проверить Grafana Alerts: http://localhost:3000/alerting
- Проверить Alertmanager: http://localhost:9093

**Критерии успеха:**
- Нет критических алертов
- Все resolved алерты обработаны

**Действия при алертах:**
- Изучить детали алерта
- Выполнить диагностику согласно типу алерта
- При необходимости — эскалация

### 1.4. Проверка свободного места

**Цель:** Убедиться, что есть достаточно места для бэкапов и логов.

**Действия:**
```bash
# Проверка места на диске
df -h

# Проверка размера директорий
du -sh /backups/*
du -sh /var/lib/docker/volumes/*
```

**Критерии успеха:**
- Свободно минимум 20% места на диске с бэкапами
- Размер бэкапов не превышает ожидаемый

**Действия при нехватке места:**
- Запустить ротацию бэкапов вручную
- Удалить старые логи
- Очистить Docker: `docker system prune`

---

## 2. Еженедельные операции

### 2.1. Проверка ротации бэкапов

**Цель:** Убедиться, что старые бэкапы удаляются согласно политике retention.

**Действия:**
```bash
# Проверка количества бэкапов
ls -d /backups/full/* | wc -l
ls -d /backups/postgres/* | wc -l

# Проверка возраста старых бэкапов
find /backups/full -type d -mtime +30
find /backups/postgres -type d -mtime +30

# Проверка WAL архивов
find /wal_archive -type f -mtime +7
```

**Критерии успеха:**
- Нет бэкапов старше 30 дней (полные)
- Нет WAL архивов старше 7 дней
- Ротация выполняется автоматически

**Действия при проблемах:**
- Запустить ротацию вручную: `./scripts/backup/rotate_backups.sh`
- Проверить расписание: `php artisan schedule:list`
- Проверить логи ротации

### 2.2. Тестирование восстановления одного компонента

**Цель:** Убедиться, что бэкапы можно восстановить.

**Действия:**
```bash
# Выбрать старый тестовый бэкап (не последний!)
TEST_BACKUP=/backups/postgres/$(ls -t /backups/postgres | tail -1)

# Восстановить в тестовую БД
docker-compose exec db psql -U hydro -c "CREATE DATABASE test_restore;"
./scripts/restore/postgres_restore.sh $TEST_BACKUP/*.dump \
  --db-name test_restore

# Проверить целостность
docker-compose exec db psql -U hydro -d test_restore -c "\dt"

# Удалить тестовую БД
docker-compose exec db psql -U hydro -c "DROP DATABASE test_restore;"
```

**Критерии успеха:**
- Бэкап успешно восстанавливается
- Данные целостны
- Время восстановления приемлемо

**Действия при проблемах:**
- Проверить целостность бэкапа: `php artisan backup:list --verify`
- Проверить логи восстановления
- При необходимости — создать новый бэкап

### 2.3. Обзор метрик и производительности

**Цель:** Выявить тренды и потенциальные проблемы.

**Действия:**
- Открыть Grafana: http://localhost:3000
- Проверить дашборды:
  - System Overview
  - Zone Telemetry
  - Node Status
  - Alerts Dashboard
- Проанализировать тренды за неделю

**Критерии успеха:**
- Нет аномальных трендов
- Производительность в норме
- Нет утечек памяти или ресурсов

**Действия при проблемах:**
- Изучить детали метрик
- Проверить логи соответствующих сервисов
- При необходимости — оптимизация

---

## 3. Ежемесячные операции

### 3.1. Полное тестирование Disaster Recovery

**Цель:** Убедиться, что система может быть полностью восстановлена.

**Действия:**

1. **Подготовка тестовой среды**
   ```bash
   # Создать тестовую копию docker-compose
   cp docker-compose.dev.yml docker-compose.test.yml
   # Изменить порты и имена контейнеров
   ```

2. **Выполнить полное восстановление**
   ```bash
   # Выбрать бэкап месячной давности
   TEST_BACKUP=/backups/full/$(ls -t /backups/full | tail -1)
   
   # Восстановить все компоненты
   ./scripts/restore/full_restore.sh $TEST_BACKUP
   ```

3. **Проверить работоспособность**
   - Запустить все сервисы
   - Проверить API endpoints
   - Проверить подключение узлов ESP32
   - Проверить телеметрию

**Критерии успеха:**
- Все компоненты восстановлены
- Система полностью функциональна
- Время восстановления ≤ 30 минут

**Документирование:**
- Записать время восстановления
- Записать найденные проблемы
- Обновить процедуры при необходимости

### 3.2. Аудит безопасности

**Цель:** Проверить безопасность системы.

**Действия:**
```bash
# Проверка уязвимостей зависимостей
cd backend/laravel
composer audit
npm audit

# Проверка конфигураций
grep -r "password" .env* | grep -v "^#"
grep -r "secret" .env* | grep -v "^#"

# Проверка прав доступа
ls -la backend/laravel/.env
ls -la backend/laravel/storage/
```

**Критерии успеха:**
- Нет критических уязвимостей
- Секреты не закоммичены
- Права доступа корректны

**Действия при проблемах:**
- Обновить уязвимые зависимости
- Исправить права доступа
- Ротация секретов при необходимости

### 3.3. Обновление документации

**Цель:** Поддержать документацию в актуальном состоянии.

**Действия:**
- Проверить актуальность RUNBOOKS.md
- Обновить процедуры при изменениях
- Добавить новые процедуры при необходимости
- Проверить ссылки на скрипты и команды

---

## 4. Процедуры обновления системы

### 4.1. Обновление зависимостей

**Последовательность:**

1. **Создать бэкап перед обновлением**
   ```bash
   php artisan backup:full
   ```

2. **Обновить зависимости**
   ```bash
   cd backend/laravel
   composer update
   npm update
   ```

3. **Проверить тесты**
   ```bash
   php artisan test
   npm test
   ```

4. **Применить миграции (если есть)**
   ```bash
   php artisan migrate
   ```

5. **Перезапустить сервисы**
   ```bash
   docker-compose restart
   ```

### 4.2. Обновление Docker образов

**Последовательность:**

1. **Создать бэкап**
   ```bash
   php artisan backup:full
   ```

2. **Обновить образы**
   ```bash
   docker-compose pull
   docker-compose up -d
   ```

3. **Проверить работоспособность**
   ```bash
   docker-compose ps
   curl http://localhost:8080/api/system/health
   ```

### 4.3. Обновление кода приложения

**Последовательность:**

1. **Создать бэкап**
   ```bash
   php artisan backup:full
   ```

2. **Получить обновления**
   ```bash
   git pull
   ```

3. **Обновить зависимости**
   ```bash
   composer install
   npm install
   ```

4. **Применить миграции**
   ```bash
   php artisan migrate
   ```

5. **Очистить кэши**
   ```bash
   php artisan config:clear
   php artisan cache:clear
   php artisan view:clear
   ```

6. **Перезапустить сервисы**
   ```bash
   docker-compose restart
   ```

---

## 5. Процедуры масштабирования

### 5.1. Добавление новых зон

**Действия:**
1. Создать зону через UI или API
2. Настроить рецепт для зоны
3. Привязать узлы ESP32
4. Проверить телеметрию

### 5.2. Добавление новых узлов ESP32

**Действия:**
1. Прошить узел прошивкой
2. Настроить Wi-Fi и MQTT
3. Зарегистрировать узел через API
4. Проверить подключение и телеметрию

### 5.3. Масштабирование сервисов

**Действия:**
1. Оценить нагрузку (метрики Prometheus)
2. Добавить реплики сервисов в docker-compose
3. Настроить load balancing (если необходимо)
4. Мониторить производительность

---

## 6. Чек-листы

### 6.1. Ежедневный чек-лист
- [ ] Бэкапы созданы успешно
- [ ] Все сервисы работают
- [ ] Нет критических алертов
- [ ] Достаточно свободного места
- [ ] Логи не переполнены

### 6.2. Еженедельный чек-лист
- [ ] Ротация бэкапов работает
- [ ] Тестирование восстановления выполнено
- [ ] Метрики проанализированы
- [ ] Нет аномальных трендов

### 6.3. Ежемесячный чек-лист
- [ ] Полное тестирование DR выполнено
- [ ] Аудит безопасности выполнен
- [ ] Документация обновлена
- [ ] Все процедуры проверены

---

## 7. Контакты и эскалация

**При критических инцидентах:**
1. Проверить RUNBOOKS.md для быстрых решений
2. Выполнить диагностику согласно процедурам
3. При необходимости — восстановление из бэкапа
4. Эскалация при невозможности решения проблемы

**Логи и мониторинг:**
- Логи Laravel: `docker-compose logs laravel`
- Логи Python сервисов: `docker-compose logs <service>`
- Grafana: http://localhost:3000
- Prometheus: http://localhost:9090
- Alertmanager: http://localhost:9093

---

## 8. Полезные ссылки

- **RUNBOOKS.md** — быстрые процедуры на случай инцидентов
- **BACKUP_AND_RECOVERY.md** — детальная информация о бэкапах
- **SYSTEM_FAILURE_RECOVERY.md** — процедуры восстановления после сбоев
- **SECURITY_ARCHITECTURE.md** — архитектура безопасности

---

# Конец файла OPERATIONS_GUIDE.md

