# Отчет о рефакторинге системы логирования

**Дата:** 2025-12-25  
**Статус:** ✅ Завершено

## Проблема

Ошибка аутентификации возвращала статус 500 вместо 401, хотя запрос все равно попадал в систему. Это происходило из-за того, что `AuthenticationException` обрабатывался в общем обработчике исключений и логировался как критическая ошибка.

## Решение

### 1. Приоритетная обработка AuthenticationException

**Файл:** `backend/laravel/bootstrap/app.php`

- ✅ Добавлен специальный обработчик для `AuthenticationException` **ПЕРЕД** общим обработчиком `Throwable`
- ✅ `AuthenticationException` теперь логируется как **предупреждение** (`Log::warning`), а не ошибка
- ✅ Возвращается правильный HTTP статус **401** для API запросов
- ✅ Добавлена детальная информация о запросе в логи:
  - URL и метод запроса
  - IP адрес и User-Agent
  - Наличие Authorization заголовка
  - Наличие Bearer токена
  - Наличие сессии
  - Тип запроса (API/Inertia/Web)

### 2. Улучшенное логирование в Authenticate Middleware

**Файл:** `backend/laravel/app/Http/Middleware/Authenticate.php`

- ✅ Добавлен метод `logUnauthenticatedAccess()` для логирования всех попыток неаутентифицированного доступа
- ✅ Логируется детальная информация:
  - Полный URL запроса
  - Метод HTTP
  - IP адрес клиента
  - User-Agent
  - Тип запроса (API/Inertia/Web)
  - Наличие токена в заголовке Authorization
  - Наличие токена в server переменных (для nginx/FastCGI)
  - Информация о сессии

### 3. Структурированное логирование

- ✅ Все логи содержат `correlation_id` для отслеживания запросов
- ✅ Логи аутентификации содержат структурированный контекст для анализа
- ✅ Разделение между предупреждениями (warning) и ошибками (error)

## Изменения в коде

### `bootstrap/app.php`

1. **Добавлен приоритетный обработчик AuthenticationException:**
   ```php
   $exceptions->render(function (\Illuminate\Auth\AuthenticationException $e, ...) {
       // Логирование как предупреждение
       \Log::warning('Authentication failed', $logContext);
       // Возврат 401 для API
       return response()->json([...], 401);
   });
   ```

2. **Обновлен общий обработчик:**
   - Добавлена проверка на `AuthenticationException` для пропуска (уже обработано)
   - Убрано дублирование логирования

### `app/Http/Middleware/Authenticate.php`

1. **Добавлен метод логирования:**
   ```php
   protected function logUnauthenticatedAccess(Request $request): void
   {
       // Детальное логирование попытки доступа
   }
   ```

2. **Вызов логирования в `redirectTo()`:**
   - Логируется каждая попытка неаутентифицированного доступа

## Результаты

### До рефакторинга:
- ❌ `AuthenticationException` логировался как ошибка (500)
- ❌ Недостаточно информации о запросе в логах
- ❌ Невозможно отследить, почему запрос попал в систему без аутентификации

### После рефакторинга:
- ✅ `AuthenticationException` логируется как предупреждение
- ✅ Возвращается правильный HTTP статус 401
- ✅ Детальная информация о запросе в логах
- ✅ Возможность отслеживать попытки неаутентифицированного доступа
- ✅ Структурированное логирование с correlation_id

## Примеры логов

### До:
```
[ERROR] Exception {"exception":"Illuminate\\Auth\\AuthenticationException","message":"Unauthenticated","status":500}
```

### После:
```
[WARNING] Authentication failed {
    "correlation_id": "req_694cf0b01a6eb_bae4e407",
    "url": "http://localhost/api/zones/34/events",
    "method": "GET",
    "ip": "127.0.0.1",
    "user_agent": "Mozilla/5.0...",
    "is_api": true,
    "is_inertia": false,
    "has_auth_header": false,
    "has_bearer_token": false,
    "has_session": false
}
```

## Безопасность

- ✅ Все попытки неаутентифицированного доступа логируются
- ✅ Можно отслеживать подозрительную активность
- ✅ Детальная информация помогает в расследовании инцидентов
- ✅ Правильные HTTP статусы не раскрывают лишнюю информацию

## Тестирование

Для проверки работы:

1. **API запрос без токена:**
   ```bash
   curl -X GET http://localhost/api/zones/34/events
   ```
   Ожидается: HTTP 401, логирование как предупреждение

2. **API запрос с невалидным токеном:**
   ```bash
   curl -X GET http://localhost/api/zones/34/events \
     -H "Authorization: Bearer invalid_token"
   ```
   Ожидается: HTTP 401, логирование с информацией о токене

3. **Inertia запрос без сессии:**
   - Ожидается: редирект на login, логирование как предупреждение

## Следующие шаги (опционально)

1. Добавить метрики для мониторинга попыток неаутентифицированного доступа
2. Настроить алерты при большом количестве попыток с одного IP
3. Добавить rate limiting для неаутентифицированных запросов
4. Интеграция с системой мониторинга (например, Sentry) для отслеживания паттернов

---

**Рефакторинг завершен успешно** ✅

