# План браузерных тестов с ИИ-ассистентами (Frontend)

Цель: дать ИИ-агенту предсказуемую карту интерфейса и сценарии, чтобы он мог автономно прогонять регрессию web UI (Vue 3 + Inertia + Pinia, Vite) через браузерные тесты (Playwright/Chromium в headed-режиме).

## 1. Окружение
- Бэк: `docker-compose -f tests/e2e/docker-compose.e2e.yml up -d` (Laravel на `http://localhost:8081`, WS Reverb `ws://localhost:6002/app/local`, MQTT 1884, Postgres 5433).
- Пользователь: использовать сидированного админа (email/пароль из сидов или `.env`; по умолчанию `admin@hydro.local` / `password` — уточнить и зашить в конфиг тестов).
- Данные: можно реюзать существующие зоны/ноды, но для стабильности лучше создавать фикстурные сущности через API перед сценарием (рецепт, зона, биндинги) и удалять после.
- Маркеры стабильных селекторов: добавить `data-testid` на интерактивные элементы (кнопки запуска цикла, пауза/резюм, отправка команды, фильтры алертов, форма логина). Без них ИИ будет опираться на текст и может ошибаться.

## 2. Базовые сценарии для агента
1) **Login/Logout**  
   - Открыть `/login`, заполнить email/пароль, проверить редирект на Dashboard и наличие имени пользователя, затем logout.

2) **Dashboard обзор зон**  
   - Проверить, что карточки зон отображают статус (PLANNED/RUNNING/PAUSED/HARVESTED), активные алерты, последние события.
   - Клик по зоне ведёт на детальную страницу.

3) **Детальная зона: snapshot + события**  
   - Проверить загрузку snapshot (наличие last_event_id, telemetry-блоков).  
   - Открыть ленту событий, удостовериться, что новые события появляются после действий (см. пункты 4–5).

4) **Управление циклом**  
   - Кнопки Start / Pause / Resume / Harvest.  
   - После Start статус зоны -> RUNNING, после Pause -> PAUSED, после Resume -> RUNNING, после Harvest -> HARVESTED.  
   - Проверить появление zone_events/уведомлений в UI.

5) **Команды узлам**  
   - На странице зоны отправить команду (например, включить main_pump).  
   - Убедиться, что UI показывает статусы SENT/ACK/ACCEPTED/DONE и обновляется без перезагрузки (WS).  
   - Проверить сообщение об ошибке при некорректном канале.

6) **Grow Cycle: рецепт**  
   - Создать рецепт (имя + описание), привязать к зоне, убедиться в статусе PLANNED и наличии текущей фазы.  
   - Пролистать фазы/таймлайн, проверить проценты прогресса.

7) **Alerts**  
   - Фильтры по статусу (ACTIVE/ACK/CLEARED), переход к деталям алерта, смена статуса (ACK/CLEAR) и наличие в таблице/лентах.  
   - Проверить отсутствие алертов для непривязанных узлов (опционально: mock temp error).

8) **Bindings**  
   - Создать binding (role -> node/channel) через UI.  
   - Проверить, что отправка команды по роли идёт на правильный node/channel (UI показывает резолв).

9) **WS деградации**  
   - В DevTools отключить сеть, убедиться, что UI показывает потерю соединения; вернуть сеть и проверить авто-ресабскрипшены (события появляются после reconnect).

## 3. Подготовка UI к агентам
- Добавить `data-testid` на: формы логина, карточки зон, кнопки управления циклом, таблицы алертов, кнопки фильтрации, поля создания рецепта/биндингов, кнопку отправки команды.
- Стабильные тексты/иконки: избегать динамических/локализованных строк в ключевых шагах, где агент ожидает текст.
- Унифицированные тосты/алерты с уникальными селекторами (`[data-testid="toast-success"]`).
- Страницы должны отдавать явное состояние подключения WS (иконка/текст с тест-id).

## 4. Подготовка данных для тестов
- Через API-хелпер перед сценарием: создать тестовую зону/рецепт/биндинги и удалить после.  
  Пример (псевдо):  
  - POST `/api/recipes` -> `recipe_id`  
  - POST `/api/zones/{id}/attach-recipe`  
  - POST `/api/zones/{id}/bindings` main_pump -> node/channel  
  - POST `/api/zones/{id}/start` для проверки RUNNING.
- Для алертов/команд можно триггерить MQTT из `tests/node_sim` или через API команд.

## 5. Тулчейн и запуск
- Использовать Playwright (Node) с headed Chromium; включить видео/trace для разборов.  
  - `npx playwright test` (конфиг: baseURL = http://localhost:8081, storageState для быстрой авторизации).  
  - Фикстура auth: логин 1 раз, сохранять state.
- Альтернатива: Cypress component/e2e, но Playwright проще для агента с автогенерацией шагов.
- Генерация шагов ИИ: разрешить агенту codegen (`npx playwright codegen http://localhost:8081`) с последующим ручным уплотнением селекторов `data-testid`.

## 6. Критерии успешности
- Каждый сценарий имеет детерминированные шаги и селекторы.  
- Нет зависимостей от случайного содержимого БД: тестовые сущности создаются/удаляются в before/after.  
- WS-индикаторы и тосты фиксированы и проверяемы.  
- Видеозаписи и trace для каждого прогона.

## 7. Следующие шаги
1) Добавить `data-testid` на ключевые элементы (см. раздел 3).  
2) Создать Playwright конфиг + auth fixture + smoke-набор (Login, Dashboard, Zone detail, Send command).  
3) Интегрировать подготовку данных через API-хелпер (Node fetch/axios) для рецепта/зоны/биндингов.  
4) Расширить набор сценариев до полного покрытия раздела 2.  
5) Включить прогон в CI (headless + trace) и сохранять артефакты.
