# –¢–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —ç—Ç–∞–ª–æ–Ω–æ–º node-sim

–ù–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—Ä–æ—à–∏–≤–æ–∫ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º node-sim.

## –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç—ã

### 1. test_node_compatibility.py

–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π:
- ‚úÖ –§–æ—Ä–º–∞—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- ‚úÖ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –§–æ—Ä–º–∞—Ç heartbeat
- ‚úÖ –§–æ—Ä–º–∞—Ç —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ JSON —Å—Ö–µ–º–∞–º

### 2. test_telemetry_format.py

–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ (–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ).

### 3. test_command_response_format.py

–¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã (–º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ).

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
./firmware/tests/run_compatibility_tests.sh

# –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
MQTT_HOST=192.168.1.100 MQTT_PORT=1883 \
./firmware/tests/run_compatibility_tests.sh

# –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ Python —Å–∫—Ä–∏–ø—Ç–∞
python3 firmware/tests/test_node_compatibility.py \
    --mqtt-host localhost \
    --mqtt-port 1884 \
    --gh-uid gh-test-1 \
    --zone-uid zn-test-1 \
    --node-uid nd-test-001
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.6+
- paho-mqtt: `pip install paho-mqtt`
- jsonschema: `pip install jsonschema`

–°–∫—Ä–∏–ø—Ç `run_compatibility_tests.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

### –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π: `metric_type`, `value`, `ts`
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π: `node_id`, `channel`
- ‚úÖ `metric_type` –≤ UPPERCASE
- ‚úÖ `ts` –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (int)
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ JSON —Å—Ö–µ–º–µ

### –û—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π: `cmd_id`, `status`, `ts`
- ‚úÖ `cmd_id` —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–º–∞–Ω–¥–µ
- ‚úÖ `ts` –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
- ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ACK, DONE, ERROR, –∏ —Ç.–¥.
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ JSON —Å—Ö–µ–º–µ

### Heartbeat
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π: `uptime`, `free_heap`
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—è `ts`
- ‚úÖ `uptime` –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ JSON —Å—Ö–µ–º–µ

### –°—Ç–∞—Ç—É—Å
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π: `status`, `ts`
- ‚úÖ `status` –≤ —Ñ–æ—Ä–º–∞—Ç–µ ONLINE/OFFLINE
- ‚úÖ `ts` –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (int)
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ JSON —Å—Ö–µ–º–µ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

### –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
python3 firmware/tests/test_telemetry_format.py sample_telemetry.json

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ stdin (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ MQTT)
mosquitto_sub -t 'hydro/+/+/+/+/telemetry' | python3 firmware/tests/test_telemetry_format.py -
```

### –¢–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
python3 firmware/tests/test_command_response_format.py sample_response.json

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ stdin
mosquitto_sub -t 'hydro/+/+/+/+/command_response' | python3 firmware/tests/test_command_response_format.py -
```

## –ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è

```json
{
  "metric_type": "PH",
  "value": 6.5,
  "ts": 1704067200
}
```

### –û—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É

```json
{
  "cmd_id": "cmd-12345",
  "status": "DONE",
  "details": "OK",
  "ts": 1704067200123
}
```

`details` –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫–æ–π, —Ç–∞–∫ –∏ –æ–±—ä–µ–∫—Ç–æ–º —Å –¥–µ—Ç–∞–ª—è–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```json
{
  "cmd_id": "cmd-12346",
  "status": "DONE",
  "details": {
    "virtual": true,
    "channel": "ph_sensor",
    "note": "probe_complete"
  },
  "ts": 1704067201123
}
```

### Heartbeat

```json
{
  "uptime": 3600,
  "free_heap": 200000,
  "rssi": -65
}
```

### –°—Ç–∞—Ç—É—Å

```json
{
  "status": "ONLINE",
  "ts": 1704067200
}
```

## –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
============================================================
–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –° –≠–¢–ê–õ–û–ù–û–ú NODE-SIM
============================================================

‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
  –ü–æ–¥–ø–∏—Å–∫–∞: hydro/gh-test-1/zn-test-1/nd-test-001/+/telemetry
  ...

üì® –ü–æ–ª—É—á–µ–Ω–æ: telemetry
   –¢–æ–ø–∏–∫: hydro/gh-test-1/zn-test-1/nd-test-001/ph_sensor/telemetry
   Payload: {
     "metric_type": "PH",
     "value": 6.5,
     "ts": 1704067200
   }

============================================================
–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
============================================================

‚úÖ status_format: –§–æ—Ä–º–∞—Ç —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É
‚úÖ telemetry_format: –§–æ—Ä–º–∞—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É
‚úÖ command_response_format: –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É
‚úÖ heartbeat_format: –§–æ—Ä–º–∞—Ç heartbeat —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —ç—Ç–∞–ª–æ–Ω—É

============================================================
–£—Å–ø–µ—à–Ω–æ: 4
–û—à–∏–±–æ–∫: 0
============================================================
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ CI

```yaml
# –ü—Ä–∏–º–µ—Ä –¥–ª—è GitHub Actions
- name: Test firmware compatibility
  run: |
    # –ó–∞–ø—É—Å–∫ MQTT –±—Ä–æ–∫–µ—Ä–∞
    docker run -d -p 1884:1883 eclipse-mosquitto
    
    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    ./firmware/tests/run_compatibility_tests.sh
```

---

**–í–µ—Ä—Å–∏—è:** 1.0
