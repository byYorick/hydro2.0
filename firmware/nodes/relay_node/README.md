# Relay Node

Релейная нода для управления системой накопления и обновления воды в баках.

## Описание

Нода управляет системой накопления и обновления воды в баках через реле:
- 2 насоса: перекачивающий и дренажный
- 2 емкости воды (расширяемо)
- Клапана для переключения магистралей воды
- Все устройства 220В, управляются через реле

## Каналы

### Актуаторы (реле)

- `pump_transfer` - перекачивающий насос
- `pump_drain` - дренажный насос
- `valve_tank1_in` - клапан подачи в бак 1
- `valve_tank1_out` - клапан выхода из бака 1
- `valve_tank2_in` - клапан подачи в бак 2
- `valve_tank2_out` - клапан выхода из бака 2
- `valve_main` - главный клапан магистрали (опционально)

## Команды

### set_state
Установка состояния реле (OPEN/CLOSED):
```json
{
  "cmd": "set_state",
  "cmd_id": "cmd-123",
  "state": 1
}
```

**Параметры:**
- `state` (integer): 0 = OPEN (разомкнуто), 1 = CLOSED (замкнуто)
- `cmd_id` (string): уникальный идентификатор команды

**Ответ:**
- `ACK` - реле успешно установлено
- `ERROR` с кодами:
  - `relay_not_found` - канал реле не найден
  - `relay_not_initialized` - драйвер реле не инициализирован
  - `relay_error` - ошибка установки состояния
  - `invalid_parameter` - неверный параметр

### toggle
Переключение состояния реле:
```json
{
  "cmd": "toggle",
  "cmd_id": "cmd-124"
}
```

**Параметры:**
- `cmd_id` (string): уникальный идентификатор команды

**Ответ:**
- `ACK` с полем `state` (новое состояние реле)
- `ERROR` с кодами:
  - `relay_not_found` - канал реле не найден
  - `relay_error` - ошибка переключения

### timed_on
Включение реле на указанное время:
```json
{
  "cmd": "timed_on",
  "cmd_id": "cmd-125",
  "duration_ms": 5000
}
```

**Параметры:**
- `duration_ms` (integer): длительность работы в миллисекундах (1-300000)
- `cmd_id` (string): уникальный идентификатор команды

**Ответ:**
- `ACK` - реле включено
- `ERROR` с кодами:
  - `relay_not_found` - канал реле не найден
  - `relay_error` - ошибка включения
  - `invalid_parameter` - неверный параметр

**Примечание:** В текущей реализации реле остается включенным до следующей команды. Для полной реализации автоматического выключения требуется система таймеров.

## Защита от дублирующих команд

Нода автоматически игнорирует повторные команды с тем же `cmd_id` в течение 60 секунд. При получении дубликата отправляется ответ со статусом `NO_EFFECT`.

## Очередь команд

Нода поддерживает очередь команд с лимитом 5. Если очередь заполнена, новые команды отклоняются с ошибкой `queue_full`. Команды обрабатываются последовательно в отдельной задаче.

## Watchdog таймер

Нода использует watchdog таймер (10 секунд) для защиты от зависаний. Все критические задачи автоматически сбрасывают watchdog в цикле.

## Конфигурация

Каналы реле настраиваются через NodeConfig:

```json
{
  "channels": [
    {
      "name": "pump_transfer",
      "type": "ACTUATOR",
      "actuator_type": "RELAY",
      "gpio": 4,
      "fail_safe_mode": "NO"
    },
    {
      "name": "pump_drain",
      "type": "ACTUATOR",
      "actuator_type": "RELAY",
      "gpio": 5,
      "fail_safe_mode": "NO"
    }
  ]
}
```

**Параметры канала:**
- `name` (string): имя канала
- `type` (string): должен быть "ACTUATOR"
- `actuator_type` (string): должен быть "RELAY"
- `gpio` (integer): GPIO пин для управления реле
- `fail_safe_mode` (string, опционально): "NO" (Normaly-Open) или "NC" (Normaly-Closed), по умолчанию "NO"

## Документация

- Архитектура нод: `doc_ai/02_HARDWARE_FIRMWARE/NODE_ARCH_FULL.md`
- MQTT спецификация: `doc_ai/03_TRANSPORT_MQTT/MQTT_SPEC_FULL.md`
- NodeConfig: `firmware/NODE_CONFIG_SPEC.md`

