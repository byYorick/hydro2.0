# pH Node

pH-нода для измерения pH и управления насосами кислоты/щелочи.

## Используемый сенсор

Нода использует **Trema pH-сенсор (iarduino)** через I²C:
- Компонент: `trema_ph`
- I²C адрес: 0x0A
- Поддержка калибровки (2 этапа)
- Автоматическая проверка стабильности измерений

## Описание

Нода измеряет pH раствора и может управлять насосами для корректировки pH (кислота/щелочь).

## Каналы

### Сенсоры
- `ph_sensor` - датчик pH

### Актуаторы
- `pump_acid` - насос кислоты
- `pump_base` - насос щелочи

## Команды

### run_pump
Запуск насоса на указанное время:
```json
{
  "cmd": "run_pump",
  "cmd_id": "cmd-123",
  "params": {
    "duration_ms": 2000
  }
}
```

**Параметры:**
- `duration_ms` (integer): длительность работы в миллисекундах (1-300000)
- `cmd_id` (string): уникальный идентификатор команды

**Ответ:**
- `ACK` - насос успешно запущен
- `ERROR` с кодами:
  - `pump_busy` - насос уже работает или в режиме охлаждения
  - `pump_not_found` - канал насоса не найден
  - `current_not_detected` - ток не обнаружен после запуска
  - `overcurrent` - превышен максимальный ток
  - `invalid_parameter` - неверный параметр

### calibrate
Калибровка pH датчика (2 этапа):
```json
{
  "cmd": "calibrate",
  "cmd_id": "cmd-124",
  "params": {
    "stage": 1,
    "known_ph": 7.0
  }
}
```

**Параметры:**
- `stage` (integer): этап калибровки (1 или 2)
- `known_ph` (float): известное значение pH (0.0-14.0)
- `cmd_id` (string): уникальный идентификатор команды

**Этапы калибровки:**
- **Этап 1**: калибровка на pH 7.0 (нейтральный буфер)
- **Этап 2**: калибровка на pH 4.0 или 10.0 (кислый/щелочной буфер)

**Ответ:**
- `ACK` - калибровка успешно выполнена
- `ERROR` с кодом `calibration_failed` - ошибка калибровки

## Защита от дублирующих команд

Нода автоматически игнорирует повторные команды с тем же `cmd_id` в течение 60 секунд. При получении дубликата отправляется ответ со статусом `NO_EFFECT`.

## Очередь команд

Нода поддерживает очередь команд с лимитом 5. Если очередь заполнена, новые команды отклоняются с ошибкой `queue_full`. Команды обрабатываются последовательно в отдельной задаче.

## Watchdog таймер

Нода использует watchdog таймер (10 секунд) для защиты от зависаний. Все критические задачи автоматически сбрасывают watchdog в цикле.

## Документация

- Архитектура нод: `../../../doc_ai/02_HARDWARE_FIRMWARE/NODE_ARCH_FULL.md`
- MQTT спецификация: `../../../doc_ai/03_TRANSPORT_MQTT/MQTT_SPEC_FULL.md`
- NodeConfig: `../../NODE_CONFIG_SPEC.md`
