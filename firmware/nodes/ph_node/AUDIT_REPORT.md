# –û—Ç—á–µ—Ç –æ–± –∞—É–¥–∏—Ç–µ ph_node
**–î–∞—Ç–∞:** 2025-01-27  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏:** —Ç–µ–∫—É—â–∞—è  
**–û—Å–Ω–æ–≤–∞:** –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏–∑ `doc_ai/02_HARDWARE_FIRMWARE/`

---

## 1. –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢–°–Ø –î–û–†–ê–ë–û–¢–ö–ê**

–ü—Ä–æ—à–∏–≤–∫–∞ ph_node –≤ —Ü–µ–ª–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –Ω–æ –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

---

## 2. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ (NODE_ARCH_FULL.md)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π** - –∫–æ–¥ —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏:
   - `ph_node_app.c` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è
   - `ph_node_init.c` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
   - `ph_node_tasks.c` - FreeRTOS –∑–∞–¥–∞—á–∏
   - `ph_node_handlers.c` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ MQTT
   - `pump_control.c` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–∞–º–∏

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**
   - ‚úÖ `config_storage` - —Ö—Ä–∞–Ω–µ–Ω–∏–µ NodeConfig
   - ‚úÖ `wifi_manager` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Wi-Fi
   - ‚úÖ `mqtt_manager` - MQTT –∫–ª–∏–µ–Ω—Ç
   - ‚úÖ `i2c_bus` - I¬≤C —à–∏–Ω–∞
   - ‚úÖ `trema_ph` - –¥—Ä–∞–π–≤–µ—Ä pH —Å–µ–Ω—Å–æ—Ä–∞
   - ‚úÖ `oled_ui` - OLED –¥–∏—Å–ø–ª–µ–π
   - ‚úÖ `setup_portal` - –ø–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
   - ‚úÖ `heartbeat_task` - heartbeat

3. **–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —É–∑–ª–∞:**
   - ‚úÖ Boot ‚Üí Load Config ‚Üí Wi-Fi ‚Üí MQTT ‚Üí Tasks

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **FreeRTOS –∑–∞–¥–∞—á–∏:**
   - ‚úÖ `task_sensors` - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
   - ‚úÖ `heartbeat_task` - —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
   - ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —è–≤–Ω–∞—è `task_actuators` (–Ω–∞—Å–æ—Å—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ handlers)

### ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏—è STATUS —Å–æ–æ–±—â–µ–Ω–∏–π:**
   - –°–æ–≥–ª–∞—Å–Ω–æ `DEVICE_NODE_PROTOCOL.md` —Ä–∞–∑–¥–µ–ª 4.2, —É–∑–µ–ª –¥–æ–ª–∂–µ–Ω –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å status –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
   - –í –∫–æ–¥–µ –Ω–µ—Ç —è–≤–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ status —Å –ø–æ–ª—è–º–∏: `online`, `ip`, `rssi`, `fw`
   - Heartbeat –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è, –Ω–æ —Ñ–æ—Ä–º–∞—Ç –º–æ–∂–µ—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

---

## 3. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—É MQTT (DEVICE_NODE_PROTOCOL.md)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–§–æ—Ä–º–∞—Ç —Ç–æ–ø–∏–∫–æ–≤:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: `hydro/{gh}/{zone}/{node}/{channel}/{type}`
   - –¢–æ–ø–∏–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `mqtt_manager`

2. **Telemetry —Ñ–æ—Ä–º–∞—Ç:**
   - ‚úÖ –ü—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫
   - ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç `value`, `ts` (timestamp)
   - ‚úÖ –°–æ–¥–µ—Ä–∂–∏—Ç `node_id`, `channel`, `metric_type`

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **Telemetry payload:**
   - –í `ph_node_tasks.c:142-150` –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: `raw`, `stub`, `stable`
   - –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ backend –∏—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
   - –ü–æ–ª–µ `ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `timestamp` –≤–º–µ—Å—Ç–æ `ts` (–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ!)

### ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **Telemetry —Ñ–æ—Ä–º–∞—Ç:**
   ```c
   // –¢–µ–∫—É—â–∏–π –∫–æ–¥ (ph_node_tasks.c:150):
   cJSON_AddNumberToObject(telemetry, "timestamp", ...);
   
   // –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ DEVICE_NODE_PROTOCOL.md:
   "ts": 1737355600456
   ```
   **–ö–†–ò–¢–ò–ß–ù–û:** –ü–æ–ª–µ –¥–æ–ª–∂–Ω–æ –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `ts`, –∞ –Ω–µ `timestamp`!

2. **Status —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ù–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ status –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
   ```json
   {
     "online": true,
     "ip": "192.168.1.44",
     "rssi": -62,
     "fw": "1.0.3"
   }
   ```
   - Heartbeat –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è, –Ω–æ —Ñ–æ—Ä–º–∞—Ç –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

---

## 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (DEVICE_NODE_PROTOCOL.md, NODE_CHANNELS_REFERENCE.md)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥:**
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `cmd_id`, `cmd`, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   - ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `command_response` —Å `cmd_id` –∏ `status`

2. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
   - ‚úÖ `run_pump` - –∑–∞–ø—É—Å–∫ –Ω–∞—Å–æ—Å–∞
   - ‚úÖ `stop_pump` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å–æ—Å–∞
   - ‚úÖ `dose` - –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ
   - ‚úÖ `set_state` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - ‚úÖ `calibrate` - –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ pH

3. **–°—Ç–∞—Ç—É—Å—ã –æ—Ç–≤–µ—Ç–æ–≤:**
   - ‚úÖ `ACK` - —É—Å–ø–µ—Ö
   - ‚úÖ `ERROR` - –æ—à–∏–±–∫–∞ —Å `error_code` –∏ `error_message`

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥:**
   - –í `NODE_CHANNELS_REFERENCE.md` —É–∫–∞–∑–∞–Ω —Ñ–æ—Ä–º–∞—Ç:
   ```json
   {
     "cmd": "DOSE",
     "ml": 1.0,
     "ttl_ms": 5000,
     "cmd_id": "cmd-19292"
   }
   ```
   - –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `dose_ml` –≤–º–µ—Å—Ç–æ `ml` (ph_node_handlers.c:302)
   - –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `duration_ms` –≤–º–µ—Å—Ç–æ `ttl_ms`

2. **–ö–æ–º–∞–Ω–¥–∞ calibrate:**
   - –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `known_ph` (ph_node_handlers.c:348)
   - –í README —É–∫–∞–∑–∞–Ω `ph_value` (ph_node/README.md:45)
   - –ù—É–∂–Ω–∞ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è

### ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ INA209 –¥–ª—è –Ω–∞—Å–æ—Å–æ–≤:**
   - –°–æ–≥–ª–∞—Å–Ω–æ `DEVICE_NODE_PROTOCOL.md` —Ä–∞–∑–¥–µ–ª 6, –¥–ª—è –Ω–∞—Å–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–∞ —á–µ—Ä–µ–∑ INA209
   - –í `pump_control.c` –Ω–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å INA209
   - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `min_bus_current_on` –∏ `max_bus_current_on`
   - –ù–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ telemetry –ø–æ –∫–∞–Ω–∞–ª—É `pump_bus_current`
   - **–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!**

2. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥:**
   - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `cmd_id`
   - –°–æ–≥–ª–∞—Å–Ω–æ `DEVICE_NODE_PROTOCOL.md` —Ä–∞–∑–¥–µ–ª 8, –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ `cmd_id`

---

## 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (NODE_ARCH_FULL.md —Ä–∞–∑–¥–µ–ª 10)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –ª–∏–º–∏—Ç—ã –Ω–∞—Å–æ—Å–æ–≤:**
   - ‚úÖ `max_duration_ms` - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã
   - ‚úÖ `min_off_time_ms` - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É

2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `is_running` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

### ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç watchdog —Ç–∞–π–º–µ—Ä:**
   - –°–æ–≥–ª–∞—Å–Ω–æ `DEVICE_NODE_PROTOCOL.md` —Ä–∞–∑–¥–µ–ª 8, —Ç—Ä–µ–±—É–µ—Ç—Å—è watchdog 5-10 —Å–µ–∫—É–Ω–¥
   - –í –∫–æ–¥–µ –Ω–µ—Ç —è–≤–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ watchdog

2. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥:**
   - –ù–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
   - –ù–µ—Ç –æ—á–µ—Ä–µ–¥–∏ "pending commands" —Å –ª–∏–º–∏—Ç–æ–º 5

3. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–∞ –Ω–∞—Å–æ—Å–æ–≤:**
   - –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å INA209 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–∞
   - –ù–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è `current_not_detected` –∏ `overcurrent`
   - **–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è!**

---

## 6. –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (ESP32_C_CODING_STANDARDS.md)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–°—Ç–∏–ª—å –∫–æ–¥–∞:**
   - ‚úÖ `snake_case` –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
   - ‚úÖ –ü—Ä–µ—Ñ–∏–∫—Å—ã –º–æ–¥—É–ª–µ–π (`ph_node_`, `pump_control_`)
   - ‚úÖ –û—Ç—Å—Ç—É–ø—ã 4 –ø—Ä–æ–±–µ–ª–∞
   - ‚úÖ K&R —Å—Ç–∏–ª—å —Ñ–∏–≥—É—Ä–Ω—ã—Ö —Å–∫–æ–±–æ–∫

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `esp_err_t`
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `ESP_LOGE`

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TAG –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–æ–≤ (ERROR, WARN, INFO, DEBUG)

4. **FreeRTOS:**
   - ‚úÖ –ó–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `vTaskDelayUntil` –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `static` –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (—Ö–æ—Ä–æ—à–æ)
   - –ù–æ –µ—Å—Ç—å –∫–µ—à `s_node_id_cache` –≤ `ph_node_app.c` - —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ

---

## 7. NodeConfig (NODE_CONFIG_SPEC.md)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
   - ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ NVS –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (setup mode)

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `config_storage_validate()`

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `config_apply` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   - ‚úÖ Graceful –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Wi-Fi/MQTT

### ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
   - –ù–∞—Å–æ—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Å hardcoded –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (ph_node_init.c:224-237)
   - –î–æ–ª–∂–Ω—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–∑ NodeConfig —á–µ—Ä–µ–∑ `pump_driver_init_from_config()`
   - –°–æ–≥–ª–∞—Å–Ω–æ `NODE_ARCH_FULL.md` —Ä–∞–∑–¥–µ–ª 10.3, –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è `pump_driver` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

---

## 8. –ö–∞–Ω–∞–ª—ã (NODE_CHANNELS_REFERENCE.md)

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–°–µ–Ω—Å–æ—Ä–Ω—ã–µ –∫–∞–Ω–∞–ª—ã:**
   - ‚úÖ `ph_sensor` - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
   - ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è telemetry

2. **–ê–∫—Ç—É–∞—Ç–æ—Ä–Ω—ã–µ –∫–∞–Ω–∞–ª—ã:**
   - ‚úÖ `pump_acid` - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
   - ‚úÖ `pump_base` - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

### ‚ùå –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–∞–Ω–∞–ª `pump_bus_current`:**
   - –°–æ–≥–ª–∞—Å–Ω–æ `NODE_CHANNELS_REFERENCE.md` —Ä–∞–∑–¥–µ–ª 3.4, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–µ–Ω—Å–æ—Ä–Ω—ã–π –∫–∞–Ω–∞–ª `pump_bus_current`
   - –≠—Ç–æ—Ç –∫–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—É–º–º–∞—Ä–Ω—ã–π —Ç–æ–∫ –≤—Å–µ—Ö –Ω–∞—Å–æ—Å–æ–≤ —á–µ—Ä–µ–∑ INA209
   - **–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!**

---

## 9. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ö–†–ò–¢–ò–ß–ù–û - –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. **–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—è –≤ telemetry:**
   - –§–∞–π–ª: `ph_node_tasks.c:150`
   - –ü—Ä–æ–±–ª–µ–º–∞: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `timestamp` –≤–º–µ—Å—Ç–æ `ts`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `ts`

2. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–∞ –Ω–∞—Å–æ—Å–æ–≤ (INA209):**
   - –§–∞–π–ª—ã: `pump_control.c`, `ph_node_handlers.c`
   - –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å INA209 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–∞
   - –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –Ω–∞—Å–æ—Å–∞, —Ä–∏—Å–∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å `ina209` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º, –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –Ω–∞—Å–æ—Å–∞

3. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–∞–Ω–∞–ª `pump_bus_current`:**
   - –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ telemetry –ø–æ —Ç–æ–∫—É –Ω–∞—Å–æ—Å–æ–≤
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é —Ç–æ–∫–∞

4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏—è STATUS:**
   - –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ status —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å heartbeat_task —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º

5. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥:**
   - –§–∞–π–ª: `ph_node_handlers.c`
   - –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö `cmd_id`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∫–µ—à –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö `cmd_id` —Å TTL

---

## 10. –ù–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### üü° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å–æ—Å–æ–≤ –∏–∑ NodeConfig:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pump_driver_init_from_config()` –≤–º–µ—Å—Ç–æ hardcoded –∑–Ω–∞—á–µ–Ω–∏–π
   - –§–∞–π–ª: `ph_node_init.c:224-237`

2. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∫–æ–º–∞–Ω–¥:**
   - –ü—Ä–∏–≤–µ—Å—Ç–∏ –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –∏–∑ `NODE_CHANNELS_REFERENCE.md`
   - `dose_ml` ‚Üí `ml`, `duration_ms` ‚Üí `ttl_ms` (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç, –Ω–æ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å)

3. **–î–æ–±–∞–≤–∏—Ç—å watchdog —Ç–∞–π–º–µ—Ä:**
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å watchdog –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π

4. **–î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥:**
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å "pending commands" —Å –ª–∏–º–∏—Ç–æ–º 5

5. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫:**
   - –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥

---

## 11. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pump_driver` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**
   - –ó–∞–º–µ–Ω–∏—Ç—å `pump_control.c` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `pump_driver`
   - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å INA209 "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"

2. **–î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã:**
   - –ü–æ–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç–∞–º–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞—Å–æ—Å–æ–≤)

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - –û–±–Ω–æ–≤–∏—Ç—å README —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –∫–æ–º–∞–Ω–¥ –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –Ω–∞—Å–æ—Å–æ–≤

---

## 12. –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ | ‚úÖ 85% | –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–¥–∞—á |
| –ü—Ä–æ—Ç–æ–∫–æ–ª MQTT | ‚ö†Ô∏è 70% | –ï—Å—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚ùå 50% | –ö—Ä–∏—Ç–∏—á–Ω–æ: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–∞ –Ω–∞—Å–æ—Å–æ–≤ |
| –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∞ | ‚úÖ 90% | –•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º |
| NodeConfig | ‚ö†Ô∏è 75% | –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è |
| –ö–∞–Ω–∞–ª—ã | ‚ö†Ô∏è 80% | –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –µ—Å—Ç—å, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `pump_bus_current` |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚ö†Ô∏è **75% - –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞**

---

## 13. –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è –ø–æ–ª—è `timestamp` ‚Üí `ts` –≤ telemetry
2. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é INA209 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–∞ –Ω–∞—Å–æ—Å–æ–≤
3. –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª `pump_bus_current` —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π telemetry
4. –î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é STATUS —Å–æ–æ–±—â–µ–Ω–∏–π
5. –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pump_driver` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–º–µ—Å—Ç–æ `pump_control`
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å–æ—Å—ã –∏–∑ NodeConfig
3. –î–æ–±–∞–≤–∏—Ç—å watchdog —Ç–∞–π–º–µ—Ä
4. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
1. –î–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥
2. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
3. –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã
4. –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

**–û—Ç—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 2025-01-27  
**–°–ª–µ–¥—É—é—â–∏–π –∞—É–¥–∏—Ç:** –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

