# Отчет аудита Watchdog таймера для ph_node

Дата: 2024-11-23

## Резюме

Проведен полный аудит использования watchdog таймера в ph_node. Найдены и исправлены все проблемы.

## Найденные проблемы

### 1. ❌ Конфликт конфигурации watchdog в sdkconfig
**Проблема:**
- `CONFIG_ESP_TASK_WDT_TIMEOUT_S=5` (должно быть 10 секунд)
- `CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU0=y` (должно быть отключено)
- `CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU1=y` (должно быть отключено)

**Причина:** Idle задачи не могут сбрасывать watchdog, что вызывает ложные срабатывания.

**Исправление:**
- Обновлен `sdkconfig`: установлен таймаут 10 секунд
- Отключена проверка idle задач для обоих CPU

### 2. ❌ Предупреждения компилятора о сравнении беззнаковых типов
**Проблема:**
- Проверка `elapsed_since_wdt < 0` для типа `TickType_t` (беззнаковый)
- Компилятор предупреждает: "comparison of unsigned expression in '< 0' is always false"

**Причина:** `TickType_t` - беззнаковый тип, никогда не может быть отрицательным.

**Исправление:**
- Удалены все проверки `< 0` для беззнаковых типов
- Добавлены комментарии о том, что переполнение работает по модулю

### 3. ✅ Все задачи правильно используют watchdog
**Проверено:**
- `task_sensors` - ✓ регистрируется в watchdog, периодически сбрасывает (каждые 2 сек)
- `task_pump_current` - ✓ регистрируется в watchdog, периодически сбрасывает (каждые 3 сек)
- `task_status` - ✓ регистрируется в watchdog, периодически сбрасывает (каждые 5 сек)
- `task_command_processor` - ✓ регистрируется в watchdog, периодически сбрасывает (каждые 3 сек)
- `heartbeat_task` - ✓ регистрируется в watchdog, периодически сбрасывает (каждые 5 сек)

## Исправленные файлы

1. **firmware/nodes/ph_node/sdkconfig**
   - `CONFIG_ESP_TASK_WDT_TIMEOUT_S=10` (было 5)
   - `CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU0=n` (было y)
   - `CONFIG_ESP_TASK_WDT_CHECK_IDLE_TASK_CPU1=n` (было y)

2. **firmware/nodes/ph_node/main/ph_node_tasks.c**
   - Удалены проверки `< 0` для беззнаковых типов в `task_sensors`
   - Удалены проверки `< 0` для беззнаковых типов в `task_pump_current`
   - Удалены проверки `< 0` для беззнаковых типов в `task_status`

3. **firmware/nodes/ph_node/main/ph_node_handlers.c**
   - Удалены проверки `< 0` для беззнаковых типов в `task_command_processor`

4. **firmware/nodes/common/components/heartbeat_task/heartbeat_task.c**
   - Удалены проверки `< 0` для беззнаковых типов в `task_heartbeat`

5. **firmware/nodes/ph_node/sdkconfig.defaults**
   - Добавлена конфигурация watchdog (для будущих сборок)

## Конфигурация watchdog

### Текущая конфигурация:
- **Таймаут:** 10 секунд (согласно DEVICE_NODE_PROTOCOL.md)
- **Проверка idle задач:** Отключена (для обоих CPU)
- **Panic при срабатывании:** Включен

### Использование в задачах:

| Задача | Интервал работы | Интервал сброса WDT | Статус |
|--------|----------------|---------------------|--------|
| `task_sensors` | 3 сек | 2 сек | ✓ |
| `task_pump_current` | 5 сек | 3 сек | ✓ |
| `task_status` | 60 сек | 5 сек | ✓ |
| `task_command_processor` | По команде | 3 сек | ✓ |
| `heartbeat_task` | 15 сек | 5 сек | ✓ |

## Рекомендации

1. ✅ **Все задачи правильно используют watchdog** - все задачи регистрируются и периодически сбрасывают watchdog
2. ✅ **Конфигурация согласована** - таймаут 10 секунд установлен везде
3. ✅ **Idle задачи не проверяются** - это предотвращает ложные срабатывания
4. ✅ **Нет предупреждений компилятора** - все проверки беззнаковых типов исправлены

## Тестирование

После исправлений необходимо:
1. Пересобрать проект: `idf.py build`
2. Прошить устройство: `idf.py -p /dev/ttyUSB0 flash`
3. Запустить монитор и проверить отсутствие ошибок watchdog

## Статус

✅ **Все проблемы исправлены**
✅ **Код готов к компиляции без предупреждений**
✅ **Watchdog правильно настроен и используется**

