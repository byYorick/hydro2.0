## План: фиксы E2E тестов (full suite)

Цель: привести полный `--suite full` к зелёному статусу в контейнере `e2e-runner`,
добавив новые API, миграции, поддержку `wait_until` в runner и фиксы chaos/WS ACK.

### 1) Контекст и источники истины
- ⏳ Проверить локальные `AGENTS.md` в подкаталогах, которые затронем.
- ⏳ Открыть ключевые документы слоёв (по факту правок):
  - `doc_ai/04_BACKEND_CORE`
  - `doc_ai/05_DATA_AND_STORAGE`
  - `doc_ai/03_TRANSPORT_MQTT`

### 2) Диагностика падений
- ⏳ Снять свежий отчёт `tests/e2e/reports/summary.json` и логи `e2e-runner`.
- ⏳ Классифицировать падения по типам:
  - отсутствующие API/эндпоинты;
  - несоответствие схемы БД (нет полей/таблиц);
  - ошибки раннера (неизвестные action, fault-inject, WS);
  - нестабильность WS/MQTT событий.

### 3) Новые API и миграции
- ⏳ Добавить недостающие API для grow cycle targets, restart/abort, scheduler (irrigation/water-change).
- ⏳ Добавить/исправить миграции и модели (поля в `grow_cycles`, таблицы для effective targets и т.п.).
- ⏳ Обновить документацию БД в `doc_ai/05_DATA_AND_STORAGE/DATA_MODEL_REFERENCE.md`.

### 4) Синхронизация API и БД с тестами
- ⏳ Подтвердить, какие сценарии относятся к недореализованным фичам.
- ⏳ Для обязательных фич:
  - добавить/исправить API эндпоинты;
  - обновить миграции/модели;
  - обновить `doc_ai/05_DATA_AND_STORAGE/DATA_MODEL_REFERENCE.md`.
- ⏳ Для неактуальных тестов:
  - обновить сценарии под текущие API;
  - либо вынести в `chaos/experimental` и исключить из `full` при необходимости.

### 5) Исправления раннера
- ⏳ Реализовать поддержку `wait_until`.
- ⏳ Исправить fault-inject (pause/unpause) для CHAOS сценариев.
- ⏳ Уточнить обработку WS событий (ACK/FAILED) и таймауты.

### 6) Инфраструктура тестов
- ⏳ Проверить сидирование (plants/recipes/zones/grow_cycles) для всех сценариев.
- ⏳ Обеспечить идемпотентность сидеров для E2E.
- ⏳ Вычистить артефакты отчётов и стандартизировать `reports/`.

### 7) Прогон и стабилизация
- ⏳ Прогон `runner.suite --suite full` внутри контейнера.
- ⏳ Фиксы по каждому оставшемуся падению до 0 ошибок.
- ⏳ Финальная фиксация результатов (summary + лог).

### 8) Документация
- ⏳ Обновить `plan_sim.md` (если есть влияние на симуляцию).
- ⏳ Зафиксировать изменения API/БД в `doc_ai/` по правилам.
