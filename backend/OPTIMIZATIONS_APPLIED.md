# Оптимизации для улучшения производительности при 1000+ нодах

**Дата:** 2025-12-08  
**Проблема:** При нагрузке 1000 нод наблюдались:
- Большая очередь (2,084 элементов)
- Потери данных (4.9%)
- Throughput не масштабировался линейно

## Примененные оптимизации

### 1. Увеличен размер очереди Redis

**Было:** `MAX_QUEUE_SIZE = 10000`  
**Стало:** `MAX_QUEUE_SIZE = 50000`

**Эффект:** Система может буферизовать больше данных при пиковых нагрузках

### 2. Уменьшена агрессивность backpressure

**Было:** Backpressure начинался при 90% заполнения, пропускалось 50% сообщений  
**Стало:** Backpressure начинается при 95% заполнения, пропускается только 20% сообщений

**Эффект:** Меньше потерь данных при высокой нагрузке

### 3. Увеличен размер батча обработки

**Было:** `telemetry_batch_size = 200`  
**Стало:** `telemetry_batch_size = 1000`

**Эффект:** Более эффективная обработка данных, меньше запросов к БД

### 4. Уменьшен интервал flush

**Было:** `telemetry_flush_ms = 500` (500ms)  
**Стало:** `telemetry_flush_ms = 200` (200ms)

**Эффект:** Более быстрая обработка данных, меньше задержка

### 5. Уменьшен интервал проверки очереди

**Было:** `queue_check_interval_sec = 0.1` (100ms)  
**Стало:** `queue_check_interval_sec = 0.05` (50ms)

**Эффект:** Более быстрая реакция на новые данные в очереди

## Ожидаемые результаты

После оптимизаций ожидается:
- Уменьшение размера очереди при той же нагрузке
- Снижение потерь данных с 4.9% до <2%
- Улучшение throughput до 400+ samples/сек
- Более стабильная работа при 1000+ нодах

## Файлы изменены

1. `backend/services/common/redis_queue.py`
   - Увеличен `MAX_QUEUE_SIZE` до 50000
   - Оптимизирован backpressure (95% вместо 90%)

2. `backend/services/common/env.py`
   - Увеличен `telemetry_batch_size` до 1000
   - Уменьшен `telemetry_flush_ms` до 200
   - Уменьшен `queue_check_interval_sec` до 0.05

