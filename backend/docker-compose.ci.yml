services:
  mqtt:
    image: eclipse-mosquitto:2
    volumes:
      - ./services/mqtt-bridge/mosquitto.dev.conf:/mosquitto/config/mosquitto.conf:ro
      - ./services/mqtt-bridge/passwords:/mosquitto/config/passwords:ro
      - ./services/mqtt-bridge/acl:/mosquitto/config/acl:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    networks:
      - ci_network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 1883 || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  db:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_DB: hydro_test
      POSTGRES_USER: hydro
      POSTGRES_PASSWORD: hydro
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ci_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hydro -d hydro_test"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis:
    image: redis:7-alpine
    networks:
      - ci_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  laravel-ci:
    build:
      context: ./laravel
      dockerfile: Dockerfile
      args:
        INSTALL_DEV_DEPS: "true"
        SKIP_FRONTEND_BUILD: "true"
    working_dir: /app
    environment:
      - APP_ENV=testing
      - APP_DEBUG=false
      - SESSION_DRIVER=array
      - CACHE_STORE=array
      - QUEUE_CONNECTION=sync
      - BROADCAST_CONNECTION=reverb
      - LOG_CHANNEL=stderr
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=hydro_test
      - DB_USERNAME=hydro
      - DB_PASSWORD=hydro
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REVERB_APP_ID=app
      - REVERB_APP_KEY=test-key
      - REVERB_APP_SECRET=test-secret
      - REVERB_SERVER_HOST=0.0.0.0
      - REVERB_SERVER_PORT=6001
      - REVERB_HOST=localhost
      - REVERB_PORT=6001
      - REVERB_SCHEME=http
      - REVERB_DEBUG=false
      - REVERB_AUTO_START=true
      - REVERB_VERBOSE=false
      - PY_API_TOKEN=test-token-12345
      - PY_INGEST_TOKEN=test-token-12345
      - LARAVEL_API_TOKEN=test-token-12345
      - MQTT_HOST=mqtt
      - MQTT_PORT=1883
    volumes:
      - ./laravel:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    networks:
      - ci_network
    command: >
      bash -c "
        set -e
        echo '=== CI Pipeline Started ==='
        echo '1. Copying .env...'
        cp .env.example .env
        php artisan key:generate --no-interaction
        echo '2. Installing PHP dependencies...'
        composer install --no-interaction --prefer-dist --optimize-autoloader
        echo '3. Installing Node dependencies...'
        npm ci --legacy-peer-deps
        echo '4. Building frontend...'
        npm run build
        echo '5. Configuring PHP...'
        php artisan config:clear
        php artisan cache:clear
        php artisan config:cache
        echo '6. Running PHP tests...'
        mkdir -p test-results
        php artisan test --testsuite=Unit,Feature --no-coverage --log-junit test-results/phpunit.xml || (echo 'PHP tests failed' && exit 1)
        echo '7. Running TypeScript typecheck...'
        npm run typecheck || (echo 'TypeScript check failed' && exit 1)
        echo '8. Running ESLint...'
        npm run lint || (echo 'ESLint failed' && exit 1)
        echo '9. Running Vitest unit tests...'
        npm run test -- --reporter=dot --reporter=junit --outputFile=test-results/junit.xml || (echo 'Vitest failed' && exit 1)
        echo '10. Running Vitest coverage...'
        npm run test -- --coverage --reporter=dot || (echo 'Vitest coverage failed' && exit 1)
        echo '=== CI Pipeline Completed Successfully ==='
      "

networks:
  ci_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
  mqtt_data:
  mqtt_logs:
