# Исправления цепочки состояния БД → MQTT → WebSocket → UI

## Проблема

Обнаружены проблемы в цепочке состояния системы:
```
БД → MQTT → WebSocket → UI
⚠ Обнаружены проблемы в цепочке состояния
```

## Выполненные исправления

### 1. Улучшена диагностика проблем в SystemMonitoringModal.vue

**Изменения:**
- Добавлена детальная категоризация проблем (критические ❌ и предупреждения ⚠️)
- Улучшено отображение статуса цепочки с детальными сообщениями
- Добавлен `chainStatus` computed для общего статуса цепочки
- Улучшено форматирование списка проблем

**Файл:**
- `backend/laravel/resources/js/Components/SystemMonitoringModal.vue`

**Результат:**
- Теперь система четко различает критические проблемы и предупреждения
- Более информативные сообщения о проблемах в цепочке

### 2. Улучшена обработка ошибок в useSystemStatus.ts

**Изменения:**
- Добавлено логирование ошибок для диагностики
- Улучшена обработка ошибок - не сбрасываем уже установленные статусы
- Сохраняем последние известные значения статусов при ошибках проверки
- Добавлена детальная информация об ошибках в логи

**Файл:**
- `backend/laravel/resources/js/composables/useSystemStatus.ts`

**Результат:**
- Более надежная обработка ошибок проверки здоровья
- Лучшая диагностика проблем через логи
- Сохранение последних известных статусов при временных ошибках

### 3. Улучшен SystemController::health()

**Изменения:**
- Добавлено логирование ошибок БД для диагностики
- Добавлен общий статус системы (`ok` / `degraded`)
- Добавлена информация о цепочке состояния в ответе
- Добавлены метаданные для диагностики (только в dev режиме)
- Улучшена категоризация критических и некритических проблем

**Файл:**
- `backend/laravel/app/Http/Controllers/SystemController.php`

**Результат:**
- Более информативный ответ health check
- Детальная диагностика проблем
- Метаданные для отладки в dev режиме

## Структура ответа health check

```json
{
  "status": "ok" | "degraded" | "fail",
  "data": {
    "app": "ok",
    "db": "ok" | "fail",
    "mqtt": "ok" | "fail" | "unknown",
    "history_logger": "ok" | "fail" | "unknown",
    "automation_engine": "ok" | "fail" | "unknown",
    "chain": {
      "db": "ok" | "fail",
      "mqtt": "ok" | "fail" | "unknown",
      "websocket": "unknown",
      "ui": "ok"
    }
  },
  "meta": {
    "timestamp": "2024-01-01T00:00:00Z",
    "db_error": "Connection refused",
    "checks": {
      "db_timeout": "2s",
      "mqtt_timeout": "2s",
      "history_logger_timeout": "3s",
      "automation_engine_timeout": "2s"
    }
  }
}
```

## Категории проблем

### Критические проблемы (❌)
- Блокируют работу системы
- Требуют немедленного внимания
- Примеры:
  - БД недоступна (`db: fail`)
  - MQTT брокер недоступен (`mqtt: offline`)
  - WebSocket соединение разорвано (`ws: disconnected`)

### Предупреждения (⚠️)
- Система работает, но может работать неоптимально
- Требуют мониторинга
- Примеры:
  - Статус неизвестен (`unknown`)
  - Сервис работает в деградированном режиме (`degraded`)

## Цепочка состояния

Цепочка состояния отслеживается в следующем порядке:
1. **БД** - база данных PostgreSQL
2. **MQTT** - MQTT брокер и bridge
3. **WebSocket** - WebSocket соединение (проверяется на клиенте)
4. **UI** - пользовательский интерфейс

### Логика определения проблем

- Цепочка считается здоровой, если нет критических проблем
- Предупреждения не блокируют работу системы
- `unknown` статус означает, что проверка еще не завершена

## Следующие шаги

1. **Мониторинг** - отслеживать логи и метрики цепочки состояния
2. **Автоматическое восстановление** - добавить автоматическое восстановление при критических проблемах
3. **Уведомления** - настроить уведомления при критических проблемах
4. **Метрики** - добавить метрики производительности цепочки состояния

---

**Статус:** ✅ Исправления применены

**Результат:** Улучшена диагностика и обработка проблем в цепочке состояния

