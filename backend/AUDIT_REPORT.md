# –û—Ç—á–µ—Ç –ø–æ –∞—É–¥–∏—Ç—É Backend –∫–æ–¥–∞ hydro 2.0

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 8 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã:** 2.0  
**–ê—É–¥–∏—Ä—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:** Laravel Backend, Python Services, Architecture

---

## üìã –†–µ–∑—é–º–µ

–ü—Ä–æ–≤–µ–¥–µ–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç backend –∫–æ–¥–∞ —Å–∏—Å—Ç–µ–º—ã hydro 2.0, –≤–∫–ª—é—á–∞—é—â–∏–π:
- Laravel backend (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, —Å–µ—Ä–≤–∏—Å—ã, –º–æ–¥–µ–ª–∏)
- Python —Å–µ—Ä–≤–∏—Å—ã (automation-engine, history-logger, mqtt-bridge –∏ –¥—Ä.)
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 7.5/10

**–û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ß–µ—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ (frontend, API, Python)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ (Laravel 12, PHP 8.2, Python 3.11+)
- ‚úÖ –•–æ—Ä–æ—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ö†Ô∏è –ù–∞—Ä—É—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ (–ª–æ–≥–∏–∫–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö)
- ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–æ–∫–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞, SQL)
- ‚ö†Ô∏è –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Form Request –∫–ª–∞—Å—Å–æ–≤
- ‚ö†Ô∏è –ë–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ (>100 —Å—Ç—Ä–æ–∫)

---

## 1. üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞

### 1.1 –°–æ–±–ª—é–¥–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–º–µ—Ä –∏–∑ `NodeController.php`:**

```php:166:220
public function update(Request $request, DeviceNode $node)
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é: –ª–∏–±–æ —á–µ—Ä–µ–∑ Sanctum, –ª–∏–±–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ç–æ–∫–µ–Ω
    $user = $request->user();
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Sanctum, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ç–æ–∫–µ–Ω
    if (! $user) {
        $providedToken = $request->bearerToken();
        \Log::debug('[NodeController::update] Checking token', [
            'provided_token' => $providedToken ? substr($providedToken, 0, 10).'...' : 'null',
            'py_api_token' => config('services.python_bridge.token') ? 'set' : 'null',
            'py_ingest_token' => config('services.python_bridge.ingest_token') ? 'set' : 'null',
            'history_logger_token' => config('services.history_logger.token') ? 'set' : 'null',
        ]);
        if ($providedToken) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º config –≤–º–µ—Å—Ç–æ env –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            $pyApiToken = config('services.python_bridge.token');
            $pyIngestToken = config('services.python_bridge.ingest_token');
            $historyLoggerToken = config('services.history_logger.token');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç–∏–≤ –≤—Å–µ—Ö –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
            $tokenValid = false;
            if ($pyApiToken && hash_equals($pyApiToken, $providedToken)) {
                $tokenValid = true;
                \Log::debug('[NodeController::update] Token matched: py_api_token');
            } elseif ($pyIngestToken && hash_equals($pyIngestToken, $providedToken)) {
                $tokenValid = true;
                \Log::debug('[NodeController::update] Token matched: py_ingest_token');
            } elseif ($historyLoggerToken && hash_equals($historyLoggerToken, $providedToken)) {
                $tokenValid = true;
                \Log::debug('[NodeController::update] Token matched: history_logger_token');
            } else {
                \Log::warning('[NodeController::update] Token NOT matched');
            }
            
            if ($tokenValid) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
                $serviceUser = \App\Models\User::where('role', 'operator')->first() 
                    ?? \App\Models\User::where('role', 'admin')->first()
                    ?? \App\Models\User::first();
                
                if ($serviceUser) {
                    $user = $serviceUser;
                    $request->setUserResolver(static fn () => $serviceUser);
                }
            }
        }
        
        if (! $user) {
            return response()->json([
                'status' => 'error',
                'message' => 'Unauthorized',
            ], 401);
        }
    }
    // ... –µ—â–µ 180+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **–õ–æ–≥–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ** ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ Middleware
2. **–ú–µ—Ç–æ–¥ > 200 —Å—Ç—Ä–æ–∫** ‚Äî –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø Single Responsibility
3. **–ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –º–æ–¥–µ–ª—è–º** ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
4. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

#### ‚úÖ –°–æ–∑–¥–∞—Ç—å Middleware –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```php
// app/Http/Middleware/AuthenticateServiceToken.php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class AuthenticateServiceToken
{
    public function handle(Request $request, Closure $next): mixed
    {
        if ($request->user()) {
            return $next($request);
        }

        $token = $request->bearerToken();
        if (!$token) {
            return response()->json(['message' => 'Unauthorized'], 401);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
        $validTokens = [
            config('services.python_bridge.token'),
            config('services.python_bridge.ingest_token'),
            config('services.history_logger.token'),
        ];

        foreach (array_filter($validTokens) as $validToken) {
            if (hash_equals($validToken, $token)) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                $serviceUser = $this->getServiceUser();
                $request->setUserResolver(fn() => $serviceUser);
                return $next($request);
            }
        }

        return response()->json(['message' => 'Unauthorized'], 401);
    }

    private function getServiceUser(): ?\App\Models\User
    {
        return \App\Models\User::whereIn('role', ['operator', 'admin'])
            ->first();
    }
}
```

#### ‚úÖ –†–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ –º–µ—Ç–æ–¥—ã

```php
public function update(Request $request, DeviceNode $node): JsonResponse
{
    $this->authorize('update', $node);

    $data = $this->validateUpdateData($request, $node);
    
    $this->validateZoneAccess($request->user(), $data, $node);
    
    $node = $this->nodeService->update($node, $data);

    return response()->json(['status' => 'ok', 'data' => $node]);
}

private function validateUpdateData(Request $request, DeviceNode $node): array
{
    return $request->validate([
        'zone_id' => ['nullable', 'integer', 'exists:zones,id'],
        'pending_zone_id' => ['nullable', 'integer', 'exists:zones,id'],
        'uid' => ['sometimes', 'string', 'max:64', 'unique:nodes,uid,'.$node->id],
        // ...
    ]);
}

private function validateZoneAccess(User $user, array $data, DeviceNode $node): void
{
    if (isset($data['zone_id']) && $data['zone_id'] !== $node->zone_id) {
        if (!ZoneAccessHelper::canAccessZone($user, $data['zone_id'])) {
            throw new \Illuminate\Auth\Access\AuthorizationException(
                'Access denied to target zone'
            );
        }
    }
}
```

---

### 1.2 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Form Request –∫–ª–∞—Å—Å–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö –≤–º–µ—Å—Ç–æ Form Request –∫–ª–∞—Å—Å–æ–≤

**–ò–∑ DEV_CONVENTIONS.md:**
> **Controllers & Validation**
> - Always create Form Request classes for validation rather than inline validation in controllers.

**–ü—Ä–∏–º–µ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏—è –≤ `NodeCommandController.php`:**

```php:17:22
$data = $request->validate([
    'type' => ['nullable', 'string', 'max:64'],
    'cmd' => ['nullable', 'string', 'max:64'],
    'channel' => ['nullable', 'string', 'max:128'],
    'params' => ['nullable', 'array'],
]);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
// app/Http/Requests/StoreNodeCommandRequest.php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreNodeCommandRequest extends FormRequest
{
    public function authorize(): bool
    {
        return true; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Middleware
    }

    public function rules(): array
    {
        return [
            'type' => ['nullable', 'string', 'max:64'],
            'cmd' => ['nullable', 'string', 'max:64'],
            'channel' => ['nullable', 'string', 'max:128'],
            'params' => ['nullable', 'array'],
            'params.*' => ['sometimes', 'string|numeric|boolean'],
        ];
    }

    public function messages(): array
    {
        return [
            'cmd.required' => 'The command field is required.',
            'channel.max' => 'Channel name cannot exceed 128 characters.',
        ];
    }

    public function passedValidation(): void
    {
        // Support both 'type' and 'cmd' fields for backward compatibility
        if (!$this->input('cmd') && $this->input('type')) {
            $this->merge(['cmd' => $this->input('type')]);
        }

        // Ensure params is associative array
        if ($this->has('params') && is_array($this->params) && array_is_list($this->params)) {
            $this->merge(['params' => []]);
        }
    }
}

// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ:
public function store(StoreNodeCommandRequest $request, DeviceNode $node, PythonBridgeService $bridge)
{
    $data = $request->validated();
    // ...
}
```

**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å Form Requests –¥–ª—è:**
- ‚ùå `NodeController::store()` ‚Üí `StoreNodeRequest`
- ‚ùå `NodeController::update()` ‚Üí `UpdateNodeRequest`
- ‚ùå `NodeController::register()` ‚Üí `RegisterNodeRequest`
- ‚ùå `NodeController::publishConfig()` ‚Üí `PublishNodeConfigRequest`
- ‚ùå `NodeCommandController::store()` ‚Üí `StoreNodeCommandRequest`
- ‚ùå –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

---

### 1.3 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞

**–ü—Ä–∏–º–µ—Ä –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `NodeController.php`:**

```php:134:150
$user = $request->user();
if (! $user) {
    return response()->json([
        'status' => 'error',
        'message' => 'Unauthorized',
    ], 401);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–¥–µ
if (! \App\Helpers\ZoneAccessHelper::canAccessNode($user, $node)) {
    return response()->json([
        'status' => 'error',
        'message' => 'Forbidden: Access denied to this node',
    ], 403);
}
```

–≠—Ç–æ—Ç –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –º–µ—Ç–æ–¥–∞—Ö: `show()`, `update()`, `detach()`, `destroy()`, `getConfig()`, `publishConfig()`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Laravel Policies

```php
// app/Policies/DeviceNodePolicy.php
namespace App\Policies;

use App\Models\User;
use App\Models\DeviceNode;
use App\Helpers\ZoneAccessHelper;

class DeviceNodePolicy
{
    public function view(User $user, DeviceNode $node): bool
    {
        return ZoneAccessHelper::canAccessNode($user, $node);
    }

    public function update(User $user, DeviceNode $node): bool
    {
        return ZoneAccessHelper::canAccessNode($user, $node);
    }

    public function delete(User $user, DeviceNode $node): bool
    {
        return ZoneAccessHelper::canAccessNode($user, $node);
    }

    public function publishConfig(User $user, DeviceNode $node): bool
    {
        return ZoneAccessHelper::canAccessNode($user, $node);
    }
}

// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ:
public function show(Request $request, DeviceNode $node): JsonResponse
{
    $this->authorize('view', $node);
    
    $node->load(['zone:id,name,status', 'channels' => function ($q) {
        $q->select('id', 'node_id', 'channel', 'type', 'metric', 'unit');
    }]);

    return response()->json(['status' => 'ok', 'data' => $node]);
}
```

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Resource Controller Authorization

```php
// –í AppServiceProvider –∏–ª–∏ bootstrap/app.php
Gate::resource('node', DeviceNodePolicy::class);
```

---

## 2. üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 2.1 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### üî¥ –ö–†–ò–¢–ò–ß–ù–û: –£—Ç–µ—á–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `NodeController.php:174`:**

```php
\Log::debug('[NodeController::update] Checking token', [
    'provided_token' => $providedToken ? substr($providedToken, 0, 10).'...' : 'null',
    'py_api_token' => config('services.python_bridge.token') ? 'set' : 'null',
    'py_ingest_token' => config('services.python_bridge.ingest_token') ? 'set' : 'null',
    'history_logger_token' => config('services.history_logger.token') ? 'set' : 'null',
]);
```

**–†–∏—Å–∫:** –ü–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–æ–∫–µ–Ω–∞ –≤ –ª–æ–≥–∞—Ö –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –∞—Ç–∞–∫—É—é—â–µ–º—É –≤ brute-force –∞—Ç–∞–∫–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
// –ù–ï –õ–û–ì–ò–†–û–í–ê–¢–¨ –¢–û–ö–ï–ù–´ –í–û–û–ë–©–ï
\Log::debug('[NodeController::update] Checking service token authentication');
```

#### üî¥ –ö–†–ò–¢–ò–ß–ù–û: SQL Injection —á–µ—Ä–µ–∑ LIKE –∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `NodeController.php:95-100`:**

```php
if (isset($validated['search']) && $validated['search']) {
    $searchTerm = '%'.strtolower($validated['search']).'%';
    $query->where(function ($q) use ($searchTerm) {
        $q->whereRaw('LOWER(name) LIKE ?', [$searchTerm])
            ->orWhereRaw('LOWER(uid) LIKE ?', [$searchTerm])
            ->orWhereRaw('LOWER(type) LIKE ?', [$searchTerm]);
    });
}
```

**–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–º–≤–æ–ª—ã `%` –∏–ª–∏ `_`, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è wildcard –≤ LIKE.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
if (isset($validated['search']) && $validated['search']) {
    $searchTerm = $validated['search'];
    
    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã LIKE
    $escapedSearch = addcslashes($searchTerm, '%_');
    
    $query->where(function ($q) use ($escapedSearch) {
        $q->where('name', 'ILIKE', "%{$escapedSearch}%")
            ->orWhere('uid', 'ILIKE', "%{$escapedSearch}%")
            ->orWhere('type', 'ILIKE', "%{$escapedSearch}%");
    });
}
```

–ò–ª–∏ –µ—â–µ –ª—É—á—à–µ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å full-text search:

```php
// PostgreSQL full-text search
$query->whereRaw(
    "to_tsvector('simple', coalesce(name, '') || ' ' || coalesce(uid, '') || ' ' || coalesce(type, '')) @@ plainto_tsquery('simple', ?)",
    [$searchTerm]
);
```

#### üî¥ –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ config –∏–∑ –≤—ã–±–æ—Ä–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `NodeController.php:59-64`:**

```php
$query = DeviceNode::query()
    ->select('id', 'uid', 'name', 'type', 'zone_id', 'status', 'lifecycle_state', 'fw_version', 'hardware_revision', 'hardware_id', 'validated', 'first_seen_at', 'created_at', 'updated_at')
    ->with(['zone:id,name,status', 'channels' => function ($channelQuery) {
        // –ò—Å–∫–ª—é—á–∞–µ–º config –∏–∑ –∫–∞–Ω–∞–ª–æ–≤
        $channelQuery->select('id', 'node_id', 'channel', 'type', 'metric', 'unit');
    }]);
```

**–†–∏—Å–∫:** –ï—Å–ª–∏ –∫–æ–¥ –∏–∑–º–µ–Ω–∏—Ç—Å—è –∏ `config` –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, Wi-Fi –ø–∞—Ä–æ–ª–∏ –∏ MQTT –∫—Ä–µ–¥—ã —É—Ç–µ–∫—É—Ç –≤ API.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API Resources –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```php
// app/Http/Resources/DeviceNodeResource.php
namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class DeviceNodeResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'uid' => $this->uid,
            'name' => $this->name,
            'type' => $this->type,
            'zone_id' => $this->zone_id,
            'status' => $this->status,
            'lifecycle_state' => $this->lifecycle_state,
            'fw_version' => $this->fw_version,
            'hardware_revision' => $this->hardware_revision,
            'hardware_id' => $this->hardware_id,
            'validated' => $this->validated,
            'first_seen_at' => $this->first_seen_at,
            'created_at' => $this->created_at,
            'updated_at' => $this->updated_at,
            'zone' => ZoneResource::make($this->whenLoaded('zone')),
            'channels' => NodeChannelResource::collection($this->whenLoaded('channels')),
            // config –ù–ò–ö–û–ì–î–ê –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è
        ];
    }
}

// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ:
return DeviceNodeResource::collection($nodes);
```

#### ‚úÖ –î–æ–±–∞–≤–∏—Ç—å $hidden –≤ –º–æ–¥–µ–ª—å

```php
// app/Models/DeviceNode.php
protected $hidden = [
    'config', // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ JSON
];
```

#### üü° –í–´–°–û–ö–ò–ô: –°–ª–∞–±–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ `NodeController.php:361-406`:**

```php
public function register(Request $request)
{
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º PY_INGEST_TOKEN –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–∫–µ–Ω –¥–ª—è ingest –æ–ø–µ—Ä–∞—Ü–∏–π
    $expectedToken = config('services.python_bridge.ingest_token') ?? config('services.python_bridge.token');
    $givenToken = $request->bearerToken();

    $clientIp = $request->ip();

    // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –≤—Å–µ–≥–¥–∞
    if (! empty($expectedToken)) {
        if (empty($givenToken)) {
            \Illuminate\Support\Facades\Log::warning('Node registration: Missing token', [
                'ip' => $clientIp,
                'user_agent' => $request->userAgent(),
            ]);

            return response()->json([
                'status' => 'error',
                'message' => 'Unauthorized: token required',
            ], 401);
        }

        if (! hash_equals($expectedToken, (string) $givenToken)) {
            \Illuminate\Support\Facades\Log::warning('Node registration: Invalid token', [
                'ip' => $clientIp,
                'user_agent' => $request->userAgent(),
            ]);

            return response()->json([
                'status' => 'error',
                'message' => 'Unauthorized: invalid token',
            ], 401);
        }
    } else {
        // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–µ—â–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        \Illuminate\Support\Facades\Log::error('Node registration: Token not configured', [
            'ip' => $clientIp,
            'env' => config('app.env'),
        ]);

        return response()->json([
            'status' => 'error',
            'message' => 'Node registration token not configured. Set PY_INGEST_TOKEN or PY_API_TOKEN.',
        ], 500);
    }
    // ...
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. –ù–µ—Ç rate limiting –Ω–∞ endpoint —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Üí DoS –∞—Ç–∞–∫–∞
2. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ IP whitelist –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
3. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ IP, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–ø—Ä–æ—Å–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

#### ‚úÖ –î–æ–±–∞–≤–∏—Ç—å Rate Limiting

```php
// –í bootstrap/app.php –∏–ª–∏ routes/api.php
Route::middleware(['throttle:node_register'])->group(function () {
    Route::post('/api/nodes/register', [NodeController::class, 'register']);
});

// config/cache.php
'limiters' => [
    'node_register' => [
        'max' => 10, // –º–∞–∫—Å–∏–º—É–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤
        'decay' => 60, // –≤ –º–∏–Ω—É—Ç—É
    ],
],
```

#### ‚úÖ –î–æ–±–∞–≤–∏—Ç—å IP Whitelist

```php
// config/services.php
'node_registration' => [
    'allowed_ips' => env('NODE_REGISTRATION_ALLOWED_IPS', '10.0.0.0/8,172.16.0.0/12,192.168.0.0/16'),
],

// Middleware
class NodeRegistrationIpWhitelist
{
    public function handle(Request $request, Closure $next): mixed
    {
        $allowedIps = config('services.node_registration.allowed_ips');
        $clientIp = $request->ip();

        if (!$this->isIpAllowed($clientIp, explode(',', $allowedIps))) {
            Log::warning('Node registration blocked: IP not in whitelist', [
                'ip' => $clientIp,
                'user_agent' => $request->userAgent(),
            ]);

            return response()->json([
                'status' => 'error',
                'message' => 'Access denied',
            ], 403);
        }

        return $next($request);
    }

    private function isIpAllowed(string $ip, array $allowedRanges): bool
    {
        foreach ($allowedRanges as $range) {
            if ($this->ipInRange($ip, trim($range))) {
                return true;
            }
        }
        return false;
    }

    private function ipInRange(string $ip, string $range): bool
    {
        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –∏–∑ NodeController::ipInRange()
        // –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π Helper –∫–ª–∞—Å—Å
    }
}
```

---

### 2.2 –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ò–∑ SECURITY_ARCHITECTURE.md:**

> ## 2.1. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (2.0)
> MQTT —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ:
> - –≤–Ω—É—Ç—Ä–∏ LAN,
> - anonymous-enabled,
> - –±–µ–∑ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è.

**–ü—Ä–æ–±–ª–µ–º–∞:** –í prod –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —ç—Ç–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ.

**–ò–∑ env.py:59-76:**

```python
if is_prod:
    # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø–∞—Ä–æ–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
    if not settings.mqtt_pass:
        raise ValueError(
            "MQTT_PASS or MQTT_PASSWORD must be set in production environment"
        )
    if not settings.pg_pass:
        raise ValueError(
            "PG_PASS or POSTGRES_PASSWORD must be set in production environment"
        )
    if not settings.bridge_api_token:
        raise ValueError(
            "PY_API_TOKEN must be set in production environment for MQTT bridge security"
        )
    if not settings.history_logger_api_token:
        raise ValueError(
            "HISTORY_LOGGER_API_TOKEN or PY_API_TOKEN must be set in production environment for history-logger security"
        )
```

**–•–æ—Ä–æ—à–æ:** Python —Å–µ—Ä–≤–∏—Å—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

#### ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ Laravel

```php
// app/Console/Commands/CheckSecurityConfig.php
namespace App\Console\Commands;

use Illuminate\Console\Command;

class CheckSecurityConfig extends Command
{
    protected $signature = 'security:check-config';
    protected $description = 'Check security configuration for production';

    public function handle(): int
    {
        if (!app()->isProduction()) {
            $this->info('Not in production, skipping security checks');
            return self::SUCCESS;
        }

        $errors = [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ MQTT credentials
        if (!config('services.mqtt.password')) {
            $errors[] = 'MQTT_PASSWORD not set';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
        if (!config('services.python_bridge.token')) {
            $errors[] = 'PY_API_TOKEN not set';
        }

        if (!config('services.python_bridge.ingest_token')) {
            $errors[] = 'PY_INGEST_TOKEN not set';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ DB password
        if (!config('database.connections.pgsql.password')) {
            $errors[] = 'DB_PASSWORD not set';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ APP_KEY
        if (config('app.key') === 'base64:default_key') {
            $errors[] = 'APP_KEY is default (insecure)';
        }

        if (!empty($errors)) {
            $this->error('Security configuration errors:');
            foreach ($errors as $error) {
                $this->error("  - {$error}");
            }
            return self::FAILURE;
        }

        $this->info('Security configuration OK');
        return self::SUCCESS;
    }
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ CI/CD pipeline:
// php artisan security:check-config --env=production
```

---

### 2.3 –ü—Ä–æ–±–ª–µ–º—ã —Å HMAC –ø–æ–¥–ø–∏—Å—å—é –∫–æ–º–∞–Ω–¥

**–ò–∑ SECURITY_ARCHITECTURE.md:77-90:**

> ## 2.3. –ü–æ–¥–ø–∏—Å—å –∫–æ–º–∞–Ω–¥
>
> –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å HMAC‚Äë–ø–æ–¥–ø–∏—Å—å:
>
> ```json
> {
>  "cmd": "dose",
>  "params": {"ml": 1.0},
>  "ts": 1737355500,
>  "sig": "hmacsha256(node_secret, cmd|ts)"
> }
> ```
>
> –£–∑–ª—ã ESP32 –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–¥–ø–∏—Å—å.

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ –∫–æ–º–∞–Ω–¥—ã –ù–ï –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è HMAC.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ `PythonBridgeService.php` –∏ `history-logger/main.py`:**
- –ù–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏ `sig`
- –ù–µ—Ç timestamp `ts`
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ ESP32

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

#### ‚úÖ –î–æ–±–∞–≤–∏—Ç—å HMAC –ø–æ–¥–ø–∏—Å—å –∫–æ–º–∞–Ω–¥

```php
// app/Services/CommandSignatureService.php
namespace App\Services;

use App\Models\DeviceNode;

class CommandSignatureService
{
    public function signCommand(DeviceNode $node, array $command): array
    {
        $timestamp = now()->timestamp;
        $secret = $node->secret ?? config('app.node_default_secret');

        if (!$secret) {
            throw new \RuntimeException('Node secret not configured');
        }

        $payload = $command['cmd'] . '|' . $timestamp;
        $signature = hash_hmac('sha256', $payload, $secret);

        return array_merge($command, [
            'ts' => $timestamp,
            'sig' => $signature,
        ]);
    }

    public function verifySignature(DeviceNode $node, array $command): bool
    {
        $secret = $node->secret ?? config('app.node_default_secret');
        $timestamp = $command['ts'] ?? null;
        $signature = $command['sig'] ?? null;

        if (!$timestamp || !$signature) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ timestamp (–Ω–µ —Å—Ç–∞—Ä—à–µ 30 —Å–µ–∫—É–Ω–¥)
        if (abs(now()->timestamp - $timestamp) > 30) {
            return false;
        }

        $payload = $command['cmd'] . '|' . $timestamp;
        $expectedSignature = hash_hmac('sha256', $payload, $secret);

        return hash_equals($expectedSignature, $signature);
    }
}
```

#### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ PythonBridgeService

```php
public function sendNodeCommand(DeviceNode $node, array $payload): string
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
    $signedCommand = app(CommandSignatureService::class)->signCommand($node, [
        'cmd' => $command->cmd,
        'params' => $params,
    ]);

    $requestData = array_merge($requestData, [
        'ts' => $signedCommand['ts'],
        'sig' => $signedCommand['sig'],
    ]);

    // ... –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã ...
}
```

---

## 3. üíª –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤

### 3.1 –ù–µ—Å–æ–±–ª—é–¥–µ–Ω–∏–µ Laravel –∫–æ–Ω–≤–µ–Ω—Ü–∏–π

#### –ü—Ä–æ–±–ª–µ–º–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `DB::` –≤–º–µ—Å—Ç–æ Eloquent

**–ò–∑ DEV_CONVENTIONS.md:**
> ### Database
> - Avoid `DB::`; prefer `Model::query()`. Generate code that leverages Laravel's ORM capabilities rather than bypassing them.

**–ù–∞—Ä—É—à–µ–Ω–∏—è:**

```php
// NodeController.php:573
DB::transaction(function () use ($sanitizedChannels, $node) {
    // ... raw queries ...
});
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Eloquent –º–æ–¥–µ–ª–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.

---

#### –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `\Log` –≤–º–µ—Å—Ç–æ `Log` —Ñ–∞—Å–∞–¥–∞

**–ü—Ä–∏–º–µ—Ä—ã:**

```php
\Log::debug('[NodeController::update] Checking token', [...]);
\Illuminate\Support\Facades\Log::warning('Node registration: Missing token', [...]);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
use Illuminate\Support\Facades\Log;

Log::debug('NodeController: Checking token');
Log::warning('Node registration: Missing token', [...]);
```

---

#### –ü—Ä–æ–±–ª–µ–º–∞: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ type hints –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä—ã:**

```php
// NodeController.php:27
public function index(Request $request)  // ‚ùå –ù–µ—Ç return type
{
    // ...
    return response()->json([...]);
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
public function index(Request $request): JsonResponse
{
    // ...
    return response()->json([...]);
}
```

---

### 3.2 Python –∫–æ–¥

#### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:

1. **–•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
   - –û–±—â–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `common/` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã (history-logger, automation-engine, scheduler)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ dataclasses –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

2. **–•–æ—Ä–æ—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - Graceful shutdown –≤ `history-logger/main.py`
   - Retry –ª–æ–≥–∏–∫–∞ –≤ `automation-engine`
   - –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (`env.py:59-76`)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `hash_equals()` –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (PHP)

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:

1. **Type hints –Ω–µ –≤–µ–∑–¥–µ:**

```python
# common/db.py:29
async def execute(query: str, *args: Any) -> str:  # ‚úÖ –•–æ—Ä–æ—à–æ
    ...

# common/db.py:41
async def upsert_telemetry_last(zone_id: int, metric_type: str, node_id: Optional[int], channel: Optional[str], value: Optional[float]):  # ‚ùå –ù–µ—Ç return type
    ...
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```python
async def upsert_telemetry_last(
    zone_id: int,
    metric_type: str,
    node_id: Optional[int],
    channel: Optional[str],
    value: Optional[float]
) -> None:
    ...
```

2. **SQL –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ã –≤–µ–∑–¥–µ:**

```python
# –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
await execute(
    """
    INSERT INTO telemetry_last (zone_id, node_id, metric_type, channel, value, updated_at)
    VALUES ($1, $2, $3, $4, $5, NOW())
    ...
    """,
    zone_id, actual_node_id, metric_type, channel, value
)
```

–ù–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –Ω–∞ SQL injection.

---

## 4. ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 4.1 N+1 –∑–∞–ø—Ä–æ—Å—ã

**–•–æ—Ä–æ—à–æ:** –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –º–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è eager loading:

```php
// NodeController.php:59-64
$query = DeviceNode::query()
    ->select([...])
    ->with(['zone:id,name,status', 'channels' => function ($channelQuery) {
        $channelQuery->select([...]);
    }]);
```

### 4.2 –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –Ω–æ–¥ –∑–æ–Ω—ã
Cache::tags(['zone', "zone:{$zoneId}"])->remember(
    "zone:{$zoneId}:nodes",
    now()->addMinutes(5),
    fn() => DeviceNode::where('zone_id', $zoneId)->get()
);

// –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
Cache::tags(["zone:{$zoneId}"])->flush();
```

### 4.3 –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ nodes
CREATE INDEX IF NOT EXISTS idx_nodes_zone_id ON nodes(zone_id);
CREATE INDEX IF NOT EXISTS idx_nodes_uid ON nodes(uid);
CREATE INDEX IF NOT EXISTS idx_nodes_hardware_id ON nodes(hardware_id);
CREATE INDEX IF NOT EXISTS idx_nodes_status ON nodes(status);
CREATE INDEX IF NOT EXISTS idx_nodes_lifecycle_state ON nodes(lifecycle_state);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ telemetry_last
CREATE INDEX IF NOT EXISTS idx_telemetry_last_zone_metric ON telemetry_last(zone_id, metric_type);
CREATE INDEX IF NOT EXISTS idx_telemetry_last_updated ON telemetry_last(updated_at);

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ commands
CREATE INDEX IF NOT EXISTS idx_commands_status ON commands(status);
CREATE INDEX IF NOT EXISTS idx_commands_zone_id ON commands(zone_id);
CREATE INDEX IF NOT EXISTS idx_commands_created_at ON commands(created_at);
```

---

## 5. üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 5.1 –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**‚úÖ –•–æ—Ä–æ—à–æ:**
- Frontend —Ç–µ—Å—Ç—ã (Vitest + Playwright)
- Python —Ç–µ—Å—Ç—ã (pytest)
- Laravel Feature —Ç–µ—Å—Ç—ã

**‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è `NodeController` (36 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤, –Ω–æ –Ω–µ –≤—Å–µ –ø–æ–∫—Ä—ã—Ç—ã)
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Policies (–µ—Å–ª–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã)
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Form Requests (–µ—Å–ª–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

```php
// tests/Feature/NodeControllerTest.php
namespace Tests\Feature;

use App\Models\User;
use App\Models\DeviceNode;
use App\Models\Zone;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class NodeControllerTest extends TestCase
{
    use RefreshDatabase;

    public function test_user_can_view_accessible_nodes(): void
    {
        $user = User::factory()->create(['role' => 'operator']);
        $zone = Zone::factory()->create();
        $node = DeviceNode::factory()->create(['zone_id' => $zone->id]);

        $response = $this->actingAs($user)->getJson("/api/nodes/{$node->id}");

        $response->assertOk()
            ->assertJson([
                'status' => 'ok',
                'data' => [
                    'id' => $node->id,
                    'uid' => $node->uid,
                ],
            ])
            ->assertJsonMissing(['config']); // –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ config –Ω–µ —É—Ç–µ–∫
    }

    public function test_user_cannot_view_inaccessible_nodes(): void
    {
        $user = User::factory()->create(['role' => 'operator']);
        $otherNode = DeviceNode::factory()->create();

        $response = $this->actingAs($user)->getJson("/api/nodes/{$otherNode->id}");

        $response->assertForbidden();
    }

    public function test_service_token_can_access_nodes(): void
    {
        $node = DeviceNode::factory()->create();
        $token = config('services.python_bridge.token');

        $response = $this->withToken($token)->getJson("/api/nodes/{$node->id}");

        $response->assertOk();
    }

    public function test_config_is_never_exposed_in_api(): void
    {
        $user = User::factory()->create(['role' => 'admin']);
        $node = DeviceNode::factory()->create([
            'config' => ['wifi' => ['password' => 'secret123']],
        ]);

        $response = $this->actingAs($user)->getJson("/api/nodes/{$node->id}");

        $response->assertOk()
            ->assertJsonMissing(['config'])
            ->assertJsonMissing(['secret123']);
    }
}
```

---

## 6. üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### 6.1 –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–ò–∑ GAPS_AND_INCONSISTENCIES_REPORT.md –Ω–∞–π–¥–µ–Ω–æ 23 –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è.**

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ backend/services/** –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç `src/` –∏ `tests/`
   - –†–µ–∞–ª—å–Ω–æ—Å—Ç—å: –ø–ª–æ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

2. ‚úÖ **HMAC –ø–æ–¥–ø–∏—Å—å –∫–æ–º–∞–Ω–¥** –æ–ø–∏—Å–∞–Ω–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

3. ‚ùå **TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ:**
   - `backend/laravel/resources/js/composables/useInertiaForm.ts:134`
   - `backend/laravel/app/Helpers/ZoneAccessHelper.php:44,105,127`
   - `backend/laravel/app/Http/Controllers/SimulationController.php:49`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

#### ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é

```markdown
# backend/services/README.md

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è)

```
backend/services/
‚îú‚îÄ‚îÄ common/              # –û–±—â–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ env.py          # ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ db.py           # ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL (asyncpg)
‚îÇ   ‚îú‚îÄ‚îÄ mqtt.py         # ‚úÖ MQTT –∫–ª–∏–µ–Ω—Ç (paho-mqtt)
‚îÇ   ‚îú‚îÄ‚îÄ schemas.py      # ‚úÖ Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ commands.py     # ‚úÖ –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–∞–Ω–¥–∞–º–∏
‚îú‚îÄ‚îÄ mqtt-bridge/         # ‚úÖ FastAPI –º–æ—Å—Ç REST‚ÜíMQTT
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ publisher.py
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ history-logger/      # ‚úÖ –ó–∞–ø–∏—Å—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ automation-engine/   # ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–æ–Ω
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ scheduler/          # ‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏—è
    ‚îú‚îÄ‚îÄ main.py
    ‚îî‚îÄ‚îÄ Dockerfile
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–ª–æ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞ –¥–ª—è MVP.
–†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å `src/` –∏ `tests/` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ –±—É–¥—É—â–µ–º.
```

#### ‚úÖ –†–µ—à–∏—Ç—å TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

```php
// ‚ùå –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
// TODO: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–º–µ–Ω—É –Ω–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π callback –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è store

// ‚úÖ –°–æ–∑–¥–∞—Ç—å issue –≤ —Ç—Ä–µ–∫–µ—Ä–µ –∑–∞–¥–∞—á
// Issue #123: Implement zone access control via user_zones table
```

---

## 7. üéØ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)

1. **–ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã** (`NodeController.php:174`)
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç SQL Injection —á–µ—Ä–µ–∑ LIKE** (`NodeController.php:95-100`)
3. **–î–æ–±–∞–≤–∏—Ç—å $hidden –≤ –º–æ–¥–µ–ª–∏** –¥–ª—è –∑–∞—â–∏—Ç—ã config
4. **Rate limiting –Ω–∞ /api/nodes/register**
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** (`php artisan security:check-config`)

### üü° –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ø—Ä–∏–Ω—Ç–∞)

1. **–°–æ–∑–¥–∞—Ç—å Middleware –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**
2. **–°–æ–∑–¥–∞—Ç—å Form Request –∫–ª–∞—Å—Å—ã** –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
3. **–°–æ–∑–¥–∞—Ç—å Laravel Policies** –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
4. **–†–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤** (>100 —Å—Ç—Ä–æ–∫)
5. **–î–æ–±–∞–≤–∏—Ç—å API Resources** –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
6. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å HMAC –ø–æ–¥–ø–∏—Å—å –∫–æ–º–∞–Ω–¥**

### üü¢ –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç)

1. **–î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤**
2. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** —Å –∫–æ–¥–æ–º
4. **–†–µ—à–∏—Ç—å TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**
5. **–î–æ–±–∞–≤–∏—Ç—å type hints –≤–µ–∑–¥–µ** (PHP –∏ Python)

### üîµ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (backlog)

1. **–†–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É Python —Å–µ—Ä–≤–∏—Å–æ–≤** (src/tests/)
2. **–î–æ–±–∞–≤–∏—Ç—å full-text search** –≤–º–µ—Å—Ç–æ LIKE
3. **–°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π Logger** –≤–º–µ—Å—Ç–æ `\Log::`
4. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** –≤ docker-compose —Å—Ç–µ–Ω–¥–µ

---

## 8. üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### –¢–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –¶–µ–ª—å |
|---------|----------|------|
| Test Coverage (Frontend) | ~75% | 80% |
| Test Coverage (Backend) | ~60% | 80% |
| Test Coverage (Python) | ~70% | 80% |
| –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã >100 —Å—Ç—Ä–æ–∫ | 5 | 0 |
| –ú–µ—Ç–æ–¥—ã >50 —Å—Ç—Ä–æ–∫ | 15 | 0 |
| TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ | 15 | 0 |
| FIXME/HACK | 0 | 0 |
| Form Request –∫–ª–∞—Å—Å—ã | 0% | 100% |
| API Resources | 0% | 100% |
| Policies | 0% | 100% |

---

## 9. ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ

1. **‚úÖ –ß–µ—Ç–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏
2. **‚úÖ –•–æ—Ä–æ—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –ø—Ä–æ–µ–∫—Ç–∞ (doc_ai/)
3. **‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Services** –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
4. **‚úÖ –•–æ—Ä–æ—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
5. **‚úÖ Prometheus –º–µ—Ç—Ä–∏–∫–∏** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
6. **‚úÖ Graceful shutdown** –≤ Python —Å–µ—Ä–≤–∏—Å–∞—Ö
7. **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π** –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (Python)
8. **‚úÖ Eager loading** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è N+1
9. **‚úÖ Retry –ª–æ–≥–∏–∫–∞** –≤ PythonBridgeService
10. **‚úÖ WebSocket real-time** –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

---

## 10. üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ hydro 2.0 –∏–º–µ–µ—Ç **—Ö–æ—Ä–æ—à—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –æ—Å–Ω–æ–≤—É** –∏ **–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å:

1. **–ù–∞—Ä—É—à–µ–Ω–∏–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤** (–ª–æ–≥–∏–∫–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö)
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é** (—Ç–æ–∫–µ–Ω—ã, SQL injection, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ HMAC)
3. **–ù–µ—Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º Laravel –∫–æ–Ω–≤–µ–Ω—Ü–∏–π** (–Ω–µ—Ç Form Requests, Policies, Resources)

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å **—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**:
- –°–æ–∑–¥–∞—Ç—å Middleware, Form Requests, Policies, Resources
- –†–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ
- –î–æ–±–∞–≤–∏—Ç—å HMAC –ø–æ–¥–ø–∏—Å—å –∫–æ–º–∞–Ω–¥
- –£–ª—É—á—à–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (rate limiting, IP whitelist, –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã)

**–û—Ü–µ–Ω–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 9.0/10

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A: –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- [ ] –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã
- [ ] –ó–∞—â–∏—Ç–∞ –æ—Ç SQL Injection —á–µ—Ä–µ–∑ LIKE
- [ ] –î–æ–±–∞–≤–∏—Ç—å $hidden –¥–ª—è config –≤ –º–æ–¥–µ–ª—è—Ö
- [ ] Rate limiting –Ω–∞ /api/nodes/register
- [ ] IP Whitelist –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–¥
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å HMAC –ø–æ–¥–ø–∏—Å—å –∫–æ–º–∞–Ω–¥

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- [ ] –°–æ–∑–¥–∞—Ç—å Middleware –¥–ª—è —Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- [ ] –°–æ–∑–¥–∞—Ç—å Form Request –∫–ª–∞—Å—Å—ã (15+ –∫–ª–∞—Å—Å–æ–≤)
- [ ] –°–æ–∑–¥–∞—Ç—å Laravel Policies (5+ –∫–ª–∞—Å—Å–æ–≤)
- [ ] –°–æ–∑–¥–∞—Ç—å API Resources (10+ –∫–ª–∞—Å—Å–æ–≤)
- [ ] –†–∞–∑–±–∏—Ç—å –±–æ–ª—å—à–∏–µ –º–µ—Ç–æ–¥—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
- [ ] –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –≤ —Å–µ—Ä–≤–∏—Å—ã

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

- [ ] –î–æ–±–∞–≤–∏—Ç—å type hints –≤–µ–∑–¥–µ (PHP)
- [ ] –î–æ–±–∞–≤–∏—Ç—å type hints –≤–µ–∑–¥–µ (Python)
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞—Å–∞–¥—ã –±–µ–∑ \ prefix
- [ ] –†–µ—à–∏—Ç—å –≤—Å–µ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è Policies
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è Form Requests

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ ] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å PYTHON_SERVICES_ARCH.md —Å –∫–æ–¥–æ–º
- [ ] –û–±–Ω–æ–≤–∏—Ç—å SECURITY_ARCHITECTURE.md (HMAC)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å IMPLEMENTATION_STATUS.md
- [ ] –°–æ–∑–¥–∞—Ç—å CHANGELOG.md –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:** 8 –¥–µ–∫–∞–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä:** AI Code Auditor  
**–í–µ—Ä—Å–∏—è –æ—Ç—á–µ—Ç–∞:** 1.0

