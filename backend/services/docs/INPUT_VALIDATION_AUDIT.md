# Input Validation Audit Report

**–î–∞—Ç–∞:** 2025-01-27  
**–ê—É–¥–∏—Ç–æ—Ä:** AI Assistant  
**–û–±–ª–∞—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏:** Laravel API –∏ Python —Å–µ—Ä–≤–∏—Å—ã

## –†–µ–∑—é–º–µ

‚úÖ **–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** –•–æ—Ä–æ—à–æ, –Ω–æ –µ—Å—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é, –Ω–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç, –≥–¥–µ –≤–∞–ª–∏–¥–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ª—É—á—à–µ–Ω–∞ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞.

## Laravel API

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `$request->validate()`**
   - –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é
   - –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
   - –ü—Ä–∏–º–µ—Ä—ã: `ZoneController`, `RecipeController`, `NodeController`

2. **FormRequest –∫–ª–∞—Å—Å—ã**
   - `ProfileUpdateRequest` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è
   - `LoginRequest` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–∞
   - –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FormRequest –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

3. **–ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã: `integer`, `string`, `numeric`, `array`
   - –ï—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è: `exists:table,column`
   - –ï—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: `min`, `max`, `between`
   - –ï—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ enum: `in:value1,value2`

### ‚ö†Ô∏è –ú–µ—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

1. **ZoneController::index()**
   ```php
   if ($request->filled('greenhouse_id')) {
       $query->where('greenhouse_id', $request->integer('greenhouse_id'));
   }
   ```
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `integer()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–∞
   - ‚ö†Ô∏è –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ `validate()`

2. **AlertWebhookController::webhook()**
   ```php
   $data = $request->all();
   ```
   - ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `all()` –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   - ‚ö†Ô∏è –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è webhook –¥–∞–Ω–Ω—ã—Ö

3. **TelemetryController::zoneHistory()**
   ```php
   $validated = $request->validate([
       'start' => 'nullable|date',
       'end' => 'nullable|date',
       'metric_type' => 'nullable|string|max:64',
       'limit' => 'nullable|integer|min:1|max:1000',
   ]);
   ```
   - ‚úÖ –ï—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è
   - ‚úÖ –ü—Ä–∞–≤–∏–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Laravel

1. **–°–æ–∑–¥–∞—Ç—å FormRequest –∫–ª–∞—Å—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
   - `StoreZoneRequest`
   - `UpdateZoneRequest`
   - `StoreRecipeRequest`
   - `StoreCommandRequest`

2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `AlertWebhookController`**
   - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É webhook –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ø–∏—Å—å/—Ç–æ–∫–µ–Ω

3. **–£–ª—É—á—à–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `validate()` –¥–ª—è query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ `index()` –º–µ—Ç–æ–¥–∞—Ö

## Python —Å–µ—Ä–≤–∏—Å—ã

### ‚úÖ –•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **Pydantic –º–æ–¥–µ–ª–∏**
   - FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ Pydantic
   - –ú–æ–¥–µ–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `common/schemas.py`
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ `mqtt-bridge/main.py`

2. **Path –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã: `Path(..., ge=1)` –¥–ª—è zone_id
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: `min_length=1` –¥–ª—è —Å—Ç—Ä–æ–∫

3. **Body –≤–∞–ª–∏–¥–∞—Ü–∏—è**
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è Pydantic –º–æ–¥–µ–ª–∏: `CommandRequest`, `FillDrainRequest`
   - FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–∏–ø—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### ‚ö†Ô∏è –ú–µ—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

1. **digital-twin/main.py**
   ```python
   class SimulationRequest(BaseModel):
       zone_id: int
       duration_hours: int = 72
       step_minutes: int = 5
       scenario: Dict[str, Any] = {}
   ```
   - ‚ö†Ô∏è `scenario` - —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π —Ç–∏–ø `Dict[str, Any]`
   - ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è `scenario`

2. **common/schemas.py**
   ```python
   class CommandRequest(BaseModel):
       type: str = Field(..., max_length=64)
       params: Dict[str, Any] = {}
   ```
   - ‚ö†Ô∏è `params` - —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π —Ç–∏–ø
   - ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–º–∞–Ω–¥

3. **mqtt-bridge/main.py**
   ```python
   class NodeConfigRequest(BaseModel):
       config: dict
   ```
   - ‚ö†Ô∏è `config` - —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π —Ç–∏–ø
   - ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É–∑–ª–∞

### üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Python

1. **–°–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ Pydantic –º–æ–¥–µ–ª–∏**
   - `SimulationScenario` –¥–ª—è `scenario` –≤ `SimulationRequest`
   - `NodeConfig` –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É–∑–ª–∞
   - `CommandParams` –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥ (—Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –ø–æ —Ç–∏–ø—É)

2. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Field()` —Å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–ª–µ–π
   - –î–æ–±–∞–≤–∏—Ç—å `@validator` –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

3. **–£–ª—É—á—à–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `TypedDict` –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –≤–º–µ—Å—Ç–æ `Dict[str, Any]`

## –ß–µ–∫-–ª–∏—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### Laravel
- [x] –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `validate()`
- [x] –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –í—Å–µ query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è
- [ ] Webhook endpoints –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] FormRequest –∫–ª–∞—Å—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### Python
- [x] FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ Pydantic
- [x] Path –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è
- [x] Body –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª–∏
- [ ] –°–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏–º–µ—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –º–æ–¥–µ–ª–∏
- [ ] –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

## –ü—Ä–∏–º–µ—Ä—ã —É–ª—É—á—à–µ–Ω–∏–π

### Laravel: FormRequest –¥–ª—è Zone

```php
class StoreZoneRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'greenhouse_id' => ['nullable', 'integer', 'exists:greenhouses,id'],
            'preset_id' => ['nullable', 'integer', 'exists:presets,id'],
            'name' => ['required', 'string', 'max:255'],
            'description' => ['nullable', 'string'],
            'status' => ['nullable', 'string', 'max:32', 'in:online,offline,warning'],
        ];
    }
}
```

### Python: –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è SimulationScenario

```python
class SimulationScenario(BaseModel):
    recipe_id: Optional[int] = None
    initial_state: Optional[Dict[str, float]] = None
    
    @validator('initial_state')
    def validate_initial_state(cls, v):
        if v:
            allowed_keys = {'ph', 'ec', 'temp_air', 'temp_water', 'humidity_air'}
            for key in v.keys():
                if key not in allowed_keys:
                    raise ValueError(f"Unknown initial_state key: {key}")
        return v

class SimulationRequest(BaseModel):
    zone_id: int = Field(..., ge=1)
    duration_hours: int = Field(72, ge=1, le=720)
    step_minutes: int = Field(5, ge=1, le=60)
    scenario: SimulationScenario = SimulationScenario()
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–∞—è, –Ω–æ –µ—Å—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `AlertWebhookController`
2. –°–æ–∑–¥–∞—Ç—å FormRequest –∫–ª–∞—Å—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Laravel
3. –°–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –≤ Python

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. ‚úÖ –°–æ–∑–¥–∞–Ω –æ—Ç—á–µ—Ç –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
2. ‚è≠Ô∏è –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `AlertWebhookController`
3. ‚è≠Ô∏è –°–æ–∑–¥–∞—Ç—å FormRequest –∫–ª–∞—Å—Å—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. ‚è≠Ô∏è –£–ª—É—á—à–∏—Ç—å Pydantic –º–æ–¥–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

