# –ß–µ–∫–ª–∏—Å—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Automation Engine

## ‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

- [x] –í—Å–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [x] –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
- [x] –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [x] SQL –º–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞

## üìã –®–∞–≥–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é

```bash
cd /home/georgiy/esp/hydro/hydro2.0/backend

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
psql -h localhost -U hydro_user -d hydro_db -c "SELECT version();"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
psql -h localhost -U hydro_user -d hydro_db -f services/automation-engine/migrations/001_add_circuit_breaker_tables.sql
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
\dt pid_state
\dt command_tracking
\dt command_audit

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
\d pid_state
\d command_tracking
\d command_audit
```

### 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑

```bash
cd /home/georgiy/esp/hydro/hydro2.0/backend

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å
docker compose -f docker-compose.dev.yml stop automation-engine

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
docker compose -f docker-compose.dev.yml build automation-engine

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
docker compose -f docker-compose.dev.yml up -d automation-engine
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—Å–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker compose -f docker-compose.dev.yml ps automation-engine

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
docker compose -f docker-compose.dev.yml logs automation-engine | grep -i error

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫
docker compose -f docker-compose.dev.yml logs automation-engine | grep -i "service started"
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫
curl http://localhost:9401/metrics | head -50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Circuit Breaker –º–µ—Ç—Ä–∏–∫–∏
curl http://localhost:9401/metrics | grep circuit_breaker

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Command Tracking –º–µ—Ç—Ä–∏–∫–∏
curl http://localhost:9401/metrics | grep command_

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å System Health –º–µ—Ç—Ä–∏–∫–∏
curl http://localhost:9401/metrics | grep system_health
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### Circuit Breaker
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breakers
curl -s http://localhost:9401/metrics | grep "circuit_breaker_state" | grep -v "#"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –∑–Ω–∞—á–µ–Ω–∏–µ 0 (CLOSED) –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```

#### Command Tracking
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–º–∞–Ω–¥—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è
curl -s http://localhost:9401/metrics | grep "pending_commands_count"
```

#### Health Checks
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health status
curl -s http://localhost:9401/metrics | grep "system_health_status"
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –∑–Ω–∞—á–µ–Ω–∏–µ 0 (healthy)
```

### 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
docker compose -f docker-compose.dev.yml logs automation-engine | jq . 2>/dev/null | head -20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Trace ID –≤ –ª–æ–≥–∞—Ö
docker compose -f docker-compose.dev.yml logs automation-engine | grep trace_id | head -5
```

### 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PID —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
docker compose -f docker-compose.dev.yml restart automation-engine

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ PID
docker compose -f docker-compose.dev.yml logs automation-engine | grep "PID.*state restored"
```

### 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Graceful Shutdown

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å SIGTERM
docker compose -f docker-compose.dev.yml kill -s SIGTERM automation-engine

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ graceful shutdown
docker compose -f docker-compose.dev.yml logs automation-engine | grep -i "graceful shutdown"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ PID —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
psql -h localhost -U hydro_user -d hydro_db -c "SELECT COUNT(*) FROM pid_state WHERE updated_at > NOW() - INTERVAL '1 minute';"
```

### 9. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤

- [ ] Circuit Breakers –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ CLOSED
- [ ] –ö–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è
- [ ] Health Checks –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç healthy —Å—Ç–∞—Ç—É—Å
- [ ] –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] PID —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç trace_id –∏ zone_id

### 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- [ ] –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω –Ω–µ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å
- [ ] –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î —Å–Ω–∏–∑–∏–ª–∞—Å—å (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- [ ] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
- [ ] –ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: Circuit Breaker –ø–æ—Å—Ç–æ—è–Ω–Ω–æ OPEN

**–ü—Ä–∏—á–∏–Ω–∞:** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–±–æ–µ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–ë–î, API, MQTT)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–±—Ä–æ—Å–∏—Ç—å Circuit Breaker (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞)

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–º–∞–Ω–¥—ã –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –£–∑–ª—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –æ—Ç–≤–µ—Ç—ã –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ `command_response` —Ç–æ–ø–∏–∫–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–∑–ª—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –æ—Ç–≤–µ—Ç—ã —Å `cmd_id`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ MQTT

### –ü—Ä–æ–±–ª–µ–º–∞: PID —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–∞–±–ª–∏—Ü–∞ `pid_state` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä–æ–º –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `setup_structured_logging()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ª–æ–≥–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ trace_id –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ª–æ–≥–∞—Ö

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- `circuit_breaker_state_*` - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0 (CLOSED)
- `system_health_status` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0 (healthy)
- `command_failure_total` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º
- `command_timeout_total` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `zone_processing_time_seconds` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω
- `command_latency_seconds` - –∑–∞–¥–µ—Ä–∂–∫–∞ –∫–æ–º–∞–Ω–¥
- `component_health_latency_ms` - –∑–∞–¥–µ—Ä–∂–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
- `command_success_total` vs `command_failure_total` - —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É–¥–∞—á–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- `pending_commands_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –∫–æ–º–∞–Ω–¥ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º)

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

1. ‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
2. ‚úÖ –í—Å–µ Circuit Breakers –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ CLOSED
3. ‚úÖ Health Checks –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç healthy
4. ‚úÖ –ö–æ–º–∞–Ω–¥—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è
5. ‚úÖ PID —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
6. ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
7. ‚úÖ Graceful Shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
8. ‚úÖ –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!** üöÄ


