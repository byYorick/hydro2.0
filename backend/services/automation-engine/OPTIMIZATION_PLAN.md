# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Automation Engine
## –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞—É–¥–∏—Ç –∏ –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏—è —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –∏ –º–∏–∫—Ä–æ–∫–ª–∏–º–∞—Ç–æ–º

**–î–∞—Ç–∞:** 2025-12-11  
**–°—Ç–∞—Ç—É—Å:** –ü–ª–∞–Ω –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–æ–Ω —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- Batch –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —Å –∑–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Cooldown –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–∞–≤–∏–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- Health monitoring –∑–æ–Ω

### ‚ö†Ô∏è –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Circuit Breaker** - –Ω–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î/API
- ‚ùå **–ù–µ—Ç graceful shutdown** - –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã
- ‚ùå **–ù–µ—Ç health checks** - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (MQTT, –ë–î)
- ‚ùå **–ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è** - –ø–æ—Å–ª–µ —Å–±–æ—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚ùå **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥** - –∫–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
- ‚ùå **–ù–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - –Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥

#### 2. –ü—Ä–æ–±–ª–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ö†Ô∏è **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** - –ª–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç trace ID –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- ‚ö†Ô∏è **–ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è PID** - —Å–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚ö†Ô∏è **–ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã** - –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
- ‚ö†Ô∏è **–ù–µ—Ç –∞—É–¥–∏—Ç–∞ –∫–æ–º–∞–Ω–¥** - –Ω–µ—Ç –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

#### 3. –ü—Ä–æ–±–ª–µ–º—ã –ª–æ–≥–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- ‚ö†Ô∏è **PID –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - –≤–æ–∑–º–æ–∂–µ–Ω windup
- ‚ö†Ô∏è **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–Ω–¥–∞ –ø–µ—Ä–µ–¥ –¥–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ–º** - –º–æ–∂–µ—Ç –¥–æ–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤ —Ç—Ä–µ–Ω–¥–∞
- ‚ö†Ô∏è **–ù–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –∑–æ–Ω** - –≤—Å–µ –∑–æ–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ
- ‚ö†Ô∏è **–ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Ç–∫–∞—Ç–∞** - –ø—Ä–∏ –æ—à–∏–±–∫–µ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
- ‚ö†Ô∏è **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥** - –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –ª–∏ –∫–æ–º–∞–Ω–¥–∞

#### 4. –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚ö†Ô∏è **–ù–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è** - —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ
- ‚ö†Ô∏è **–ù–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
- ‚ö†Ô∏è **–ù–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤** - –º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## üéØ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô)

#### 1.1 Circuit Breaker Pattern
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î –∏–ª–∏ API —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∫–∞—Å–∫–∞–¥–Ω—ã–º —Å–±–æ—è–º.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# infrastructure/circuit_breaker.py
class CircuitBreaker:
    """Circuit Breaker –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤."""
    def __init__(self, failure_threshold=5, timeout=60):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.failure_count = 0
        self.last_failure_time = None
        self.state = 'CLOSED'  # CLOSED, OPEN, HALF_OPEN
    
    async def call(self, func, *args, **kwargs):
        if self.state == 'OPEN':
            if time.time() - self.last_failure_time > self.timeout:
                self.state = 'HALF_OPEN'
            else:
                raise CircuitBreakerOpenError("Circuit breaker is OPEN")
        
        try:
            result = await func(*args, **kwargs)
            if self.state == 'HALF_OPEN':
                self.state = 'CLOSED'
                self.failure_count = 0
            return result
        except Exception as e:
            self.failure_count += 1
            self.last_failure_time = time.time()
            if self.failure_count >= self.failure_threshold:
                self.state = 'OPEN'
            raise
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- –û–±–µ—Ä–Ω—É—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- –û–±–µ—Ä–Ω—É—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ Laravel API
- –û–±–µ—Ä–Ω—É—Ç—å MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

**–ú–µ—Ç—Ä–∏–∫–∏:**
- `circuit_breaker_state{component}` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ circuit breaker
- `circuit_breaker_failures_total{component}` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–±–æ–µ–≤

---

#### 1.2 Graceful Shutdown
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã, PID —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Ä—è–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# main.py
import signal
import asyncio

_shutdown_event = asyncio.Event()

def signal_handler(signum, frame):
    logger.info(f"Received signal {signum}, initiating graceful shutdown...")
    _shutdown_event.set()

signal.signal(signal.SIGTERM, signal_handler)
signal.signal(signal.SIGINT, signal_handler)

async def main():
    # ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
    
    try:
        while not _shutdown_event.is_set():
            # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–æ–Ω ...
            await asyncio.sleep(automation_settings.MAIN_LOOP_SLEEP_SECONDS)
    finally:
        # Graceful shutdown
        logger.info("Graceful shutdown initiated")
        
        # 1. –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—É—â–∏—Ö –∑–æ–Ω (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
        await asyncio.wait_for(
            _finish_current_zones(zone_service, active_zones),
            timeout=30.0
        )
        
        # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
        await _save_pid_state(zone_service)
        
        # 3. –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        mqtt.stop()
        await client.aclose()
        
        logger.info("Graceful shutdown completed")
```

**–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ shutdown:**
1. –ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–µ–∫—É—â–∏—Ö –∑–æ–Ω (—Å —Ç–∞–π–º–∞—É—Ç–æ–º)
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –≤ –ë–î
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
4. –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

---

#### 1.3 Health Checks
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# health_monitor.py (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
class SystemHealthMonitor:
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã."""
    
    async def check_health(self) -> Dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤."""
        health = {
            'status': 'healthy',
            'components': {},
            'timestamp': datetime.utcnow().isoformat()
        }
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
        db_health = await self._check_database()
        health['components']['database'] = db_health
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ MQTT
        mqtt_health = await self._check_mqtt()
        health['components']['mqtt'] = mqtt_health
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ Laravel API
        api_health = await self._check_laravel_api()
        health['components']['laravel_api'] = api_health
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
        if any(c['status'] != 'healthy' for c in health['components'].values()):
            health['status'] = 'degraded'
        if any(c['status'] == 'critical' for c in health['components'].values()):
            health['status'] = 'critical'
        
        return health
    
    async def _check_database(self) -> Dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î."""
        try:
            start = time.time()
            await fetch("SELECT 1", timeout=5.0)
            latency = time.time() - start
            
            return {
                'status': 'healthy',
                'latency_ms': latency * 1000,
                'last_check': datetime.utcnow().isoformat()
            }
        except Exception as e:
            return {
                'status': 'critical',
                'error': str(e),
                'last_check': datetime.utcnow().isoformat()
            }
    
    async def _check_mqtt(self) -> Dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ MQTT —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è."""
        if mqtt.is_connected():
            return {
                'status': 'healthy',
                'connected': True,
                'last_check': datetime.utcnow().isoformat()
            }
        else:
            return {
                'status': 'critical',
                'connected': False,
                'last_check': datetime.utcnow().isoformat()
            }
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- `system_health_status` - –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
- `component_health_status{component}` - —Å—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- `component_health_latency_ms{component}` - –∑–∞–¥–µ—Ä–∂–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

---

#### 1.4 –ú–µ—Ö–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ç–µ—Ä—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# services/pid_state_manager.py
class PidStateManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤."""
    
    async def save_pid_state(self, zone_id: int, pid_type: str, pid: AdaptivePid):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ PID –≤ –ë–î."""
        await execute(
            """
            INSERT INTO pid_state (zone_id, pid_type, integral, prev_error, last_output_ms, stats)
            VALUES ($1, $2, $3, $4, $5, $6)
            ON CONFLICT (zone_id, pid_type) DO UPDATE
            SET integral = EXCLUDED.integral,
                prev_error = EXCLUDED.prev_error,
                last_output_ms = EXCLUDED.last_output_ms,
                stats = EXCLUDED.stats,
                updated_at = NOW()
            """,
            zone_id,
            pid_type,
            pid.integral,
            pid.prev_error,
            pid.last_output_ms,
            json.dumps({
                'corrections_count': pid.stats.corrections_count,
                'total_output': pid.stats.total_output,
                'max_error': pid.stats.max_error,
                'avg_error': pid.stats.avg_error
            })
        )
    
    async def load_pid_state(self, zone_id: int, pid_type: str) -> Optional[Dict]:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ PID –∏–∑ –ë–î."""
        rows = await fetch(
            """
            SELECT integral, prev_error, last_output_ms, stats
            FROM pid_state
            WHERE zone_id = $1 AND pid_type = $2
            """,
            zone_id,
            pid_type
        )
        
        if rows:
            return {
                'integral': rows[0]['integral'],
                'prev_error': rows[0]['prev_error'],
                'last_output_ms': rows[0]['last_output_ms'],
                'stats': json.loads(rows[0]['stats'])
            }
        return None
```

**–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:**
```sql
CREATE TABLE IF NOT EXISTS pid_state (
    zone_id INTEGER NOT NULL,
    pid_type VARCHAR(10) NOT NULL,
    integral FLOAT NOT NULL DEFAULT 0.0,
    prev_error FLOAT,
    last_output_ms BIGINT NOT NULL DEFAULT 0,
    stats JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    PRIMARY KEY (zone_id, pid_type)
);
```

---

#### 1.5 –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# infrastructure/command_validator.py
class CommandValidator:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π."""
    
    def validate_correction_command(self, command: Dict[str, Any]) -> Tuple[bool, Optional[str]]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏."""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        required_fields = ['node_uid', 'channel', 'cmd', 'params']
        for field in required_fields:
            if field not in command:
                return False, f"Missing required field: {field}"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∫–æ–º–∞–Ω–¥—ã
        if command['cmd'] not in ['adjust_ph', 'adjust_ec']:
            return False, f"Invalid command type: {command['cmd']}"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        params = command.get('params', {})
        amount = params.get('amount')
        if amount is None or amount <= 0:
            return False, f"Invalid amount: {amount}"
        
        if amount > 200:  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–æ–∑–∞
            return False, f"Amount too high: {amount}ml"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
        correction_type = params.get('type')
        if correction_type not in ['add_acid', 'add_base', 'add_nutrients', 'dilute']:
            return False, f"Invalid correction type: {correction_type}"
        
        return True, None
    
    def validate_irrigation_command(self, command: Dict[str, Any]) -> Tuple[bool, Optional[str]]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª–∏–≤–∞."""
        params = command.get('params', {})
        duration = params.get('duration_sec')
        
        if duration is None or duration <= 0:
            return False, "Invalid duration"
        
        if duration > 3600:  # –ú–∞–∫—Å–∏–º—É–º 1 —á–∞—Å
            return False, f"Duration too long: {duration}s"
        
        return True, None
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```python
# infrastructure/command_bus.py
async def publish_controller_command(self, zone_id: int, command: Dict[str, Any]) -> bool:
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã
    validator = CommandValidator()
    if command.get('cmd', '').startswith('adjust_'):
        is_valid, error = validator.validate_correction_command(command)
    elif command.get('cmd') == 'irrigate':
        is_valid, error = validator.validate_irrigation_command(command)
    else:
        is_valid, error = True, None
    
    if not is_valid:
        logger.error(f"Zone {zone_id}: Invalid command: {error}", extra={
            'zone_id': zone_id,
            'command': command,
            'validation_error': error
        })
        await create_zone_event(zone_id, 'COMMAND_VALIDATION_FAILED', {
            'command': command,
            'error': error
        })
        return False
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã...
```

---

#### 1.6 –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ —É–∑–ª–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# infrastructure/command_tracker.py
class CommandTracker:
    """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥."""
    
    def __init__(self):
        self.pending_commands: Dict[str, Dict] = {}  # cmd_id -> command info
        self.command_timeout = 300  # 5 –º–∏–Ω—É—Ç
    
    async def track_command(self, zone_id: int, command: Dict[str, Any]) -> str:
        """–ù–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã."""
        cmd_id = f"{zone_id}_{int(time.time() * 1000)}"
        
        self.pending_commands[cmd_id] = {
            'zone_id': zone_id,
            'command': command,
            'sent_at': datetime.utcnow(),
            'status': 'pending'
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        await execute(
            """
            INSERT INTO command_tracking (cmd_id, zone_id, command, status, sent_at)
            VALUES ($1, $2, $3, 'pending', NOW())
            """,
            cmd_id,
            zone_id,
            json.dumps(command)
        )
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç
        asyncio.create_task(self._check_timeout(cmd_id))
        
        return cmd_id
    
    async def confirm_command(self, cmd_id: str, success: bool, response: Optional[Dict] = None):
        """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã."""
        if cmd_id not in self.pending_commands:
            return
        
        self.pending_commands[cmd_id]['status'] = 'completed' if success else 'failed'
        self.pending_commands[cmd_id]['completed_at'] = datetime.utcnow()
        self.pending_commands[cmd_id]['response'] = response
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ë–î
        await execute(
            """
            UPDATE command_tracking
            SET status = $1, completed_at = NOW(), response = $2
            WHERE cmd_id = $3
            """,
            'completed' if success else 'failed',
            json.dumps(response) if response else None,
            cmd_id
        )
    
    async def _check_timeout(self, cmd_id: str):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –∫–æ–º–∞–Ω–¥—ã."""
        await asyncio.sleep(self.command_timeout)
        
        if cmd_id in self.pending_commands:
            cmd = self.pending_commands[cmd_id]
            if cmd['status'] == 'pending':
                # –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
                logger.warning(
                    f"Command {cmd_id} timed out",
                    extra={'zone_id': cmd['zone_id'], 'command': cmd['command']}
                )
                await self.confirm_command(cmd_id, False, {'error': 'timeout'})
                
                # –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
                await create_zone_event(
                    cmd['zone_id'],
                    'COMMAND_TIMEOUT',
                    {'cmd_id': cmd_id, 'command': cmd['command']}
                )
```

**–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ command_response:**
```python
# main.py
async def setup_command_tracking(mqtt: MqttClient, command_tracker: CommandTracker):
    """–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç—ã –∫–æ–º–∞–Ω–¥."""
    async def handle_command_response(topic: str, payload: bytes):
        try:
            data = json.loads(payload.decode())
            cmd_id = data.get('cmd_id')
            success = data.get('status') == 'ok'
            response = data.get('response')
            
            if cmd_id:
                await command_tracker.confirm_command(cmd_id, success, response)
        except Exception as e:
            logger.error(f"Error handling command response: {e}", exc_info=True)
    
    mqtt.subscribe("hydro/+/+/+/+/command_response", handle_command_response)
```

---

### –§–∞–∑–∞ 2: –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô)

#### 2.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Trace ID
**–†–µ—à–µ–Ω–∏–µ:**
```python
# utils/logging_context.py
import contextvars
import uuid

trace_id_var = contextvars.ContextVar('trace_id', default=None)

def get_trace_id() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å trace ID."""
    trace_id = trace_id_var.get()
    if trace_id is None:
        trace_id = str(uuid.uuid4())[:8]
        trace_id_var.set(trace_id)
    return trace_id

class StructuredFormatter(logging.Formatter):
    """–§–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è."""
    
    def format(self, record):
        # –î–æ–±–∞–≤–ª—è–µ–º trace_id
        record.trace_id = get_trace_id()
        
        # –î–æ–±–∞–≤–ª—è–µ–º zone_id –µ—Å–ª–∏ –µ—Å—Ç—å
        if hasattr(record, 'zone_id'):
            record.zone_id = record.zone_id
        else:
            record.zone_id = None
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ JSON
        log_data = {
            'timestamp': self.formatTime(record),
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'trace_id': record.trace_id,
            'zone_id': record.zone_id,
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º extra –ø–æ–ª—è
        if hasattr(record, 'extra'):
            log_data.update(record.extra)
        
        # –î–æ–±–∞–≤–ª—è–µ–º exception –µ—Å–ª–∏ –µ—Å—Ç—å
        if record.exc_info:
            log_data['exception'] = self.formatException(record.exc_info)
        
        return json.dumps(log_data, ensure_ascii=False)
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
```python
# main.py
logging.basicConfig(
    level=getattr(logging, log_level, logging.INFO),
    handlers=[logging.StreamHandler()],
    format='%(message)s'  # JSON —Ñ–æ—Ä–º–∞—Ç
)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
handler = logging.StreamHandler()
handler.setFormatter(StructuredFormatter())
logger.addHandler(handler)
```

---

#### 2.2 –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ PID
**–†–µ—à–µ–Ω–∏–µ:**
```python
# correction_controller.py
async def check_and_correct(...):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ PID –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
    logger.debug(
        f"Zone {zone_id}: {self.metric_name} PID calculation",
        extra={
            'zone_id': zone_id,
            'metric': self.metric_name,
            'current': current_val,
            'target': target_val,
            'error': diff,
            'pid_zone': pid.get_zone().value,
            'pid_output': amount,
            'pid_integral': pid.integral,
            'pid_prev_error': pid.prev_error,
            'pid_dt': dt_seconds,
            'pid_config': {
                'dead_zone': pid.config.dead_zone,
                'close_zone': pid.config.close_zone,
                'far_zone': pid.config.far_zone,
                'kp': pid.config.zone_coeffs[pid.get_zone()].kp,
                'ki': pid.config.zone_coeffs[pid.get_zone()].ki,
                'kd': pid.config.zone_coeffs[pid.get_zone()].kd,
            }
        }
    )
```

---

#### 2.3 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
**–†–µ—à–µ–Ω–∏–µ:**
```python
# main.py
async def log_system_state(zone_service: ZoneAutomationService, zones: List[Dict]):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã."""
    state = {
        'timestamp': datetime.utcnow().isoformat(),
        'zones_count': len(zones),
        'active_zones': len([z for z in zones if z.get('status') == 'active']),
        'pid_instances': {
            'ph': len(zone_service.ph_controller._pid_by_zone),
            'ec': len(zone_service.ec_controller._pid_by_zone)
        },
        'pending_commands': len(command_tracker.pending_commands),
        'circuit_breakers': {
            'database': db_circuit_breaker.state,
            'api': api_circuit_breaker.state,
            'mqtt': mqtt_circuit_breaker.state
        }
    }
    
    logger.info("System state", extra=state)
```

**–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

---

#### 2.4 –ê—É–¥–∏—Ç –∫–æ–º–∞–Ω–¥
**–†–µ—à–µ–Ω–∏–µ:**
```python
# infrastructure/command_audit.py
class CommandAudit:
    """–ê—É–¥–∏—Ç –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥."""
    
    async def audit_command(self, zone_id: int, command: Dict[str, Any], context: Dict[str, Any]):
        """–ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –∞—É–¥–∏—Ç."""
        await execute(
            """
            INSERT INTO command_audit (
                zone_id, command_type, command_data, 
                telemetry_snapshot, decision_context, 
                pid_state, created_at
            )
            VALUES ($1, $2, $3, $4, $5, $6, NOW())
            """,
            zone_id,
            command.get('cmd'),
            json.dumps(command),
            json.dumps(context.get('telemetry', {})),
            json.dumps({
                'current_value': context.get('current_value'),
                'target_value': context.get('target_value'),
                'diff': context.get('diff'),
                'reason': context.get('reason')
            }),
            json.dumps(context.get('pid_state', {}))
        )
```

**–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î:**
```sql
CREATE TABLE IF NOT EXISTS command_audit (
    id SERIAL PRIMARY KEY,
    zone_id INTEGER NOT NULL,
    command_type VARCHAR(50) NOT NULL,
    command_data JSONB NOT NULL,
    telemetry_snapshot JSONB,
    decision_context JSONB,
    pid_state JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_command_audit_zone_id ON command_audit(zone_id);
CREATE INDEX idx_command_audit_created_at ON command_audit(created_at);
```

---

### –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)

#### 3.1 –£–ª—É—á—à–µ–Ω–∏–µ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ–∑–º–æ–∂–µ–Ω integral windup.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# utils/adaptive_pid.py
def compute(self, current_value: float, dt_seconds: float) -> float:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # Anti-windup: –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞–ª
    if abs(self.integral) > self.config.max_integral:
        self.integral = math.copysign(self.config.max_integral, self.integral)
    
    # Clamping: –µ—Å–ª–∏ –≤—ã—Ö–æ–¥ —É–∂–µ –Ω–∞ –º–∞–∫—Å–∏–º—É–º–µ, –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞–ª
    if abs(output) >= self.config.max_output:
        # –ù–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞–ª –µ—Å–ª–∏ —É–∂–µ –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ
        self.integral = self.integral * 0.95  # –ù–µ–±–æ–ª—å—à–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
```

---

#### 3.2 –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–æ–Ω
**–†–µ—à–µ–Ω–∏–µ:**
```python
# main.py
def prioritize_zones(zones: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–æ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏."""
    def get_priority(zone: Dict) -> int:
        priority = 0
        
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã (–Ω–∏–∑–∫–∏–π health_score) - –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        health_score = zone.get('health_score', 100)
        if health_score < 50:
            priority += 1000
        elif health_score < 80:
            priority += 500
        
        # –ó–æ–Ω—ã —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–ª–µ—Ä—Ç–∞–º–∏
        active_alerts = zone.get('active_alerts_count', 0)
        priority += active_alerts * 100
        
        # –ó–æ–Ω—ã —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
        last_telemetry_age = zone.get('last_telemetry_age_minutes', 0)
        if last_telemetry_age > 30:
            priority += 50
        
        return priority
    
    return sorted(zones, key=get_priority, reverse=True)
```

---

#### 3.3 –ú–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∫–∞—Ç–∞ –∫–æ–º–∞–Ω–¥
**–†–µ—à–µ–Ω–∏–µ:**
```python
# infrastructure/command_rollback.py
class CommandRollback:
    """–ú–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∫–∞—Ç–∞ –∫–æ–º–∞–Ω–¥."""
    
    async def rollback_command(self, cmd_id: str):
        """–û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—É."""
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–µ
        rows = await fetch(
            """
            SELECT zone_id, command_data
            FROM command_tracking
            WHERE cmd_id = $1
            """,
            cmd_id
        )
        
        if not rows:
            return
        
        command = json.loads(rows[0]['command_data'])
        zone_id = rows[0]['zone_id']
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Ç–∫–∞—Ç–∞
        rollback_command = self._create_rollback_command(command)
        
        if rollback_command:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Ç–∫–∞—Ç–∞
            await command_bus.publish_controller_command(zone_id, rollback_command)
            
            # –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
            await create_zone_event(zone_id, 'COMMAND_ROLLBACK', {
                'original_cmd_id': cmd_id,
                'rollback_command': rollback_command
            })
    
    def _create_rollback_command(self, original_command: Dict) -> Optional[Dict]:
        """–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –æ—Ç–∫–∞—Ç–∞."""
        cmd = original_command.get('cmd')
        
        if cmd == 'adjust_ph':
            # –û—Ç–∫–∞—Ç: –¥–æ–∑–∏—Ä—É–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–µ –≤–µ—â–µ—Å—Ç–≤–æ
            params = original_command.get('params', {})
            original_type = params.get('type')
            amount = params.get('amount', 0)
            
            if original_type == 'add_acid':
                rollback_type = 'add_base'
            elif original_type == 'add_base':
                rollback_type = 'add_acid'
            else:
                return None
            
            return {
                'node_uid': original_command['node_uid'],
                'channel': original_command['channel'],
                'cmd': 'adjust_ph',
                'params': {
                    'amount': amount * 0.5,  # 50% –æ—Ç–∫–∞—Ç
                    'type': rollback_type
                }
            }
        
        # –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥ –æ—Ç–∫–∞—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        return None
```

---

#### 3.4 –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥
**–†–µ—à–µ–Ω–∏–µ:**
```python
# main.py
async def verify_command_execution(zone_id: int, command: Dict[str, Any], timeout: int = 60):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã."""
    cmd_type = command.get('cmd')
    
    if cmd_type == 'adjust_ph':
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ pH —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
        await asyncio.sleep(120)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ pH
        telemetry = await get_zone_telemetry_last(zone_id)
        current_ph = telemetry.get('PH')
        expected_change = command.get('params', {}).get('amount', 0) / 10.0  # –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
        
        if current_ph is None:
            logger.warning(f"Zone {zone_id}: Cannot verify pH correction - no telemetry")
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ pH –≤ –æ–∂–∏–¥–∞–µ–º–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
        # (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
        return True  # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    
    return True
```

---

### –§–∞–∑–∞ 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)

#### 4.1 –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**–†–µ—à–µ–Ω–∏–µ:**
```python
# infrastructure/cache.py
from functools import lru_cache
import asyncio
from datetime import datetime, timedelta

class ZoneDataCache:
    """–ö–µ—à –¥–∞–Ω–Ω—ã—Ö –∑–æ–Ω."""
    
    def __init__(self, ttl_seconds: int = 30):
        self.cache: Dict[int, Dict] = {}
        self.cache_timestamps: Dict[int, datetime] = {}
        self.ttl = timedelta(seconds=ttl_seconds)
    
    async def get_zone_data(self, zone_id: int, fetch_func) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–æ–Ω—ã –∏–∑ –∫–µ—à–∞ –∏–ª–∏ –ë–î."""
        now = datetime.utcnow()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        if zone_id in self.cache:
            if now - self.cache_timestamps[zone_id] < self.ttl:
                return self.cache[zone_id]
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –ë–î
        data = await fetch_func(zone_id)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
        self.cache[zone_id] = data
        self.cache_timestamps[zone_id] = now
        
        return data
    
    def invalidate(self, zone_id: int):
        """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –∑–æ–Ω—ã."""
        self.cache.pop(zone_id, None)
        self.cache_timestamps.pop(zone_id, None)
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å capabilities –∑–æ–Ω (TTL: 5 –º–∏–Ω—É—Ç)
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ä–µ—Ü–µ–ø—Ç–æ–≤ (TTL: 10 –º–∏–Ω—É—Ç)
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤ (TTL: 2 –º–∏–Ω—É—Ç—ã)

---

#### 4.2 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
**–†–µ—à–µ–Ω–∏–µ:**
```python
# repositories/recipe_repository.py
async def get_zone_data_batch_optimized(self, zone_ids: List[int]) -> Dict[int, Dict]:
    """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π batch –∑–∞–ø—Ä–æ—Å –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–æ–Ω."""
    # –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤
    rows = await fetch(
        """
        WITH zone_recipe_data AS (
            SELECT 
                z.id as zone_id,
                zri.recipe_id,
                zri.current_phase_index,
                rp.targets,
                rp.phase_name
            FROM zones z
            LEFT JOIN zone_recipe_instances zri ON zri.zone_id = z.id
            LEFT JOIN recipe_phases rp ON rp.recipe_id = zri.recipe_id 
                AND rp.phase_index = zri.current_phase_index
            WHERE z.id = ANY($1::int[])
        ),
        zone_telemetry AS (
            SELECT 
                zone_id,
                metric_type,
                value,
                updated_at
            FROM telemetry_last
            WHERE zone_id = ANY($1::int[])
        ),
        zone_nodes AS (
            SELECT 
                n.zone_id,
                n.id,
                n.uid,
                n.type,
                nc.channel
            FROM nodes n
            LEFT JOIN node_channels nc ON nc.node_id = n.id
            WHERE n.zone_id = ANY($1::int[])
        )
        SELECT 
            zrd.zone_id,
            json_build_object(
                'recipe_info', json_build_object(
                    'recipe_id', zrd.recipe_id,
                    'phase_index', zrd.current_phase_index,
                    'phase_name', zrd.phase_name,
                    'targets', zrd.targets
                ),
                'telemetry', (
                    SELECT json_object_agg(metric_type, value)
                    FROM zone_telemetry zt
                    WHERE zt.zone_id = zrd.zone_id
                ),
                'telemetry_timestamps', (
                    SELECT json_object_agg(metric_type, updated_at)
                    FROM zone_telemetry zt
                    WHERE zt.zone_id = zrd.zone_id
                ),
                'nodes', (
                    SELECT json_object_agg(
                        n.type || '_' || COALESCE(n.channel, 'default'),
                        json_build_object(
                            'node_uid', n.uid,
                            'channel', n.channel,
                            'type', n.type
                        )
                    )
                    FROM zone_nodes n
                    WHERE n.zone_id = zrd.zone_id
                )
            ) as zone_data
        FROM zone_recipe_data zrd
        """,
        zone_ids
    )
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä—å
    result = {}
    for row in rows:
        result[row['zone_id']] = row['zone_data']
    
    return result
```

---

### –§–∞–∑–∞ 5: –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)

#### 5.1 –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
**–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:**
```python
# metrics.py
# –ú–µ—Ç—Ä–∏–∫–∏ PID
PID_OUTPUT = Histogram(
    "pid_output_ml",
    "PID output in ml",
    ["zone_id", "pid_type", "zone"]
)

PID_ERROR = Histogram(
    "pid_error",
    "PID error (current - target)",
    ["zone_id", "pid_type"]
)

PID_INTEGRAL = Gauge(
    "pid_integral",
    "PID integral value",
    ["zone_id", "pid_type"]
)

# –ú–µ—Ç—Ä–∏–∫–∏ –∫–æ–º–∞–Ω–¥
COMMAND_LATENCY = Histogram(
    "command_latency_seconds",
    "Time from command send to confirmation",
    ["zone_id", "command_type"]
)

COMMAND_SUCCESS_RATE = Counter(
    "command_success_rate",
    "Command success rate",
    ["zone_id", "command_type"]
)

# –ú–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
SYSTEM_HEALTH = Gauge(
    "system_health_score",
    "Overall system health score",
    ["component"]
)

CIRCUIT_BREAKER_STATE = Gauge(
    "circuit_breaker_state",
    "Circuit breaker state (0=CLOSED, 1=OPEN, 2=HALF_OPEN)",
    ["component"]
)
```

---

#### 5.2 –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
**–†–µ—à–µ–Ω–∏–µ:**
```python
# services/predictive_monitoring.py
class PredictiveMonitor:
    """–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–µ–Ω–¥–æ–≤."""
    
    async def predict_ph_drift(self, zone_id: int) -> Optional[Dict]:
        """–ü—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –¥—Ä–µ–π—Ñ pH."""
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç—Ä–µ–Ω–¥ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞
        rows = await fetch(
            """
            SELECT value, ts
            FROM telemetry_samples
            WHERE zone_id = $1 AND metric_type = 'PH'
            AND ts >= NOW() - INTERVAL '2 hours'
            ORDER BY ts ASC
            """,
            zone_id
        )
        
        if len(rows) < 10:
            return None
        
        values = [float(r['value']) for r in rows]
        
        # –õ–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
        n = len(values)
        x = list(range(n))
        x_mean = sum(x) / n
        y_mean = sum(values) / n
        
        numerator = sum((x[i] - x_mean) * (values[i] - y_mean) for i in range(n))
        denominator = sum((x[i] - x_mean) ** 2 for i in range(n))
        
        if denominator == 0:
            return None
        
        slope = numerator / denominator
        
        # –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —á–∞—Å
        predicted_value = values[-1] + slope * 60  # 60 —Ç–æ—á–µ–∫ = 1 —á–∞—Å
        
        # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        targets = await get_zone_targets(zone_id)
        target_ph = targets.get('ph')
        
        if target_ph:
            predicted_diff = predicted_value - target_ph
            
            # –ï—Å–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
            if abs(predicted_diff) > 0.5:
                return {
                    'type': 'ph_drift_warning',
                    'current': values[-1],
                    'predicted': predicted_value,
                    'target': target_ph,
                    'predicted_diff': predicted_diff,
                    'time_horizon_minutes': 60
                }
        
        return None
```

---

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (2-3 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ Circuit Breaker –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. ‚úÖ Graceful Shutdown
3. ‚úÖ Health Checks
4. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è PID
5. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
6. ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥

### –≠—Ç–∞–ø 2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Trace ID
2. ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ PID
3. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
4. ‚úÖ –ê—É–¥–∏—Ç –∫–æ–º–∞–Ω–¥

### –≠—Ç–∞–ø 3: –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (2-3 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ PID (anti-windup)
2. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–æ–Ω
3. ‚úÖ –ú–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∫–∞—Ç–∞ –∫–æ–º–∞–Ω–¥
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥

### –≠—Ç–∞–ø 4: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –≠—Ç–∞–ø 5: –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
2. ‚úÖ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
- **Uptime:** > 99.9%
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:** < 30 —Å–µ–∫—É–Ω–¥
- **–ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤:** Circuit Breaker –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É

### –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
- **100% –∫–æ–º–∞–Ω–¥ –≤ –∞—É–¥–∏—Ç–µ** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ª—é–±–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- **–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º** - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∑–∞ 1 —á–∞—Å –¥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** - –≥–∞—Ä–∞–Ω—Ç–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
- **–ú–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–∫–∞—Ç–∞** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î:** 30-40% –∑–∞ —Å—á–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:** 20-30% –∑–∞ —Å—á–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω—ã: ~2-3 —Å–µ–∫—É–Ω–¥—ã
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–º–∞–Ω–¥: ~95%
- –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è: 5-10 –º–∏–Ω—É—Ç
- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: –°—Ä–µ–¥–Ω—è—è

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ü–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω—ã: ~1.5-2 —Å–µ–∫—É–Ω–¥—ã (-25%)
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–º–∞–Ω–¥: >99% (+4%)
- –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è: <30 —Å–µ–∫—É–Ω–¥ (-95%)
- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: –ü–æ–ª–Ω–∞—è (100% –∫–æ–º–∞–Ω–¥ –≤ –∞—É–¥–∏—Ç–µ)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```python
# requirements.txt (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)
tenacity>=8.2.0  # Retry –º–µ—Ö–∞–Ω–∏–∑–º
structlog>=23.2.0  # –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î
```sql
-- –°–æ—Å—Ç–æ—è–Ω–∏–µ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
CREATE TABLE pid_state (...);

-- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
CREATE TABLE command_tracking (...);

-- –ê—É–¥–∏—Ç –∫–æ–º–∞–Ω–¥
CREATE TABLE command_audit (...);
```

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏
- `infrastructure/circuit_breaker.py`
- `infrastructure/command_validator.py`
- `infrastructure/command_tracker.py`
- `infrastructure/command_rollback.py`
- `infrastructure/command_audit.py`
- `infrastructure/cache.py`
- `services/pid_state_manager.py`
- `services/predictive_monitoring.py`
- `utils/logging_context.py`

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

1. **–ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ:** –ù–∞—á–∏–Ω–∞—Ç—å —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (Circuit Breaker, Graceful Shutdown)
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –£—Å–∏–ª–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ –≤—Ä–µ–º—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
4. **–û—Ç–∫–∞—Ç:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
5. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –û–±–Ω–æ–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –º–µ—Ä–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

---

## üîç Best Practices –∏–∑ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏

### Agricultural Automation Systems
- **Redundancy:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
- **Data Validation:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ–Ω—Å–æ—Ä–æ–≤ –¥–æ–ª–∂–Ω—ã –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è
- **Safety Limits:** –ñ–µ—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –¥–æ–∑—ã –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
- **Audit Trail:** –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è compliance

### Industrial Control Systems
- **State Persistence:** –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è
- **Command Confirmation:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å—Å—è
- **Graceful Degradation:** –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–∏ —Å–±–æ—è—Ö
- **Predictive Maintenance:** –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –¥–æ –∏—Ö –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production

- [ ] Circuit Breaker –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] Graceful Shutdown —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Health Checks –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è PID
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- [ ] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
- [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Trace ID
- [ ] –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ PID –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- [ ] –ê—É–¥–∏—Ç –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- [ ] Anti-windup –≤ PID –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
- [ ] –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∑–æ–Ω
- [ ] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- [ ] –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ Prometheus
- [ ] –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- [ ] –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ (>80%)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Load testing –ø—Ä–æ–π–¥–µ–Ω
- [ ] Disaster recovery –ø–ª–∞–Ω –≥–æ—Ç–æ–≤

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –û–±—Å—É–¥–∏—Ç—å –ø–ª–∞–Ω —Å –∫–æ–º–∞–Ω–¥–æ–π
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
3. –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–Ω–µ–¥—Ä—è—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–∑—ã

