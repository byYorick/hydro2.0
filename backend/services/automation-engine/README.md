# Automation Engine

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ç–µ–ø–ª–∏—Ü —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω, —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°–ª–æ–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         main.py (Entry Point)        ‚îÇ
‚îÇ  - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ Laravel API      ‚îÇ
‚îÇ  - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–æ–Ω       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   ZoneAutomationService (Service)    ‚îÇ
‚îÇ  - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω—ã        ‚îÇ
‚îÇ  - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                     ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Controllers‚îÇ    ‚îÇ  Repositories    ‚îÇ
‚îÇ - pH/EC    ‚îÇ    ‚îÇ  - Zone          ‚îÇ
‚îÇ - Climate  ‚îÇ    ‚îÇ  - Telemetry     ‚îÇ
‚îÇ - Light    ‚îÇ    ‚îÇ  - Node          ‚îÇ
‚îÇ - Irrigation‚îÇ   ‚îÇ  - Recipe        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ                     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Infrastructure    ‚îÇ
    ‚îÇ  - CommandBus (REST)‚îÇ
    ‚îÇ  - Error Handler    ‚îÇ
    ‚îÇ  - Retry Mechanism  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. **Services** (`services/`)
- `ZoneAutomationService` - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω—ã, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

#### 2. **Repositories** (`repositories/`)
- `ZoneRepository` - –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∑–æ–Ω –∏ capabilities
- `TelemetryRepository` - –¥–æ—Å—Ç—É–ø –∫ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- `NodeRepository` - –¥–æ—Å—Ç—É–ø –∫ —É–∑–ª–∞–º
- `RecipeRepository` - –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Ü–µ–ø—Ç–∞–º –∏ —Ñ–∞–∑–∞–º

#### 3. **Controllers** (–∫–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è)
- `CorrectionController` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è pH/EC –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
- `ClimateController` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–º–∞—Ç–æ–º (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, CO‚ÇÇ)
- `LightController` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º –∏ —Ñ–æ—Ç–æ–ø–µ—Ä–∏–æ–¥–æ–º
- `IrrigationController` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º –∏ —Ä–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–µ–π

#### 4. **Infrastructure** (`infrastructure/`)
- `CommandBus` - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ history-logger REST API
- `error_handler.py` - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `exceptions.py` - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- `utils/retry.py` - retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### 5. **Configuration** (`config/`)
- `settings.py` - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ—Ä–æ–≥–∏, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –º–Ω–æ–∂–∏—Ç–µ–ª–∏)

### Scheduler Task API (planner contract)

`automation-engine` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ—Ç `scheduler` –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:

- `POST /scheduler/bootstrap` -> `ready|wait|deny` + lease
- `POST /scheduler/bootstrap/heartbeat` -> refresh lease
- `POST /scheduler/task` -> `accepted` + `task_id`
- `GET /scheduler/task/{task_id}` -> `accepted|running|completed|failed|rejected|expired`
- `GET /health/live` -> liveness probe
- `GET /health/ready` -> readiness probe (`CommandBus + DB + bootstrap lease-store`)

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ `task_type`:
- `irrigation`
- `lighting`
- `ventilation`
- `solution_change`
- `mist`
- `diagnostics`

–í–∞–∂–Ω–æ: scheduler –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å device-level –∫–æ–º–∞–Ω–¥—ã –Ω–∞–ø—Ä—è–º—É—é.  
–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ `automation-engine` —á–µ—Ä–µ–∑ `CommandBus`.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- `correlation_id` –≤ `POST /scheduler/task` –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω;
- –ø–æ–≤—Ç–æ—Ä–Ω—ã–π `POST` —Å —Ç–µ–º –∂–µ `correlation_id` –∏ —Ç–µ–º –∂–µ payload –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ `task_id` (`is_duplicate=true`);
- –ø–æ–≤—Ç–æ—Ä —Å —Ç–µ–º –∂–µ `correlation_id`, –Ω–æ –¥—Ä—É–≥–∏–º payload –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è (`409 idempotency_payload_mismatch`).

–ú–∞–ø–ø–∏–Ω–≥ `task_type -> node_types/cmd/params` –≤—ã–Ω–µ—Å–µ–Ω –≤ `config/scheduler_task_mapping.py` –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç override –∏–∑ `payload.config.execution`.
–°–Ω–∏–º–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ scheduler-task (`accepted/running/completed/failed`) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `scheduler_logs` –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–æ–Ω (–¥–æ 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- ‚úÖ Batch –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ pH/EC
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–º–∞—Ç–æ–º (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è)
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º (—Ñ–æ—Ç–æ–ø–µ—Ä–∏–æ–¥, –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å)
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º –∏ —Ä–µ—Ü–∏—Ä–∫—É–ª—è—Ü–∏–µ–π
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –∑–æ–Ω (health score)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ñ–∞–∑–∞–º–∏ —Ä–µ—Ü–µ–ø—Ç–∞

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–æ–Ω (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 3-5 —Ä–∞–∑)
- ‚úÖ Batch –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 40-50%)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã —Å CTE

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫
python main.py
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `config/settings.py`:

```python
from config.settings import get_settings

settings = get_settings()
print(settings.MAIN_LOOP_SLEEP_SECONDS)  # 15
print(settings.MAX_CONCURRENT_ZONES)     # 5
print(settings.PH_CORRECTION_THRESHOLD)  # 0.2
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- `MAIN_LOOP_SLEEP_SECONDS` - –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15)
- `MAX_CONCURRENT_ZONES` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –∑–æ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5)
- `PH_CORRECTION_THRESHOLD` - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ pH (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.2)
- `EC_CORRECTION_THRESHOLD` - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ EC (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.2)
- `PH_DOSING_MULTIPLIER` - –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ–∑–∏—Ä–æ–≤–∫–∏ pH (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10.0)
- `EC_DOSING_MULTIPLIER` - –º–Ω–æ–∂–∏—Ç–µ–ª—å –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ–∑–∏—Ä–æ–≤–∫–∏ EC (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 100.0)

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest automation-engine/ -v

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
pytest automation-engine/test_correction_controller.py -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
pytest automation-engine/ --cov=automation-engine --cov-report=html
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

- **72+ —Ç–µ—Å—Ç–æ–≤** –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **100% –ø–æ–∫—Ä—ã—Ç–∏–µ** –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (exceptions, error_handler, config, retry)
- **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã** –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏ —Å –º–æ–∫–∞–º–∏ –ë–î

## üìä –ú–µ—Ç—Ä–∏–∫–∏ Prometheus

–ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–∞ –ø–æ—Ä—Ç—É 9401 (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `config/settings.py`):

- `automation_loop_errors_total` - –æ—à–∏–±–∫–∏ –≤ –≥–ª–∞–≤–Ω–æ–º —Ü–∏–∫–ª–µ
- `config_fetch_errors_total` - –æ—à–∏–±–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `config_fetch_success_total` - —É—Å–ø–µ—à–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `zone_checks_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–æ–Ω
- `zone_check_seconds` - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–æ–Ω—ã
- `automation_commands_sent_total{zone_id, metric}` - –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `rest_command_errors_total{error_type}` - –æ—à–∏–±–∫–∏ REST –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ history-logger
- `command_rest_latency_seconds` - –∑–∞–¥–µ—Ä–∂–∫–∞ REST –∑–∞–ø—Ä–æ—Å–æ–≤
- `automation_errors_total` - –æ–±—â–∏–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from services import ZoneAutomationService
from repositories import ZoneRepository, TelemetryRepository, NodeRepository, RecipeRepository
from infrastructure import CommandBus

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
zone_repo = ZoneRepository()
telemetry_repo = TelemetryRepository()
node_repo = NodeRepository()
recipe_repo = RecipeRepository()

# CommandBus –∏—Å–ø–æ–ª—å–∑—É–µ—Ç REST API –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥
history_logger_url = "http://history-logger:9300"
history_logger_token = os.getenv("HISTORY_LOGGER_API_TOKEN") or os.getenv("PY_INGEST_TOKEN")
command_bus = CommandBus(
    mqtt=None,  # Deprecated, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    gh_uid="gh-1",
    history_logger_url=history_logger_url,
    history_logger_token=history_logger_token
)

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
zone_service = ZoneAutomationService(
    zone_repo, telemetry_repo, node_repo, recipe_repo, command_bus
)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–æ–Ω—ã
await zone_service.process_zone(zone_id=1)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CorrectionController

```python
from correction_controller import CorrectionController, CorrectionType

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –¥–ª—è pH
ph_controller = CorrectionController(CorrectionType.PH)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
command = await ph_controller.check_and_correct(
    zone_id=1,
    targets={"ph": {"target": 6.5}},
    telemetry={"PH": 6.2},
    nodes={"irrig:default": {"node_uid": "nd-1", "channel": "default", "type": "irrig"}},
    water_level_ok=True
)

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
if command:
    await ph_controller.apply_correction(command, command_bus)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
from error_handler import handle_zone_error, error_handler
from exceptions import ZoneNotFoundError

# –†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
try:
    await zone_service.process_zone(1)
except Exception as e:
    handle_zone_error(1, e, {"action": "process_zone"})

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
@error_handler(zone_id=1, default_return=None)
async def process_zone_safe(zone_id: int):
    await zone_service.process_zone(zone_id)
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
automation-engine/
‚îú‚îÄ‚îÄ main.py                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ config/                      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ settings.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îú‚îÄ‚îÄ repositories/                # –°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ zone_repository.py
‚îÇ   ‚îú‚îÄ‚îÄ telemetry_repository.py
‚îÇ   ‚îú‚îÄ‚îÄ node_repository.py
‚îÇ   ‚îî‚îÄ‚îÄ recipe_repository.py
‚îú‚îÄ‚îÄ services/                    # –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ zone_automation_service.py
‚îú‚îÄ‚îÄ infrastructure/              # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ command_bus.py          # REST API –¥–ª—è –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ command_validator.py    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ command_tracker.py      # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îî‚îÄ‚îÄ command_audit.py        # –ê—É–¥–∏—Ç –∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ api.py                       # REST API –¥–ª—è scheduler
‚îú‚îÄ‚îÄ utils/                       # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ retry.py
‚îú‚îÄ‚îÄ exceptions.py                # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ error_handler.py             # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îú‚îÄ‚îÄ correction_controller.py     # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä pH/EC
‚îú‚îÄ‚îÄ climate_controller.py       # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∫–ª–∏–º–∞—Ç–∞
‚îú‚îÄ‚îÄ light_controller.py          # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Å–≤–µ—â–µ–Ω–∏—è
‚îú‚îÄ‚îÄ irrigation_controller.py    # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–ª–∏–≤–∞
‚îú‚îÄ‚îÄ health_monitor.py            # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è
‚îú‚îÄ‚îÄ alerts_manager.py            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞–º–∏
‚îú‚îÄ‚îÄ correction_cooldown.py      # Cooldown –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
‚îî‚îÄ‚îÄ test_*.py                    # –¢–µ—Å—Ç—ã
```

## üîÑ –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

–ü—Ä–æ–µ–∫—Ç –ø—Ä–æ—à–µ–ª –ø–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å —É–ª—É—á—à–µ–Ω–∏–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:

- ‚úÖ **–≠—Ç–∞–ø A**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤
- ‚úÖ **–≠—Ç–∞–ø B**: –í—ã–¥–µ–ª–µ–Ω–∏–µ Correction Controller (—É–±—Ä–∞–Ω–æ 200+ —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ **–≠—Ç–∞–ø C**: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
- ‚úÖ **–≠—Ç–∞–ø D**: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Å–ª–æ—è
- ‚úÖ **–≠—Ç–∞–ø E**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º, batch –∑–∞–ø—Ä–æ—Å—ã)
- ‚úÖ **–≠—Ç–∞–ø F**: –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- ‚úÖ **–≠—Ç–∞–ø G**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (72+ —Ç–µ—Å—Ç–æ–≤)

## üìà –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 10 –∑–æ–Ω | ~2.5 –º–∏–Ω | ~30 —Å–µ–∫ | **5x** |
| –ó–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –Ω–∞ –∑–æ–Ω—É | 4+ | 1-2 | **50-75%** |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | **40-50%** |

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ–µ–∫—Ç –∫–æ–º–ø–∞–Ω–∏–∏.
