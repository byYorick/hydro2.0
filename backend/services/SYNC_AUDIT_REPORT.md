# –û—Ç—á–µ—Ç –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å automation-engine

**–î–∞—Ç–∞:** 2025-12-11  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

---

## üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
| –°–µ—Ä–≤–∏—Å | –°—Ç–∞—Ç—É—Å | Health | –ü–æ—Ä—Ç | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |
|--------|--------|--------|------|-------------|
| **automation-engine** | ‚úÖ Running | ‚úÖ Healthy | 9401 | mqtt, db, laravel |
| **history-logger** | ‚úÖ Running | ‚úÖ Healthy | 9300-9301 | mqtt, db, redis, laravel |
| **mqtt-bridge** | ‚úÖ Running | ‚úÖ Healthy | 9000 | mqtt, db, laravel |
| **scheduler** | ‚úÖ Running | ‚úÖ Healthy | 9402 | mqtt, db |
| **digital-twin** | ‚úÖ Running | ‚úÖ Healthy | 8003, 9403 | db |
| **telemetry-aggregator** | ‚úÖ Running | ‚úÖ Healthy | 9404 | db |

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
| –°–µ—Ä–≤–∏—Å | –°—Ç–∞—Ç—É—Å | Health | –ü–æ—Ä—Ç |
|--------|--------|--------|------|
| **mqtt** | ‚úÖ Running | ‚úÖ Healthy | 1883 |
| **redis** | ‚úÖ Running | ‚úÖ Healthy | 6379 |
| **db** | ‚úÖ Running | ‚úÖ Healthy | 5432 |
| **laravel** | ‚úÖ Running | ‚úÖ Healthy | 8080 |

---

## üîó –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ MQTT

### –¢–æ–ø–∏–∫–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

#### 1. automation-engine ‚Üí –£–∑–ª—ã
- **–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥:** `hydro/{gh_uid}/zn-{zone_id}/{node_uid}/{channel}/command`
- **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç—ã:** `hydro/+/+/+/+/command_response`

**–ü—Ä–∏–º–µ—Ä:**
```json
{
  "cmd": "set_ph",
  "params": {"value": 6.5}
}
```

#### 2. history-logger ‚Üí –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è
- **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é:** `hydro/+/+/+/+/telemetry`
- **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç—ã:** `hydro/+/+/+/+/command_response`
- **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:** `hydro/+/+/+/config_response`

**–§–æ—Ä–º–∞—Ç —Ç–æ–ø–∏–∫–∞:** `hydro/{gh_uid}/{zone_uid}/{node_uid}/{channel}/telemetry`

#### 3. scheduler ‚Üí –ö–æ–º–∞–Ω–¥—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- **–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥:** `hydro/{gh_uid}/zn-{zone_id}/{node_uid}/{channel}/command`

**–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥:**
- –ü–æ–ª–∏–≤: `{"cmd": "pump_on", "params": {"duration": 300}}`
- –û—Å–≤–µ—â–µ–Ω–∏–µ: `{"cmd": "light_on", "params": {"duration": 3600}}`

#### 4. mqtt-bridge ‚Üí REST ‚Üí MQTT
- **–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥:** `hydro/{gh_uid}/zn-{zone_id}/{node_uid}/{channel}/command`
- **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é:** `hydro/+/+/+/+/telemetry`

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 1. MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ automation-engine –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
- ‚úÖ history-logger –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
- ‚úÖ scheduler –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
- ‚úÖ mqtt-bridge –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MQTT –±—Ä–æ–∫–µ—Ä—É

### 2. –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ–ø–∏–∫–∏
- ‚úÖ automation-engine –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ `hydro/+/+/+/+/command_response`
- ‚úÖ history-logger –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞:
  - `hydro/+/+/+/+/telemetry`
  - `hydro/+/+/+/+/command_response`
  - `hydro/+/+/+/config_response`

### 3. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
- ‚úÖ automation-engine –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ pH/EC
- ‚úÖ scheduler –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–ø–æ–ª–∏–≤, –æ—Å–≤–µ—â–µ–Ω–∏–µ)
- ‚úÖ mqtt-bridge –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏–∑ REST API

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- ‚úÖ history-logger –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ Redis –æ—á–µ—Ä–µ–¥—å
- ‚úÖ history-logger –±–∞—Ç—á-–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –≤ PostgreSQL
- ‚úÖ automation-engine –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

---

## üîç –ú–µ—Ç—Ä–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### automation-engine
```prometheus
# –ö–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
automation_commands_sent_total{zone_id="1", metric="set_ph"} 0.0

# –û—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ MQTT
mqtt_publish_errors_total{error_type="not_connected"} 0.0

# –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω
zone_processing_time_seconds_count 0.0
```

### history-logger
```prometheus
# –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è –ø–æ–ª—É—á–µ–Ω–∞
telemetry_received_total{zone_id="1", metric="ph"} 0.0

# –û—á–µ—Ä–µ–¥—å Redis
redis_queue_size{queue="telemetry"} 0.0
```

### scheduler
```prometheus
# –†–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
schedules_executed_total{type="irrigation"} 0.0
```

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. MQTT —Å–µ—Ä–≤–∏—Å –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω
**–ü—Ä–æ–±–ª–µ–º–∞:** automation-engine –∏ scheduler –ø–∞–¥–∞–ª–∏ —Å –æ—à–∏–±–∫–æ–π `name resolution` –¥–ª—è `mqtt:1883`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker compose -f docker-compose.dev.yml up -d mqtt
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 2. Redis —Å–µ—Ä–≤–∏—Å –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω
**–ü—Ä–æ–±–ª–µ–º–∞:** history-logger –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π `name resolution` –¥–ª—è `redis:6379`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker compose -f docker-compose.dev.yml up -d redis
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±—ã–ª–∏ –≥–æ—Ç–æ–≤—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã health checks –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞:
1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: `mqtt`, `redis`, `db`
2. Laravel API: `laravel`
3. Python —Å–µ—Ä–≤–∏—Å—ã: `mqtt-bridge`, `history-logger`, `automation-engine`, `scheduler`, `digital-twin`, `telemetry-aggregator`

### 2. Health checks
–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç health checks, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º (MQTT, DB, Redis)
- –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å:
- `mqtt_publish_errors_total` - –æ—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ MQTT
- `command_success_total` vs `command_failure_total` - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥
- `telemetry_received_total` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–π —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- `zone_processing_time_seconds` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–æ–Ω

### 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç:
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT
- –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ–ø–∏–∫–∏
- –ü—É–±–ª–∏–∫–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥
- –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**

- ‚úÖ automation-engine –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é —á–µ—Ä–µ–∑ history-logger
- ‚úÖ automation-engine –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
- ‚úÖ scheduler –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- ‚úÖ history-logger –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ë–î
- ‚úÖ mqtt-bridge –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç REST ‚Üí MQTT –º–æ—Å—Ç
- ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
- ‚úÖ –í—Å–µ health checks –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

---

**–û—Ç—á–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 2025-12-11  
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã


