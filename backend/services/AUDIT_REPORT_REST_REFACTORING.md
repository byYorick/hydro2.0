# –û—Ç—á–µ—Ç –æ–± –∞—É–¥–∏—Ç–µ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ REST API

**–î–∞—Ç–∞:** 2025-12-11  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

---

## üìã –ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –∞—É–¥–∏—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ –∏–º–ø–æ—Ä—Ç–æ–≤
- ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –õ–∏–Ω—Ç–µ—Ä –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –æ—à–∏–±–æ–∫

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏

#### 2.1 History-logger
- ‚úÖ Endpoint `/commands` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (`cmd` –∏ `type`)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –¥–æ–±–∞–≤–ª–µ–Ω—ã
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `trace_id` —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–∏–ø –ø–æ–ª—è `type` –≤ `CommandRequest` —Å `str = Field(None, ...)` –Ω–∞ `Optional[str] = Field(None, ...)`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `req.get_command_name()` –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º payload
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `ValueError` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ payload

#### 2.2 Automation-engine
- ‚úÖ `CommandBus` –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ REST API history-logger
- ‚úÖ FastAPI endpoint `/scheduler/command` –¥–æ–±–∞–≤–ª–µ–Ω
- ‚úÖ FastAPI —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ —Å –Ω–æ–≤—ã–º event loop
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –æ–±–Ω–æ–≤–ª–µ–Ω—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç: `get_logging_context()` ‚Üí `get_trace_id()` (—Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—É—Å–∫ FastAPI: —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π event loop –¥–ª—è –ø–æ—Ç–æ–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON –æ—Ç–≤–µ—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ `response.text`

#### 2.3 Scheduler
- ‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ REST API —á–µ—Ä–µ–∑ automation-engine
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `send_command_via_automation_engine()` –¥–æ–±–∞–≤–ª–µ–Ω–∞
- ‚úÖ –£–±—Ä–∞–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `mqtt` –∏ `gh_uid` –∏–∑ —Ñ—É–Ω–∫—Ü–∏–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `monitor_pump_safety()` - —É–±—Ä–∞–Ω—ã `mqtt` –∏ `gh_uid`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `execute_irrigation_schedule()` - —É–±—Ä–∞–Ω—ã `mqtt` –∏ `gh_uid`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `execute_lighting_schedule()` - —É–±—Ä–∞–Ω—ã `mqtt` –∏ `gh_uid`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ `check_and_execute_schedules()` - —É–±—Ä–∞–Ω `mqtt`
- –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π `gh_uid` –∏–∑ `check_and_execute_schedules()`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ `response.text`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:**
- `check_water_changes()` –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MQTT, —Ç–∞–∫ –∫–∞–∫ `execute_water_change()` –≤ `common/water_cycle.py` —Ç—Ä–µ–±—É–µ—Ç MQTT. –≠—Ç–æ –æ–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∏ –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.

#### 2.4 MQTT ACL
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: —Ç–æ–ª—å–∫–æ history-logger –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ automation-engine –∏ scheduler –Ω–µ –º–æ–≥—É—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

#### 3.1 Automation-engine
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `requirements.txt`:
  - `fastapi==0.115.4`
  - `uvicorn==0.32.0`
  - `pydantic==2.9.2`

#### 3.2 History-logger
- ‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∂–µ –±—ã–ª–∏ –≤ `requirements.txt`

#### 3.3 Scheduler
- ‚úÖ `httpx` —É–∂–µ –±—ã–ª –≤ `requirements.txt`

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –ø–æ–ª—è –≤ CommandRequest
**–ü—Ä–æ–±–ª–µ–º–∞:** `type: str = Field(None, ...)` - –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
type: Optional[str] = Field(None, max_length=64, description="Command type (legacy)")
```

### 2. –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è get_logging_context()
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `command_bus.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å `get_logging_context()`, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
from utils.logging_context import get_logging_context
context = get_logging_context()
trace_id = context.get("trace_id")

# –°—Ç–∞–ª–æ:
from utils.logging_context import get_trace_id
trace_id = get_trace_id()
```

### 3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—É—Å–∫–æ–º FastAPI –≤ –ø–æ—Ç–æ–∫–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio.run()` –≤ –ø–æ—Ç–æ–∫–µ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å event loop

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
def run_api_server():
    import sys
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π event loop –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ç–æ–∫–∞
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    # ...
    try:
        loop.run_until_complete(server.serve())
    except Exception as e:
        logger.error(f"FastAPI server error: {e}", exc_info=True)
        sys.exit(1)
```

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON
**–ü—Ä–æ–±–ª–µ–º–∞:** `response.json()` –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º JSON

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
try:
    result = response.json()
    # ...
except Exception as e:
    error_type = "json_decode_error"
    REST_PUBLISH_ERRORS.labels(error_type=error_type).inc()
    logger.error(...)
    return False
```

### 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ response.text
**–ü—Ä–æ–±–ª–µ–º–∞:** `response.text` –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
try:
    error_msg = response.text
except Exception:
    error_msg = f"HTTP {response.status_code}"
```

### 6. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö scheduler
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞–ª–∏ `mqtt` –∏ `gh_uid`, –Ω–æ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∏—Ö

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±—Ä–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ —Å–∏–≥–Ω–∞—Ç—É—Ä —Ñ—É–Ω–∫—Ü–∏–π
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π

### 7. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç httpx –≤ api.py
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª—Å—è `httpx`, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±—Ä–∞–Ω –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥
```
Scheduler ‚Üí REST ‚Üí Automation-Engine ‚Üí REST ‚Üí History-Logger ‚Üí MQTT ‚Üí –ù–æ–¥—ã
                                                                    ‚Üì
                                                              Command Response
                                                                    ‚Üì
                                                              History-Logger ‚Üí –ë–î/Redis
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

1. **Scheduler ‚Üí Automation-Engine:**
   - ‚úÖ Endpoint: `POST /scheduler/command`
   - ‚úÖ –§–æ—Ä–º–∞—Ç: `{"zone_id": 1, "node_uid": "...", "channel": "...", "cmd": "...", "params": {...}}`
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –µ—Å—Ç—å

2. **Automation-Engine ‚Üí History-Logger:**
   - ‚úÖ Endpoint: `POST /commands`
   - ‚úÖ –§–æ—Ä–º–∞—Ç: `{"cmd": "...", "greenhouse_uid": "...", "zone_id": 1, "node_uid": "...", "channel": "...", "params": {...}, "trace_id": "..."}`
   - ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: Bearer token
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –µ—Å—Ç—å

3. **History-Logger ‚Üí MQTT:**
   - ‚úÖ –¢–æ–ø–∏–∫: `hydro/{gh_uid}/zn-{zone_id}/{node_uid}/{channel}/command`
   - ‚úÖ Payload: `{"cmd": "...", "cmd_id": "...", "params": {...}}`
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –µ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫

1. **Automation-Engine:**
   - ‚úÖ `rest_command_errors_total{error_type}` - –æ—à–∏–±–∫–∏ REST –∑–∞–ø—Ä–æ—Å–æ–≤
   - ‚úÖ `command_rest_latency_seconds` - –∑–∞–¥–µ—Ä–∂–∫–∞ REST –∑–∞–ø—Ä–æ—Å–æ–≤
   - ‚úÖ `automation_commands_sent_total{zone_id, metric}` - –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

2. **History-Logger:**
   - ‚úÖ `commands_sent_total{zone_id, metric}` - –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
   - ‚úÖ `mqtt_publish_errors_total{error_type}` - –æ—à–∏–±–∫–∏ MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

3. **Scheduler:**
   - ‚úÖ `scheduler_command_rest_errors_total{error_type}` - –æ—à–∏–±–∫–∏ REST –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ –≤–µ—Å—å —Å—Ç–µ–∫: scheduler ‚Üí automation-engine ‚Üí history-logger ‚Üí MQTT
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Prometheus

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ `rest_command_errors_total`
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ `mqtt_publish_errors_total`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å `command_rest_latency_seconds`

### 3. –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `execute_water_change()` –≤ `common/water_cycle.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è REST API
- –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è REST –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å circuit breaker –¥–ª—è REST –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ history-logger

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

**–í—Å–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**
- ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞
- ‚úÖ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–±—Ä–∞–Ω—ã
- ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!** üöÄ

