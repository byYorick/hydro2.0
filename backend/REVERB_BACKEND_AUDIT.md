# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç Reverb –Ω–∞ –±—ç–∫–µ–Ω–¥–µ

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 2024  
**–û–±–ª–∞—Å—Ç—å:** Laravel Reverb (WebSocket —Å–µ—Ä–≤–µ—Ä)  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | üü° –í–∞–∂–Ω–æ | üü¢ –ù–∏–∑–∫–∞—è

---

## üìã –û–ë–ó–û–† –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Reverb

**–§–∞–π–ª:** `backend/laravel/config/reverb.php`

```php
'servers' => [
    'reverb' => [
        'host' => '0.0.0.0',
        'port' => 6001,
        'max_request_size' => 10_000,
        'scaling' => [
            'enabled' => false, // ‚ùå –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
        ],
    ],
],

'apps' => [
    [
        'key' => env('REVERB_APP_KEY'),
        'secret' => env('REVERB_APP_SECRET'),
        'app_id' => env('REVERB_APP_ID'),
        'allowed_origins' => ['*'], // ‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω –ª—é–±–æ–π origin
        'ping_interval' => 30, // —Å–µ–∫—É–Ω–¥
        'activity_timeout' => 60, // —Å–µ–∫—É–Ω–¥
        'max_connections' => null, // ‚ùå –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        'max_message_size' => 10_000, // –±–∞–π—Ç
    ],
],
```

### –ó–∞–ø—É—Å–∫ Reverb

**–§–∞–π–ª:** `backend/laravel/reverb-supervisor.conf`

```ini
[program:reverb]
command=php /app/artisan reverb:start --host=0.0.0.0 --port=6001
autostart=true
autorestart=true
stdout_logfile=/tmp/reverb.log
```

**–§–∞–π–ª:** `backend/laravel/docker-entrypoint.sh:121-125`

Reverb –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Supervisor –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –°–æ–±—ã—Ç–∏—è `CommandStatusUpdated` –∏ `CommandFailed` –ù–ï –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–¥–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ–±—ã—Ç–∏—è `CommandStatusUpdated` –∏ `CommandFailed` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `app/Events/`
- –ù–æ –Ω–∏–≥–¥–µ –≤ –∫–æ–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏—Ö –≤—ã–∑–æ–≤–∞ —á–µ—Ä–µ–∑ `event(new CommandStatusUpdated(...))`
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è, –Ω–æ –æ–Ω–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

**–§–∞–π–ª—ã:**
- `backend/laravel/app/Events/CommandStatusUpdated.php` ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç
- `backend/laravel/app/Events/CommandFailed.php` ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç
- `backend/laravel/resources/js/composables/useWebSocket.ts` ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å
- ‚ùå **–ù–µ—Ç –≤—ã–∑–æ–≤–æ–≤ `event(new CommandStatusUpdated(...))` –≤ –∫–æ–¥–µ**

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–º–∞–Ω–¥
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
- –û—à–∏–±–∫–∏ –∫–æ–º–∞–Ω–¥ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã —Å–æ–±—ã—Ç–∏–π –≤ –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã:
- –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö –∫–æ–º–∞–Ω–¥
- –í —Å–µ—Ä–≤–∏—Å–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
- –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç Python-—Å–µ—Ä–≤–∏—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```php
// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã
event(new CommandStatusUpdated(
    commandId: $command->id,
    status: 'pending',
    zoneId: $zone->id
));

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Python-—Å–µ—Ä–≤–∏—Å–∞
event(new CommandStatusUpdated(
    commandId: $command->id,
    status: 'completed',
    message: 'Command executed successfully',
    zoneId: $zone->id
));

// –ü—Ä–∏ –æ—à–∏–±–∫–µ
event(new CommandFailed(
    commandId: $command->id,
    message: 'Command failed',
    error: $errorMessage,
    zoneId: $zone->id
));
```

---

### 2. –°–æ–±—ã—Ç–∏–µ `EventCreated` –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ–±—ã—Ç–∏–µ `EventCreated` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ `app/Events/EventCreated.php`
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª `events.global` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç—Ç–∏—Ö —Å–æ–±—ã—Ç–∏–π
- –ù–æ –Ω–∏–≥–¥–µ –≤ –∫–æ–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤—ã–∑–æ–≤–∞ `event(new EventCreated(...))`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ WebSocket

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã `EventCreated` –≤ –º–µ—Å—Ç–∞—Ö —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π –≤ `zone_events`
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –ü—Ä–∏ –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–§–∞–π–ª:** `backend/laravel/config/reverb.php:88`

```php
'max_connections' => env('REVERB_APP_MAX_CONNECTIONS'), // null –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç DDoS –∞—Ç–∞–∫ —á–µ—Ä–µ–∑ WebSocket

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
- –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```php
'max_connections' => env('REVERB_APP_MAX_CONNECTIONS', 1000), // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑—É–º–Ω—ã–π –ª–∏–º–∏—Ç
```

---

### 4. `allowed_origins: ['*']` - —Ä–∞–∑—Ä–µ—à–µ–Ω –ª—é–±–æ–π origin

**–§–∞–π–ª:** `backend/laravel/config/reverb.php:85`

```php
'allowed_origins' => ['*'], // ‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω –ª—é–±–æ–π origin
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –õ—é–±–æ–π —Å–∞–π—Ç –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ CORS
- –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –º–µ–∂—Å–∞–π—Ç–æ–≤—ã—Ö –∞—Ç–∞–∫

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Å–∞–π—Ç–æ–≤
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```php
'allowed_origins' => [
    env('APP_URL', 'http://localhost'),
    env('FRONTEND_URL', 'http://localhost:5173'),
    // –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã
],
```

---

## üü° –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 5. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ (`scaling.enabled = false`)

**–§–∞–π–ª:** `backend/laravel/config/reverb.php:41`

```php
'scaling' => [
    'enabled' => env('REVERB_SCALING_ENABLED', false), // ‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ
],
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ Laravel) —Å–æ–±—ã—Ç–∏—è –Ω–µ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
- –ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç–∞–Ω—Å Reverb —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
- –ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –Ω–µ –ø–æ–ª—É—á–∞—Ç —Å–æ–±—ã—Ç–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
- –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ load balancer

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–î–ª—è production —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å scaling —á–µ—Ä–µ–∑ Redis:
```php
'scaling' => [
    'enabled' => env('REVERB_SCALING_ENABLED', true),
    'channel' => env('REVERB_SCALING_CHANNEL', 'reverb'),
    'server' => [
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'port' => env('REDIS_PORT', '6379'),
        // ...
    ],
],
```

---

### 6. –°–æ–±—ã—Ç–∏—è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—á–µ—Ä–µ–¥–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í—Å–µ —Å–æ–±—ã—Ç–∏—è —Ä–µ–∞–ª–∏–∑—É—é—Ç `ShouldBroadcast`, –Ω–æ –Ω–µ `ShouldQueue`
- –°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –±–ª–æ–∫–∏—Ä—É—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å Reverb –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª—è—Ç—å—Å—è

**–ü—Ä–∏–º–µ—Ä:**
```php
class CommandStatusUpdated implements ShouldBroadcast // ‚ùå –ù–µ—Ç ShouldQueue
{
    // ...
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å WebSocket
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Reverb
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ShouldBroadcastNow` –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –∏–ª–∏ `ShouldQueue` –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö:
```php
use Illuminate\Contracts\Broadcasting\ShouldBroadcastNow;

class CommandStatusUpdated implements ShouldBroadcastNow // ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
{
    // ...
}
```

–ò–ª–∏ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏:
```php
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;

class CommandStatusUpdated implements ShouldBroadcast, ShouldQueue
{
    // ...
}
```

---

### 7. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Reverb

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `event(new ...)` –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Reverb
- –ï—Å–ª–∏ Reverb –Ω–µ –∑–∞–ø—É—â–µ–Ω, —Å–æ–±—ã—Ç–∏—è —Ç–µ—Ä—è—é—Ç—Å—è –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ù–µ—Ç fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –¢–∏—Ö–∞—è –ø–æ—Ç–µ—Ä—è —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å Reverb
- –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ broadcasting:
```php
try {
    event(new CommandStatusUpdated(...));
} catch (\Exception $e) {
    Log::error('Failed to broadcast event', [
        'event' => 'CommandStatusUpdated',
        'error' => $e->getMessage(),
    ]);
    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
}
```

---

### 8. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ö–æ—Å—Ç–∞ –∏ –ø–æ—Ä—Ç–∞

**–§–∞–π–ª:** `backend/laravel/config/reverb.php`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```php
'servers' => [
    'reverb' => [
        'host' => env('REVERB_SERVER_HOST', '0.0.0.0'), // ‚ùå REVERB_SERVER_HOST
        'port' => env('REVERB_SERVER_PORT', 6001),      // ‚ùå REVERB_SERVER_PORT
        'hostname' => env('REVERB_HOST', '0.0.0.0'),    // ‚ùå REVERB_HOST (–¥—É–±–ª–∏–∫–∞—Ç)
    ],
],

'apps' => [
    [
        'options' => [
            'host' => env('REVERB_HOST', '0.0.0.0'),    // ‚ùå REVERB_HOST
            'port' => env('REVERB_PORT', 6001),         // ‚ùå REVERB_PORT (–¥—É–±–ª–∏–∫–∞—Ç)
        ],
    ],
],
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ
- `REVERB_SERVER_HOST` vs `REVERB_HOST`
- `REVERB_SERVER_PORT` vs `REVERB_PORT`
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```php
'servers' => [
    'reverb' => [
        'host' => env('REVERB_HOST', '0.0.0.0'),
        'port' => env('REVERB_PORT', 6001),
        'hostname' => env('REVERB_HOST', '0.0.0.0'),
    ],
],
```

---

## üü¢ –ù–ò–ó–ö–ê–Ø –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨ / –£–õ–£–ß–®–ï–ù–ò–Ø

### 9. –õ–æ–≥–∏ Reverb –≤ `/tmp/reverb.log` –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã

**–§–∞–π–ª:** `backend/laravel/reverb-supervisor.conf:12`

```ini
stdout_logfile=/tmp/reverb.log
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `/tmp`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—á–∏—â–∞—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- –ù–µ—Ç —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
- –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Ä–æ—Ç–∞—Ü–∏—é:
```ini
stdout_logfile=/var/log/reverb/reverb.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
```

---

### 10. –ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Reverb

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ—Ç health check endpoint –¥–ª—è Reverb

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- Prometheus –º–µ—Ç—Ä–∏–∫–∏
- Health check endpoint
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

---

### 11. `max_message_size` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º

**–§–∞–π–ª:** `backend/laravel/config/reverb.php:89`

```php
'max_message_size' => env('REVERB_APP_MAX_MESSAGE_SIZE', 10_000), // 10 KB
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–æ–Ω—ã) –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç
- –°–æ–±—ã—Ç–∏—è —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
–£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
```php
'max_message_size' => env('REVERB_APP_MAX_MESSAGE_SIZE', 100_000), // 100 KB
```

---

## üìä –°–í–û–î–ö–ê –°–û–ë–´–¢–ò–ô

### –°–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Reverb:

| –°–æ–±—ã—Ç–∏–µ | –ö–∞–Ω–∞–ª | –¢–∏–ø | –í—ã–∑—ã–≤–∞–µ—Ç—Å—è? |
|---------|-------|-----|-------------|
| `ZoneUpdated` | `hydro.zones.{id}` | Private | ‚úÖ –î–∞ (ZoneService) |
| `NodeConfigUpdated` | `hydro.devices` | Public | ‚úÖ –î–∞ (NodeService, Models) |
| `AlertCreated` | `hydro.alerts` | Public | ‚úÖ –î–∞ (AlertService) |
| `CommandStatusUpdated` | `commands.{zoneId}` | Private | ‚ùå **–ù–ï–¢** |
| `CommandFailed` | `commands.{zoneId}` | Private | ‚ùå **–ù–ï–¢** |
| `EventCreated` | `events.global` | Public | ‚ùå **–ù–ï–¢** |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã —Å–æ–±—ã—Ç–∏–π –∫–æ–º–∞–Ω–¥** (#1, #2)
   - –ù–∞–π—Ç–∏ –º–µ—Å—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
   - –î–æ–±–∞–≤–∏—Ç—å `event(new CommandStatusUpdated(...))`
   - –î–æ–±–∞–≤–∏—Ç—å `event(new CommandFailed(...))`
   - –î–æ–±–∞–≤–∏—Ç—å `event(new EventCreated(...))`

2. **–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å `allowed_origins`** (#4)
   - –£–±—Ä–∞—Ç—å `['*']`
   - –£–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã

3. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `max_connections`** (#3)
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑—É–º–Ω—ã–π –ª–∏–º–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000)

### –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:

4. **–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ broadcasting** (#7)
5. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** (#8)
6. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π –¥–ª—è —Å–æ–±—ã—Ç–∏–π** (#6)

### –£–ª—É—á—à–µ–Ω–∏—è:

7. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** (#5) - –µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
8. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** (#9)
9. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** (#10)
10. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π** (#11)

---

## üîç –ú–ï–°–¢–ê –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–û–ë–´–¢–ò–ô

### CommandStatusUpdated / CommandFailed

–ò—Å–∫–∞—Ç—å –≤:
- `app/Http/Controllers/*CommandController.php`
- `app/Services/*CommandService.php`
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç Python-—Å–µ—Ä–≤–∏—Å–æ–≤
- –ú–µ—Å—Ç–∞, –≥–¥–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –∫–æ–º–∞–Ω–¥—ã –≤ –ë–î

### EventCreated

–ò—Å–∫–∞—Ç—å –≤:
- `app/Services/*Service.php` - –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π –≤ `zone_events`
- `app/Models/ZoneEvent.php` - –≤ observer –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
- –ú–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

---

## üìù –ü–†–ò–ú–ï–†–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –ü—Ä–∏–º–µ—Ä 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥—ã

```php
// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–µ
public function sendCommand(int $zoneId, string $command, array $params)
{
    $command = Command::create([
        'zone_id' => $zoneId,
        'command' => $command,
        'params' => $params,
        'status' => 'pending',
    ]);
    
    // ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
    event(new CommandStatusUpdated(
        commandId: $command->id,
        status: 'pending',
        message: 'Command queued',
        zoneId: $zoneId
    ));
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã...
    
    return $command;
}
```

### –ü—Ä–∏–º–µ—Ä 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

```php
// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Python-—Å–µ—Ä–≤–∏—Å–∞
public function handleCommandResponse(int $commandId, array $response)
{
    $command = Command::find($commandId);
    
    if ($response['status'] === 'success') {
        $command->update(['status' => 'completed']);
        
        // ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
        event(new CommandStatusUpdated(
            commandId: $commandId,
            status: 'completed',
            message: $response['message'] ?? 'Command completed',
            zoneId: $command->zone_id
        ));
    } else {
        $command->update(['status' => 'failed']);
        
        // ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –æ–± –æ—à–∏–±–∫–µ
        event(new CommandFailed(
            commandId: $commandId,
            message: $response['message'] ?? 'Command failed',
            error: $response['error'] ?? null,
            zoneId: $command->zone_id
        ));
    }
}
```

---

**–ê–≤—Ç–æ—Ä –∞—É–¥–∏—Ç–∞:** AI Assistant  
**–î–∞—Ç–∞:** 2024

