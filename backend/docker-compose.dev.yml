version: "3.9"
services:
  mqtt:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
    volumes:
      - ./services/mqtt-bridge/mosquitto.dev.conf:/mosquitto/config/mosquitto.conf:ro
  db:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_PASSWORD: hydro
      POSTGRES_USER: hydro
      POSTGRES_DB: hydro_dev
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - wal_archive:/wal_archive
    # WAL архивирование отключено в dev окружении для упрощения
    # В production используйте правильную команду архивирования
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  laravel:
    build:
      context: ./laravel
      dockerfile: Dockerfile
    working_dir: /app
    # docker-entrypoint.sh will handle supervisor startup automatically
    # Base image will start nginx/php-fpm via its default entrypoint
    environment:
      - WEB_DOCUMENT_ROOT=/app/public
      - APP_ENV=local
      - APP_DEBUG=1
      - SESSION_DRIVER=file
      - CACHE_DRIVER=file
      - LOG_CHANNEL=stderr
      - LOG_LEVEL=debug
      - BROADCAST_DRIVER=reverb
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=hydro_dev
      - DB_USERNAME=hydro
      - DB_PASSWORD=hydro
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REVERB_APP_ID=app
      - REVERB_APP_KEY=local
      - REVERB_APP_SECRET=secret
      - REVERB_HOST=0.0.0.0
      - REVERB_PORT=6001
      - REVERB_SCHEME=http
      - REVERB_DEBUG=true
      - REVERB_AUTO_START=true
      - VITE_DEV_SERVER_URL=http://localhost:5173
      # Vite environment variables for WebSocket
      - VITE_ENABLE_WS=true
      - VITE_REVERB_APP_KEY=local
      - VITE_REVERB_HOST=localhost
      - VITE_REVERB_PORT=6001
      - VITE_REVERB_SCHEME=http
      - VITE_PUSHER_APP_KEY=local
      - VITE_WS_HOST=localhost
      - VITE_WS_PORT=6001
      - VITE_WS_TLS=false
      # PHP opcache settings for development (disable caching)
      - PHP_OPCACHE_ENABLE=0
      - PHP_OPCACHE_VALIDATE_TIMESTAMPS=1
      - PHP_OPCACHE_REVALIDATE_FREQ=0
      # PHP-FPM оптимизация для снижения нагрузки на CPU
      - PHP_FPM_PM=dynamic
      - PHP_FPM_PM_MAX_CHILDREN=5
      - PHP_FPM_PM_START_SERVERS=2
      - PHP_FPM_PM_MIN_SPARE_SERVERS=1
      - PHP_FPM_PM_MAX_SPARE_SERVERS=3
      - PHP_FPM_PM_MAX_REQUESTS=500
    volumes:
      - ./laravel:/app
    ports:
      - "8080:80"
      - "5173:5173"
      - "6001:6001"
    depends_on:
      - db
      - redis
  mqtt-bridge:
    build:
      context: ./services
      dockerfile: mqtt-bridge/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - PG_HOST=db
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
      - LARAVEL_API_URL=http://laravel
    depends_on:
      - mqtt
      - db
      - laravel
    ports:
      - "9000:9000"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect((\"localhost\", 9000)); s.close()' || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
  history-logger:
    build:
      context: ./services
      dockerfile: history-logger/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - PG_HOST=db
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
      - LARAVEL_API_URL=http://laravel
      - LARAVEL_API_TOKEN=
    depends_on:
      - mqtt
      - db
      - laravel
    ports:
      - "9300:9300"
      - "9301:9301"  # Prometheus metrics
  automation-engine:
    build:
      context: ./services
      dockerfile: automation-engine/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - PG_HOST=db
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
      - LARAVEL_API_URL=http://laravel
      - LARAVEL_API_TOKEN=
    depends_on:
      - mqtt
      - db
      - laravel
    ports:
      - "9401:9401"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect((\"localhost\", 9401)); s.close()' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
  scheduler:
    build:
      context: ./services
      dockerfile: scheduler/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - PG_HOST=db
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
    depends_on:
      - mqtt
      - db
    ports:
      - "9402:9402"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect((\"localhost\", 9402)); s.close()' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./configs/dev/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./configs/dev/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - automation-engine
      - scheduler
      - mqtt-bridge
    restart: unless-stopped
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
      - GF_DEFAULT_LANGUAGE=ru
      - GF_USERS_DEFAULT_LANGUAGE=ru
    volumes:
      - ./configs/dev/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./configs/dev/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./configs/dev/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - db
    restart: unless-stopped
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./configs/dev/alertmanager/config.yml:/etc/alertmanager/config.yml:ro
      - alertmanager_data:/alertmanager
    ports:
      - "9093:9093"
    depends_on:
      - prometheus
      - laravel
    restart: unless-stopped

  digital-twin:
    build:
      context: ./services
      dockerfile: digital-twin/Dockerfile
    environment:
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
      - PYTHONPATH=/app
    depends_on:
      - db
    ports:
      - "8003:8003"
      - "9403:9403"  # Prometheus metrics
    restart: unless-stopped

  telemetry-aggregator:
    build:
      context: ./services
      dockerfile: telemetry-aggregator/Dockerfile
    environment:
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
      - PYTHONPATH=/app
    depends_on:
      - db
    ports:
      - "9404:9404"  # Prometheus metrics
    restart: unless-stopped

  python-tests:
    build:
      context: ./services
      dockerfile: Dockerfile.test
    environment:
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DB=hydro_dev
      - PG_USER=hydro
      - PG_PASS=hydro
      - PYTHONPATH=/app
    depends_on:
      - db
    volumes:
      - ./services:/app
    profiles:
      - tests
    command: ["python", "-m", "pytest", "common/test_metrics.py", "common/test_alerts.py", "common/test_telemetry_phase2.py", "automation-engine/test_alerts_manager_phase2.py", "-v"]

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  alertmanager_data:
  wal_archive:


