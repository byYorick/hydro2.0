# Найденные баги в цепочке MQTT команд

## Критические баги (ИСПРАВЛЕНО)

### БАГ #1: zone_uid не передается в publish_command
**Проблема:**
- В `publisher.py` функция `publish_command` пыталась получить `zone_uid` из `payload.get("zone_uid")`
- Но `payload` содержит только `{"cmd": "...", "cmd_id": "...", "params": {...}}`
- `zone_uid` там нет!

**Последствия:**
- Если `mqtt_zone_format = "uid"`, то всегда использовался `zn-{zone_id}`
- Нода подписывается на `hydro/{gh_uid}/{zone_uid}/{node_uid}/+/command`
- Если `zone_uid != zn-{zone_id}`, команда не дойдет до ноды

**Исправление:**
- Добавлен параметр `zone_uid` в `publish_command`
- В `main.py` добавлено получение `zone_uid` из БД, если `mqtt_zone_format = "uid"`
- Передается `zone_uid` в `publish_command`

### БАГ #2: Отсутствие проверки подключения MQTT в publish_command
**Проблема:**
- В `publish_command` не было проверки подключения MQTT
- В отличие от `publish_config`, где есть проверка и переподключение

**Последствия:**
- Если MQTT клиент отключен, команда не будет опубликована
- Ошибка будет молча проигнорирована

**Исправление:**
- Добавлена проверка подключения MQTT
- Добавлена логика переподключения при необходимости
- Добавлена обработка ошибок с try-except блоком

### БАГ #3: Отсутствие валидации входных параметров
**Проблема:**
- Не проверялись пустые `gh_uid`, `node_uid`, `channel`
- Могли создаваться неправильные топики типа `hydro///node-temp/...`

**Исправление:**
- Добавлена валидация входных параметров
- Проверка на пустые значения перед публикацией

## Потенциальные проблемы

### ПРОБЛЕМА #1: Пустые идентификаторы в топиках
**Описание:**
- Если `gh_uid`, `zone_uid` или `node_uid` пустые, топик будет `hydro///node-temp/...`
- MQTT wildcard может не работать правильно с пустыми сегментами

**Статус:** Требует тестирования
- Временные идентификаторы (`gh-temp`, `zn-temp`) должны использоваться вместо пустых
- Нужно проверить, что нода всегда имеет хотя бы временные идентификаторы

### ПРОБЛЕМА #2: Несоответствие zone_segment при mqtt_zone_format="uid"
**Описание:**
- Если `mqtt_zone_format = "uid"`, но `zone_uid` не найден в БД, используется `zn-{zone_id}`
- Нода может подписаться на `{zone_uid}` из конфига, и они не совпадут

**Статус:** Частично исправлено
- Добавлено предупреждение в лог
- Нужно убедиться, что все зоны имеют `uid`

### ПРОБЛЕМА #3: Дублирование публикации команд
**Описание:**
- Команды публикуются на два топика (основной и временный)
- Это может привести к двойной обработке команды нодой

**Статус:** По дизайну
- Нода должна обрабатывать команду только один раз (по `cmd_id`)
- Нужно проверить дедупликацию команд в прошивке

## Рекомендации

1. **Тестирование:**
   - Протестировать публикацию команд с разными комбинациями идентификаторов
   - Проверить работу с пустыми идентификаторами
   - Проверить работу с `mqtt_zone_format = "uid"`

2. **Мониторинг:**
   - Добавить метрики для публикации команд
   - Логировать все публикации команд
   - Отслеживать ошибки публикации

3. **Валидация:**
   - Убедиться, что все зоны имеют `uid`
   - Проверить, что ноды всегда имеют хотя бы временные идентификаторы

