# PHASE 3 - –û—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

–î–∞—Ç–∞: 2025-12-25

## ‚úÖ PHASE 3: –°–µ–Ω—Å–æ—Ä—ã –∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è (–µ–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–æ—Å—Ç—É)

### –í—ã–ø–æ–ª–Ω–µ–Ω–æ

#### 3.1. –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ sensors

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `2025_12_25_151718_create_sensors_table.php`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `greenhouse_id` (FK NOT NULL) - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å —Å —Ç–µ–ø–ª–∏—Ü–µ–π
- `zone_id` (FK nullable) - NULL –¥–ª—è —Ç–µ–ø–ª–∏—á–Ω—ã—Ö/–Ω–∞—Ä—É–∂–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
- `node_id` (FK nullable) - –µ—Å–ª–∏ –¥–∞—Ç—á–∏–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–∞ –Ω–æ–¥–µ
- `scope` (enum: inside|outside) - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
- `type` (enum) - —Ç–∏–ø—ã —Å–µ–Ω—Å–æ—Ä–æ–≤: TEMPERATURE, HUMIDITY, CO2, PH, EC, –∏ —Ç.–¥.
- `label` - —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
- `unit` - –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
- `specs` (jsonb) - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- `is_active` - —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `last_read_at` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á—Ç–µ–Ω–∏—è

**–ò–Ω–¥–µ–∫—Å—ã:**
- `(zone_id)` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–æ–Ω–µ
- `(greenhouse_id, scope)` - –¥–ª—è —Ç–µ–ø–ª–∏—á–Ω—ã—Ö/–Ω–∞—Ä—É–∂–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
- `(greenhouse_id, type)` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É
- `(node_id)` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–æ–¥–µ
- `(is_active)` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö

**–ú–æ–¥–µ–ª—å:** `Sensor` —Å relationships –∏ scopes

#### 3.2. –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ telemetry_samples —Å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `2025_12_25_151719_create_telemetry_samples_table.php`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `sensor_id` (FK) - —Å–≤—è–∑—å —Å sensors (–∑–∞–º–µ–Ω—è–µ—Ç zone_id, node_id, channel, metric_type)
- `ts` (timestamp) - –≤—Ä–µ–º—è –∏–∑–º–µ—Ä–µ–Ω–∏—è
- `zone_id` (FK nullable) - –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- `cycle_id` (FK nullable) - –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- `value` (decimal 10,4) - –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
- `quality` (enum: GOOD|BAD|UNCERTAIN) - –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö
- `metadata` (jsonb) - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–ò–Ω–¥–µ–∫—Å—ã:**
- `(sensor_id, ts)` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Å–µ–Ω—Å–æ—Ä—É –∏ –≤—Ä–µ–º–µ–Ω–∏
- `(zone_id, ts)` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∑–æ–Ω–µ –∏ –≤—Ä–µ–º–µ–Ω–∏
- `(cycle_id, ts)` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ü–∏–∫–ª—É –∏ –≤—Ä–µ–º–µ–Ω–∏
- `(ts)` - –¥–ª—è –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `(quality)` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É

**–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- SQL —Å–∫—Ä–∏–ø—Ç `telemetry_partitioning.sql` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
- –§—É–Ω–∫—Ü–∏–∏ `create_telemetry_partition()` –∏ `ensure_telemetry_partitions()`
- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ 3 –º–µ—Å—è—Ü–∞ –≤–ø–µ—Ä—ë–¥

**–ú–æ–¥–µ–ª—å:** `TelemetrySample` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

#### 3.3. –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ telemetry_last (–∫—ç—à)

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `2025_12_25_151720_create_telemetry_last_table.php`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- `sensor_id` (PK, FK) - —Å–≤—è–∑—å —Å sensors
- `last_value` (decimal 10,4) - –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- `last_ts` (timestamp) - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è
- `last_quality` (enum) - –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
- `updated_at` - –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ú–æ–¥–µ–ª—å:** `TelemetryLast` —Å relationship –∫ Sensor

#### 3.4. –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã retention –ø–æ–ª–∏—Ç–∏–∫–∏

**SQL —Å–∫—Ä–∏–ø—Ç:** `telemetry_retention.sql`

**–§—É–Ω–∫—Ü–∏–∏:**
- `cleanup_old_telemetry_partitions()` - —É–¥–∞–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π —á–µ—Ä–µ–∑ cron job –∏–ª–∏ Laravel scheduler

**–ü–æ–ª–∏—Ç–∏–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è:**
- Raw –¥–∞–Ω–Ω—ã–µ: 90 –¥–Ω–µ–π
- –ê–≥—Ä–µ–≥–∞—Ç—ã: 1 –≥–æ–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)

## ‚úÖ Acceptance –∫—Ä–∏—Ç–µ—Ä–∏–∏

- ‚úÖ –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Ä—É–∂–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ (zone_id NULL, scope outside)
- ‚úÖ –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–ø–ª–∏—á–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ (zone_id NULL, scope inside)
- ‚úÖ –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∑–æ–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ (zone_id NOT NULL)
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ telemetry_samples –≥–æ—Ç–æ–≤–∞ –∫ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é
- ‚úÖ –ï—Å—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è (90 –¥–Ω–µ–π –¥–ª—è raw –¥–∞–Ω–Ω—ã—Ö)
- ‚úÖ –ï—Å—Ç—å –∫—ç—à –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

PHASE 4: –ö–æ–º–∞–Ω–¥—ã –∏ –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∞–Ω–Ω—ã—Ö)
- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã `commands` –∏ `command_acks`
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (ACK + DONE/ERROR)
- –î–æ–±–∞–≤–∏—Ç—å `request_id` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥

