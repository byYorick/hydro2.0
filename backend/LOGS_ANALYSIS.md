# Анализ логов Grafana и БД

## Логи Grafana

### Найденные проблемы:

1. **Ошибки 400 при запросах к PostgreSQL:**
   ```
   method=POST path=/api/ds/query status=400
   ```
   - Происходят при запросах к datasource
   - Время: 10:35, 10:49, 10:50
   - Размер ответа: 151-311 байт (ошибка)

2. **Ошибки 404 для public dashboards:**
   ```
   GET /api/dashboards/uid/.../public-dashboards status=404
   ```
   - Это нормально, public dashboards не настроены
   - Не влияет на работу обычных dashboards

3. **Предупреждения о плагинах:**
   ```
   Plugin validation failed: grafana-simple-json-datasource
   ```
   - Это нормально, плагин устарел
   - Не влияет на работу

## Логи БД

### Статус:

✅ **БД работает нормально:**
- Нет ошибок
- Только обычные checkpoint логи
- 6 активных подключений (нормально)
- Нет долгих запросов или блокировок

## Проблема: Ошибки 400

Ошибки 400 означают, что запросы к PostgreSQL неправильно сформированы или возвращают данные в неправильном формате.

### Возможные причины:

1. **Неправильный формат времени:**
   - DATE_TRUNC может возвращать не TIMESTAMP
   - Нужно явное приведение `::timestamp`

2. **Неправильный формат значения:**
   - COUNT(*) может быть BIGINT
   - Нужно `::float` для time series

3. **Проблема с GROUP BY:**
   - GROUP BY должен включать все неагрегированные поля
   - Или использовать DATE_TRUNC в GROUP BY

4. **Проблема с LIMIT:**
   - LIMIT может вызывать проблемы в некоторых случаях
   - Нужно проверить синтаксис

## Решение

### 1. Проверка запросов напрямую

Запросы проверены и работают:
- ✅ Alerts Timeline запрос работает
- ✅ Zone Telemetry запрос работает

### 2. Исправления применены

- ✅ Добавлено `::timestamp` для времени
- ✅ Добавлено `::float` для значений
- ✅ Исправлен GROUP BY
- ✅ Добавлен LIMIT

### 3. Что проверить

1. **Query Inspector:**
   - Откройте панель → Edit
   - Query Inspector → Run query
   - Проверьте ошибки в "Error" tab

2. **Временной диапазон:**
   - Выберите "Last 30 days" в правом верхнем углу
   - Данные есть с 19-21 ноября

3. **Автообновление:**
   - Отключите временно (кнопка обновления → Off)
   - Проверьте, стабильно ли работают данные

## Следующие шаги

Если ошибки 400 продолжаются:

1. Проверьте Query Inspector для конкретной ошибки
2. Упростите запросы до минимума
3. Проверьте настройки datasource (Configuration → Data Sources → PostgreSQL → Test)
4. Проверьте версию PostgreSQL плагина в Grafana

## Проверка подключения

```bash
# Проверка подключений к БД
docker exec backend-db-1 psql -U hydro -d hydro_dev -c "SELECT COUNT(*) FROM pg_stat_activity WHERE datname = 'hydro_dev';"

# Проверка данных
docker exec backend-db-1 psql -U hydro -d hydro_dev -c "SELECT COUNT(*) FROM alerts WHERE status = 'ACTIVE';"
```

## Статус

- ✅ БД работает нормально
- ⚠️ Grafana возвращает 400 при некоторых запросах
- ✅ Запросы работают напрямую в БД
- ✅ Исправления применены

Нужно проверить Query Inspector для получения конкретной ошибки.

