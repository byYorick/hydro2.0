# Backend Services - hydro2.0

Backend-—Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –≥–∏–¥—Ä–æ–ø–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** `../doc_ai/` - —ç—Ç–∞–ª–æ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **–ò–Ω–¥–µ–∫—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** `../doc_ai/INDEX.md`
- **Backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** `../doc_ai/04_BACKEND_CORE/BACKEND_ARCH_FULL.md`
- **Python-—Å–µ—Ä–≤–∏—Å—ã:** `../doc_ai/04_BACKEND_CORE/PYTHON_SERVICES_ARCH.md`

### –ë—ã—Å—Ç—Ä—ã–µ –≥–∞–π–¥—ã
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** `MONITORING_QUICK_START.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- **–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤:** `LOGS_ANALYSIS.md`

### –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **Changelog:** `CHANGELOG.md` - –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

### Laravel (API Gateway)
Laravel –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å API Gateway –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:
- REST API –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`/api/*`)
- WebSocket/Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (Laravel Reverb)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (–∑–æ–Ω—ã, –Ω–æ–¥—ã, —Ä–µ—Ü–µ–ø—Ç—ã)
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### Python-—Å–µ—Ä–≤–∏—Å—ã
- `mqtt-bridge` ‚Äî FastAPI –º–æ—Å—Ç REST‚ÜíMQTT (–ø–æ—Ä—Ç 9000)
- `history-logger` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ MQTT, –∑–∞–ø–∏—Å—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –≤ PostgreSQL (–º–µ—Ç—Ä–∏–∫–∏: 9300)
- `automation-engine` ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–æ–Ω, –ø—Ä–æ–≤–µ—Ä–∫–∞ targets, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ (–º–µ—Ç—Ä–∏–∫–∏: 9401)
- `scheduler` ‚Äî —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–∏–≤–æ–≤/—Å–≤–µ—Ç–∞ –∏–∑ recipe phases
- `device-registry` ‚Äî —Ä–µ–µ—Å—Ç—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Å—Ç–∞—Ç—É—Å: PLANNED)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤:** `services/*/README.md`

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤–∫–ª—é—á–∞–µ—Ç:

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **Prometheus** (–ø–æ—Ä—Ç 9090)
   - –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —Å Python-—Å–µ—Ä–≤–∏—Å–æ–≤
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ (retention: 15-30 –¥–Ω–µ–π)
   - –ü—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–æ–≤

2. **Grafana** (–ø–æ—Ä—Ç 3000)
   - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
   - –î–∞—à–±–æ—Ä–¥—ã:
     - System Overview ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
     - Zone Telemetry ‚Äî –≥—Ä–∞—Ñ–∏–∫–∏ pH/EC/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
     - Node Status ‚Äî —Å—Ç–∞—Ç—É—Å —É–∑–ª–æ–≤
     - Alerts Dashboard ‚Äî –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
     - Commands & Automation ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥

3. **Alertmanager** (–ø–æ—Ä—Ç 9093)
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞–º–∏
   - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Email, Telegram, UI webhook)

### –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö

- **PostgreSQL + TimescaleDB** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
- **Retention –ø–æ–ª–∏—Ç–∏–∫–∏**:
  - Raw –¥–∞–Ω–Ω—ã–µ: 7-30 –¥–Ω–µ–π (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
  - –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (1m, 1h, daily): –¥–æ 12 –º–µ—Å—è—Ü–µ–≤
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è**: Laravel –∫–æ–º–∞–Ω–¥—ã `telemetry:cleanup-raw` –∏ `telemetry:aggregate`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
./scripts/check_monitoring.sh
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- Dev: `configs/dev/prometheus.yml`, `configs/dev/alertmanager/config.yml`
- Prod: `configs/prod/prometheus.yml`, `configs/prod/alertmanager/config.yml`

### –ê–ª–µ—Ä—Ç—ã

–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–ª–µ—Ä—Ç—ã –Ω–∞:
- –ü–∞–¥–µ–Ω–∏–µ —É–∑–ª–æ–≤ (offline > 5 –º–∏–Ω—É—Ç)
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤ (Python-—Å–µ—Ä–≤–∏—Å—ã, MQTT broker)
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –≤ –∑–æ–Ω–∞—Ö
- –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –∫–æ–º–∞–Ω–¥

–°–º. `configs/*/prometheus/alerts.yml` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ —ç—Ç–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ

### –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- `MONITORING_QUICK_START.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `PROMETHEUS_FIX_SUMMARY.md` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Prometheus
- `LOGS_ANALYSIS.md` - –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ Grafana –∏ –ë–î
- `ARCHITECTURE_ANALYSIS_AND_IMPROVEMENTS.md` - –∞–Ω–∞–ª–∏–∑ –∏ —É–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- `CHANGELOG.md` - –∏—Å—Ç–æ—Ä–∏—è –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- `docs/IMPORTANT_FIXES_SUMMARY.md` - –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤–∞–∂–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
–í –∫–∞—Ç–∞–ª–æ–≥–µ `backend/` –µ—Å—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö (—Ñ–∞–π–ª—ã `*FIX*.md`, `*SOLUTION*.md`, `*SUMMARY*.md`).
–≠—Ç–∏ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –∫–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É–¥—É—â–µ–º. –í–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –≤ `CHANGELOG.md`.

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ó–∞–ø—É—Å–∫ dev –æ–∫—Ä—É–∂–µ–Ω–∏—è
docker-compose -f docker-compose.dev.yml up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker-compose -f docker-compose.dev.yml ps

# –õ–æ–≥–∏
docker-compose -f docker-compose.dev.yml logs -f laravel
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# Laravel —Ç–µ—Å—Ç—ã
docker-compose -f docker-compose.dev.yml exec laravel php artisan test

# Python —Ç–µ—Å—Ç—ã
docker-compose -f docker-compose.dev.yml exec mqtt-bridge pytest
```

---

**–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** `../doc_ai/INDEX.md`

