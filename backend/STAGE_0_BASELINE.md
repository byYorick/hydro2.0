# Этап 0: Базовое состояние тестового контура

**Ветка:** `refactor/grow-cycle-centric`  
**Дата:** 2025-12-25  
**Цель:** Зафиксировать текущее состояние тестов перед началом рефакторинга

## 1. PHP/Laravel тесты (php artisan test)

**Статус:** Частично проходит

### Результаты:
- ✅ **408 тестов прошли** (1323 assertions)
- ❌ **39 тестов упали**
- ⏭️ **6 тестов пропущено**
- ⏱️ **Длительность:** 43.90s

### Известные проблемы (не критичные для рефакторинга):
- Некоторые тесты используют устаревшие аннотации PHPUnit (deprecated doc-comments)
- Несколько тестов падают из-за проблем с данными/таймингами (ZoneEventLedgerTest, ZonePidLogControllerTest, ZoneSnapshotTest)

### Важно:
- Тесты используют БД `hydro_test` (конфигурация в phpunit.xml)
- Все миграции должны работать с `migrate:fresh` (backward compat не требуется)

## 2. Python тесты (pytest)

**Статус:** Частично работает

### Результаты сбора:
- ✅ **162 теста найдено**
- ⚠️ **41 ошибка при сборе** (вероятно, проблемы с импортами/конфигурацией)
- pytest версия: 8.0.0 (в контейнере), 9.0.2 (локально)

### Конфигурация:
- `pytest.ini` находится в `/backend/services/pytest.ini`
- Конфигурация: `testpaths = .`, `python_files = test_*.py`, `asyncio_mode = auto`

### Тесты найдены в:
- `automation-engine/test_*.py` (например, test_config_settings.py, test_controllers_with_bindings.py)

### Примечание:
- Тесты Python сервисов требуют отдельной проверки в контексте Docker
- После рефакторинга нужно будет обновить тесты для работы с новой моделью (grow_cycles вместо zone_recipe_instances)
- Ошибки сбора могут быть связаны с отсутствием зависимостей или неправильными путями импорта

## 3. E2E тесты (Playwright)

**Статус:** Настроен

### Конфигурация:
- `playwright.config.ts` в `/backend/laravel/playwright.config.ts`
- Тесты находятся в `/backend/laravel/tests/E2E`
- WebServer: `php artisan serve --host=127.0.0.1 --port=8000`

### Найденные E2E тесты:
- `dashboard.smoke.spec.ts`
- `pid-config.spec.ts`

### Примечание:
- E2E тесты требуют отдельного запуска после настройки окружения
- После рефакторинга UI потребуется обновление E2E тестов под новые эндпоинты

## 4. Docker окружение

**Статус:** ✅ Работает

### Запущенные сервисы:
- ✅ `db` (TimescaleDB) - порт 5432
- ✅ `laravel` - порты 8080, 5173, 6001
- ✅ `automation-engine` - порты 9401, 9405
- ✅ `scheduler` - порт 9402
- ✅ `digital-twin` - порты 8003, 9403
- ✅ `history-logger` - порты 9300-9301
- ✅ `telemetry-aggregator` - порт 9404
- ✅ `mqtt-bridge` - порт 9000
- ✅ `mqtt` - порт 1883
- ✅ `redis` - порт 6379
- ✅ `prometheus` - порт 9090
- ✅ `grafana` - порт 3000
- ✅ `alertmanager` - порт 9093

## 5. Правила для рефакторинга

### Миграции:
- ✅ Все миграции должны работать с `migrate:fresh`
- ✅ Backward compatibility **не требуется**
- ✅ Можно удалять legacy таблицы и колонки без сохранения данных

### Тестирование:
- После каждого этапа рефакторинга запускать `php artisan test` для проверки
- Python тесты обновлять параллельно с изменением сервисов
- E2E тесты обновлять после изменений UI/API

## 6. Следующие шаги

1. ✅ Создана ветка `refactor/grow-cycle-centric`
2. ✅ Зафиксировано базовое состояние тестов
3. ⏭️ **Этап 1:** Пересборка схемы БД под новую доменную модель

---

**Примечание:** Этот документ служит baseline для отслеживания изменений в процессе рефакторинга. После завершения каждого этапа обновлять результаты тестов.

