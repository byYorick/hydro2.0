# Улучшения мониторинга системы

## Реализованный функционал

### 1. ✅ Проверка здоровья сервисов в backend
**Проблема**: Backend не проверял статусы history-logger и automation-engine.

**Решение**: 
- Расширен `SystemController::health()` для проверки сервисов:
  - `history-logger` - проверка через `/health` endpoint (порт 9300)
  - `automation-engine` - проверка через `/metrics` endpoint (порт 9401)
- API теперь возвращает статусы всех сервисов в ответе `/api/system/health`

### 2. ✅ Индикаторы статусов в HeaderStatusBar
**Проблема**: В хедере не было индикаторов состояния сервисов.

**Решение**: 
- Добавлена кнопка "Сервисы" в HeaderStatusBar
- Кнопка открывает модальное окно с детальным мониторингом
- Показываются статусы Core, DB, WebSocket, MQTT

### 3. ✅ Модальное окно мониторинга
**Проблема**: Не было отдельного окна для мониторинга сервисов.

**Решение**: Создан компонент `SystemMonitoringModal.vue` с:
- **Карточки статусов**: Каждый компонент (Core, DB, WebSocket, MQTT, History Logger, Automation Engine) имеет свою карточку с индикатором состояния
- **Визуализация цепочки состояния**: Показывает цепочку БД → MQTT → WebSocket → UI с цветовыми индикаторами
- **Автообновление**: Обновление статусов каждые 10 секунд при открытом модальном окне
- **Кнопка "Обновить"**: Ручное обновление статусов
- **Открытие в новом окне**: Возможность открыть мониторинг в отдельном окне

### 4. ✅ Расширение useSystemStatus
**Проблема**: Composables не отслеживал статусы сервисов.

**Решение**: 
- Добавлены статусы `historyLoggerStatus` и `automationEngineStatus`
- Обновлена функция `checkHealth()` для получения статусов сервисов из API
- Статусы автоматически обновляются каждые 30 секунд

### 5. ✅ Визуализация цепочки состояния
**Проблема**: Оператор не видел деградации цепочки WebSocket/MQTT/БД.

**Решение**: 
- В модальном окне добавлена визуализация цепочки состояния
- Показывает статус каждого звена цепочки цветовыми индикаторами
- Отображает общий статус цепочки (здорова/есть проблемы)

## Измененные файлы

### Backend
- `backend/laravel/app/Http/Controllers/SystemController.php` - добавлена проверка сервисов history-logger и automation-engine

### Frontend
- `backend/laravel/resources/js/composables/useSystemStatus.ts` - добавлены статусы сервисов
- `backend/laravel/resources/js/Components/HeaderStatusBar.vue` - добавлена кнопка для открытия модального окна
- `backend/laravel/resources/js/Components/SystemMonitoringModal.vue` - новое модальное окно для мониторинга
- `backend/laravel/resources/js/Components/ServiceStatusCard.vue` - новый компонент карточки статуса сервиса

## Структура мониторинга

### Основные компоненты
- **Core API**: Основной API сервис (Laravel)
- **Database**: PostgreSQL база данных
- **WebSocket**: WebSocket соединение (Laravel Reverb)
- **MQTT Broker**: MQTT брокер

### Python сервисы
- **History Logger**: Логирование телеметрии в БД (порт 9300)
- **Automation Engine**: Автоматизация управления зонами (порт 9401)

### Цепочка состояния
```
БД → MQTT → WebSocket → UI
```

Каждое звено цепочки проверяется отдельно, и при проблеме в любом звене цепочка считается деградированной.

## Использование

### Открытие мониторинга
1. Нажмите кнопку "Сервисы" в HeaderStatusBar
2. Откроется модальное окно с детальной информацией о всех компонентах

### Автообновление
- При открытом модальном окне статусы обновляются автоматически каждые 10 секунд
- Можно обновить вручную, нажав кнопку "Обновить"

### Открытие в новом окне
- Нажмите "Открыть в новом окне" для постоянного мониторинга
- Откроется отдельное окно, которое можно оставить открытым на другом мониторе

## Статусы

### Статусы компонентов
- **ok**: Компонент работает корректно (зеленый индикатор)
- **fail**: Компонент не работает (красный индикатор)
- **unknown**: Статус неизвестен (серый индикатор)

### Статусы WebSocket
- **connected**: Соединение активно (зеленый)
- **disconnected**: Соединение разорвано (красный)
- **unknown**: Статус неизвестен (серый)

### Статусы MQTT
- **online**: Брокер доступен (зеленый)
- **offline**: Брокер недоступен (красный)
- **degraded**: Частичная доступность (желтый)
- **unknown**: Статус неизвестен (серый)

## Результат

Теперь оператор может:
- ✅ Видеть состояние всех компонентов системы в реальном времени
- ✅ Отслеживать деградацию цепочки WebSocket/MQTT/БД
- ✅ Мониторить статусы history-logger и automation-engine
- ✅ Открыть отдельное окно для постоянного мониторинга
- ✅ Получать уведомления о проблемах в системе

