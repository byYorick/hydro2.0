version: "3.9"
services:
  mqtt:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
    volumes:
      - ./services/mqtt-bridge/mosquitto.prod.conf:/mosquitto/config/mosquitto.conf:ro
      - ./services/mqtt-bridge/passwords:/mosquitto/config/passwords:ro
      - ./services/mqtt-bridge/acl:/mosquitto/config/acl:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
  db:
    image: timescaledb/timescaledb:latest-pg16
    environment:
      # ВАЖНО: Замените на уникальный пароль через переменную окружения
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_USER: ${POSTGRES_USER:-hydro}
      POSTGRES_DB: ${POSTGRES_DB:-hydro}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - wal_archive:/wal_archive
    command:
      - "postgres"
      - "-c"
      - "archive_mode=on"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "archive_command='test ! -f /wal_archive/%f && cp %p /wal_archive/%f'"
  redis:
    image: redis:7-alpine
  laravel:
    build:
      context: ./laravel
      dockerfile: Dockerfile
    working_dir: /app
    command: >
      sh -c "
        if [ \"$$REVERB_AUTO_START\" = \"true\" ]; then
          echo 'Starting Laravel Reverb...';
          cd /app && nohup php artisan reverb:start --host=0.0.0.0 --port=6001 > /tmp/reverb.log 2>&1 &
          sleep 2;
        fi;
        exec /opt/docker/bin/entrypoint.sh supervisord
      "
    environment:
      - WEB_DOCUMENT_ROOT=/app/public
      - APP_ENV=production
      - APP_DEBUG=false
      - SESSION_DRIVER=redis
      - CACHE_DRIVER=redis
      - LOG_CHANNEL=stderr
      - LOG_LEVEL=info
      - BROADCAST_DRIVER=reverb
      - DB_CONNECTION=pgsql
      - DB_HOST=db
      - DB_PORT=5432
      - DB_DATABASE=hydro
      - DB_USERNAME=hydro
      - DB_PASSWORD=${POSTGRES_PASSWORD:-change-me}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REVERB_APP_ID=${REVERB_APP_ID:-app}
      # ВАЖНО: Замените на уникальные ключи через переменные окружения
      - REVERB_APP_KEY=${REVERB_APP_KEY:?REVERB_APP_KEY must be set}
      - REVERB_APP_SECRET=${REVERB_APP_SECRET:?REVERB_APP_SECRET must be set}
      - REVERB_HOST=0.0.0.0
      - REVERB_PORT=6001
      - REVERB_SCHEME=http
      - REVERB_DEBUG=false
      - REVERB_AUTO_START=${REVERB_AUTO_START:-true}
      # Vite environment variables for WebSocket (передаются при сборке)
      - VITE_ENABLE_WS=true
      - VITE_REVERB_APP_KEY=${REVERB_APP_KEY:-change-me}
      - VITE_REVERB_HOST=${REVERB_HOST:-0.0.0.0}
      - VITE_REVERB_PORT=6001
      - VITE_REVERB_SCHEME=http
      - VITE_PUSHER_APP_KEY=${REVERB_APP_KEY:-change-me}
      - VITE_WS_HOST=${REVERB_HOST:-0.0.0.0}
      - VITE_WS_PORT=6001
      - VITE_WS_TLS=false
    volumes:
      - ./laravel:/app
    ports:
      - "8080:80"
      - "6001:6001"
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/api/system/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
  # api-gateway: роль выполняется Laravel (см. backend/laravel/)
  mqtt-bridge:
    build:
      context: ./services
      dockerfile: mqtt-bridge/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - MQTT_USER=${MQTT_MQTT_BRIDGE_USER:-mqtt_bridge}
      # ВАЖНО: Замените на уникальный пароль через переменную окружения
      - MQTT_PASS=${MQTT_MQTT_BRIDGE_PASS:?MQTT_MQTT_BRIDGE_PASS must be set}
      - PG_HOST=db
      - PG_DB=hydro
      - PG_USER=hydro
      - PG_PASS=${POSTGRES_PASSWORD:-change-me}
      - LARAVEL_API_URL=http://laravel
    depends_on:
      - mqtt
      - db
      - laravel
  # device-registry: PLANNED - функционал частично в Laravel (см. backend/services/device-registry/README.md)
  # device-registry:
  #   build: ./services/device-registry
  #   depends_on: [db]
  automation-engine:
    build: ./services/automation-engine
    environment:
      - MQTT_HOST=mqtt
      - MQTT_USER=${MQTT_AUTOMATION_ENGINE_USER:-automation_engine}
      # ВАЖНО: Замените на уникальный пароль через переменную окружения
      - MQTT_PASS=${MQTT_AUTOMATION_ENGINE_PASS:?MQTT_AUTOMATION_ENGINE_PASS must be set}
      - PG_HOST=db
      - PG_DB=hydro
      - PG_USER=hydro
      - PG_PASS=${POSTGRES_PASSWORD:-change-me}
      - LARAVEL_API_URL=http://laravel
      - LARAVEL_API_TOKEN=${LARAVEL_API_TOKEN:-}
    depends_on:
      - db
      - mqtt
      - laravel
  history-logger:
    build:
      context: ./services
      dockerfile: history-logger/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - MQTT_USER=${MQTT_HISTORY_LOGGER_USER:-history_logger}
      # ВАЖНО: Замените на уникальный пароль через переменную окружения
      - MQTT_PASS=${MQTT_HISTORY_LOGGER_PASS:?MQTT_HISTORY_LOGGER_PASS must be set}
      - PG_HOST=db
      - PG_DB=hydro
      - PG_USER=hydro
      - PG_PASS=${POSTGRES_PASSWORD:-change-me}
    depends_on:
      - mqtt
      - db
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./configs/prod/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./configs/prod/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - automation-engine
      - scheduler
      - mqtt-bridge
    restart: unless-stopped
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      # ВАЖНО: Замените на уникальный пароль через переменную окружения
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD must be set}
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - ./configs/prod/grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./configs/prod/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./configs/prod/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - db
    restart: unless-stopped
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./configs/prod/alertmanager/config.yml:/etc/alertmanager/config.yml:ro
      - alertmanager_data:/alertmanager
    ports:
      - "9093:9093"
    depends_on:
      - prometheus
      - laravel
    restart: unless-stopped
  scheduler:
    build:
      context: ./services
      dockerfile: scheduler/Dockerfile
    environment:
      - MQTT_HOST=mqtt
      - MQTT_USER=${MQTT_SCHEDULER_USER:-scheduler}
      # ВАЖНО: Замените на уникальный пароль через переменную окружения
      - MQTT_PASS=${MQTT_SCHEDULER_PASS:?MQTT_SCHEDULER_PASS must be set}
      - PG_HOST=db
      - PG_DB=hydro
      - PG_USER=hydro
      - PG_PASS=${POSTGRES_PASSWORD:-change-me}
    depends_on:
      - mqtt
      - db
    ports:
      - "9402:9402"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect((\"localhost\", 9402)); s.close()' || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  postgres_data:
  prometheus_data:
  mqtt_data:
  mqtt_logs:
  grafana_data:
  alertmanager_data:
  wal_archive:


