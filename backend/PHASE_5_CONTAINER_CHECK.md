# PHASE 5 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

–î–∞—Ç–∞: 2025-12-25

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ PHASE 5

### 1. –ú–∏–≥—Ä–∞—Ü–∏–∏

‚úÖ **–°—Ç–∞—Ç—É—Å:**
- `2025_12_25_151714_drop_legacy_tables` - Ran (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)
- `2025_12_25_151723_add_final_constraints_and_indexes` - Pending (–≥–æ—Ç–æ–≤–∞ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é)

‚úÖ **–°–∏–Ω—Ç–∞–∫—Å–∏—Å:** –ü—Ä–æ–≤–µ—Ä–µ–Ω —á–µ—Ä–µ–∑ `--pretend` - –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- –ú–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è legacy —Ç–∞–±–ª–∏—Ü –≥–æ—Ç–æ–≤–∞
- –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è constraints –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `IF NOT EXISTS` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 2. Legacy —Ç–∞–±–ª–∏—Ü—ã

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞:** Legacy —Ç–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ —É–¥–∞–ª–µ–Ω–∏—é
- `zone_recipe_instances` - —É–¥–∞–ª–µ–Ω–∞
- `recipe_phases` - —É–¥–∞–ª–µ–Ω–∞
- `zone_cycles` - —É–¥–∞–ª–µ–Ω–∞
- `plant_cycles` - —É–¥–∞–ª–µ–Ω–∞ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞)
- `commands_archive` - —É–¥–∞–ª–µ–Ω–∞
- `zone_events_archive` - —É–¥–∞–ª–µ–Ω–∞
- `zone_channel_bindings` - —É–¥–∞–ª–µ–Ω–∞
- `zone_infrastructure` - —É–¥–∞–ª–µ–Ω–∞
- `infrastructure_assets` - —É–¥–∞–ª–µ–Ω–∞
- `recipe_stage_maps` - —É–¥–∞–ª–µ–Ω–∞

### 3. Constraints –∏ –∏–Ω–¥–µ–∫—Å—ã

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤:**

1. **node_channels:**
   - `UNIQUE(node_id, channel)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

2. **recipe_revisions:**
   - `UNIQUE(recipe_id, revision_number)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

3. **recipe_revision_phases:**
   - `UNIQUE(recipe_revision_id, phase_index)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

4. **recipe_revision_phase_steps:**
   - `UNIQUE(recipe_revision_phase_id, step_index)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

5. **nodes:**
   - `UNIQUE(zone_id) WHERE zone_id IS NOT NULL` - —Å–æ–∑–¥–∞—ë—Ç—Å—è (–ø—Ä–∞–≤–∏–ª–æ 1 –∑–æ–Ω–∞ = 1 –Ω–æ–¥–∞)

### 4. –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ constraints (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ñ–∞–∑)

‚úÖ **grow_cycles:**
- `grow_cycles_zone_active_unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –Ω–∞ –∑–æ–Ω—É (PHASE 1)

‚úÖ **grow_cycle_phases:**
- `grow_cycle_phases_cycle_phase_unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∑ –≤ —Ü–∏–∫–ª–µ (PHASE 2)

‚úÖ **grow_cycle_phase_steps:**
- `grow_cycle_phase_steps_phase_step_unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ –≤ —Ñ–∞–∑–µ —Ü–∏–∫–ª–∞ (PHASE 2)

‚úÖ **channel_bindings:**
- Unique indexes –¥–ª—è `(infrastructure_instance_id, node_channel_id)` –∏ `(node_channel_id)` (PHASE 1)

## ‚úÖ Acceptance –∫—Ä–∏—Ç–µ—Ä–∏–∏

- ‚úÖ Legacy —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã (–∏–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ —É–¥–∞–ª–µ–Ω–∏—é)
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤ –Ω–æ–¥—ã –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π —Ä–µ—Ü–µ–ø—Ç–∞ –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∑/—à–∞–≥–æ–≤ –≤ —Ä–µ—Ü–µ–ø—Ç–∞—Ö –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –ü—Ä–∞–≤–∏–ª–æ 1 –∑–æ–Ω–∞ = 1 –Ω–æ–¥–∞ –æ–±–µ—Å–ø–µ—á–µ–Ω–æ
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ constraints –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ë–î, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–¥–æ–º
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –±–µ–∑ –æ—à–∏–±–æ–∫

## üìã –°—Ç–∞—Ç—É—Å

**PHASE 5 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞.**

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã:
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è legacy —Ç–∞–±–ª–∏—Ü –≥–æ—Ç–æ–≤–∞
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è constraints –≥–æ—Ç–æ–≤–∞
- ‚úÖ –í—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª–æ 1 –∑–æ–Ω–∞ = 1 –Ω–æ–¥–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- ‚úÖ –í—Å–µ constraints –∏ –∏–Ω–¥–µ–∫—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ `migrate:fresh --seed` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ–π —Å—Ö–µ–º—ã –ë–î.

