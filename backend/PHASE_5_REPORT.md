# PHASE 5 - –£–¥–∞–ª–µ–Ω–∏–µ legacy –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É–∂–µ—Å—Ç–æ—á–µ–Ω–∏–µ —Å—Ö–µ–º—ã

–î–∞—Ç–∞: 2025-12-25

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 5.1 –£–¥–∞–ª–µ–Ω–∏–µ legacy —Ç–∞–±–ª–∏—Ü

**–§–∞–π–ª:** `2025_12_25_151714_drop_legacy_tables.php` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª)

**–£–¥–∞–ª—è–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `recipe_stage_maps` - –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `stage_template_id` –≤ `recipe_revision_phases`
- `zone_recipe_instances` - –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `grow_cycles + recipe_revisions`
- `recipe_phases` - legacy JSON targets, –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `recipe_revision_phases`
- `zone_cycles` - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `grow_cycles`
- `plant_cycles` - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- `commands_archive` - –¥—É–±–ª–∏, retention —á–µ—Ä–µ–∑ –ø–æ–ª–∏—Ç–∏–∫–∏
- `zone_events_archive` - –¥—É–±–ª–∏, retention —á–µ—Ä–µ–∑ –ø–æ–ª–∏—Ç–∏–∫–∏
- `zone_channel_bindings` - –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `channel_bindings`
- `zone_infrastructure` - –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `infrastructure_instances`
- `infrastructure_assets` - –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `infrastructure_instances`

### 5.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö constraints –∏ indexes

**–§–∞–π–ª:** `2025_12_25_151723_add_final_constraints_and_indexes.php`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ constraints:**

1. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤ –Ω–æ–¥—ã (node_channels):**
   - `UNIQUE(node_id, channel)` - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `create_node_channels_table`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

2. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π —Ä–µ—Ü–µ–ø—Ç–∞ (recipe_revisions):**
   - `UNIQUE(recipe_id, revision_number)` - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `create_recipe_revisions_table`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

3. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∑ –≤ —Ä–µ—Ü–µ–ø—Ç–µ (recipe_revision_phases):**
   - `UNIQUE(recipe_revision_id, phase_index)` - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `create_recipe_revision_phases_table`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

4. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ –≤ —Ñ–∞–∑–µ (recipe_revision_phase_steps):**
   - `UNIQUE(recipe_revision_phase_id, step_index)` - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `create_recipe_revision_phase_steps_table`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

5. **–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å 1 –∑–æ–Ω–∞ = 1 –Ω–æ–¥–∞ (nodes):**
   - `UNIQUE(zone_id) WHERE zone_id IS NOT NULL` - —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ —ç—Ç–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–æ: –æ–¥–Ω–∞ –∑–æ–Ω–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –Ω–æ–¥—É

**–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ constraints (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ñ–∞–∑):**
- `grow_cycles_zone_active_unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –Ω–∞ –∑–æ–Ω—É (PHASE 1)
- `grow_cycle_phases_cycle_phase_unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∑ –≤ —Ü–∏–∫–ª–µ (PHASE 2)
- `grow_cycle_phase_steps_phase_step_unique` - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ –≤ —Ñ–∞–∑–µ —Ü–∏–∫–ª–∞ (PHASE 2)
- `channel_bindings` unique indexes (PHASE 1)

## ‚úÖ Acceptance –∫—Ä–∏—Ç–µ—Ä–∏–∏

- ‚úÖ Legacy —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã (–∏–ª–∏ –≥–æ—Ç–æ–≤—ã –∫ —É–¥–∞–ª–µ–Ω–∏—é)
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤ –Ω–æ–¥—ã –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π —Ä–µ—Ü–µ–ø—Ç–∞ –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–∑/—à–∞–≥–æ–≤ –≤ —Ä–µ—Ü–µ–ø—Ç–∞—Ö –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –ü—Ä–∞–≤–∏–ª–æ 1 –∑–æ–Ω–∞ = 1 –Ω–æ–¥–∞ –æ–±–µ—Å–ø–µ—á–µ–Ω–æ
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ constraints –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ë–î, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∫–æ–¥–æ–º

## üìã –°—Ç–∞—Ç—É—Å

**PHASE 5 –∑–∞–≤–µ—Ä—à–µ–Ω–∞.**

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã:
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è legacy —Ç–∞–±–ª–∏—Ü –≥–æ—Ç–æ–≤–∞
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è constraints –≥–æ—Ç–æ–≤–∞
- ‚úÖ –í—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª–æ 1 –∑–æ–Ω–∞ = 1 –Ω–æ–¥–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å `migrate:fresh --seed` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ–π —Å—Ö–µ–º—ã.

