# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–∑–ª–æ–≤

–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: 2025-01-27

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: Async handlers –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –ª–æ–≥–∞—Ö history-logger –≤–∏–¥–Ω–æ:
```
RuntimeWarning: coroutine 'handle_node_hello' was never awaited
RuntimeWarning: coroutine 'handle_heartbeat' was never awaited
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `handle_node_hello` –∏ `handle_heartbeat` –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞:**
–í `backend/services/common/mqtt.py` –º–µ—Ç–æ–¥ `_wrap` –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å async handlers, –Ω–æ —Å—É–¥—è –ø–æ –æ—à–∏–±–∫–∞–º, event loop –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ event loop –∑–∞–ø—É—â–µ–Ω.

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –§–∞–π–ª: `backend/services/common/mqtt.py`
- –ú–µ—Ç–æ–¥: `_wrap` (—Å—Ç—Ä–æ–∫–∏ 59-113)
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `message_callback_add`, –Ω–æ event loop –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
–ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è event loop –≤ `mqtt.py`. Event loop –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω –¥–æ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ–ø–∏–∫–∏.

### 2. ‚ö†Ô∏è LARAVEL_API_TOKEN –ø—É—Å—Ç–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í history-logger –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `LARAVEL_API_TOKEN` –ø—É—Å—Ç–∞—è:
```
LARAVEL_API_URL=http://laravel
LARAVEL_API_TOKEN=
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Laravel:**
–¢–æ–∫–µ–Ω—ã –≤ Laravel –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ `php artisan tinker`):
```php
config('services.python_bridge.ingest_token') // null
config('services.python_bridge.token') // null
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ï—Å–ª–∏ –≤ Laravel —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–æ–∫–µ–Ω (`PY_INGEST_TOKEN` –∏–ª–∏ `PY_API_TOKEN`), –Ω–æ –≤ history-logger –æ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∑–ª–∞ –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π 401
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∏–≥–¥–µ, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
- –í–∞—Ä–∏–∞–Ω—Ç –ê (–¥–ª—è dev): –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–æ–∫–µ–Ω—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∏–≥–¥–µ (—Ç–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è)
- –í–∞—Ä–∏–∞–Ω—Ç –ë (–¥–ª—è prod): –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–æ–∫–µ–Ω –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö:
  ```bash
  # –í .env –∏–ª–∏ docker-compose.yml
  PY_INGEST_TOKEN=your-secret-token-here
  LARAVEL_API_TOKEN=your-secret-token-here
  ```

### 3. üìä –£–∑–ª—ã –≤ –ë–î —Å–æ–∑–¥–∞–Ω—ã –Ω–µ —á–µ—Ä–µ–∑ node_hello

**–°—Ç–∞—Ç—É—Å —É–∑–ª–æ–≤ –≤ –ë–î:**
```sql
 id |     uid      | hardware_id |  type  | lifecycle_state |     created_at      
----+--------------+-------------+--------+-----------------+---------------------
  3 | nd-ph-001    |             | sensor | UNPROVISIONED   | 2025-11-20 06:43:55
  4 | nd-ec-001    |             | sensor | UNPROVISIONED   | 2025-11-20 06:43:55
  5 | nd-temp-001  |             | sensor | UNPROVISIONED   | 2025-11-20 06:43:55
  6 | nd-combo-001 |             | sensor | UNPROVISIONED   | 2025-11-20 06:43:55
```

**–ê–Ω–∞–ª–∏–∑:**
- –£–∑–ª—ã –∏–º–µ—é—Ç `lifecycle_state = UNPROVISIONED` (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `REGISTERED_BACKEND` –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ node_hello)
- `hardware_id` –ø—É—Å—Ç–æ–π (–¥–æ–ª–∂–µ–Ω –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ node_hello)
- –£–∑–ª—ã, –≤–µ—Ä–æ—è—Ç–Ω–æ, —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π –º–µ—Ö–∞–Ω–∏–∑–º

**–í—ã–≤–æ–¥:**
–ù–æ–≤—ã–µ —É–∑–ª—ã –ù–ï —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ node_hello (–∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã #1).

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–í–´–°–û–ö–ò–ô**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å async handlers (#1) - –±–µ–∑ —ç—Ç–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤ –≤–æ–æ–±—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **–°–†–ï–î–ù–ò–ô**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–æ–∫–µ–Ω—ã (#2) - –º–æ–∂–µ—Ç –ø–æ–º–µ—à–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
3. **–ù–ò–ó–ö–ò–ô**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É —É–∑–ª—ã –≤ –ë–î —Å–æ–∑–¥–∞–Ω—ã –Ω–µ —á–µ—Ä–µ–∑ node_hello (#3) - —ç—Ç–æ —Å–ª–µ–¥—Å—Ç–≤–∏–µ –ø—Ä–æ–±–ª–µ–º—ã #1

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å async handlers

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `event_loop` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `AsyncMqttClient.start()`, –Ω–æ –∫–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `_wrap` –≤ `_on_connect`, `self._event_loop` –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `event_loop` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –î–û –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ–ø–∏–∫–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `run_coroutine_threadsafe` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã

–î–ª—è dev –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ç–µ–∫—É—â–µ–µ):
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–æ–∫–µ–Ω—ã –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö (history-logger –∏ Laravel)
- –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–æ–∫–µ–Ω

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å history-logger
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å test node_hello —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ MQTT
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ history-logger –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ node_hello
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É–∑–µ–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º lifecycle_state

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ history-logger
docker-compose -f docker-compose.dev.yml logs history-logger | grep -i "node_hello"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–∑–ª—ã –≤ –ë–î
docker-compose -f docker-compose.dev.yml exec db psql -U hydro -d hydro_dev -c "SELECT id, uid, hardware_id, type, lifecycle_state FROM nodes ORDER BY created_at DESC LIMIT 5;"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
docker-compose -f docker-compose.dev.yml exec history-logger env | grep LARAVEL_API_TOKEN
docker-compose -f docker-compose.dev.yml exec laravel php artisan tinker --execute="var_dump(config('services.python_bridge.ingest_token'));"
```

## –°—Ç–∞—Ç—É—Å

- [x] –ü—Ä–æ–±–ª–µ–º—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã
- [ ] –ü—Ä–æ–±–ª–µ–º–∞ #1 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ (async handlers)
- [ ] –ü—Ä–æ–±–ª–µ–º–∞ #2 –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ (—Ç–æ–∫–µ–Ω—ã)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
- [ ] –£–∑–ª—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ node_hello

