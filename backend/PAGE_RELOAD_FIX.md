# Исправление множественных перезагрузок страницы при старте

## Проблема

При старте страница много раз перезагружалась, что вызывало:
- Множественные инициализации WebSocket соединения
- Повторные запросы к серверу
- Плохой пользовательский опыт

## Причины

### 1. Обработчик router.on('success') в app.js

**Проблема:**
- Обработчик вызывался при каждом успешном запросе Inertia.js
- Это вызывало проверку и переинициализацию WebSocket при каждом обновлении страницы
- При старте страницы может быть несколько запросов, что вызывало множественные переинициализации

**Исправление:**
- Удален обработчик `router.on('success')` из `app.js`
- WebSocket соединение теперь управляется только через `bootstrap.js` и `echoClient.ts`
- Inertia.js обновления страницы не должны вызывать переинициализацию WebSocket

### 2. Множественные проверки соединения в bootstrap.js

**Проблема:**
- При загрузке страницы выполнялось 5 попыток проверки соединения
- Каждая попытка могла вызвать переинициализацию, если соединение не было готово
- Это вызывало множественные переинициализации при старте

**Исправление:**
- Упрощена проверка соединения - теперь только одна проверка через 1 секунду
- Переинициализация происходит только если соединение действительно не работает
- Добавлена задержка 2 секунды перед переинициализацией, чтобы дать время соединению установиться

### 3. Отсутствие защиты от множественных инициализаций

**Проблема:**
- Функция `initializeEcho()` могла вызываться несколько раз одновременно
- Это вызывало множественные попытки инициализации

**Исправление:**
- Добавлен флаг `echoInitialized` для защиты от множественных инициализаций
- Функция `initializeEchoOnce()` проверяет флаг перед инициализацией
- Инициализация происходит только один раз при загрузке страницы

### 4. Переподключение при состоянии 'connecting'

**Проблема:**
- Функция `scheduleReconnect()` могла вызывать переподключение даже когда соединение уже устанавливалось
- Это вызывало конфликты и множественные попытки подключения

**Исправление:**
- Добавлена проверка состояния 'connecting' в `scheduleReconnect()`
- Переподключение не происходит, если соединение уже подключено или в процессе подключения

## Применённые исправления

### 1. app.js

```javascript
// УДАЛЕНО: Обработчик router.on('success')
// ИСПРАВЛЕНО: Удален обработчик router.on('success') - он вызывал множественные переинициализации
// WebSocket соединение должно управляться только через bootstrap.js и echoClient.ts
```

### 2. bootstrap.js

```javascript
// ИСПРАВЛЕНО: Добавлена защита от множественных инициализаций
let echoInitialized = false;

function initializeEchoOnce() {
  if (echoInitialized) {
    logger.debug('[bootstrap.js] Echo already initialized, skipping', {});
    return;
  }
  echoInitialized = true;
  initializeEcho();
}

// Упрощена проверка соединения после загрузки страницы
// Теперь только одна проверка через 1 секунду
```

### 3. echoClient.ts

```typescript
// ИСПРАВЛЕНО: Проверка состояния 'connecting' в scheduleReconnect()
if (connection.state === 'connected' || connection.state === 'connecting') {
  logger.debug('[echoClient] Already connected or connecting, skipping reconnect', {
    reason,
    state: connection.state,
    socketId: connection.socket_id,
  });
  return;
}
```

## Результат

- ✅ Страница не перезагружается множественно при старте
- ✅ WebSocket инициализируется только один раз
- ✅ Переподключение происходит только при необходимости
- ✅ Улучшен пользовательский опыт

## Статус

- ✅ Исправлено множественное переподключение при старте
- ✅ Добавлена защита от множественных инициализаций
- ✅ Упрощена логика проверки соединения
- ✅ Удален обработчик router.on('success'), вызывавший переинициализации

