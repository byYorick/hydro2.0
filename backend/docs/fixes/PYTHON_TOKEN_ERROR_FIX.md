# Исправление ошибки Python service token

## Проблема

В логах контейнера Laravel постоянно появлялась ошибка:
```
[2025-11-24 17:06:11] local.ERROR: Python service token not configured in services.python_bridge.token
```

Это приводило к ошибкам 500 при попытке Python-сервисов получить конфигурацию через `/api/system/config/full`.

## Причина

Middleware `VerifyPythonServiceToken` проверял наличие токена в конфигурации и возвращал ошибку 500, если токен не был настроен. Это неправильно, так как:
1. Ошибка 500 означает проблему на сервере, а не проблему с аутентификацией
2. В dev режиме токен может быть не настроен
3. Middleware должен также проверять Sanctum аутентификацию

## Исправления

### 1. Добавлена проверка Sanctum аутентификации
Теперь middleware сначала проверяет, авторизован ли пользователь через Sanctum, и разрешает доступ без проверки токена.

### 2. Изменен уровень логирования
- Вместо `Log::error()` используется `Log::warning()` для отсутствия токена
- Ошибка 500 заменена на 401 (Unauthorized)

### 3. Разрешен доступ без токена в dev режиме
В dev режиме (когда `APP_ENV=local` или `APP_DEBUG=true`) система разрешает доступ без токена для упрощения разработки.

## Измененные файлы

- `backend/laravel/app/Http/Middleware/VerifyPythonServiceToken.php`

## Результат

1. **В dev режиме:** Система работает без токена, логируется только информационное сообщение
2. **В production:** Требуется либо токен Python сервисов, либо Sanctum аутентификация
3. **Ошибки 500 заменены на 401:** Более корректная обработка отсутствия аутентификации

## Рекомендации

Для production окружения рекомендуется установить `PY_API_TOKEN` в переменных окружения:

```bash
export PY_API_TOKEN="your-secure-token-here"
```

Или в `.env` файле:
```
PY_API_TOKEN=your-secure-token-here
```

---

_Дата исправления: 2024-11-24_

