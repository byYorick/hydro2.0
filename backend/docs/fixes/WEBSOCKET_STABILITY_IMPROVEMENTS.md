# Улучшения стабильности WebSocket соединения

## Проблема

WebSocket соединение периодически разрывается, что приводит к потере real-time обновлений.

## Примененные исправления

### 1. Улучшены таймауты в конфигурации Reverb

**Файл:** `backend/laravel/config/reverb.php`

- `ping_interval`: уменьшено с 60 до 30 секунд для более частых проверок соединения
- `activity_timeout`: увеличено с 30 до 60 секунд для большей стабильности

### 2. Улучшены настройки клиента Pusher

**Файл:** `backend/laravel/resources/js/bootstrap.js`

Добавлены настройки для улучшения стабильности:
- `activityTimeout: 60000` - 60 секунд таймаут активности
- `pongTimeout: 30000` - 30 секунд таймаут ожидания pong
- `unavailableTimeout: 10000` - 10 секунд перед попыткой переподключения

### 3. Улучшена обработка переподключения

**Файл:** `backend/laravel/resources/js/bootstrap.js`

- Добавлена автоматическая попытка переподключения при разрыве соединения
- Улучшено логирование состояния соединения
- Предотвращено дублирование обработчиков событий

### 4. Автоматическое переподключение в useSystemStatus

**Файл:** `backend/laravel/resources/js/composables/useSystemStatus.ts`

- Добавлена автоматическая попытка переподключения при обнаружении разрыва
- Улучшена проверка состояния соединения
- Добавлено логирование разрывов соединения для диагностики

## Рекомендации

### Мониторинг

Следите за логами Reverb:
```bash
docker exec backend-laravel-1 tail -f /tmp/reverb.log
```

### Проверка состояния

Проверяйте статус WebSocket в консоли браузера:
- Должно быть: `[WebSocket] Connection status after 3s: { state: "connected", ... }`
- Если `state: "connecting"` - соединение устанавливается (нормально)
- Если `state: "disconnected"` - есть проблема

### Диагностика проблем

1. **Reverb перезапускается:**
   - Проверьте логи: `docker exec backend-laravel-1 tail -50 /tmp/reverb.log`
   - Проверьте память: `docker stats backend-laravel-1`
   - Проверьте supervisor: `docker exec backend-laravel-1 supervisorctl status`

2. **Соединение разрывается:**
   - Проверьте сетевые настройки
   - Проверьте файрвол
   - Проверьте таймауты прокси (nginx)

3. **Медленное подключение:**
   - Увеличьте `activity_timeout` в конфигурации
   - Проверьте нагрузку на сервер

## Ожидаемое поведение

После применения исправлений:

1. ✅ WebSocket автоматически переподключается при разрыве
2. ✅ Более стабильное соединение благодаря увеличенным таймаутам
3. ✅ Улучшенное логирование для диагностики
4. ✅ Предотвращение дублирования обработчиков

---

_Обновлено: 2024-11-24_





