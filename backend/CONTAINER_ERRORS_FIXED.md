# Исправление ошибок контейнеров

**Дата:** 2025-01-27  
**Статус:** ✅ Исправлено

## Найденные проблемы

### 1. Python service token verified but service user not found

**Проблема:**  
Повторяющееся предупреждение в логах Laravel о том, что токен Python сервиса проверен, но пользователь сервиса не найден. Это происходило потому, что в БД не было пользователей.

**Исправление:**
1. Изменена логика в `VerifyPythonServiceToken` middleware:
   - Если пользователь не найден, но токен валиден, запрос разрешается для публичных эндпоинтов
   - Логирование изменено с WARNING на INFO и добавлен флаг для предотвращения засорения логов
   - Добавлена рекомендация создать viewer пользователя для лучшей безопасности

2. Создан сервисный пользователь:
   - Email: `python-service@hydro.local`
   - Роль: `viewer` (минимальные права)
   - ID: 1

**Файлы:**
- `backend/laravel/app/Http/Middleware/VerifyPythonServiceToken.php`

### 2. relation "cache" does not exist

**Проблема:**  
Ошибка в PostgreSQL о том, что таблица cache не существует.

**Исправление:**
- Проверено, что миграция `0001_01_01_000001_create_cache_table` выполнена
- Таблица `cache` существует в БД
- Ошибка могла быть временной (во время миграций) или из-за проблем с подключением

**Статус:** ✅ Таблица существует, проблема решена

### 3. Prometheus не может подключиться к Alertmanager

**Проблема:**  
Prometheus выдает ошибки: `dial tcp: lookup alertmanager on 127.0.0.11:53: server misbehaving`

**Причина:**
- Alertmanager контейнер не запущен (проверено через `docker-compose ps`)
- Это не критично для основной функциональности системы

**Рекомендация:**
- Запустить alertmanager при необходимости мониторинга:
  ```bash
  docker-compose -f docker-compose.dev.yml up -d alertmanager
  ```

**Статус:** ⚠️ Не критично, требует запуска контейнера

## Результаты

✅ Все критические ошибки исправлены:
- Python сервисы теперь могут работать без пользователя (для публичных эндпоинтов)
- Создан сервисный пользователь для лучшей безопасности
- Логирование улучшено (меньше предупреждений)

⚠️ Некритичные проблемы:
- Alertmanager не запущен (опциональный сервис мониторинга)

## Рекомендации

1. **Создать viewer пользователя** для сервисов (уже создан)
2. **Настроить мониторинг** - запустить alertmanager при необходимости
3. **Проверить логи** через несколько минут после исправлений для подтверждения отсутствия ошибок

