# ADR: WebSocket Orchestration Architecture

## Статус
Принято

## Контекст

Текущая архитектура WebSocket/Echo слоя имеет несколько проблем:

1. **Дублирующие reconnect механизмы**: 
   - `bootstrap.js` имеет собственную retry логику с таймерами (`scheduleEchoInitialization`)
   - `echoClient.ts` имеет reconnect логику (`scheduleReconnect`)
   - Оба могут конкурировать и создавать гонки

2. **Неопределенность источника истины**:
   - `bootstrap.js` может вызывать `initEcho()` независимо
   - `echoClient.ts` управляет lifecycle, но `bootstrap.js` тоже пытается управлять
   - Нет единого места для состояния соединения

3. **Проблемы с resubscribe**:
   - `useWebSocket.ts` имеет свой таймер `resubscribeTimer`
   - Подписки могут восстанавливаться несколько раз или не восстанавливаться
   - Нет гарантии, что resubscribe произойдет один раз после reconnect

4. **Утечки памяти**:
   - При unmount компонентов подписки могут не очищаться корректно
   - При teardown Echo могут оставаться таймеры и обработчики

## Решение

### Разделение ответственности

#### 1. `echoClient.ts` - Единственный источник истины для lifecycle
- **Ответственность**: создание Echo instance, управление соединением, reconnect
- **Экспортирует**: `initEcho()`, `getEchoInstance()`, `onWsStateChange()`, `getConnectionState()`
- **Не делает**: не управляет подписками, не знает о компонентах

#### 2. `useWebSocket.ts` - Registry подписок и удобный API
- **Ответственность**: хранение подписок, восстановление при reconnect, удобный API для компонентов
- **Экспортирует**: `useWebSocket()`, `resubscribeAllChannels()`, `cleanupWebSocketChannels()`
- **Не делает**: не создает Echo, не управляет reconnect

#### 3. `bootstrap.js` - Минимальная инициализация
- **Ответственность**: настройка axios, однократный вызов `initEcho()` при загрузке
- **Экспортирует**: helper функции для подписки на каналы (legacy, для обратной совместимости)
- **Не делает**: не управляет reconnect, не имеет собственных таймеров

### Архитектура reconnect

```
┌─────────────────┐
│  bootstrap.js   │
│  (init once)    │
└────────┬────────┘
         │ initEcho()
         ▼
┌─────────────────┐
│  echoClient.ts  │◄──────┐
│  (orchestrator) │       │
│                 │       │ reconnect loop
│  - initEcho()   │       │
│  - reconnect()  │───────┘
│  - state mgmt   │
└────────┬────────┘
         │ onWsStateChange('connected')
         ▼
┌─────────────────┐
│ useWebSocket.ts │
│  (registry)     │
│                 │
│  - resubscribe  │
│  - subscriptions│
└─────────────────┘
```

### Гарантии

1. **Один reconnect механизм**: только `echoClient.ts` управляет reconnect
2. **Детерминированный resubscribe**: при событии `connected` вызывается `resubscribeAllChannels()` один раз
3. **Нет утечек**: при unmount компонентов подписки очищаются, при teardown все таймеры отменяются

### Телеметрия состояния

Создается store для состояния соединения:
- `connected` - соединение установлено
- `connecting` - идет подключение
- `retrying` - переподключение после ошибки
- `failed` - критическая ошибка, переподключение невозможно
- `disconnected` - соединение разорвано

## Последствия

### Положительные
- Устранение гонок между reconnect механизмами
- Предсказуемое поведение при reconnect
- Легче отлаживать проблемы с соединением
- Централизованная телеметрия состояния

### Отрицательные
- Требуется рефакторинг существующего кода
- Нужно протестировать все сценарии reconnect
- Legacy код в `bootstrap.js` может потребовать обновления

## Реализация

1. Создать store для состояния соединения
2. Убрать reconnect логику из `bootstrap.js`
3. Упростить `bootstrap.js` до однократного вызова `initEcho()`
4. Гарантировать однократный вызов `resubscribeAllChannels()` при reconnect
5. Добавить тесты для проверки отсутствия утечек

## Альтернативы

### Альтернатива 1: Оставить текущую архитектуру
- ❌ Проблемы с гонками останутся
- ❌ Сложно отлаживать

### Альтернатива 2: Переместить все в один файл
- ❌ Нарушение разделения ответственности
- ❌ Сложно поддерживать

## Принятое решение

Выбрана консолидация с четким разделением ответственности:
- `echoClient.ts` - lifecycle и reconnect
- `useWebSocket.ts` - registry подписок
- `bootstrap.js` - минимальная инициализация

