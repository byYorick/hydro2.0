# Rate Limiting Configuration

Документация по настройке Rate Limiting в Laravel API.

## Обзор

Rate Limiting защищает API от злоупотреблений и DDoS атак, ограничивая количество запросов от одного клиента за определенный период времени.

## Конфигурация

### Глобальный Rate Limiting

В `bootstrap/app.php` настроен глобальный rate limiting для всех API роутов:

```php
$middleware->api(prepend: [
    \Illuminate\Routing\Middleware\ThrottleRequests::class.':60,1',
]);
```

**Параметры:**
- `60` - максимальное количество запросов
- `1` - период времени в минутах

**Результат:** 60 запросов в минуту для всех API роутов по умолчанию.

### Специфичные лимиты для групп роутов

В `routes/api.php` настроены специфичные лимиты для разных групп:

#### 1. Auth роуты (более строгий лимит)
```php
Route::prefix('auth')->middleware('throttle:10,1')->group(function () {
    // 10 запросов в минуту
});
```
**Причина:** Защита от брутфорс атак на логин.

#### 2. Системные эндпоинты
```php
Route::middleware('throttle:30,1')->group(function () {
    // 30 запросов в минуту
});
```
**Причина:** Публичные эндпоинты, но нужна защита от злоупотреблений.

#### 3. Основные API роуты (аутентифицированные)
```php
Route::middleware(['auth', 'throttle:60,1'])->group(function () {
    // 60 запросов в минуту
});
```
**Причина:** Стандартный лимит для аутентифицированных пользователей.

#### 4. Python ingest (внутренние сервисы)
```php
Route::prefix('python')->middleware('throttle:120,1')->group(function () {
    // 120 запросов в минуту
});
```
**Причина:** Высокий лимит для внутренних сервисов, которые отправляют телеметрию.

#### 5. Регистрация узлов
```php
Route::middleware('throttle:20,1')->group(function () {
    // 20 запросов в минуту
});
```
**Причина:** Умеренный лимит для публичных эндпоинтов регистрации.

## Как работает Rate Limiting

1. **Идентификация клиента:**
   - Для аутентифицированных пользователей: по user ID
   - Для неаутентифицированных: по IP адресу

2. **Хранение счетчиков:**
   - Используется кэш (Redis или файловый кэш)
   - Ключ: `throttle:{identifier}:{route}`

3. **При превышении лимита:**
   - HTTP 429 Too Many Requests
   - Заголовок `Retry-After` с количеством секунд до следующего запроса
   - Тело ответа с сообщением об ошибке

## Пример ответа при превышении лимита

```json
{
    "message": "Too Many Attempts.",
    "retry_after": 45
}
```

HTTP Headers:
```
HTTP/1.1 429 Too Many Requests
Retry-After: 45
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 0
```

## Настройка для разных окружений

### Development
- Можно увеличить лимиты для удобства разработки
- Или отключить для локальной разработки

### Production
- Строгие лимиты для защиты от злоупотреблений
- Мониторинг превышений лимитов через логи

## Мониторинг

### Проверка текущих лимитов

```bash
# Проверить количество запросов для IP
php artisan cache:get throttle:127.0.0.1:api/auth/login
```

### Логирование превышений

Laravel автоматически логирует превышения rate limit в `storage/logs/laravel.log`:
```
[2025-01-19 10:00:00] local.WARNING: Rate limit exceeded for 127.0.0.1
```

## Рекомендации

1. **Для критичных эндпоинтов:** Используйте более строгие лимиты
2. **Для внутренних сервисов:** Используйте токены и более высокие лимиты
3. **Для публичных API:** Используйте умеренные лимиты с возможностью увеличения через подписку
4. **Мониторинг:** Отслеживайте количество 429 ответов для выявления атак

## Изменение лимитов

Для изменения лимитов:

1. **Глобальный лимит:** Измените значение в `bootstrap/app.php`
2. **Специфичный лимит:** Измените значение в соответствующей группе роутов в `routes/api.php`

После изменения очистите кэш:
```bash
php artisan cache:clear
php artisan config:clear
php artisan route:clear
```

