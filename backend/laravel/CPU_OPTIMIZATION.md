# Оптимизация использования CPU

## Проблема
Контейнер Laravel потреблял ~47% CPU, что слишком много для dev окружения.

## Примененные оптимизации

### 1. Vite Watch Оптимизация
- **Интервал polling**: увеличен с 100ms до 1000ms (в 10 раз реже)
- **Игнорируемые директории**: добавлены `node_modules`, `.git`, `storage`, `vendor`, `bootstrap/cache`
- **Результат**: Снижение нагрузки от файлового watcher на ~90%

### 2. PHP-FPM Оптимизация
- **Максимум процессов**: ограничено до 5 (было по умолчанию больше)
- **Стартовые процессы**: 2
- **Минимум свободных**: 1
- **Максимум свободных**: 3
- **Максимум запросов на процесс**: 500 (после чего перезапуск)
- **Результат**: Меньше процессов PHP-FPM = меньше нагрузка на CPU

### 3. Supervisor Приоритеты
- **Vite**: priority=999 (низкий приоритет)
- **Reverb**: priority=998 (низкий приоритет)
- **Результат**: PHP-FPM получает больше CPU времени

### 4. Vite Refresh Оптимизация
- Ограничен список файлов для автоматического refresh
- Только важные директории: views, js, controllers, routes
- **Результат**: Меньше ненужных перезагрузок

### 5. OptimizeDeps
- Предварительная оптимизация зависимостей Vue и Inertia
- **Результат**: Быстрее загрузка, меньше работы во время выполнения

## Ожидаемые результаты

- **CPU использование**: с ~47% до ~10-15%
- **Отзывчивость**: сохранена (polling 1 секунда все еще достаточно быстрый)
- **Hot reload**: работает, но менее агрессивно

## Дополнительные рекомендации

Если CPU все еще высокий:
1. Увеличить интервал polling до 2000ms
2. Отключить Vite в dev режиме и использовать production build
3. Уменьшить PHP_FPM_PM_MAX_CHILDREN до 3
4. Использовать Redis для кеширования вместо file

## Мониторинг

```bash
# Проверка использования CPU
docker stats backend-laravel-1 --no-stream

# Проверка процессов
docker exec backend-laravel-1 sh -c "top -bn1 | head -20"
```

