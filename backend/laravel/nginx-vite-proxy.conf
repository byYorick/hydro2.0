# Прокси для Vite dev server в development режиме
# Этот файл будет скопирован в контейнер и включен в конфигурацию nginx
# ВАЖНО: Эти правила должны быть ДО location / для приоритета

# Прокси для Vite HMR и клиента (WebSocket поддержка)
location /@vite {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    # WebSocket таймауты
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    # ИСПРАВЛЕНО: Передаем все заголовки от Vite (включая Content-Type)
    proxy_pass_header Content-Type;
    proxy_pass_header Content-Length;
    # ИСПРАВЛЕНО: CORS заголовки без Credentials для избежания конфликта
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # ИСПРАВЛЕНО: Fallback для MIME типа, если Vite не установил заголовок
    default_type text/javascript;
}

# Прокси для Vite специальных путей (@id, @fs, @react-refresh и т.д.)
location ~ ^/@(id|fs|vite|react-refresh|client) {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    # ИСПРАВЛЕНО: Передаем все заголовки от Vite (включая Content-Type)
    proxy_pass_header Content-Type;
    proxy_pass_header Content-Length;
    # ИСПРАВЛЕНО: CORS заголовки без Credentials для избежания конфликта
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # ИСПРАВЛЕНО: Fallback для MIME типа, если Vite не установил заголовок
    default_type text/javascript;
}

# Прокси для node_modules (Vite оптимизированные зависимости)
location /node_modules {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Прокси для vendor (Ziggy и другие vendor ресурсы)
location /vendor {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Прокси для JavaScript файлов (js, mjs)
# ВАЖНО: Это должно быть ДО location / для приоритета
# ИСПРАВЛЕНО: Отдельный блок для JavaScript файлов с явным Content-Type
location ~ ^/resources/(js|css)/.*\.(js|mjs)$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    # ИСПРАВЛЕНО: Передаем заголовки от Vite
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # ИСПРАВЛЕНО: Явно устанавливаем Content-Type для JavaScript файлов
    # Это критично для правильной загрузки ES модулей в браузере
    # Используем proxy_hide_header чтобы перезаписать заголовок от Vite если он неправильный
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript always;
    
    # ИСПРАВЛЕНО: CORS заголовки без Credentials для статических ресурсов
    # Credentials не нужны для модулей и HMR, и их нельзя использовать с Access-Control-Allow-Origin: *
    # Используем конкретный Origin или * без Credentials
    set $cors_origin "*";
    if ($http_origin) {
        set $cors_origin $http_origin;
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # ИСПРАВЛЕНО: НЕ используем Credentials для статических ресурсов (модули, HMR)
    # Credentials нужны только для WebSocket (Reverb), но не для статических файлов
    
    # ИСПРАВЛЕНО: Отключаем буферизацию для правильной передачи заголовков
    proxy_buffering off;
}

# Прокси для TypeScript файлов (ts)
location ~ ^/resources/(js|css)/.*\.ts$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript always;
    
    # ИСПРАВЛЕНО: CORS заголовки с конкретным Origin вместо * для совместимости
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Allow-Credentials true always;
    
    proxy_buffering off;
}

# Прокси для Vue файлов (vue)
location ~ ^/resources/(js|css)/.*\.vue$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript always;
    
    # ИСПРАВЛЕНО: CORS заголовки с конкретным Origin вместо * для совместимости
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Allow-Credentials true always;
    
    proxy_buffering off;
}

# Прокси для CSS файлов (css)
# ИСПРАВЛЕНО: Vite в dev режиме возвращает CSS как JavaScript модуль для HMR
# Поэтому нужно использовать application/javascript, а не text/css
location ~ ^/resources/(js|css)/.*\.css$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # ИСПРАВЛЕНО: Vite возвращает CSS как JavaScript модуль для HMR
    # Устанавливаем application/javascript вместо text/css
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript always;
    
    # ИСПРАВЛЕНО: CORS заголовки с конкретным Origin вместо * для совместимости
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    add_header Access-Control-Allow-Credentials true always;
    
    proxy_buffering off;
}

# ИСПРАВЛЕНО: Дополнительный блок для всех остальных запросов к /resources/(js|css)/
# (для файлов без расширения или с другими расширениями)
# ИСПРАВЛЕНО: НЕ устанавливаем default_type, чтобы Vite мог правильно определить MIME тип
# Vite сам устанавливает правильный Content-Type для каждого типа файла
location ~ ^/resources/(js|css)/ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    # ИСПРАВЛЕНО: НЕ добавляем WebSocket заголовки для обычных HTTP запросов
    # proxy_set_header Upgrade и Connection только для WebSocket запросов
    
    # ИСПРАВЛЕНО: Передаем заголовки от Vite (включая Content-Type)
    # Vite правильно определяет MIME тип для каждого файла (text/css для CSS, application/javascript для JS)
    proxy_pass_header Content-Type;
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # ИСПРАВЛЕНО: НЕ перезаписываем Content-Type от Vite
    # Vite правильно устанавливает text/css для CSS и application/javascript для JS
    # Убираем proxy_hide_header и add_header, чтобы не перезаписывать правильный тип от Vite
    
    # ИСПРАВЛЕНО: CORS заголовки без Credentials для статических ресурсов
    # Credentials не нужны для модулей и HMR, и их нельзя использовать с Access-Control-Allow-Origin: *
    # Используем конкретный Origin или * без Credentials
    set $cors_origin "*";
    if ($http_origin) {
        set $cors_origin $http_origin;
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # ИСПРАВЛЕНО: НЕ используем Credentials для статических ресурсов (модули, HMR)
    # Credentials нужны только для WebSocket (Reverb), но не для статических файлов
    
    # ИСПРАВЛЕНО: Отключаем буферизацию
    proxy_buffering off;
}

# Прокси для Laravel Reverb WebSocket (порт 6001)
# ВАЖНО: Этот блок должен быть ДО location / для приоритета
# ИСПРАВЛЕНО: Используем более точный паттерн для WebSocket запросов к Reverb
# Обрабатываем только запросы к /app/{app_key} для WebSocket
location ~ ^/app/[^/]+$ {
    # ИСПРАВЛЕНО: Проксируем путь /app/... на Reverb, сохраняя исходный путь
    # Не добавляем путь в proxy_pass, чтобы nginx сохранил /app/... из запроса
    proxy_pass http://127.0.0.1:6001;
    proxy_http_version 1.1;
    
    # ИСПРАВЛЕНО: WebSocket upgrade заголовки ТОЛЬКО для WebSocket запросов
    # Проверяем наличие заголовка Upgrade перед установкой
    # Если заголовок Upgrade отсутствует, это обычный HTTP запрос, не WebSocket
    set $upgrade_header $http_upgrade;
    if ($upgrade_header = '') {
        # Если нет заголовка Upgrade, это не WebSocket запрос
        # Возвращаем ошибку или проксируем как обычный HTTP
        return 400;
    }
    
    # ИСПРАВЛЕНО: WebSocket upgrade заголовки
    # Эти заголовки критически важны для правильной работы WebSocket
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # ИСПРАВЛЕНО: Базовые заголовки для проксирования
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # ИСПРАВЛЕНО: WebSocket специфичные настройки
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    proxy_connect_timeout 60s;
    proxy_send_timeout 86400;
    
    # ИСПРАВЛЕНО: Критически важно для WebSocket - не буферизуем соединения
    proxy_buffering off;
    proxy_request_buffering off;
    
    # ИСПРАВЛЕНО: Отключаем сжатие для WebSocket (может нарушать фреймы)
    proxy_set_header Accept-Encoding "";
    
    # ИСПРАВЛЕНО: CORS заголовки для WebSocket с конкретным Origin и Credentials
    # Для WebSocket нужны Credentials, поэтому используем конкретный Origin (не *)
    set $ws_cors_origin "";
    if ($http_origin) {
        set $ws_cors_origin $http_origin;
    }
    # Если Origin не указан, используем Host (для same-origin запросов)
    if ($ws_cors_origin = "") {
        set $ws_cors_origin "http://$host";
    }
    add_header Access-Control-Allow-Origin $ws_cors_origin always;
    add_header Access-Control-Allow-Credentials true always;
    
    # Логирование WebSocket запросов для диагностики
    access_log /var/log/nginx/websocket_access.log combined;
}
