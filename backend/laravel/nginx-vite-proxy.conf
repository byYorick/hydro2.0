# Прокси для Vite dev server в development режиме
# Этот файл будет скопирован в контейнер и включен в конфигурацию nginx
# ВАЖНО: Эти правила должны быть ДО location / для приоритета

# Прокси для Vite HMR и клиента (WebSocket поддержка)
location /@vite {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    # WebSocket таймауты
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    # Передаем заголовки от Vite
    proxy_pass_header Content-Length;
    # Явно устанавливаем Content-Type для ES модулей
    proxy_hide_header Content-Type;
    add_header Content-Type "application/javascript; charset=utf-8" always;
    # CORS заголовки без Credentials для избежания конфликта
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
}

# Прокси для Vite специальных путей (@id, @fs, @react-refresh и т.д.)
location ~ ^/@(id|fs|vite|react-refresh|client) {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    # Передаем заголовки от Vite
    proxy_pass_header Content-Length;
    # Явно устанавливаем Content-Type для ES модулей
    proxy_hide_header Content-Type;
    add_header Content-Type "application/javascript; charset=utf-8" always;
    # CORS заголовки без Credentials для избежания конфликта
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
}

# Прокси для node_modules (Vite оптимизированные зависимости)
location /node_modules {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Прокси для vendor (Ziggy и другие vendor ресурсы)
location /vendor {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Прокси для JavaScript файлов (js, mjs)
# ВАЖНО: Это должно быть ДО location / для приоритета
# Отдельный блок для JavaScript файлов с явным Content-Type
location ~ ^/resources/(js|css)/.*\.(js|mjs)$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    # Передаем заголовки от Vite
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # Явно устанавливаем Content-Type для JavaScript файлов
    # Это критично для правильной загрузки ES модулей в браузере
    # Используем proxy_hide_header чтобы перезаписать заголовок от Vite если он неправильный
    proxy_hide_header Content-Type;
    add_header Content-Type application/javascript always;
    
    # CORS заголовки без Credentials для статических ресурсов
    # Credentials не нужны для модулей и HMR, и их нельзя использовать с Access-Control-Allow-Origin: *
    # Используем конкретный Origin или * без Credentials
    set $cors_origin "*";
    if ($http_origin) {
        set $cors_origin $http_origin;
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # НЕ используем Credentials для статических ресурсов (модули, HMR)
    # Credentials нужны только для WebSocket (Reverb), но не для статических файлов
    
    # Отключаем буферизацию для правильной передачи заголовков
    proxy_buffering off;
}

# Прокси для TypeScript файлов (ts)
location ~ ^/resources/(js|css)/.*\.ts$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    # Обработка ошибок проксирования
    proxy_intercept_errors off;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # CORS заголовки с конкретным Origin вместо * для совместимости с Credentials
    # Credentials можно использовать только с конкретным Origin, не с *
    set $cors_origin $http_origin;
    if ($cors_origin = "") {
        set $cors_origin "http://$host";
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # Credentials только если Origin указан (не *)
    if ($cors_origin != "*") {
        add_header Access-Control-Allow-Credentials true always;
    }
    
    proxy_buffering off;
}

# Прокси для Vue файлов (vue)
location ~ ^/resources/(js|css)/.*\.vue$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # CORS заголовки с конкретным Origin вместо * для совместимости с Credentials
    # Credentials можно использовать только с конкретным Origin, не с *
    set $cors_origin $http_origin;
    if ($cors_origin = "") {
        set $cors_origin "http://$host";
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # Credentials только если Origin указан (не *)
    if ($cors_origin != "*") {
        add_header Access-Control-Allow-Credentials true always;
    }
    
    proxy_buffering off;
}

# Прокси для CSS файлов (css)
# Vite в dev режиме возвращает CSS как JavaScript модуль для HMR
# Поэтому нужно использовать application/javascript, а не text/css
location ~ ^/resources/(js|css)/.*\.css$ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # CORS заголовки с конкретным Origin вместо * для совместимости с Credentials
    # Credentials можно использовать только с конкретным Origin, не с *
    set $cors_origin $http_origin;
    if ($cors_origin = "") {
        set $cors_origin "http://$host";
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # Credentials только если Origin указан (не *)
    if ($cors_origin != "*") {
        add_header Access-Control-Allow-Credentials true always;
    }
    
    proxy_buffering off;
}

# Дополнительный блок для всех остальных запросов к /resources/(js|css)/
# (для файлов без расширения или с другими расширениями)
# НЕ устанавливаем default_type, чтобы Vite мог правильно определить MIME тип
# Vite сам устанавливает правильный Content-Type для каждого типа файла
location ~ ^/resources/(js|css)/ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    
    # НЕ добавляем WebSocket заголовки для обычных HTTP запросов
    # proxy_set_header Upgrade и Connection только для WebSocket запросов
    
    # Передаем заголовки от Vite
    proxy_pass_header Content-Length;
    proxy_pass_header Last-Modified;
    proxy_pass_header ETag;
    proxy_pass_header Cache-Control;
    proxy_pass_header Vary;
    
    # CORS заголовки без Credentials для статических ресурсов
    # Credentials не нужны для модулей и HMR, и их нельзя использовать с Access-Control-Allow-Origin: *
    # Используем конкретный Origin или * без Credentials
    set $cors_origin "*";
    if ($http_origin) {
        set $cors_origin $http_origin;
    }
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # НЕ используем Credentials для статических ресурсов (модули, HMR)
    # Credentials нужны только для WebSocket (Reverb), но не для статических файлов
    
    # Отключаем буферизацию
    proxy_buffering off;
}

# Прокси для Laravel Reverb WebSocket (порт 6001)
# ВАЖНО: Этот блок должен быть ДО location / для приоритета
# Используем более точный паттерн для WebSocket запросов к Reverb
# Обрабатываем запросы к /app/{app_key} и /app/{app_key}/* для WebSocket
# Pusher может создавать пути вида /app/{app_key} или /app/{app_key}/...
# Также обрабатываем ошибочные пути вида /app/app/{app_key} и перенаправляем их на /app/{app_key}
location ~ ^/app/app/([^/]+)(/.*)?$ {
    # Исправляем двойной путь /app/app/{key} на /app/{key}
    # Это временное решение, пока не исправлена конфигурация Pusher
    set $fixed_path /app/$1$2;
    rewrite ^/app/app/([^/]+)(/.*)?$ /app/$1$2 break;
    proxy_pass http://127.0.0.1:6001;
    proxy_http_version 1.1;
    
    # WebSocket upgrade заголовки ТОЛЬКО для WebSocket запросов
    set $upgrade_header $http_upgrade;
    if ($upgrade_header = '') {
        return 400;
    }
    
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    proxy_connect_timeout 60s;
    proxy_send_timeout 86400;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_set_header Accept-Encoding "";
    
    set $ws_cors_origin "";
    if ($http_origin) {
        set $ws_cors_origin $http_origin;
    }
    if ($ws_cors_origin = "") {
        set $ws_cors_origin "http://$host";
    }
    add_header Access-Control-Allow-Origin $ws_cors_origin always;
    add_header Access-Control-Allow-Credentials true always;
    access_log /var/log/nginx/websocket_access.log combined;
}

location ~ ^/app/[^/]+(/.*)?$ {
    # Проксируем путь /app/... на Reverb, сохраняя исходный путь
    # Не добавляем путь в proxy_pass, чтобы nginx сохранил /app/... из запроса
    proxy_pass http://127.0.0.1:6001;
    proxy_http_version 1.1;
    
    # WebSocket upgrade заголовки ТОЛЬКО для WebSocket запросов
    # Проверяем наличие заголовка Upgrade перед установкой
    # Если заголовок Upgrade отсутствует, это обычный HTTP запрос, не WebSocket
    set $upgrade_header $http_upgrade;
    if ($upgrade_header = '') {
        # Если нет заголовка Upgrade, это не WebSocket запрос
        # Возвращаем ошибку или проксируем как обычный HTTP
        return 400;
    }
    
    # WebSocket upgrade заголовки
    # Эти заголовки критически важны для правильной работы WebSocket
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Базовые заголовки для проксирования
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # WebSocket специфичные настройки
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    proxy_connect_timeout 60s;
    proxy_send_timeout 86400;
    
    # Критически важно для WebSocket - не буферизуем соединения
    proxy_buffering off;
    proxy_request_buffering off;
    
    # Отключаем сжатие для WebSocket (может нарушать фреймы)
    proxy_set_header Accept-Encoding "";
    
    # CORS заголовки для WebSocket с конкретным Origin и Credentials
    # Для WebSocket нужны Credentials, поэтому используем конкретный Origin (не *)
    set $ws_cors_origin "";
    if ($http_origin) {
        set $ws_cors_origin $http_origin;
    }
    # Если Origin не указан, используем Host (для same-origin запросов)
    if ($ws_cors_origin = "") {
        set $ws_cors_origin "http://$host";
    }
    add_header Access-Control-Allow-Origin $ws_cors_origin always;
    add_header Access-Control-Allow-Credentials true always;
    
    # Логирование WebSocket запросов для диагностики
    access_log /var/log/nginx/websocket_access.log combined;
}
