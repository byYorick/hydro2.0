# Прокси для Vite dev server в development режиме
# Этот файл будет скопирован в контейнер и включен в конфигурацию nginx
# ВАЖНО: Эти правила должны быть ДО location / для приоритета

# Прокси для Vite HMR и клиента (WebSocket поддержка)
location /@vite {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    # WebSocket таймауты
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    # ИСПРАВЛЕНО: Передаем все заголовки от Vite (включая Content-Type)
    proxy_pass_header Content-Type;
    proxy_pass_header Content-Length;
    # Разрешаем CORS для модулей
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # ИСПРАВЛЕНО: Fallback для MIME типа, если Vite не установил заголовок
    default_type text/javascript;
}

# Прокси для Vite специальных путей (@id, @fs, @react-refresh и т.д.)
location ~ ^/@(id|fs|vite|react-refresh|client) {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    # ИСПРАВЛЕНО: Передаем все заголовки от Vite (включая Content-Type)
    proxy_pass_header Content-Type;
    proxy_pass_header Content-Length;
    # Разрешаем CORS для модулей
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
    # ИСПРАВЛЕНО: Fallback для MIME типа, если Vite не установил заголовок
    default_type text/javascript;
}

# Прокси для node_modules (Vite оптимизированные зависимости)
location /node_modules {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Прокси для vendor (Ziggy и другие vendor ресурсы)
location /vendor {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
}

# Прокси для ресурсов Vite (js, css, vue, ts файлы)
# ВАЖНО: Это должно быть ДО location / для приоритета
location ~ ^/resources/(js|css)/ {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    # Не добавляем заголовки здесь - Vite сам установит правильные заголовки
    # Добавление заголовков может конфликтовать с Vite HMR и обработкой TypeScript
}

# Прокси для Laravel Reverb WebSocket (порт 6001)
# ВАЖНО: Этот блок должен быть ДО location / для приоритета
location /app/ {
    # ИСПРАВЛЕНО: Проксируем путь /app/... на Reverb, сохраняя исходный путь
    # Не добавляем путь в proxy_pass, чтобы nginx сохранил /app/... из запроса
    proxy_pass http://127.0.0.1:6001;
    proxy_http_version 1.1;
    
    # ИСПРАВЛЕНО: WebSocket upgrade заголовки
    # Эти заголовки критически важны для правильной работы WebSocket
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # ИСПРАВЛЕНО: Базовые заголовки для проксирования
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # ИСПРАВЛЕНО: WebSocket специфичные настройки
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    proxy_connect_timeout 7d;
    proxy_send_timeout 7d;
    
    # ИСПРАВЛЕНО: Критически важно для WebSocket - не буферизуем соединения
    proxy_buffering off;
    proxy_request_buffering off;
    
    # ИСПРАВЛЕНО: Отключаем сжатие для WebSocket (может нарушать фреймы)
    proxy_set_header Accept-Encoding "";
    
    # Логирование WebSocket запросов для диагностики
    access_log /var/log/nginx/websocket_access.log combined;
}
