name: E02_command_happy
description: Тест успешного выполнения команды узлу

steps:
  - name: Check system health
    api.get:
      path: /api/system/health
      save: health

  - name: Get zones
    api.get:
      path: /api/zones
      save: zones

  - name: Get nodes
    api.get:
      path: /api/nodes
      save: nodes

  - name: Find test zone and node
    set:
      test_zone_id: ${zones.data.data[0].id}
      test_node_id: ${nodes.data.data[0].id}

  - name: Subscribe to command channel
    ws.subscribe:
      # Commands are broadcast per-zone (see App\Events\CommandStatusUpdated::broadcastOn)
      channel: private-commands.${test_zone_id}

  - name: Subscribe to zone channel
    ws.subscribe:
      channel: private-hydro.zones.${test_zone_id}

  - name: Send command to node
    api.post:
      path: /api/nodes/${test_node_id}/commands
      json:
        cmd: set_relay_state
        channel: main_pump
        params:
          state: false
      save: command_response

  - name: Save command ID
    set:
      command_id: ${command_response.data.command_id}

  - name: Wait for command status update (SENT or ACCEPTED)
    ws.wait_event:
      event: ".App\\Events\\CommandStatusUpdated"
      timeout: 15.0

  - name: Check command status in DB (wait for SENT or ACCEPTED)
    db.wait:
      query: SELECT status FROM commands WHERE cmd_id = :cmd_id AND status IN ('SENT', 'ACCEPTED')
      params:
        cmd_id: ${command_id}
      timeout: 15.0
      expected_rows: 1
      save: command_status

  - name: Assert command status is SENT or ACCEPTED
    assert.contains:
      container: ['SENT', 'ACCEPTED']
      item: ${command_status[0].status}
      message: "Expected SENT or ACCEPTED, but got ${command_status[0].status}"

  - name: Wait for command acceptance (ACCEPTED) if not already
    ws.wait_event:
      event: ".App\\Events\\CommandStatusUpdated"
      timeout: 10.0
      filter:
        status: ACCEPTED
        commandId: ${command_id}
      optional: true

  - name: Check command status is ACCEPTED or DONE (if ACCEPTED not received, skip to DONE)
    db.wait:
      query: SELECT status FROM commands WHERE cmd_id = :cmd_id AND status IN ('ACCEPTED', 'DONE', 'ACK')
      params:
        cmd_id: ${command_id}
      timeout: 20.0
      expected_rows: 1
      save: command_status_final

  - name: Wait for command completion (DONE)
    ws.wait_event:
      event: ".App\\Events\\CommandStatusUpdated"
      timeout: 10.0
      filter:
        commandId: ${command_id}
        status: DONE

  - name: Get final command status
    api.get:
      path: /api/commands/${command_id}/status
      save: final_command

  - name: Assert command is DONE or ACCEPTED
    assert.contains:
      container: ['DONE', 'ACCEPTED']
      item: ${final_command.data.status}
      message: "Expected DONE or ACCEPTED, but got ${final_command.data.status}"

  - name: Get command history
    db.query:
      query: SELECT status, created_at, updated_at, sent_at, ack_at FROM commands WHERE cmd_id = :cmd_id ORDER BY updated_at
      params:
        cmd_id: ${command_id}
      save: command_history

  - name: Assert monotonic command status
    assert.monotonic_command_status:
      commands: ${command_history}

  - name: Check command recorded in zone_events
    type: database_query
    query: |
      SELECT id, type, entity_type, entity_id, payload
      FROM zone_events
      WHERE zone_id = :zone_id
      AND entity_type = 'command'
      AND entity_id = :cmd_id
      AND type = 'command_status'
    params:
      zone_id: ${test_zone_id}
      cmd_id: ${command_id}
    timeout: 10.0
    expected:
      - field: id
        operator: is_not_null
      - field: type
        operator: equals
        value: "command_status"
