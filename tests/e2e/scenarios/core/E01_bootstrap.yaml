# E01: Bootstrap - Телеметрия в БД + online статус
# DoD: telemetry в БД + online статус

name: E01_bootstrap
description: |
  Проверяет базовый bootstrap пайплайна:
  - Узел публикует телеметрию через MQTT
  - Телеметрия сохраняется в БД
  - Статус узла обновляется на ONLINE
  - last_seen_at обновляется

setup:
  # Настройка симулятора узла
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1884}
        username: ${MQTT_USER:-null}
        password: ${MQTT_PASS:-null}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
          - solution_temp_c
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0

  # Предварительные условия
  prerequisites:
    - database: nodes table exists
    - database: zones table exists with zone_id for zn-test-1
    - mqtt: broker is accessible
    - backend: Laravel is running

actions:
  # Шаг 1: Запуск симулятора узла (обязательно)
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3  # Ждем подключения и первой публикации

  # Шаг 2: Получаем zone_id и node_id по UID из конфига симулятора
  - step: get_zones
    type: api_get
    endpoint: "/api/zones"
    save: zones
  
  - step: get_nodes
    type: api_get
    endpoint: "/api/nodes"
    save: nodes

  # Ищем зону и ноду по UID из конфига симулятора (не по индексу)
  - step: find_test_zone_and_node
    type: set
    test_zone_uid: zn-test-1
    test_node_uid: nd-ph-esp32una
  
  # Шаг 3: Получаем zone_id и node_id по UID (runner должен установить их автоматически, но проверим)
  # Если zone_id/node_id не установлены автоматически, ищем по UID
  - step: resolve_ids_by_uid
    type: database_query
    query: |
      SELECT 
        z.id as zone_id,
        n.id as node_id
      FROM nodes n
      LEFT JOIN zones z ON n.zone_id = z.id
      WHERE n.uid = :node_uid
      AND z.uid = :zone_uid
      LIMIT 1
    params:
      node_uid: ${test_node_uid}
      zone_uid: ${test_zone_uid}
    timeout: 5.0
    expected_rows: 1
    save: id_resolution

  - step: set_resolved_ids
    type: set
    zone_id: ${id_resolution[0].zone_id}
    node_id: ${id_resolution[0].node_id}

  # Шаг 4: Ждем публикации телеметрии от node-sim (он работает автоматически)
  # node-sim публикует телеметрию каждые 2 секунды, ждем минимум одну публикацию
  - step: wait_for_telemetry_publish
    type: sleep
    seconds: 8

assertions:
  # Проверка 1: Телеметрия в БД (ОБЯЗАТЕЛЬНАЯ - DoD требует телеметрию в БД)
  - name: telemetry_in_db
    type: database_query
    query: |
      SELECT value, channel, node_id, zone_id, updated_at, metric_type
      FROM telemetry_last
      WHERE zone_id = :zone_id
      AND node_id = :node_id
      AND metric_type = 'ph'
      LIMIT 1
    params:
      zone_id: ${zone_id}
      node_id: ${node_id}
    timeout: 20.0
    expected_rows: 1
    expected:
      - field: value
        operator: is_not_null
      - field: metric_type
        operator: equals
        value: "ph"
      - field: updated_at
        operator: is_not_null

  # Проверка 2: Статус узла ONLINE
  - name: node_status_online
    type: database_query
    query: |
      SELECT status, last_seen_at
      FROM nodes
      WHERE uid = :node_uid
    params:
      node_uid: ${test_node_uid}
    expected:
      - field: status
        operator: equals
        value: "online"
      - field: last_seen_at
        operator: is_not_null

  # Проверка 3: Узел привязан к зоне
  - name: node_attached_to_zone
    type: database_query
    query: |
      SELECT zone_id
      FROM nodes
      WHERE uid = :node_uid
    params:
      node_uid: ${test_node_uid}
    expected:
      - field: zone_id
        operator: is_not_null

cleanup:
  - step: stop_node_simulator
    type: stop_simulator
