# E01: Bootstrap - Телеметрия в БД + online статус
# DoD: telemetry в БД + online статус

name: E01_bootstrap
description: |
  Проверяет базовый bootstrap пайплайна:
  - Узел публикует телеметрию через MQTT
  - Телеметрия сохраняется в БД
  - Статус узла обновляется на ONLINE
  - last_seen_at обновляется

setup:
  # Настройка симулятора узла
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1884}
        username: ${MQTT_USER:-null}
        password: ${MQTT_PASS:-null}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
          - solution_temp_c
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0

  # Предварительные условия
  prerequisites:
    - database: nodes table exists
    - database: zones table exists with zone_id for zn-test-1
    - mqtt: broker is accessible
    - backend: Laravel is running

actions:
  # Шаг 1: Запуск симулятора узла (обязательно)
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3  # Ждем подключения и первой публикации

  # Шаг 2: Получаем zone_id и node_id по UID из конфига симулятора
  - step: get_zones
    type: api_get
    endpoint: "/api/zones"
    save: zones
  
  - step: get_nodes
    type: api_get
    endpoint: "/api/nodes"
    save: nodes

  # Ищем зону и ноду по UID из конфига симулятора (не по индексу)
  - step: find_test_zone_and_node
    type: set
    test_zone_uid: zn-test-1
    test_node_uid: nd-ph-esp32una
  
  # Шаг 3: Получаем zone_id и node_id по UID через API
  # Runner автоматически устанавливает zone_id/node_id из setup, но проверим через API
  - step: find_zone_by_uid
    type: api_get
    endpoint: /api/zones
    save: zones_list

  - step: find_node_by_uid
    type: api_get
    endpoint: /api/nodes
    save: nodes_list

  # Получаем zone_id/node_id из БД (устойчиво к изменению ID)
  - step: fetch_zone_id
    type: database_query
    query: |
      SELECT id AS zone_id
      FROM zones
      WHERE uid = 'zn-test-1'
      LIMIT 1
    expected_rows: 1
    save: zone_row

  - step: fetch_node_id
    type: database_query
    query: |
      SELECT id AS node_id
      FROM nodes
      WHERE uid = 'nd-ph-esp32una'
      LIMIT 1
    expected_rows: 1
    save: node_row

  - step: set_zone_and_node_ids
    type: set
    zone_id: ${zone_row.0.zone_id}
    node_id: ${node_row.0.node_id}

  # Отладка: проверяем что переменные установлены
  - step: debug_variables
    type: set
    debug_zone_id: ${zone_id}
    debug_node_id: ${node_id}

  # Ждем публикации телеметрии от node-sim (он работает автоматически)
  # node-sim публикует телеметрию каждые 2 секунды, ждем минимум одну публикацию
  - step: wait_for_telemetry_publish
    type: wait
    seconds: 5

assertions:
  # Проверка 1: Телеметрия в БД (ОБЯЗАТЕЛЬНАЯ - DoD требует телеметрию в БД)
  # Используем raw SQL для TimescaleDB
  - name: telemetry_in_db
    type: database_query
    query: |
      SELECT
        tl.last_value as value,
        s.label as channel,
        s.node_id,
        s.zone_id,
        tl.updated_at,
        s.type as metric_type
      FROM telemetry_last tl
      JOIN sensors s ON s.id = tl.sensor_id
      WHERE s.zone_id = :zone_id
        AND s.node_id = :node_id
        AND s.type = 'PH'
      LIMIT 1
    params:
      zone_id: ${zone_id}
      node_id: ${node_id}
    timeout: 30.0
    expected_rows: 1
    expected:
      - field: value
        operator: is_not_null
      - field: metric_type
        operator: equals
        value: "PH"
      - field: updated_at
        operator: is_not_null

  # Проверка 2: Статус узла ONLINE
  - name: node_status_online
    type: database_query
    query: |
      SELECT status, last_seen_at
      FROM nodes
      WHERE uid = 'nd-ph-esp32una'
    expected_rows: 1
    expected:
      - field: status
        operator: equals
        value: "online"
      - field: last_seen_at
        operator: is_not_null

  # Проверка 3: Узел привязан к зоне
  - name: node_attached_to_zone
    type: database_query
    query: |
      SELECT zone_id
      FROM nodes
      WHERE uid = 'nd-ph-esp32una'
    expected_rows: 1
    expected:
      - field: zone_id
        operator: is_not_null

cleanup:
  - step: stop_node_simulator
    type: stop_simulator
