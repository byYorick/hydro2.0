# E01: Bootstrap - Телеметрия в БД + online статус
# DoD: telemetry в БД + online статус

name: E01_bootstrap
description: |
  Проверяет базовый bootstrap пайплайна:
  - Узел публикует телеметрию через MQTT
  - Телеметрия сохраняется в БД
  - Статус узла обновляется на ONLINE
  - last_seen_at обновляется

setup:
  # Настройка симулятора узла
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1883}
        username: ${MQTT_USER:-null}
        password: ${MQTT_PASS:-null}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
          - solution_temp_c
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0

  # Предварительные условия
  prerequisites:
    - database: nodes table exists
    - database: zones table exists with zone_id for zn-test-1
    - mqtt: broker is accessible
    - backend: Laravel is running

actions:
  # Шаг 1: Запуск симулятора узла
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3  # Ждем подключения и первой публикации

  # Шаг 2: Получаем zone_id и node_id
  - step: get_zones
    type: api_get
    endpoint: "/api/zones"
    save: zones
  
  - step: get_nodes
    type: api_get
    endpoint: "/api/nodes"
    save: nodes

  - step: find_test_zone_and_node
    type: set
    test_zone_id: ${zones.data.data[0].id}
    test_node_id: ${nodes.data.data[0].id}
    test_node_uid: ${nodes.data.data[0].uid}

  # Шаг 3: Ждем публикации телеметрии от node-sim (он работает автоматически)
  # node-sim публикует телеметрию каждые 5 секунд, ждем минимум одну публикацию
    wait_seconds: 8

assertions:
  # Проверка 1: Телеметрия в БД
  - name: telemetry_in_db
    type: database_query
    query: |
      SELECT value, channel, node_id, zone_id, updated_at, metric_type
      FROM telemetry_last
      WHERE zone_id = :zone_id
      AND node_id = :node_id
      AND metric_type = 'ph'
    params:
      zone_id: ${test_zone_id}
      node_id: ${test_node_id}
    timeout: 15.0
    expected:
      - field: value
        operator: is_not_null
      - field: metric_type
        operator: equals
        value: "ph"
      - field: updated_at
        operator: is_not_null

  # Проверка 2: Статус узла ONLINE
  - name: node_status_online
    type: database_query
    query: |
      SELECT status, last_seen_at
      FROM nodes
      WHERE uid = :node_uid
    params:
      node_uid: ${test_node_uid}
    expected:
      - field: status
        operator: equals
        value: "online"
      - field: last_seen_at
        operator: is_not_null

  # Проверка 3: Узел привязан к зоне
  - name: node_attached_to_zone
    type: database_query
    query: |
      SELECT zone_id
      FROM nodes
      WHERE uid = :node_uid
    params:
      node_uid: ${test_node_uid}
    expected:
      - field: zone_id
        operator: is_not_null

cleanup:
  - step: stop_node_simulator
    type: stop_simulator

