# E00: API Smoke - Проверка доступности ключевых API endpoints без 500 ошибок
# DoD: Все ключевые endpoints возвращают 200/201/401/403/404, но не 500

name: E00_api_smoke
description: |
  Проверяет доступность ключевых API endpoints без 500 ошибок.
  Все endpoints должны возвращать корректные HTTP статусы (200/201 для успешных, 401/403/404 для auth/errors).

setup:
  prerequisites:
    - backend: Laravel is running
    - database: database is accessible

actions:
  # Тест 1: Health endpoint
  - step: check_health
    type: api_get
    endpoint: /api/system/health
    save: health_response

  # Тест 2: Auth endpoints (должны вернуть 401 без токена)
  - step: check_login_endpoint
    type: api_post
    endpoint: /api/auth/login
    data:
      email: "invalid@test.local"
      password: "invalid"
    save: login_response
    expect_no_500: true

  # Тест 3: Protected endpoints (должны вернуть 401 без токена)
  - step: check_zones_protected
    type: api_get
    endpoint: /api/zones
    save: zones_response
    expect_no_500: true

  - step: check_nodes_protected
    type: api_get
    endpoint: /api/nodes
    save: nodes_response
    expect_no_500: true

  - step: check_cycles_protected
    type: api_get
    endpoint: /api/grow-cycles
    save: cycles_response
    expect_no_500: true

  - step: check_greenhouses_protected
    type: api_get
    endpoint: /api/greenhouses
    save: greenhouses_response
    expect_no_500: true

  # Тест 4: Commands endpoint (должен вернуть 401)
  - step: check_commands_protected
    type: api_post
    endpoint: /api/commands
    data:
      type: "TEST_COMMAND"
      zone_id: 1
      node_id: 1
    save: commands_response
    expect_no_500: true

assertions:
  # Проверка 1: Health endpoint работает
  - name: health_endpoint_works
    type: json_assertion
    data: ${health_response}
    expected:
      - field: status_code
        operator: in
        value: [200, 201]
        optional: true

  # Проверка 2: Нет 500 ошибок (все endpoints возвращают корректные статусы)
  - name: no_500_errors_on_endpoints
    type: custom_assert
    condition: all(s not in [500, 502, 503, 504] for s in [context.get('health_response', {}).get('status_code', 0), context.get('login_response', {}).get('status_code', 0), context.get('zones_response', {}).get('status_code', 0), context.get('nodes_response', {}).get('status_code', 0), context.get('cycles_response', {}).get('status_code', 0), context.get('greenhouses_response', {}).get('status_code', 0), context.get('commands_response', {}).get('status_code', 0)] if s > 0)
