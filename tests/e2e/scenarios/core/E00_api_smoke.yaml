# E00: API Smoke - Проверка доступности ключевых API endpoints без 500 ошибок
# DoD: Все ключевые endpoints возвращают 200/201/401/403/404, но не 500

name: E00_api_smoke
description: |
  Проверяет доступность ключевых API endpoints без 500 ошибок.
  Все endpoints должны возвращать корректные HTTP статусы (200/201 для успешных, 401/403/404 для auth/errors).

setup:
  prerequisites:
    - backend: Laravel is running
    - database: database is accessible

actions:
  - step: set_laravel_url
    type: set
    LARAVEL_URL: http://localhost:8081

  # Тест 1: Health endpoint
  - step: check_health
    type: api_get
    endpoint: /api/system/health
    save: health_response

  # Тест 2: Auth endpoints (должны вернуть 422 при неправильных credentials)
  - step: check_login_endpoint
    type: http_request
    method: POST
    url: ${LARAVEL_URL}/api/auth/login
    body:
      email: "invalid@test.local"
      password: "invalid"
    capture_response: login_response

  # Тест 3: Protected endpoints (должны вернуть 401 без токена)
  - step: check_zones_protected
    type: api_get
    endpoint: /api/zones
    save: zones_response
    expect_no_500: true

  - step: check_nodes_protected
    type: api_get
    endpoint: /api/nodes
    save: nodes_response
    expect_no_500: true

  - step: check_cycles_protected
    type: api_get
    endpoint: /api/grow-cycles
    save: cycles_response
    expect_no_500: true

  - step: check_greenhouses_protected
    type: api_get
    endpoint: /api/greenhouses
    save: greenhouses_response
    expect_no_500: true

  # Тест 4: Zone commands endpoint (должен вернуть 422 при неправильных данных)
  - step: check_commands_protected
    type: api_post
    endpoint: /api/zones/${zone_id}/commands
    payload:
      type: "IRRIGATION"
      node_id: ${node_id}
      params:
        duration_sec: 30
    save: commands_response
    expected_status: 422

assertions:
  # Проверка 1: Health endpoint работает
  - name: health_endpoint_works
    type: json_assertion
    data: ${health_response}
    expected:
      - field: status_code
        operator: in
        value: [200, 201]
        optional: true

  # Проверка 2: Нет 500 ошибок (все endpoints возвращают корректные статусы)
  # Логин возвращает 422 (validation error) - это ожидаемо для неправильных credentials
  # Остальные endpoints возвращают 401 (unauthorized) - это нормально
  - name: no_500_errors_on_endpoints
    type: custom_assert
    condition: all(s not in [500, 502, 503, 504] for s in [context.get('health_response', {}).get('status_code', 0), context.get('login_response', {}).get('status_code', 0), context.get('zones_response', {}).get('status_code', 0), context.get('nodes_response', {}).get('status_code', 0), context.get('cycles_response', {}).get('status_code', 0), context.get('greenhouses_response', {}).get('status_code', 0), context.get('commands_response', {}).get('status_code', 0)] if s > 0)

  # Проверка 3: Логин возвращает правильный validation error
  - name: login_returns_validation_error
    type: custom_assert
    condition: context.get('login_response', {}).get('status_code') == 422
