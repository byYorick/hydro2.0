# E20: Frontend Legacy Guard - проверка работы guard для legacy паттернов в frontend
# DoD: Frontend legacy guard корректно логирует доступ к legacy URL/параметрам

name: E20_frontend_legacy_guard
description: |
  Проверяет работу Frontend Legacy Guard:
  - Делает запрос к странице с legacy query параметром
  - Проверяет логи на наличие записей о legacy guard
  - Убеждается, что guard логирует, но не блокирует работу системы

actions:
  # Создаем HTTP запрос к странице с legacy параметром (имитируем frontend запрос)
  - step: request_with_legacy_param
    type: http_request
    method: GET
    url: ${LARAVEL_URL}/dashboard?zone_recipe_instance_id=123&legacy_mode=true
    headers:
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
      User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
    save: legacy_request_response

  # Ждем немного, чтобы логи были записаны
  - step: wait_for_logging
    type: sleep
    duration: 2.0

  # Проверяем логи на наличие FRONT_LEGACY_GUARD записей
  - step: check_frontend_legacy_logs
    type: database_query
    query: |
      SELECT COUNT(*) as guard_warning_count
      FROM system_logs
      WHERE level = 'warning'
      AND message LIKE '%FRONT_LEGACY_GUARD%'
      AND created_at > NOW() - INTERVAL '5 minutes'
    save: guard_warnings

  # Проверяем логи на наличие ошибок о legacy параметрах
  - step: check_legacy_param_errors
    type: database_query
    query: |
      SELECT COUNT(*) as guard_error_count
      FROM system_logs
      WHERE level = 'error'
      AND message LIKE '%FRONT_LEGACY_GUARD%'
      AND message LIKE '%query parameter%'
      AND created_at > NOW() - INTERVAL '5 minutes'
    save: guard_errors

assertions:
  # Проверка 1: HTTP запрос выполнен (guard не блокирует)
  - name: request_succeeds
    type: json_assertion
    data: ${legacy_request_response}
    expected:
      - field: status_code
        operator: in
        value: [200, 302, 404]  # 404 нормально, если страница не существует

  # Проверка 2: Guard логирует legacy URL паттерны (предупреждения)
  - name: guard_logs_legacy_patterns
    type: json_assertion
    data: ${guard_warnings}
    expected:
      - field: guard_warning_count
        operator: greater_than_or_equal
        value: 0  # Может быть 0, если URL паттерн не найден

  # Проверка 3: Guard логирует legacy query параметры (ошибки)
  - name: guard_logs_legacy_params
    type: json_assertion
    data: ${guard_errors}
    expected:
      - field: guard_error_count
        operator: greater_than
        value: 0  # Должны быть ошибки о legacy параметрах

  # Проверка 4: Система продолжает работать (нет критических ошибок)
  - name: system_still_works
    type: custom_assert
    condition: |
      # Проверяем, что запрос был обработан (даже если вернул 404)
      status = context.get('legacy_request_response', {}).get('status_code', 0)
      status > 0  # Любой HTTP статус означает, что система работает

cleanup:
  # Очищаем логи guard (опционально, для чистоты тестов)
  - step: cleanup_guard_logs
    type: database_execute
    query: |
      DELETE FROM system_logs
      WHERE (level IN ('warning', 'error'))
      AND message LIKE '%FRONT_LEGACY_GUARD%'
      AND created_at > NOW() - INTERVAL '10 minutes'
    optional: true
