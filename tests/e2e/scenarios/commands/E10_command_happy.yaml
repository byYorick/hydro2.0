name: E10_command_happy
description: Тест успешного выполнения команды узлу

steps:
  - name: Check system health
    api.get:
      path: /api/system/health
      save: health

  - name: Get zones
    api.get:
      path: /api/zones
      save: zones

  - name: Get nodes
    api.get:
      path: /api/nodes
      save: nodes

  - name: Find test zone and node
    set:
      test_zone_id: ${zones.data.data[0].id}
      test_node_id: ${nodes.data.data[0].id}

  - name: Subscribe to command channel
    ws.subscribe:
      # Commands are broadcast per-zone (see App\Events\CommandStatusUpdated::broadcastOn)
      channel: private-commands.${test_zone_id}

  - name: Subscribe to zone channel
    ws.subscribe:
      channel: private-hydro.zones.${test_zone_id}

  - name: Send command to node
    api.post:
      path: /api/nodes/${test_node_id}/commands
      json:
        cmd: set_relay_state
        channel: main_pump
        params:
          state: false
      save: command_response

  - name: Save command ID
    set:
      command_id: ${command_response.data.command_id}

  # Ждем финального статуса команды - DONE (DoD требует проверку финализации)
  - name: Wait for command final status DONE
    db.wait:
      query: SELECT status FROM commands WHERE cmd_id = :cmd_id AND status = 'DONE'
      params:
        cmd_id: ${command_id}
      timeout: 30.0
      expected_rows: 1
      save: command_status

  - name: Assert command status is DONE
    assert.equals:
      actual: ${command_status[0].status}
      expected: "DONE"
      message: "Expected DONE, but got ${command_status[0].status}"

  # Ждем WebSocket события DONE
  - name: Wait for command DONE event
    ws.wait_event:
      event: ".App\\Events\\CommandStatusUpdated"
      timeout: 10.0
      filter:
        commandId: ${command_id}
        status: 'DONE'

  - name: Get final command status from API
    api.get:
      path: /api/commands/${command_id}/status
      save: final_command

  - name: Assert final command status is DONE
    assert.equals:
      actual: ${final_command.data.status}
      expected: "DONE"
      message: "Expected DONE, but got ${final_command.data.status}"

  - name: Check command recorded in zone_events (must validate result)
    db.wait:
      query: |
        SELECT id, type, entity_type, entity_id, payload_json
        FROM zone_events
        WHERE zone_id = :zone_id
        AND entity_type = 'command'
        AND entity_id = :cmd_id
        AND type = 'command_status'
      params:
        zone_id: ${test_zone_id}
        cmd_id: ${command_id}
      timeout: 10.0
      expected_rows: 1
      save: zone_event

  - name: Validate zone_event exists
    assert.equals:
      actual: ${zone_event.length}
      expected: 1
      message: "Expected exactly 1 zone_event, got ${zone_event.length}"
