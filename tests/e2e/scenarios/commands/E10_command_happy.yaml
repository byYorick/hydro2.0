name: E10_command_happy
description: Тест успешного выполнения команды узлу

setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1884}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0

actions:
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3

  - step: check_system_health
    type: api_get
    endpoint: /api/system/health

  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: get_nodes
    type: api_get
    endpoint: /api/nodes
    save: nodes_response

  - step: find_test_zone_and_node
    type: set
    # Используем zone_id и node_id из контекста (установлены runner'ом из setup)
    test_zone_id: ${zone_id}
    test_node_id: ${node_id}

  - step: subscribe_command_channel
    type: websocket_subscribe
    channel: "private-commands.${test_zone_id}"

  - step: subscribe_zone_channel
    type: websocket_subscribe
    channel: "private-hydro.zones.${test_zone_id}"

  - step: send_command
    type: api_post
    endpoint: /api/nodes/${test_node_id}/commands
    payload:
      cmd: set_relay_state
      channel: main_pump
      params:
        state: false
    save: command_response

  - step: save_command_id
    type: set
    command_id: ${command_response.data.command_id}

  # Ждем финального статуса команды - DONE (DoD требует проверку финализации)
  # Node-sim отвечает через MQTT command_response, history-logger нормализует статус и обновляет в БД
  # Сначала может быть ACCEPTED (если node-sim быстро отвечает ACK), затем DONE
  - step: wait_for_command_status
    type: db_wait
    query: SELECT status FROM commands WHERE cmd_id = :cmd_id AND status IN ('SENT', 'ACCEPTED')
    params:
      cmd_id: ${command_id}
    timeout: 60.0
    expected_rows: 1
    save: command_status

  # Если статус ACCEPTED, ждем перехода в DONE
  # Node-sim обычно отвечает DONE после выполнения команды
  - step: wait_for_done_status
    type: wait_until
    condition: "context.get('command_status', [{}])[0].get('status') == 'DONE'"
    timeout: 15.0
    interval: 1.0

  # Проверяем, что команда естественным образом дошла до статуса DONE (node-sim сам отправляет DONE)
  - step: check_final_status_done
    type: db_wait
    query: SELECT status, updated_at FROM commands WHERE cmd_id = :cmd_id AND status = 'DONE'
    params:
      cmd_id: ${command_id}
    timeout: 90.0
    expected_rows: 1
    save: command_status_final

assertions:
  # Проверяем, что команда дошла до финального статуса DONE
  - name: assert_final_status_is_done
    type: database_query
    query: |
      SELECT status
      FROM commands
      WHERE cmd_id = :cmd_id
      AND status = 'DONE'
    params:
      cmd_id: ${command_id}
    timeout: 5.0
    expected_rows: 1
    expected:
      - field: status
        operator: equals
        value: "DONE"

  # Проверка WebSocket события (опционально)
  - name: wait_for_done_ws_event
    type: websocket_event
    event_type: ".App\\Events\\CommandStatusUpdated"
    timeout: 15.0
    optional: true

  # Проверка через API
  - name: get_command_status_from_api
    type: database_query
    query: |
      SELECT status
      FROM commands
      WHERE cmd_id = :cmd_id
      AND status = 'DONE'
    params:
      cmd_id: ${command_id}
    timeout: 5.0
    expected_rows: 1
    expected:
      - field: status
        operator: equals
        value: "DONE"

  # Проверка zone_event для командного леджера временно отключена:
  # реализация zone_events ledger для команд может отличаться от ожидаемого контракта
