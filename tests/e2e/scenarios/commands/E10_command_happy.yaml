name: E10_command_happy
description: Тест успешного выполнения команды узлу

steps:
  - name: Check system health
    api.get:
      path: /api/system/health
      save: health

  - name: Get zones
    api.get:
      path: /api/zones
      save: zones

  - name: Get nodes
    api.get:
      path: /api/nodes
      save: nodes

  - name: Find test zone and node
    set:
      test_zone_id: ${zones.data.data[0].id}
      test_node_id: ${nodes.data.data[0].id}

  - name: Subscribe to command channel
    ws.subscribe:
      # Commands are broadcast per-zone (see App\Events\CommandStatusUpdated::broadcastOn)
      channel: private-commands.${test_zone_id}

  - name: Subscribe to zone channel
    ws.subscribe:
      channel: private-hydro.zones.${test_zone_id}

  - name: Send command to node
    api.post:
      path: /api/nodes/${test_node_id}/commands
      json:
        cmd: set_relay_state
        channel: main_pump
        params:
          state: false
      save: command_response

  - name: Save command ID
    set:
      command_id: ${command_response.data.command_id}

  # Команда может сразу перейти в ACCEPTED (если node-sim быстро отвечает)
  # Проверяем статус в БД напрямую (более надежно, чем WebSocket события)
  - name: Check command status in DB (wait for SENT, ACCEPTED, or ACK)
    db.wait:
      query: SELECT status FROM commands WHERE cmd_id = :cmd_id AND status IN ('SENT', 'ACCEPTED', 'ACK')
      params:
        cmd_id: ${command_id}
      timeout: 20.0
      expected_rows: 1
      save: command_status

  - name: Assert command status is SENT, ACCEPTED, or ACK
    assert.contains:
      container: ['SENT', 'ACCEPTED', 'ACK']
      item: ${command_status[0].status}
      message: "Expected SENT, ACCEPTED, or ACK, but got ${command_status[0].status}"

  # Опционально ждем WebSocket события (могут прийти раньше, чем мы подписались)
  - name: Wait for command acceptance (ACCEPTED) event if available
    ws.wait_event:
      event: ".App\\Events\\CommandStatusUpdated"
      timeout: 5.0
      filter:
        commandId: ${command_id}
        status: ['ACCEPTED', 'ACK']
      optional: true

  - name: Get final command status from API
    api.get:
      path: /api/commands/${command_id}/status
      save: final_command

  - name: Assert command was processed (SENT, ACCEPTED, or ACK)
    assert.contains:
      container: ['SENT', 'ACCEPTED', 'ACK']
      item: ${final_command.data.status}
      message: "Expected SENT, ACCEPTED, or ACK, but got ${final_command.data.status}"

  # Note: command history query removed to avoid datetime serialization issues
  # TODO: Fix datetime serialization in db.query results

  - name: Check command recorded in zone_events
    db.query:
      query: |
        SELECT id, type, entity_type, entity_id, payload_json
        FROM zone_events
        WHERE zone_id = :zone_id
        AND entity_type = 'command'
        AND entity_id = :cmd_id
        AND type = 'command_status'
      params:
        zone_id: ${test_zone_id}
        cmd_id: ${command_id}
      expected_rows: 1
      save: zone_event
