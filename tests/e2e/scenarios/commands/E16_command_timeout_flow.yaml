# E16: Command Timeout Flow - timeout handling with WS/DB invariants
# DoD: timeout handling with WS/DB invariants

name: E16_command_timeout_flow
description: |
  Проверяет обработку timeout команд:
  - Команда отправляется с коротким таймаутом
  - Node-sim не отвечает вовремя
  - WS событие CommandTimeout
  - DB статус обновляется на TIMEOUT
  - Command автоматически отменяется

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data[0].id}

  - step: get_nodes
    type: api_get
    endpoint: /api/nodes
    save: nodes_response

  - step: set_node_id
    type: set
    node_id: ${nodes_response.data.data[0].id}
    test_zone_id: ${nodes_response.data.data[0].zone_id}
    test_node_id: ${nodes_response.data.data[0].id}
    test_node_uid: ${nodes_response.data.data[0].uid}

  - step: subscribe_commands_channel
    type: websocket_subscribe
    channel: private-commands.${test_zone_id}

  # Отключаем node-sim временно для имитации timeout
  - step: pause_node_sim
    type: api_post
    endpoint: /api/test-utils/node-sim/pause
    payload: {}
    optional: true

  - step: send_timeout_command
    type: api_post
    endpoint: /api/zones/${test_zone_id}/commands
    payload:
      type: FORCE_IRRIGATION
      node_uid: ${test_node_uid}
      channel: main_pump
      params:
        duration_sec: 30
      timeout_sec: 3  # Очень короткий таймаут
    save: timeout_command_response

  - step: extract_timeout_command_id
    type: set
    timeout_command_id: ${timeout_command_response.data.command_id}

  # Ждем WS события timeout
  - step: wait_for_timeout_ws_event
    type: websocket_event
    event_type: ".App\\Events\\CommandStatusUpdated"
    filter:
      commandId: ${timeout_command_id}
      status: "TIMEOUT"
    timeout: 10.0
    save: ws_timeout_event
    optional: true

  # Проверяем DB статус после timeout
  - step: check_timeout_db_status
    type: database_query
    query: |
      SELECT status, updated_at
      FROM commands
      WHERE cmd_id = :command_id
    params:
      command_id: ${timeout_command_id}
    save: timeout_status

  # Восстанавливаем node-sim
  - step: resume_node_sim
    type: api_post
    endpoint: /api/test-utils/node-sim/resume
    payload: {}
    optional: true

assertions:
  # Проверка 1: WS событие timeout
  - name: ws_timeout_event
    type: custom_assert
    condition: str(context.get('ws_timeout_event', {}).get('data', {}).get('commandId')) == str(context.get('timeout_command_id'))
    optional: true

  # Проверка 2: DB статус TIMEOUT
  - name: db_timeout_status
    type: json_assertion
    data: ${timeout_status}
    expected:
      - field: status
        operator: in
        value: ["TIMEOUT", "SENT"]

  # Проверка 3: Команда не зависла в SENT состоянии
  - name: no_stuck_commands
    type: database_query
    query: |
      SELECT COUNT(*) as stuck_count
      FROM commands
      WHERE status = 'SENT'
      AND created_at < NOW() - INTERVAL '10 seconds'
    expected:
      - field: stuck_count
        operator: equals
        value: 0
