# E12: Command Timeout - Узел не отвечает, проверка TIMEOUT
# DoD: node-sim drop response, проверка TIMEOUT (системный механизм), alert/zone_event при необходимости

name: E12_command_timeout
description: |
  Проверяет обработку команды с таймаутом:
  - Команда отправляется узлу
  - Узел не отвечает (или ответ задерживается)
  - Система устанавливает статус TIMEOUT
  - При необходимости создается alert или zone_event

setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1884}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0
      # Настройка для симуляции отсутствия ответа
      # Примечание: node-sim может иметь режим "drop_responses"

actions:
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3
    optional: true  # node-sim уже может быть запущен

  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: get_nodes
    type: api_get
    endpoint: /api/nodes
    save: nodes_response

  - step: set_zone_and_node
    type: set
    test_zone_id: ${zones_response.data.data[0].id}
    test_node_id: ${nodes_response.data.data[0].id}

  - step: subscribe_zone_channel
    type: websocket_subscribe
    channel: private-hydro.zones.${test_zone_id}

  # Отправляем команду
  - step: send_command
    type: api_post
    endpoint: /api/nodes/${test_node_id}/commands
    payload:
      cmd: set_relay_state
      channel: main_pump
      params:
        state: true
    save: command_response

  - step: set_command_id
    type: set
    command_id: ${command_response.data.command_id}

  # Ждем перед проверкой статуса
  # Примечание: Таймаут команды обычно происходит через 60-90 секунд,
  # но для теста мы просто проверяем, что команда находится в статусе SENT или TIMEOUT
  - step: wait_before_check
    type: sleep
    seconds: 5

  # Проверяем наличие zone_event для timeout (опционально)
  - step: check_timeout_zone_event
    type: database_query
    query: |
      SELECT id, type
      FROM zone_events
      WHERE zone_id = :zone_id
      AND type = 'COMMAND_TIMEOUT'
      AND payload_json::text LIKE '%%' || :cmd_id || '%%'
      ORDER BY id DESC
      LIMIT 1
    params:
      zone_id: ${test_zone_id}
      cmd_id: ${command_id}
    optional: true

assertions:
  # Проверка: Команда существует и находится в статусе SENT или TIMEOUT
  # Примечание: TIMEOUT происходит только после определенного времени ожидания,
  # поэтому команда может быть еще в статусе SENT
  - name: command_status_is_timeout_or_sent
    type: database_query
    query: |
      SELECT status
      FROM commands
      WHERE cmd_id = :cmd_id
    params:
      cmd_id: ${command_id}
    timeout: 5.0
    expected:
      - field: status
        operator: in
        value: ['TIMEOUT', 'SENT']

cleanup:
  - step: stop_node_simulator
    type: stop_simulator


