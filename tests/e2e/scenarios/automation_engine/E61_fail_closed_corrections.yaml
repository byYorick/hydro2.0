# E61: Fail Closed Corrections - stale telemetry → AE НЕ дозирует
# DoD: stale telemetry ph/ec → AE НЕ дозирует, создает событие/alert "skipped"

name: E61_fail_closed_corrections
description: |
  Проверяет fail-closed поведение при stale telemetry:
  - Публикуется stale telemetry ph/ec (старая временная метка)
  - AE НЕ дозирует (fail-closed)
  - Создается событие/alert "skipped"

setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1883}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
          - ec_sensor
      telemetry:
        interval_seconds: 2.0

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3

  # Публикуем stale telemetry (ts в прошлом - больше часа назад)
  - step: publish_stale_ph_telemetry
    type: mqtt_publish
    topic: hydro/gh-test-1/zn-test-1/nd-ph-esp32una/ph_sensor/telemetry
    payload:
      value: 6.0
      ts: ${TIMESTAMP_MS - 7200000}  # 2 часа назад (stale)
    qos: 1
    wait_seconds: 5

  # Ждем обработки (AE должен обнаружить stale и не дозировать)
  - step: wait_ae_processing
    type: sleep
    seconds: 10

assertions:
  # Проверка 1: Команды дозирования НЕ созданы (fail-closed)
  - name: no_dosing_commands
    type: database_query
    query: |
      SELECT COUNT(*) as cmd_count
      FROM commands
      WHERE zone_id = :zone_id
      AND (cmd LIKE '%ph%' OR cmd LIKE '%ec%' OR cmd LIKE '%dose%' OR cmd LIKE '%correction%')
      AND created_at > NOW() - INTERVAL '2 minutes'
    params:
      zone_id: ${zone_id}
    expected:
      - field: cmd_count
        operator: equals
        value: 0
    timeout: 5.0

  # Проверка 2: Создан alert/event о пропуске (опционально)
  - name: skipped_event_or_alert
    type: database_query
    query: |
      SELECT COUNT(*) as event_count
      FROM zone_events
      WHERE zone_id = :zone_id
      AND (type LIKE '%SKIP%' OR type LIKE '%STALE%')
      AND created_at > NOW() - INTERVAL '2 minutes'
    params:
      zone_id: ${zone_id}
    timeout: 5.0
    optional: true

cleanup:
  - step: stop_node_simulator
    type: stop_simulator
