# E65: Phase Transition API - AE uses GrowCycle API for phase transitions
# DoD: AE uses GrowCycle API for phase transitions

name: E65_phase_transition_api
description: |
  Проверяет, что Automation-engine использует GrowCycle API для перехода фаз:
  - Фаза завершается по времени или условиям
  - AE вызывает GrowCycle API для advance_phase
  - Цикл переходит на следующую фазу
  - Effective-targets обновляются для новой фазы

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: cleanup_old_cycles
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id;
    params:
      zone_id: ${zone_id}

  # Создаем рецепт с несколькими фазами
  - step: create_multi_phase_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: multi-phase-recipe-${TIMESTAMP_S}
      description: Recipe with multiple phases for transition testing
      plant_id: 1
    save: recipe_response

  - step: create_revision
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/revisions
    payload:
      description: Multi-phase revision
    save: revision_response

  # Фаза 0: короткая фаза для быстрого завершения
  - step: add_phase_0
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 0
      name: Phase 0 - Quick
      duration_hours: 1
      ph_target: 6.0
      ec_target: 1.5
      temp_air_target: 22.0
      irrigation_mode: SUBSTRATE

  # Фаза 1: следующая фаза
  - step: add_phase_1
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 1
      name: Phase 1 - Next
      duration_hours: 24
      ph_target: 6.2
      ec_target: 1.8
      temp_air_target: 23.0
      irrigation_mode: SUBSTRATE

  - step: publish_revision
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/publish
    payload: {}

  # Создаем и запускаем цикл
  - step: create_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: ${revision_response.data.id}
      plant_id: 1
      start_immediately: true
    save: cycle_response

  - step: set_cycle_id
    type: set
    cycle_id: ${cycle_response.data.id}

  # Проверяем начальную фазу
  - step: check_initial_phase
    type: database_query
    query: |
      SELECT p.phase_index, p.started_at
      FROM grow_cycles gc
      JOIN grow_cycle_phases p ON p.id = gc.current_phase_id
      WHERE gc.id = :cycle_id
    params:
      cycle_id: ${cycle_id}
    save: initial_phase

  - step: advance_phase
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/advance-phase
    payload: {}

  - step: wait_for_phase_completion
    type: sleep
    seconds: 2

  # Проверяем финальную фазу
  - step: check_final_phase
    type: database_query
    query: |
      SELECT p.phase_index, p.started_at
      FROM grow_cycles gc
      JOIN grow_cycle_phases p ON p.id = gc.current_phase_id
      WHERE gc.id = :cycle_id
    params:
      cycle_id: ${cycle_id}
    save: final_phase

  # Проверяем, что effective-targets обновились для новой фазы
  - step: fetch_phase_targets_updated
    type: api_get
    endpoint: /api/zones/${zone_id}/effective-targets
    save: phase_targets

assertions:
  # Проверка 1: Начальная фаза 0
  - name: initial_phase_zero
    type: json_assertion
    source: initial_phase
    path: "[0]"
    expected:
      - field: phase_index
        operator: equals
        value: 0
      - field: started_at
        operator: is_not_null

  # Проверка 2: Переход на фазу 1
  - name: transitioned_to_phase_one
    type: json_assertion
    source: final_phase
    path: "[0]"
    expected:
      - field: phase_index
        operator: equals
        value: 1
      - field: started_at
        operator: is_not_null

  # Проверка 3: Effective-targets обновились для фазы 1
  - name: targets_updated_for_phase_one
    type: json_assertion
    source: phase_targets
    path: data.targets
    expected:
      - field: ph.target
        operator: equals
        value: 6.2
      - field: ec.target
        operator: equals
        value: 1.8
      - field: climate_request.temp_air_target
        operator: equals
        value: 23

  # Проверка 4: Переход выполнен через API (проверяем логи или статус)
  - name: transition_via_api
    type: database_query
    query: |
      SELECT COUNT(*) as transition_count
      FROM grow_cycle_transitions
      WHERE grow_cycle_id = :cycle_id
      AND trigger_type = 'MANUAL'
      AND created_at > NOW() - INTERVAL '2 minutes'
    params:
      cycle_id: ${cycle_id}
    expected:
      - field: transition_count
        operator: greater_than
        value: 0

cleanup:
  - step: abort_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/abort
    payload: {}
    optional: true

  - step: delete_recipe
    type: api_delete
    endpoint: /api/recipes/${recipe_response.data.id}
    optional: true
