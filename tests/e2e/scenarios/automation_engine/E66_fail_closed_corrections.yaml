# E66: Fail Closed Corrections - AE handles failures gracefully
# DoD: AE handles failures gracefully

name: E66_fail_closed_corrections
description: |
  Проверяет fail-closed поведение AE при сбоях:
  - Контроллер корректировок падает (test hook)
  - AE создает событие CONTROLLER_FAILED
  - Команды дозирования не публикуются

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: ensure_zone_online
    type: database_execute
    query: |
      UPDATE zones
      SET status = 'online'
      WHERE id = :zone_id;
    params:
      zone_id: ${zone_id}

  - step: cleanup_old_cycles
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id;
    params:
      zone_id: ${zone_id}

  # Создаем цикл с targets
  - step: create_plant
    type: api_post
    endpoint: /api/plants
    payload:
      name: test-plant-e66-${TIMESTAMP_S}
      scientific_name: Test Plant
    save: plant_response

  - step: create_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e66-${TIMESTAMP_S}
      description: Test recipe for E66
      plant_id: ${plant_response.data.id}
    save: recipe_response

  - step: create_revision
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/revisions
    payload:
      description: Test revision for E66
    save: revision_response

  - step: add_phase
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 0
      name: Test Phase
      duration_hours: 24
      ph_target: 6.0
      ph_min: 5.8
      ph_max: 6.2
      ec_target: 1.2
      ec_min: 1.0
      ec_max: 1.4
      temp_air_target: 22.0
      humidity_target: 60.0
      irrigation_mode: SUBSTRATE
      irrigation_interval_sec: 3600
      irrigation_duration_sec: 300

  - step: publish_revision
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/publish
    payload: {}

  - step: create_simple_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: ${revision_response.data.id}
      plant_id: ${plant_response.data.id}
      start_immediately: true
    save: cycle_response

  - step: set_cycle_id
    type: set
    cycle_id: ${cycle_response.data.id}

  - step: wait_for_effective_targets
    type: sleep
    seconds: 2

  # Устанавливаем targets которые требуют коррекции
  - step: set_correction_targets
    type: database_execute
    query: |
      INSERT INTO grow_cycle_overrides (
        grow_cycle_id, parameter, value_type, value, is_active, created_at, updated_at
      )
      VALUES (:cycle_id, 'ph.target', 'decimal', '7.0', true, NOW(), NOW());
    params:
      cycle_id: ${cycle_id}

  - step: enable_capabilities
    type: database_execute
    query: |
      UPDATE zones
      SET capabilities = jsonb_build_object(
        'ph_control', true,
        'ec_control', true,
        'climate_control', true,
        'light_control', true,
        'irrigation_control', true,
        'recirculation', true,
        'flow_sensor', true
      )
      WHERE id = :zone_id;
    params:
      zone_id: ${zone_id}

  - step: reset_backoff
    type: ae_test_hook
    url: http://${AUTOMATION_ENGINE_HOST}:9505
    zone_id: ${zone_id}
    action: reset_backoff

  - step: inject_correction_error
    type: ae_test_hook
    url: http://${AUTOMATION_ENGINE_HOST}:9505
    zone_id: ${zone_id}
    controller: correction
    action: inject_error
    error_type: ControllerError

  - step: wait_after_inject
    type: sleep
    seconds: 10

  - step: wait_controller_failed_event
    type: wait_zone_event
    zone_id: ${zone_id}
    event_type: CONTROLLER_FAILED
    filter:
      controller: correction
    timeout: 45.0

assertions:
  # Проверка 1: Команды дозирования не созданы при ошибке контроллера
  - name: no_dosing_commands
    type: database_query
    query: |
      SELECT COUNT(*) as cmd_count
      FROM commands
      WHERE zone_id = :zone_id
      AND cmd IN ('dose', 'run_pump')
      AND params->>'type' IN ('add_acid', 'add_base', 'add_nutrients', 'dilute')
      AND created_at > NOW() - INTERVAL '30 seconds'
    params:
      zone_id: ${zone_id}
    expected:
      - field: cmd_count
        operator: equals
        value: 0

cleanup:
  - step: abort_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/abort
    payload: {}
    optional: true

  - step: clear_test_hook
    type: ae_test_hook
    url: http://${AUTOMATION_ENGINE_HOST}:9505
    zone_id: ${zone_id}
    controller: correction
    action: clear_error
    optional: true

  - step: delete_overrides
    type: database_execute
    query: |
      DELETE FROM grow_cycle_overrides
      WHERE grow_cycle_id = :cycle_id;
    params:
      cycle_id: ${cycle_id}
    optional: true

  - step: reset_automation_state
    type: database_execute
    query: |
      DELETE FROM zone_automation_state
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true

  - step: delete_recipe
    type: api_delete
    endpoint: /api/recipes/${recipe_response.data.id}
    optional: true

  - step: delete_plant
    type: api_delete
    endpoint: /api/plants/${plant_response.data.id}
    optional: true
