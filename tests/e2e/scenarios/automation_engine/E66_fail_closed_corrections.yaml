# E66: Fail Closed Corrections - AE handles failures gracefully
# DoD: AE handles failures gracefully

name: E66_fail_closed_corrections
description: |
  Проверяет fail-closed поведение AE при сбоях:
  - Команда не выполняется (node-sim failure)
  - AE не продолжает корректировки в failed состоянии
  - Backoff mechanism активируется
  - Система остается в безопасном состоянии

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data[0].id}

  # Создаем цикл с targets
  - step: create_simple_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: 1  # Assume test recipe exists
      plant_id: 1
      start_immediately: true
    save: cycle_response

  - step: set_cycle_id
    type: set
    cycle_id: ${cycle_response.data.id}

  # Устанавливаем targets которые требуют коррекции
  - step: set_correction_targets
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/targets
    payload:
      ph_target: 7.0  # Значительно отличается от текущего
      correction_enabled: true
    save: targets_response

  # Настраиваем node-sim на failure для pH команд
  - step: enable_ph_failure_mode
    type: api_post
    endpoint: /api/test-utils/node-sim/command-failure
    payload:
      command_type: "ADJUST_PH"
      enabled: true
      failure_rate: 1.0  # Все команды ADJUST_PH будут fail
    optional: true

  # Ждем попыток коррекции от AE
  - step: wait_for_correction_attempts
    type: wait_until
    condition: |
      # Проверяем, что были попытки коррекции pH
      from runner.steps.database import DatabaseStepExecutor
      from runner.schema.variables import VariableResolver
      resolver = VariableResolver(context)
      db_exec = DatabaseStepExecutor(context.get('db'), resolver)
      import asyncio
      result = asyncio.run(db_exec.execute_db_step('database_query', {
        'query': 'SELECT COUNT(*) as attempt_count FROM commands WHERE zone_id = :zone_id AND type = :cmd_type AND created_at > NOW() - INTERVAL \"30 seconds\"',
        'params': {'zone_id': context['zone_id'], 'cmd_type': 'ADJUST_PH'}
      }))
      result and result[0]['attempt_count'] >= 2  # Минимум 2 попытки
    timeout: 45.0
    interval: 5.0

  # Проверяем, что команды failed
  - step: check_failed_commands
    type: database_query
    query: |
      SELECT
        COUNT(*) as total_ph_commands,
        COUNT(CASE WHEN status = 'FAILED' THEN 1 END) as failed_count
      FROM commands
      WHERE zone_id = :zone_id
      AND type = 'ADJUST_PH'
      AND created_at > NOW() - INTERVAL '1 minute'
    params:
      zone_id: ${zone_id}
    save: command_stats

  # Проверяем backoff состояние
  - step: check_backoff_state
    type: database_query
    query: |
      SELECT backoff_until, consecutive_failures
      FROM zone_automation_state
      WHERE zone_id = :zone_id
      AND parameter = 'ph'
    params:
      zone_id: ${zone_id}
    save: backoff_state

  # Отключаем failure mode
  - step: disable_ph_failure_mode
    type: api_post
    endpoint: /api/test-utils/node-sim/command-failure
    payload:
      command_type: "ADJUST_PH"
      enabled: false
    optional: true

  # Ждем восстановления (backoff истекает)
  - step: wait_for_backoff_expiry
    type: eventually
    condition: |
      # Проверяем, что backoff истек
      from runner.steps.database import DatabaseStepExecutor
      from runner.schema.variables import VariableResolver
      resolver = VariableResolver(context)
      db_exec = DatabaseStepExecutor(context.get('db'), resolver)
      import asyncio
      result = asyncio.run(db_exec.execute_db_step('database_query', {
        'query': 'SELECT backoff_until FROM zone_automation_state WHERE zone_id = :zone_id AND parameter = :param',
        'params': {'zone_id': context['zone_id'], 'param': 'ph'}
      }))
      not result or result[0]['backoff_until'] is None or result[0]['backoff_until'] < datetime.now()
    timeout: 60.0

assertions:
  # Проверка 1: Были попытки коррекции
  - name: correction_attempts_made
    type: json_assertion
    data: ${command_stats}
    expected:
      - field: total_ph_commands
        operator: greater_than
        value: 1

  # Проверка 2: Большинство команд failed
  - name: commands_failed
    type: json_assertion
    data: ${command_stats}
    expected:
      - field: failed_count
        operator: greater_than
        value: 0

  # Проверка 3: Backoff активирован
  - name: backoff_activated
    type: json_assertion
    data: ${backoff_state}
    expected:
      - field: backoff_until
        operator: is_not_null
      - field: consecutive_failures
        operator: greater_than
        value: 1

  # Проверка 4: После восстановления коррекции возобновляются
  - name: corrections_resume_after_backoff
    type: database_query
    query: |
      SELECT COUNT(*) as recent_commands
      FROM commands
      WHERE zone_id = :zone_id
      AND type = 'ADJUST_PH'
      AND status = 'DONE'
      AND created_at > NOW() - INTERVAL '30 seconds'
    params:
      zone_id: ${zone_id}
    expected:
      - field: recent_commands
        operator: greater_than
        value: 0

cleanup:
  - step: abort_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/abort
    payload: {}
    optional: true

  - step: reset_automation_state
    type: database_execute
    query: |
      DELETE FROM zone_automation_state
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true
