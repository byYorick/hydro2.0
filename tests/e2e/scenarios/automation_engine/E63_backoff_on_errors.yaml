# E63: Backoff On Errors - серия ошибок → degraded mode
# DoD: серия ошибок → AE увеличивает интервал/переходит в degraded, подтверждение через метрики/лог/zone_events

name: E63_backoff_on_errors
description: |
  Проверяет механизм backoff при ошибках:
  - Создается серия ошибок
  - AE увеличивает интервал/переходит в degraded mode
  - Подтверждение через метрики/лог/zone_events

setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1884}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0

actions:
  # Получаем зону с UID zn-test-1 из seeder
  - step: get_automation_zone
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id_from_uid
    type: database_query
    query: |
      SELECT id
      FROM zones
      WHERE uid = 'zn-test-1'
      LIMIT 1
    save: zone_row
  
  - step: set_zone_id
    type: set
    zone_id: ${zone_row[0].id}

  - step: enable_capabilities
    type: database_execute
    query: |
      UPDATE zones
      SET capabilities = jsonb_build_object(
        'ph_control', true,
        'ec_control', true,
        'climate_control', true,
        'light_control', true,
        'irrigation_control', true,
        'recirculation', true,
        'flow_sensor', true
      )
      WHERE id = :zone_id;
    params:
      zone_id: ${zone_id}

  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3
    optional: true  # node-sim уже может быть запущен

  # Включаем test mode
  - step: enable_test_mode
    type: set
    AE_TEST_MODE: 1

  # Создаем серию ошибок через test hook (детерминированно)
  - step: inject_error_1
    type: ae_test_hook
    url: http://localhost:9405
    zone_id: ${zone_id}
    controller: climate
    action: inject_error
    error_type: ControllerError

  - step: wait_cycle_1
    type: sleep
    seconds: 3

  - step: inject_error_2
    type: ae_test_hook
    url: http://localhost:9405
    zone_id: ${zone_id}
    controller: climate
    action: inject_error
    error_type: ControllerError

  - step: wait_cycle_2
    type: sleep
    seconds: 3

  - step: inject_error_3
    type: ae_test_hook
    url: http://localhost:9405
    zone_id: ${zone_id}
    controller: climate
    action: inject_error
    error_type: ControllerError

  - step: wait_backoff
    type: sleep
    seconds: 15  # Даем время на обработку и backoff

  # Проверяем метрики до и после
  - step: check_metrics_before
    type: scrape_metrics
    # automation-engine метрики проброшены на localhost:9401
    url: http://localhost:9401
    save: metrics_before

  - step: wait_next_cycle_after_backoff
    type: sleep
    seconds: 10

  - step: check_metrics_after
    type: scrape_metrics
    url: http://localhost:9401
    save: metrics_after
  
  - step: set_metrics_defaults
    type: set
    automation_loop_errors_before: ${metrics_before.get('automation_loop_errors_total', 0)}
    automation_loop_errors_after: ${metrics_after.get('automation_loop_errors_total', 0)}
    next_allowed_run_at: ""
  
  # Получаем текущее состояние backoff и сохраняем next_allowed_run_at
  - step: check_backoff_state
    type: http_request
    method: GET
    url: http://localhost:9405/test/hook/${zone_id}
    save: hook_state

  - step: set_backoff_state_vars
    type: set
    next_allowed_run_at: ${hook_state.data.state_override.next_allowed_run_at}

assertions:
  # Проверка 1: Zone event ZONE_PROCESSING_FAILED или BACKOFF создан
  - name: backoff_event_created
    type: database_query
    query: |
      SELECT id, type, details
      FROM zone_events
      WHERE zone_id = :zone_id
      AND (type LIKE '%%BACKOFF%%' OR type LIKE '%%DEGRADED%%' OR type = 'ZONE_PROCESSING_FAILED')
      AND created_at > NOW() - INTERVAL '5 minutes'
      ORDER BY created_at DESC
      LIMIT 1
    params:
      zone_id: ${zone_id}
    timeout: 20.0
    optional: true

  # Проверка 2: Метрики automation_loop_errors_total и zone_processing_errors_total увеличились
  - name: error_metrics_increased
    type: assert
    assert_type: custom
    condition: ${automation_loop_errors_after} >= ${automation_loop_errors_before}
    optional: true

  # Проверка 4: В degraded режиме выполняются только safety/health контроллеры
  - name: degraded_mode_safety_only
    type: database_query
    query: |
      SELECT COUNT(*) as cmd_count
      FROM commands
      WHERE zone_id = :zone_id
      AND source = 'automation'
      AND created_at > NOW() - INTERVAL '5 minutes'
    params:
      zone_id: ${zone_id}
    timeout: 10.0
    optional: true  # В degraded режиме команд может быть меньше

  # Проверка 5: Сброс backoff через test hook
  - name: backoff_reset_works
    type: database_query
    query: |
      SELECT COUNT(*) as cmd_count
      FROM commands
      WHERE zone_id = :zone_id
      AND source = 'automation'
      AND created_at > NOW() - INTERVAL '1 minute'
    params:
      zone_id: ${zone_id}
    timeout: 10.0
    optional: true

  # Проверка 3: next_allowed_run_at установлен (проверяем сохраненное состояние)
  - name: backoff_state_set
    type: assert
    assert_type: custom
    condition: ${next_allowed_run_at} is not None
    optional: true

cleanup:
  - step: reset_backoff
    type: ae_test_hook
    url: http://localhost:9405
    zone_id: ${zone_id}
    action: reset_backoff

  - step: wait_after_reset
    type: sleep
    seconds: 2

  - step: stop_node_simulator
    type: stop_simulator
    optional: true  # fault injection не работает в контейнере
