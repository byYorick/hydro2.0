# E60: Climate Control Happy - telemetry → AE → команды fan/vent/heater
# DoD: telemetry → AE → команды fan/vent/heater, node-sim выполняет, commands DONE + WS

name: E60_climate_control_happy
description: |
  Проверяет автоматическое управление климатом:
  - Публикуется telemetry (t/rh/co2)
  - Targets из active stage
  - AE формирует команду (fan/vent/heater)
  - node-sim выполняет
  - Команды DONE + WS

setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1883}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-esp32una
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
          - air_temp_c
          - air_rh
        actuators:
          - fan
          - heater
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3

  - step: subscribe_zone_channel
    type: websocket_subscribe
    channel: private-hydro.zones.${zone_id}

  # Публикуем telemetry с отклонением от целевых значений
  # (температура ниже целевой → AE должен включить heater)
  - step: publish_low_temp_telemetry
    type: mqtt_publish
    topic: hydro/gh-test-1/zn-test-1/nd-ph-esp32una/air_temp_c/telemetry
    payload:
      value: 18.0  # Низкая температура (целевая обычно 22-25)
      ts: ${TIMESTAMP_MS}
    qos: 1
    wait_seconds: 10  # Даем время AE на обработку

  # Ждем команду от automation-engine
  - step: wait_for_heater_command
    type: db.wait
    query: |
      SELECT cmd_id, cmd, params, status
      FROM commands
      WHERE zone_id = :zone_id
      AND cmd LIKE '%heater%' OR cmd LIKE '%heat%'
      AND status IN ('SENT', 'ACK', 'ACCEPTED', 'DONE')
    params:
      zone_id: ${zone_id}
    timeout: 30.0
    expected_rows: 1
    optional: true  # Может не быть, если AE не настроен
    save: heater_command

assertions:
  # Проверка 1: Telemetry сохранилась в БД
  - name: telemetry_saved
    type: database_query
    query: |
      SELECT value
      FROM telemetry_last
      WHERE zone_id = :zone_id
      AND metric_type = 'air_temp_c'
    params:
      zone_id: ${zone_id}
    timeout: 10.0
    expected_rows: 1
    optional: true

  # Проверка 2: Команда создана (если AE активен)
  - name: command_created_by_ae
    type: database_query
    query: |
      SELECT COUNT(*) as cmd_count
      FROM commands
      WHERE zone_id = :zone_id
      AND created_at > NOW() - INTERVAL '1 minute'
    params:
      zone_id: ${zone_id}
    timeout: 5.0
    optional: true

cleanup:
  - step: stop_node_simulator
    type: stop_simulator
