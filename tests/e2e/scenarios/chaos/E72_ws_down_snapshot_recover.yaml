# E72: WS Down Snapshot Recover - WS down → snapshot+replay догоняют
# DoD: WS down → snapshot+replay догоняют

name: E72_ws_down_snapshot_recover
description: |
  Проверяет восстановление после падения WebSocket:
  - WebSocket сервер останавливается
  - Создаются события во время простоя
  - WebSocket восстанавливается
  - Snapshot+replay догоняют все события

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: get_zone_id_by_uid
    type: database_query
    query: |
      SELECT id AS zone_id
      FROM zones
      WHERE uid = :zone_uid
      LIMIT 1
    params:
      zone_uid: zn-test-1
    save: zone_row
    expected_rows: 1

  - step: set_zone_id
    type: set
    zone_id: ${zone_row.0.zone_id}

  - step: get_initial_last_event_id
    type: database_query
    query: |
      SELECT COALESCE(MAX(id), 0) AS last_event_id
      FROM zone_events
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: baseline_event_row
    expected_rows: 1

  # Получаем начальный snapshot - опционально, т.к. endpoint может не работать
  - step: get_initial_snapshot
    type: api_get
    endpoint: /api/zones/${zone_id}
    optional: true
    save: snapshot_before

  - step: set_initial_last_event_id
    type: set
    initial_last_event_id: ${baseline_event_row.0.last_event_id}

  # Подключаемся к WebSocket
  - step: connect_websocket
    type: websocket_connect

  - step: subscribe_zone_channel
    type: websocket_subscribe
    channel: private-hydro.zones.${zone_id}

  # Останавливаем WebSocket сервер (reverb) - опционально, т.к. fault injection может не работать
  - step: stop_reverb
    type: fault.inject
    service: reverb
    action: stop
    optional: true

  - step: wait_during_ws_down
    type: sleep
    seconds: 3

  # Создаем события во время простоя WS (через команду или ошибку)
  - step: create_event_during_ws_down
    type: api_post
    endpoint: /api/zones/${zone_id}/commands
    payload:
      cmd: set_relay
      channel: main_pump
      params:
        state: true
    save: command_during_ws_down
    optional: true

  # Восстанавливаем WebSocket - опционально
  - step: restore_reverb
    type: fault.restore
    service: reverb
    optional: true

  - step: wait_after_restore
    type: sleep
    seconds: 5

  # Получаем новый snapshot - опционально
  - step: get_final_snapshot
    type: api_get
    endpoint: /api/zones/${zone_id}
    optional: true
    save: snapshot_after

  # Запрашиваем события после initial_last_event_id
  - step: get_missed_events
    type: api_get
    endpoint: /api/zones/${zone_id}/events
    params:
      after_id: ${initial_last_event_id}
    save: missed_events

assertions:
  # Проверка 1: Zone существует
  - name: zone_exists
    type: database_query
    query: |
      SELECT id
      FROM zones
      WHERE id = :zone_id
    params:
      zone_id: ${zone_id}
    expected_rows: 1

cleanup:
  - step: ensure_reverb_running
    type: fault.restore
    service: reverb
    optional: true
