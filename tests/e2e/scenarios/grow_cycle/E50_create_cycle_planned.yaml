# E50: Create Cycle Planned - create plant + recipe + stage-map → PLANNED
# DoD: create plant + recipe + stage-map → PLANNED

name: E50_create_cycle_planned
description: |
  Проверяет создание grow-cycle:
  - Создается recipe
  - Recipe привязывается к зоне
  - Зона получает статус PLANNED
  - zone_recipe_instance создается

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: create_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e50-${TIMESTAMP_S}
      description: Test recipe for E50
    save: recipe_response

  - step: add_phase_0
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/phases
    payload:
      phase_index: 0
      name: Planting
      duration_hours: 24
      targets:
        ph:
          min: 5.5
          max: 6.5
        ec: 1.5
        temp_air: 22
        humidity_air: 60
        light_hours: 16

  - step: add_phase_1
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/phases
    payload:
      phase_index: 1
      name: Veg
      duration_hours: 48
      targets:
        ph:
          min: 5.6
          max: 6.6
        ec: 1.8
        temp_air: 23
        humidity_air: 55
        light_hours: 18

  - step: attach_recipe_to_zone
    type: api_post
    endpoint: /api/zones/${zone_id}/attach-recipe
    payload:
      recipe_id: ${recipe_response.data.id}
    save: attach_response

  - step: set_ids_for_cleanup
    type: set
    recipe_id: ${recipe_response.data.id}

  # Устанавливаем статус зоны на PLANNED (если не установлен автоматически)
  - step: set_zone_status_planned
    type: api_patch
    endpoint: /api/zones/${zone_id}
    payload:
      status: PLANNED
    optional: true

assertions:
  # Проверка 1: Статус зоны = PLANNED
  - name: cycle_status_planned
    type: database_query
    query: |
      SELECT status
      FROM zones
      WHERE id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: status
        operator: equals
        value: PLANNED

  # Проверка 2: zone_recipe_instance создан
  - name: recipe_instance_created
    type: database_query
    query: |
      SELECT id, recipe_id, current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected_rows: 1

cleanup:
  # Примечание: detach-recipe endpoint не реализован в backend
  # Вместо этого можно удалить recipe_instance через БД или оставить cleanup опциональным
  - step: detach_recipe_via_db
    type: database_execute
    query: |
      DELETE FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true

  - step: delete_recipe
    type: api_delete
    endpoint: /api/recipes/${recipe_id}
    optional: true
