# E50: Create Cycle Planned - create plant + recipe + revision → PLANNED
# DoD: create plant + recipe + revision → PLANNED

name: E50_create_cycle_planned
description: |
  Проверяет создание grow-cycle:
  - Создается plant
  - Создается recipe
  - Создается recipe revision с фазами
  - Создается grow-cycle со статусом PLANNED

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data[0].id}

  - step: create_plant
    type: api_post
    endpoint: /api/plants
    payload:
      name: test-plant-e50-${TIMESTAMP_S}
      scientific_name: Test Plant
    save: plant_response

  - step: create_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e50-${TIMESTAMP_S}
      description: Test recipe for E50
    save: recipe_response

  - step: create_revision
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/revisions
    payload:
      description: Test revision for E50
    save: revision_response

  - step: add_phase_0
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 0
      name: Planting
      duration_hours: 24
      ph_target: 6.0
      ph_min: 5.5
      ph_max: 6.5
      ec_target: 1.5
      ec_min: 1.3
      ec_max: 1.7
      irrigation_mode: SUBSTRATE
      irrigation_interval_sec: 3600
      irrigation_duration_sec: 300
      temp_air_target: 22.0
      humidity_target: 60.0
      lighting_photoperiod_hours: 16

  - step: add_phase_1
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 1
      name: Veg
      duration_hours: 48
      ph_target: 6.2
      ph_min: 5.6
      ph_max: 6.6
      ec_target: 1.8
      ec_min: 1.6
      ec_max: 2.0
      irrigation_mode: SUBSTRATE
      irrigation_interval_sec: 3600
      irrigation_duration_sec: 300
      temp_air_target: 23.0
      humidity_target: 55.0
      lighting_photoperiod_hours: 18

  - step: publish_revision
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/publish
    payload: {}
    save: publish_response

  - step: create_grow_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: ${revision_response.data.id}
      plant_id: ${plant_response.data.id}
      start_immediately: false
    save: cycle_response

  - step: set_ids_for_cleanup
    type: set
    recipe_id: ${recipe_response.data.id}
    plant_id: ${plant_response.data.id}

assertions:
  # Проверка 1: Grow cycle создан со статусом PLANNED
  - name: cycle_status_planned
    type: database_query
    query: |
      SELECT status
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    expected:
      - field: status
        operator: equals
        value: PLANNED

  # Проверка 2: Grow cycle имеет recipe_revision_id
  - name: cycle_has_revision
    type: database_query
    query: |
      SELECT recipe_revision_id, plant_id
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    expected_rows: 1
    expected:
      - field: recipe_revision_id
        operator: is_not_null
      - field: plant_id
        operator: equals
        value: ${plant_response.data.id}

cleanup:
  - step: delete_grow_cycle
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true

  - step: delete_recipe
    type: api_delete
    endpoint: /api/recipes/${recipe_id}
    optional: true

  - step: delete_plant
    type: api_delete
    endpoint: /api/plants/${plant_id}
    optional: true
