# E51: Start Cycle Running - start cycle → RUNNING, zone_recipe_instance
# DoD: start cycle → RUNNING, zone_recipe_instance

name: E51_start_cycle_running
description: |
  Проверяет запуск grow-cycle:
  - Рецепт привязан к зоне (status = PLANNED)
  - Запускается цикл (start)
  - Создается zone_recipe_instance
  - Статус зоны = RUNNING
  - Стадия ACTIVE

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: get_zone_details
    type: api_get
    endpoint: /api/zones/${zone_id}
    optional: true
    save: zone_details

  # Проверяем, есть ли у зоны рецепт
  - step: check_recipe_instance
    type: database_query
    query: |
      SELECT id, recipe_id, current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true
    save: existing_instance

  # Если рецепта нет, создаем и привязываем
  - step: create_recipe_if_needed
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e51
      description: Test recipe for E51
    save: recipe_response
    optional: true

  - step: attach_recipe_if_needed
    type: api_post
    endpoint: /api/zones/${zone_id}/attach-recipe
    payload:
      recipe_id: ${recipe_response.data.id}
    save: attach_response
    optional: true

  - step: set_recipe_id
    type: set
    recipe_id: ${recipe_response.data.id if recipe_response else existing_instance[0].recipe_id}
    optional: true

  # Обновляем статус зоны на PLANNED если нужно
  - step: set_zone_planned
    type: api_patch
    endpoint: /api/zones/${zone_id}
    payload:
      status: PLANNED
    save: zone_update_response
    optional: true

  # Запускаем цикл (обновляем статус на RUNNING)
  - step: start_cycle
    type: api_patch
    endpoint: /api/zones/${zone_id}
    payload:
      status: RUNNING
    save: start_response

assertions:
  # Проверка 1: Статус зоны = RUNNING
  - name: zone_status_running
    type: database_query
    query: |
      SELECT status
      FROM zones
      WHERE id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: status
        operator: is_not_null

  # Проверка 2: zone_recipe_instance создан
  - name: recipe_instance_exists
    type: database_query
    query: |
      SELECT id, recipe_id, current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected_rows: 1

  # Проверка 3: Текущая фаза активна (current_phase_index >= 0)
  - name: phase_is_active
    type: database_query
    query: |
      SELECT current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: current_phase_index
        operator: greater_than_or_equal
        value: 0
