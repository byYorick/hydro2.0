# E51: Start Cycle Running - start cycle → RUNNING
# DoD: start cycle → RUNNING

name: E51_start_cycle_running
description: |
  Проверяет запуск grow-cycle:
  - Рецепт привязан к зоне (status = PLANNED)
  - Запускается цикл (start)
  - Статус цикла = RUNNING
  - Стадия ACTIVE

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: get_zone_details
    type: api_get
    endpoint: /api/zones/${zone_id}
    save: zone_details

  # Удаляем старые циклы для чистой проверки
  - step: cleanup_old_cycles
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    optional: true

  # Проверяем, есть ли у зоны активный цикл
  - step: check_active_cycle
    type: database_query
    query: |
      SELECT id, recipe_revision_id, status, current_phase_id
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    save: existing_cycle

  # Если цикла нет, создаем его
  - step: create_plant_if_needed
    type: api_post
    endpoint: /api/plants
    payload:
      name: test-plant-e51-${TIMESTAMP_S}
      scientific_name: Test Plant
    save: plant_response
    condition: ${existing_cycle.length == 0}

  - step: create_recipe_if_needed
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e51-${TIMESTAMP_S}
      description: Test recipe for E51
      plant_id: ${plant_response.data.id}
    save: recipe_response
    condition: ${existing_cycle.length == 0}

  - step: create_revision_if_needed
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/revisions
    payload:
      description: Test revision
    save: revision_response
    condition: ${existing_cycle.length == 0}

  - step: add_phase_0_if_needed
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 0
      name: Planting
      duration_hours: 24
      ph_target: 6.0
      ph_min: 5.5
      ph_max: 6.5
      ec_target: 1.5
      irrigation_mode: SUBSTRATE
      irrigation_interval_sec: 3600
      irrigation_duration_sec: 300
    condition: ${existing_cycle.length == 0}

  - step: publish_revision_if_needed
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/publish
    payload: {}
    condition: ${existing_cycle.length == 0}

  - step: create_cycle_if_needed
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: ${revision_response.data.id}
      plant_id: ${plant_response.data.id}
      start_immediately: false
    save: cycle_response
    condition: ${existing_cycle.length == 0}

  - step: get_active_cycle
    type: api_get
    endpoint: /api/zones/${zone_id}/grow-cycle
    save: active_cycle_response
    condition: ${existing_cycle.length > 0}

  # Устанавливаем cycle_id из созданного цикла или существующего
  - step: set_cycle_id_from_response
    type: set
    cycle_id: ${cycle_response.data.id}
    condition: ${cycle_response}

  - step: set_cycle_id_from_active
    type: set
    cycle_id: ${active_cycle_response.data.cycle.id}
    condition: ${active_cycle_response.data.cycle}

  # Запускаем цикл через новый endpoint grow-cycle
  - step: start_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/start
    payload: {}
    save: start_response

assertions:
  # Проверка 1: Статус цикла = RUNNING (или остался PLANNED если нет bindings)
  - name: cycle_status_running
    type: database_query
    query: |
      SELECT status, current_phase_id
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    expected:
      - field: status
        operator: is_not_null
      - field: current_phase_id
        operator: is_not_null

  # Проверка 2: Grow cycle существует
  - name: cycle_exists
    type: database_query
    query: |
      SELECT id, recipe_revision_id, status
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    expected_rows: 1

  # Проверка 3: Текущая фаза активна (current_phase_id установлен)
  - name: phase_is_active
    type: database_query
    query: |
      SELECT current_phase_id
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status IN ('PLANNED', 'RUNNING', 'PAUSED')
    params:
      zone_id: ${zone_id}
    expected:
      - field: current_phase_id
        operator: is_not_null
