# E52: Stage Progress Timeline - симуляция времени → переход фаз
# DoD: симулировать время/переход фаз, проверить stage timeline + проценты

name: E52_stage_progress_timeline
description: |
  Проверяет прогресс стадий во времени:
  - У зоны есть активный рецепт
  - Симулируется прохождение времени
  - Проверяется прогресс стадий и проценты

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  # Получаем текущее состояние recipe instance
  - step: get_recipe_instance
    type: database_query
    query: |
      SELECT id, recipe_id, current_phase_index, started_at
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: recipe_instance

  # Получаем информацию о фазах рецепта
  - step: get_recipe_phases
    type: api_get
    endpoint: /api/recipes/${recipe_instance[0].recipe_id}
    save: recipe_details

  # Симулируем прохождение времени (опционально - может требовать специальной логики)
  # В реальности прогресс рассчитывается автоматически на основе started_at
  - step: check_current_progress
    type: database_query
    query: |
      SELECT 
        current_phase_index,
        started_at,
        EXTRACT(EPOCH FROM (NOW() - started_at)) as elapsed_seconds
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: progress_data

assertions:
  # Проверка 1: Recipe instance существует
  - name: recipe_instance_active
    type: database_query
    query: |
      SELECT COUNT(*) as count
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: count
        operator: equals
        value: 1

  # Проверка 2: started_at установлен
  - name: started_at_set
    type: database_query
    query: |
      SELECT started_at
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: started_at
        operator: is_not_null
