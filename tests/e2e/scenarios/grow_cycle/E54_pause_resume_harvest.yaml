# E54: Pause Resume Harvest - pause/resume/harvest → закрытие цикла
# DoD: pause/resume/harvest → закрытие цикла, API snapshot отражает изменения

name: E54_pause_resume_harvest
description: |
  Проверяет управление циклом:
  - Pause цикла
  - Resume цикла
  - Harvest → закрытие цикла
  - API snapshot отражает изменения

actions:
  - step: set_zone_id_from_uid
    type: database_query
    query: |
      SELECT id
      FROM zones
      WHERE uid = 'zn-test-1'
      LIMIT 1
    save: zone_row

  - step: set_zone_id
    type: set
    zone_id: ${zone_row.0.id}

  - step: cleanup_old_cycles
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id;
    params:
      zone_id: ${zone_id}

  - step: create_plant
    type: api_post
    endpoint: /api/plants
    payload:
      name: test-plant-e54-${TIMESTAMP_S}
      scientific_name: Test Plant
    save: plant_response

  - step: create_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e54-${TIMESTAMP_S}
      description: Test recipe
      plant_id: ${plant_response.data.id}
    save: recipe_response

  - step: create_revision
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/revisions
    payload:
      description: Test revision
    save: revision_response

  - step: add_phase
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 0
      name: Test Phase
      duration_hours: 24
      ph_target: 6.0
      ec_target: 1.5
      irrigation_mode: SUBSTRATE

  - step: publish_revision
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/publish

  - step: create_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: ${revision_response.data.id}
      plant_id: ${plant_response.data.id}
      start_immediately: false
    save: cycle_response

  - step: set_cycle_id
    type: set
    cycle_id: ${cycle_response.data.id}

  - step: start_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/start
    payload: {}

  # Pause цикла
  - step: pause_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/pause
    payload: {}
    save: pause_response

  - step: wait_after_pause
    type: sleep
    seconds: 1

  # Resume цикла
  - step: resume_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/resume
    payload: {}
    save: resume_response

  - step: wait_after_resume
    type: sleep
    seconds: 1

  # Harvest (закрытие цикла)
  - step: harvest_cycle
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/harvest
    payload:
      batch_label: Test Batch E54
    save: harvest_response

  - step: wait_after_harvest
    type: sleep
    seconds: 1

  # Получаем snapshot после изменений
  - step: get_snapshot_after_changes
    type: api_get
    endpoint: /api/zones/${zone_id}/grow-cycle
    save: final_snapshot

cleanup:
  - step: delete_grow_cycle
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true

  - step: delete_recipe
    type: api_delete
    endpoint: /api/recipes/${recipe_response.data.id}
    optional: true

  - step: delete_plant
    type: api_delete
    endpoint: /api/plants/${plant_response.data.id}
    optional: true

assertions:
  # Проверка 1: Zone существует
  - name: zone_exists
    type: database_query
    query: |
      SELECT id
      FROM zones
      WHERE id = :zone_id
    params:
      zone_id: ${zone_id}
    expected_rows: 1

  # Проверка 2: Цикл имеет статус HARVESTED
  - name: cycle_harvested
    type: database_query
    query: |
      SELECT status
      FROM grow_cycles
      WHERE id = :cycle_id
    params:
      cycle_id: ${cycle_id}
    expected:
      - field: status
        operator: equals
        value: HARVESTED

  # Проверка 3: actual_harvest_at установлен
  - name: harvest_at_set
    type: database_query
    query: |
      SELECT actual_harvest_at
      FROM grow_cycles
      WHERE id = :cycle_id
    params:
      cycle_id: ${cycle_id}
    expected:
      - field: actual_harvest_at
        operator: is_not_null
