# E57: Batch Targets - batch target updates
# DoD: batch target updates

name: E57_batch_targets
description: |
  Проверяет выдачу effective targets для нескольких параметров:
  - В фазе заданы pH/EC и климат
  - API возвращает все параметры

actions:
  - step: get_greenhouses
    type: api_get
    endpoint: /api/greenhouses
    save: greenhouses_response

  - step: create_zone
    type: api_post
    endpoint: /api/zones
    payload:
      name: e2e-grow-zone-e57-${TIMESTAMP_S}
      greenhouse_id: ${greenhouses_response.data.data[0].id}
    save: zone_response

  - step: set_zone_id
    type: set
    zone_id: ${zone_response.data.id}

  - step: create_plant
    type: api_post
    endpoint: /api/plants
    payload:
      name: test-plant-e57-${TIMESTAMP_S}
      scientific_name: Test Plant
    save: plant_response

  - step: create_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e57-${TIMESTAMP_S}
      description: Test recipe
      plant_id: ${plant_response.data.id}
    save: recipe_response

  - step: create_revision
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/revisions
    payload:
      description: Test revision
    save: revision_response

  - step: add_phase
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/phases
    payload:
      phase_index: 0
      name: Test Phase
      duration_hours: 1
      ph_target: 6.9
      ph_min: 6.4
      ph_max: 7.4
      ec_target: 2.2
      ec_min: 2.0
      ec_max: 2.4
      irrigation_mode: SUBSTRATE
      temp_air_target: 24.0
      humidity_target: 55.0

  - step: publish_revision
    type: api_post
    endpoint: /api/recipe-revisions/${revision_response.data.id}/publish

  - step: create_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/grow-cycles
    payload:
      recipe_revision_id: ${revision_response.data.id}
      plant_id: ${plant_response.data.id}
      start_immediately: true
    save: cycle_response

  - step: wait_after_start
    type: sleep
    seconds: 1

  - step: get_effective_targets
    type: api_get
    endpoint: /api/zones/${zone_id}/effective-targets
    save: effective_targets_response

assertions:
  # Проверка 1: Параметры фазы сохранены
  - name: phase_targets_saved
    type: database_query
    query: |
      SELECT ph_target, ph_min, ph_max, ec_target, temp_air_target, humidity_target
      FROM recipe_revision_phases
      WHERE recipe_revision_id = :revision_id
      AND phase_index = 0
      LIMIT 1
    params:
      revision_id: ${revision_response.data.id}
    expected:
      - field: ph_target
        operator: greater_than_or_equal
        value: 6.9
      - field: ph_target
        operator: less_than
        value: 6.91
      - field: ph_min
        operator: greater_than_or_equal
        value: 6.4
      - field: ph_min
        operator: less_than
        value: 6.41
      - field: ph_max
        operator: greater_than_or_equal
        value: 7.4
      - field: ph_max
        operator: less_than
        value: 7.41
      - field: ec_target
        operator: greater_than_or_equal
        value: 2.2
      - field: ec_target
        operator: less_than
        value: 2.21
      - field: temp_air_target
        operator: greater_than_or_equal
        value: 24.0
      - field: temp_air_target
        operator: less_than
        value: 24.01
      - field: humidity_target
        operator: greater_than_or_equal
        value: 55.0
      - field: humidity_target
        operator: less_than
        value: 55.01

cleanup:
  - step: delete_test_cycle
    type: database_execute
    query: |
      DELETE FROM grow_cycles
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    optional: true

  - step: delete_zone
    type: api_delete
    endpoint: /api/zones/${zone_id}
    optional: true

  - step: delete_recipe
    type: api_delete
    endpoint: /api/recipes/${recipe_response.data.id}
    optional: true

  - step: delete_plant
    type: api_delete
    endpoint: /api/plants/${plant_response.data.id}
    optional: true
