# E57: Batch Targets - batch target updates
# DoD: batch target updates

name: E57_batch_targets
description: |
  Проверяет пакетное обновление целей:
  - Множественные параметры обновляются одновременно
  - Все effective-targets корректно обновлены
  - Timestamp обновления консистентный

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data[0].id}

  - step: get_running_cycle
    type: database_query
    query: |
      SELECT id, status
      FROM grow_cycles
      WHERE zone_id = :zone_id
      AND status = 'RUNNING'
      ORDER BY created_at DESC
      LIMIT 1
    params:
      zone_id: ${zone_id}
    save: running_cycle

  - step: skip_if_no_cycle
    type: set
    cycle_id: ${running_cycle.data[0].id if running_cycle.data else None}

  - step: skip_test_if_no_cycle
    type: eventually
    condition: "context.get('cycle_id') is not None"
    timeout: 1.0
    optional: true

  - step: batch_override
    type: api_post
    endpoint: /api/grow-cycles/${cycle_id}/targets/batch
    payload:
      targets:
        - parameter: ph
          target: 6.9
          min: 6.4
          max: 7.4
        - parameter: ec
          target: 2.2
          min: 2.0
          max: 2.4
        - parameter: temp_air
          target: 24.0
          min: 22.0
          max: 26.0
    save: batch_response

  - step: wait_for_batch_update
    type: wait_until
    condition: |
      # Проверяем, что все параметры обновлены
      from runner.steps.database import DatabaseStepExecutor
      from runner.schema.variables import VariableResolver
      resolver = VariableResolver(context)
      db_exec = DatabaseStepExecutor(context.get('db'), resolver)
      import asyncio
      result = asyncio.run(db_exec.execute_db_step('database_query', {
        'query': '''
          SELECT COUNT(*) as updated_count
          FROM effective_targets
          WHERE cycle_id = :cycle_id
          AND (ph_target = 6.9 OR ec_target = 2.2 OR temp_air_target = 24.0)
          AND created_at > NOW() - INTERVAL '10 seconds'
        ''',
        'params': {'cycle_id': context['cycle_id']}
      }))
      result[0]['updated_count'] >= 3 if result else False
    timeout: 15.0
    interval: 1.0

assertions:
  # Проверка 1: Все параметры обновлены
  - name: all_targets_updated
    type: database_query
    query: |
      SELECT
        COUNT(CASE WHEN ph_target = 6.9 THEN 1 END) as ph_updated,
        COUNT(CASE WHEN ec_target = 2.2 THEN 1 END) as ec_updated,
        COUNT(CASE WHEN temp_air_target = 24.0 THEN 1 END) as temp_updated
      FROM effective_targets
      WHERE cycle_id = :cycle_id
      AND created_at > NOW() - INTERVAL '30 seconds'
    params:
      cycle_id: ${cycle_id}
    expected:
      - field: ph_updated
        operator: greater_than
        value: 0
      - field: ec_updated
        operator: greater_than
        value: 0
      - field: temp_updated
        operator: greater_than
        value: 0

  # Проверка 2: API ответ успешный
  - name: batch_api_success
    type: json_assertion
    data: ${batch_response}
    expected:
      - field: status_code
        operator: in
        value: [200, 201]

  # Проверка 3: Все записи имеют одинаковый timestamp (batch)
  - name: consistent_timestamps
    type: database_query
    query: |
      SELECT COUNT(DISTINCT DATE_TRUNC('second', created_at)) as timestamp_count
      FROM effective_targets
      WHERE cycle_id = :cycle_id
      AND created_at > NOW() - INTERVAL '30 seconds'
      AND (ph_target = 6.9 OR ec_target = 2.2 OR temp_air_target = 24.0)
    params:
      cycle_id: ${cycle_id}
    expected:
      - field: timestamp_count
        operator: equals
        value: 1
