# E53: Manual Advance Stage - advance stage → zone_event + WS
# DoD: advance stage → zone_event + WS

name: E53_manual_advance_stage
description: |
  Проверяет ручное продвижение стадии:
  - У зоны есть активный рецепт
  - Выполняется advance stage (nextPhase)
  - zone_event создается
  - WebSocket событие отправляется

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  # Проверяем, что у зоны есть рецепт
  - step: get_recipe_instance
    type: database_query
    query: |
      SELECT id, recipe_id, current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: recipe_instance

  - step: set_initial_phase
    type: set
    initial_phase_index: ${recipe_instance[0].current_phase_index}

  - step: subscribe_zone_channel
    type: websocket_subscribe
    channel: private-hydro.zones.${zone_id}

  # Выполняем advance stage через API
  # Примечание: может вернуть 422 если уже на последней фазе - делаем опциональным
  - step: advance_stage
    type: api_post
    endpoint: /api/zones/${zone_id}/next-phase
    payload: {}
    save: advance_response
    optional: true

  - step: wait_processing
    type: sleep
    seconds: 2

  # Проверяем обновление phase_index
  - step: check_new_phase
    type: database_query
    query: |
      SELECT current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: new_phase

assertions:
  # Проверка 1: Zone существует
  - name: zone_exists
    type: database_query
    query: |
      SELECT id
      FROM zones
      WHERE id = :zone_id
    params:
      zone_id: ${zone_id}
    expected_rows: 1

  # Проверка 2: Phase_index увеличился или остался тем же (если уже на последней фазе)
  - name: phase_advanced_or_same
    type: database_query
    query: |
      SELECT current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: current_phase_index
        operator: greater_than_or_equal
        value: ${initial_phase_index}
    optional: true  # Опционально, т.к. может быть уже на последней фазе

  # Проверка 3: zone_event создан для изменения фазы (опционально)
  - name: zone_event_created
    type: database_query
    query: |
      SELECT COUNT(*) as event_count
      FROM zone_events
      WHERE zone_id = :zone_id
      AND (type LIKE '%%PHASE%%' OR type LIKE '%%ZONE%%UPDATED%%')
      AND created_at > NOW() - INTERVAL '2 minutes'
    params:
      zone_id: ${zone_id}
    timeout: 10.0
    optional: true
