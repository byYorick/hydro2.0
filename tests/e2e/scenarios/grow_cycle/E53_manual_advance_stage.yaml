# E53: Manual Advance Stage - advance stage → zone_event + WS
# DoD: advance stage → zone_event + WS

name: E53_manual_advance_stage
description: |
  Проверяет ручное продвижение стадии:
  - У зоны есть активный рецепт
  - Выполняется advance stage (nextPhase)
  - zone_event создается
  - WebSocket событие отправляется

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  - step: create_recipe
    type: api_post
    endpoint: /api/recipes
    payload:
      name: test-recipe-e53-${TIMESTAMP_S}
      description: Test recipe for E53
    save: recipe_response

  - step: add_phase_0
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/phases
    payload:
      phase_index: 0
      name: Planting
      duration_hours: 24
      targets:
        ph:
          min: 5.5
          max: 6.5
        ec: 1.5
        temp_air: 22
        humidity_air: 60
        light_hours: 16

  - step: add_phase_1
    type: api_post
    endpoint: /api/recipes/${recipe_response.data.id}/phases
    payload:
      phase_index: 1
      name: Veg
      duration_hours: 48
      targets:
        ph:
          min: 5.6
          max: 6.6
        ec: 1.8
        temp_air: 23
        humidity_air: 55
        light_hours: 18

  - step: attach_recipe
    type: api_post
    endpoint: /api/zones/${zone_id}/attach-recipe
    payload:
      recipe_id: ${recipe_response.data.id}

  - step: start_cycle
    type: api_post
    endpoint: /api/zones/${zone_id}/start
    payload: {}

  - step: subscribe_zone_channel
    type: websocket_subscribe
    channel: private-hydro.zones.${zone_id}

  - step: get_recipe_instance
    type: database_query
    query: |
      SELECT id, recipe_id, current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: recipe_instance

  - step: set_initial_phase
    type: set
    initial_phase_index: ${recipe_instance[0].current_phase_index}

  # Выполняем advance stage через API
  - step: advance_stage
    type: api_post
    endpoint: /api/zones/${zone_id}/next-phase
    payload: {}
    save: advance_response

  - step: wait_processing
    type: sleep
    seconds: 2

  # Проверяем обновление phase_index
  - step: check_new_phase
    type: database_query
    query: |
      SELECT current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: new_phase

assertions:
  # Проверка 1: Zone существует
  - name: zone_exists
    type: database_query
    query: |
      SELECT id
      FROM zones
      WHERE id = :zone_id
    params:
      zone_id: ${zone_id}
    expected_rows: 1

  # Проверка 2: Phase_index увеличился или остался тем же (если уже на последней фазе)
  - name: phase_advanced_or_same
    type: database_query
    query: |
      SELECT current_phase_index
      FROM zone_recipe_instances
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    expected:
      - field: current_phase_index
        operator: greater_than
        value: ${initial_phase_index}

  # Проверка 3: zone_event создан для изменения фазы (опционально)
  - name: zone_event_created
    type: database_query
    query: |
      SELECT COUNT(*) as event_count
      FROM zone_events
      WHERE zone_id = :zone_id
      AND (type LIKE '%%PHASE%%' OR type LIKE '%%ZONE%%UPDATED%%')
      AND created_at > NOW() - INTERVAL '2 minutes'
    params:
      zone_id: ${zone_id}
    timeout: 10.0
    expected:
      - field: event_count
        operator: greater_than_or_equal
        value: 1
