# E03: Duplicate Command Response - Дублирующиеся ответы не ломают статус
# DoD: duplicate responses не ломают статус

name: E03_duplicate_cmd_response
description: |
  Проверяет устойчивость к дублирующимся ответам от узла:
  - Команда отправляется
  - Узел отправляет DONE ответ дважды (дубль)
  - Статус команды остается DONE (не переходит в FAILED или другой статус)
  - WebSocket событие отправляется только один раз

setup:
  # Настройка симулятора узла
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1883}
        username: ${MQTT_USER:-null}
        password: ${MQTT_PASS:-null}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-test-1
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured
        channels:
          - ph_sensor
        actuators:
          - main_pump
      telemetry:
        interval_seconds: 2.0
        heartbeat_interval_seconds: 15.0

  # Предварительные условия
  prerequisites:
    - database: nodes table exists
    - database: zones table exists with zone_id for zn-test-1
    - database: node attached to zone
    - mqtt: broker is accessible
    - backend: Laravel is running
    - websocket: WebSocket server is running

actions:
  # Шаг 1: Запуск симулятора узла
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 3

  # Шаг 1.5: Получаем zone_id и node_id из API (если не установлены автоматически)
  - step: get_zones
    type: api_get
    endpoint: "/api/zones"
    save: zones
  
  - step: get_nodes
    type: api_get
    endpoint: "/api/nodes"
    save: nodes

  - step: find_test_zone_and_node
    type: set
    test_zone_id: ${zones.data.data[0].id}
    test_node_id: ${nodes.data.data[0].id}

  # Шаг 2: Подписка на WebSocket канал команд зоны
  - step: subscribe_ws_commands
    type: websocket_subscribe
    channel: "private-commands.${test_zone_id}"
    wait_seconds: 1

  # Шаг 3: Отправка команды через API
  - step: send_command
    type: api_post
    endpoint: "/api/nodes/${test_node_id}/commands"
    payload:
      cmd: "set_relay_state"
      params:
        channel: "main_pump"
        state: false
    save: command_response
    wait_seconds: 2

  # Шаг 3.5: Сохраняем COMMAND_ID
  - step: set_command_id
    type: set
    COMMAND_ID: ${command_response.data.command_id}

  # Шаг 4: Симулятор отправляет DONE ответ (первый раз)
  - step: node_sends_done_first
    type: mqtt_publish
    topic: "hydro/gh-test-1/zn-test-1/nd-ph-test-1/main_pump/cmd_response"
    payload:
      cmd_id: ${COMMAND_ID}
      status: "DONE"
      result_code: 0
      ts: ${TIMESTAMP_MS}
    qos: 1
    wait_seconds: 2

  # Шаг 5: Симулятор отправляет DONE ответ второй раз (дубль)
  - step: node_sends_done_duplicate
    type: mqtt_publish
    topic: "hydro/gh-test-1/zn-test-1/nd-ph-test-1/main_pump/cmd_response"
    payload:
      cmd_id: ${COMMAND_ID}
      status: "DONE"
      result_code: 0
      ts: ${TIMESTAMP_MS}
    qos: 1
    wait_seconds: 2

assertions:
  # Проверка 1: Команда остается в статусе DONE (не изменилась после дубля)
  - name: command_stays_done
    type: database_query
    query: |
      SELECT id, status, updated_at
      FROM commands
      WHERE cmd_id = :cmd_id
    params:
      cmd_id: ${COMMAND_ID}
    expected:
      - field: status
        operator: equals
        value: "DONE"

  # Проверка 2: Команда обновлялась только один раз (по updated_at)
  - name: command_updated_once
    type: database_query
    query: |
      SELECT status, updated_at
      FROM commands
      WHERE cmd_id = :cmd_id
    params:
      cmd_id: ${COMMAND_ID}
    expected:
      - field: status
        operator: equals
        value: "DONE"

  # Проверка 3: WebSocket событие CommandStatusUpdated отправлено один раз
  - name: ws_event_sent_once
    type: websocket_event_count
    channel: "private-commands.${test_zone_id}"
    event_type: ".App\\Events\\CommandStatusUpdated"
    timeout: 10.0
    filter:
      command.cmd_id: ${COMMAND_ID}
      command.status: "DONE"
    expected:
      - field: count
        operator: equals
        value: 1

cleanup:
  - step: stop_node_simulator
    type: stop_simulator
  - step: unsubscribe_ws
    type: websocket_unsubscribe
