actions:
- endpoint: /api/zones
  save: zones_response
  step: get_zones
  type: api_get
- step: set_zone_id
  type: set
  zone_id: ${zones_response.data.data[0].id}
- params:
    zone_id: ${zone_id}
  query: "DELETE FROM alerts \nWHERE zone_id = :zone_id \nAND code LIKE '%%node_error_sensor_dlq_test%%'\n"
  step: cleanup_old_alerts
  type: db.execute
- config_ref: node_sim.config
  optional: true
  step: start_node_simulator
  type: start_simulator
  wait_seconds: 3
- action: stop
  optional: true
  service: laravel
  step: stop_laravel
  type: fault.inject
- payload:
    component: sensor
    error_code: dlq_test
    level: ERROR
    message: Test error for DLQ replay
    ts: ${TIMESTAMP_MS}
  qos: 1
  step: publish_error_while_laravel_down
  topic: hydro/gh-test-1/zn-test-1/nd-ph-esp32una/error
  type: mqtt_publish
  wait_seconds: 5
- optional: true
  query: 'SELECT COUNT(*) as dlq_count

    FROM pending_alerts

    WHERE alert_code LIKE ''%%dlq_test%%''

    OR (payload_json::text LIKE ''%%dlq_test%%'' AND status = ''failed'')

    '
  step: check_dlq_item
  timeout: 5.0
  type: database_query
- optional: true
  service: laravel
  step: restore_laravel
  type: fault.restore
- seconds: 10
  step: wait_for_replay_processing
  type: sleep
- expected_rows: 1
  params:
    zone_id: ${zone_id}
  query: 'SELECT id, status, code

    FROM alerts

    WHERE zone_id = :zone_id

    AND code LIKE ''%%node_error_sensor_dlq_test%%''

    AND status = ''ACTIVE''

    '
  save: alert_created
  step: wait_for_alert_created
  timeout: 30.0
  type: database_query
assertions:
- expected:
  - field: alert_count
    operator: greater_than_or_equal
    optional: true
    value: 0
  name: alert_created_after_replay
  optional: true
  params:
    zone_id: ${zone_id}
  query: 'SELECT COUNT(*) as alert_count

    FROM alerts

    WHERE zone_id = :zone_id

    AND (code LIKE ''%%dlq_test%%'' OR code LIKE ''%%dlq%%'' OR code LIKE ''%%node_error%%'')

    AND status = ''ACTIVE''

    '
  timeout: 30.0
  type: database_query
cleanup:
- optional: true
  step: stop_node_simulator
  type: stop_simulator
- service: laravel
  step: ensure_laravel_running
  type: fault.restore
description: 'Проверяет механизм replay из DLQ (Dead Letter Queue):

  - Создается DLQ item (алерт, который не удалось доставить)

  - Выполняется replay

  - Alert доставляется успешно

  '
name: E25_dlq_replay
setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1884}
      node:
        actuators:
        - main_pump
        channels:
        - ph_sensor
        gh_uid: gh-test-1
        hardware_id: esp32-test-001
        mode: configured
        node_type: ph
        node_uid: nd-ph-esp32una
        zone_uid: zn-test-1
      telemetry:
        heartbeat_interval_seconds: 15.0
        interval_seconds: 2.0
