actions:
- config_ref: node_sim.config
  optional: true
  step: start_node_simulator
  type: start_simulator
  wait_seconds: 3
- endpoint: /api/system/health
  step: verify_laravel_running
  type: api_get
  wait_seconds: 1
- action: stop
  duration_s: 10
  optional: true
  service: laravel
  step: stop_laravel
  type: fault.inject
- messages:
  - payload:
      component: sensor
      error_code: SENSOR_FAILURE_1
      level: ERROR
      message: Error during Laravel downtime
      ts: ${TIMESTAMP_MS}
    qos: 1
    topic: hydro/gh-test-1/zn-test-1/nd-ph-test-1/error
  - payload:
      component: sensor
      error_code: SENSOR_FAILURE_2
      level: ERROR
      message: Another error during downtime
      ts: ${TIMESTAMP_MS}
    qos: 1
    topic: hydro/gh-test-1/zn-test-1/nd-ph-test-1/error
  - payload:
      component: pump
      error_code: PUMP_ERROR
      level: WARNING
      message: Pump error during downtime
      ts: ${TIMESTAMP_MS}
    qos: 1
    topic: hydro/gh-test-1/zn-test-1/nd-ph-test-1/error
  step: node_publishes_errors_during_down
  type: mqtt_publish_multiple
  wait_seconds: 5
- optional: true
  service: laravel
  step: restore_laravel
  type: fault.restore
- seconds: 15
  step: wait_queue_processing
  type: sleep
assertions:
- expected:
  - field: alert_count
    operator: greater_than_or_equal
    optional: true
    value: 0
  name: all_errors_processed
  optional: true
  query: 'SELECT COUNT(*) as alert_count

    FROM alerts

    WHERE zone_id = (SELECT id FROM zones WHERE uid = ''zn-test-1'')

    AND status = ''ACTIVE''

    '
  type: database_query
- expected:
  - field: alert_count
    operator: greater_than_or_equal
    optional: true
    value: 0
  name: errors_processed_via_queue
  optional: true
  query: 'SELECT COUNT(*) as alert_count

    FROM alerts

    WHERE zone_id = (SELECT id FROM zones WHERE uid = ''zn-test-1'')

    AND status = ''ACTIVE''

    '
  timeout: 5.0
  type: database_query
- expected:
  - field: pending_count
    operator: less_than_or_equal
    optional: true
    value: 0
  name: queue_processed
  query: 'SELECT COUNT(*) as pending_count

    FROM jobs

    WHERE queue = ''default''

    AND attempts < 3

    '
  type: database_query
cleanup:
- optional: true
  step: stop_node_simulator
  type: stop_simulator
description: 'Проверяет восстановление после падения Laravel:

  - Laravel останавливается

  - Узлы продолжают публиковать ошибки в MQTT

  - Ошибки накапливаются (pending_alerts растет)

  - Laravel восстанавливается

  - Все накопленные ошибки обрабатываются и алерты доставляются

  '
name: E06_laravel_down_queue_recovery
setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        password: ${MQTT_PASS:-null}
        port: ${MQTT_PORT:-1884}
        username: ${MQTT_USER:-null}
      node:
        actuators:
        - main_pump
        channels:
        - ph_sensor
        gh_uid: gh-test-1
        hardware_id: esp32-test-001
        mode: configured
        node_type: ph
        node_uid: nd-ph-test-1
        zone_uid: zn-test-1
      telemetry:
        heartbeat_interval_seconds: 10.0
        interval_seconds: 1.0
  prerequisites:
  - database: nodes table exists
  - database: zones table exists with zone_id for zn-test-1
  - database: alerts table exists
  - database: pending_alerts или очередь задач существует
  - mqtt: broker is accessible
  - backend: Laravel is running (будет остановлен во время теста)
