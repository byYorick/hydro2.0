name: E07_ws_reconnect_snapshot_replay
description: |
  Проверяет механизм "snapshot + replay" для восстановления клиента после разрыва WS:
  - Берём snapshot (last_event_id)
  - "Теряем" WS (disconnect)
  - Создаём событие (через MQTT error → alert → zone_event)
  - Переподключаемся
  - Делаем replay через GET /api/zones/{zone}/events?after_id=...

setup:
  node_sim:
    config:
      mqtt:
        host: ${MQTT_HOST:-localhost}
        port: ${MQTT_PORT:-1883}
      node:
        gh_uid: gh-test-1
        zone_uid: zn-test-1
        node_uid: nd-ph-test-1
        hardware_id: esp32-test-001
        node_type: ph
        mode: configured

actions:
  - step: start_node_simulator
    type: start_simulator
    config_ref: node_sim.config
    wait_seconds: 2

  - step: connect_ws
    type: websocket_connect
    wait_seconds: 1

  - step: subscribe_ws_zone
    type: websocket_subscribe
    channel: "private-hydro.zones.${zone_id}"
    wait_seconds: 1

  - step: fetch_snapshot_before
    type: snapshot.fetch
    zone_id: ${zone_id}
    save: snapshot_before
    wait_seconds: 1

  - step: capture_last_event_id
    type: set
    last_event_id_before: ${snapshot_before.data.data.last_event_id}

  - step: disconnect_ws
    type: websocket_disconnect
    wait_seconds: 1

  # Создаём событие во время "gap" (через error → alert → zone_event)
  - step: publish_error_during_gap
    type: mqtt_publish
    topic: "hydro/gh-test-1/zn-test-1/nd-ph-test-1/error"
    payload:
      level: "ERROR"
      component: "sensor"
      error_code: "infra_sensor_stuck_i2c"
      message: "I2C sensor bus stuck (gap)"
      ts: ${TIMESTAMP_MS}
    qos: 1
    wait_seconds: 5  # Увеличиваем время для обработки ошибки и создания алерта/события

  - step: reconnect_ws
    type: websocket_connect
    wait_seconds: 1

  - step: fetch_events_after_id
    type: events.replay
    zone_id: ${zone_id}
    after_id: ${last_event_id_before}
    limit: 50
    save: events_after
    wait_seconds: 2

assertions:
  - name: snapshot_has_last_event_id
    type: json_assertion
    source: snapshot_before
    path: data
    expected:
      - field: last_event_id
        operator: is_not_null

  - name: replay_has_new_events
    type: json_assertion
    source: events_after
    path: data
    expected:
      - field: length
        operator: greater_than_or_equal
        value: 0  # Может быть 0, если событие еще не обработано - это нормально для теста reconnect

  - name: replay_has_new_events
    type: json_assertion
    source: events_after
    path: data
    expected:
      - field: length
        operator: greater_than
        value: 0

cleanup:
  - step: disconnect_ws_final
    type: websocket_disconnect
  - step: stop_node_simulator
    type: stop_simulator
