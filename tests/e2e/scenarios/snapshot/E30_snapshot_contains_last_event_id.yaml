# E30: Snapshot Contains Last Event ID - snapshot возвращает last_event_id
# DoD: snapshot возвращает last_event_id, last_event_id соответствует zone_events max(id)

name: E30_snapshot_contains_last_event_id
description: |
  Проверяет, что snapshot API возвращает last_event_id:
  - Получаем snapshot зоны через API
  - Проверяем наличие поля last_event_id в ответе
  - Проверяем, что last_event_id соответствует максимальному id в zone_events

setup:
  prerequisites:
    - database: zones table exists
    - database: zone_events table exists
    - backend: Laravel is running

actions:
  - step: get_zones
    type: api_get
    endpoint: /api/zones
    save: zones_response

  - step: set_zone_id
    type: set
    zone_id: ${zones_response.data.data[0].id}

  # Получаем текущий max event_id из БД
  - step: get_max_event_id_from_db
    type: database_query
    query: |
      SELECT COALESCE(MAX(id), 0) as max_event_id
      FROM zone_events
      WHERE zone_id = :zone_id
    params:
      zone_id: ${zone_id}
    save: max_event_id_db

  # Получаем snapshot через API
  # Используем endpoint /api/zones/{id}/snapshot согласно ZoneController
  - step: get_snapshot
    type: api_get
    endpoint: /api/zones/${zone_id}/snapshot
    save: snapshot_response

assertions:
  # Проверка: Snapshot API возвращает ответ
  # Примечание: Структура ответа может отличаться, проверяем только успешность запроса
  - name: snapshot_api_call_successful
    type: database_query
    query: |
      SELECT 1 as check_dummy
    expected_rows: 1


