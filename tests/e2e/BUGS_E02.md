# Найденные баги в E02_command_happy.yaml

## ✅ Исправленные баги

### 1. ✅ Использование полного имени события
**Исправлено:** Заменено `CommandStatusUpdated` на `.App\\Events\\CommandStatusUpdated` в строках 50, 70, 86-87

### 2. ✅ ORDER BY created_at → updated_at
**Исправлено:** Изменено `ORDER BY created_at` на `ORDER BY updated_at` в строке 106

### 3. ✅ Добавлена проверка zone_events
**Исправлено:** Добавлена проверка записи команды в zone_events (строки 115-133)

### 4. ✅ Улучшены фильтры событий
**Исправлено:** Добавлен фильтр `commandId` к фильтрам событий для точной идентификации команд

## Оставшиеся проблемы

### 1. ⚠️ Неправильный фильтр в строке 73 (частично исправлено)
**Проблема:** Фильтр использует `status: ACCEPTED`, но структура события CommandStatusUpdated содержит данные в поле `data`, и статус находится по пути `command.status` или просто `status` в корне payload.

**Структура события CommandStatusUpdated (из `broadcastWith()`):**
```php
[
    'command' => [...], // объект команды
    'status' => 'ACCEPTED', // статус в корне
    'zoneId' => $this->zoneId,
    'event_id' => $this->eventId,
    'server_ts' => $this->serverTs,
]
```

**Исправление:** Нужно проверить структуру payload - возможно нужно использовать `command.status` вместо `status`.

### 2. ❌ ORDER BY created_at в строке 102
**Проблема:** Для одной команды ORDER BY created_at не имеет смысла - команда одна, изменения статусов отслеживаются через поле `updated_at` или нужно смотреть историю изменений.

**Текущий запрос:**
```sql
SELECT status, created_at, sent_at, ack_at 
FROM commands 
WHERE cmd_id = :cmd_id 
ORDER BY created_at
```

**Проблема:** Для одной команды с одним `cmd_id` будет только одна запись, поэтому ORDER BY не нужен. Возможно, нужно смотреть на таблицу истории изменений статусов (если такая есть) или просто убрать ORDER BY.

**Рекомендация:** 
- Убрать ORDER BY или изменить на ORDER BY updated_at
- Или использовать таблицу истории статусов, если она существует

### 3. ⚠️ Использование короткого имени события вместо полного
**Проблема:** В строках 50, 70, 86 используется короткое имя `CommandStatusUpdated` вместо полного `.App\\Events\\CommandStatusUpdated`.

**Риск:** Средний. Код в `ws_client.py` нормализует имена событий, но лучше использовать полное имя для консистентности с E03.

**Рекомендация:** Использовать `.App\\Events\\CommandStatusUpdated` для консистентности.

### 4. ⚠️ Отсутствие проверки структуры ответа API
**Проблема:** В строке 91 используется `/api/commands/${command_id}/status`, но нет проверки формата ответа.

**Проверено:** Endpoint существует в `CommandStatusController.php` и возвращает структуру:
```json
{
    "status": "ok",
    "data": {
        "cmd_id": "...",
        "status": "DONE",
        ...
    }
}
```

**Проблема:** В строке 97 используется `${final_command.data.status}`, что предполагает структуру `{data: {status: ...}}`, но нужно проверить реальную структуру ответа.

### 5. ⚠️ Логическая проблема с ожиданием событий
**Проблема:** 
- Строка 48-51: Ждет событие CommandStatusUpdated (любое)
- Строка 68-74: Снова ждет событие CommandStatusUpdated с фильтром `status: ACCEPTED`, но это `optional: true`
- Строка 84-87: Снова ждет событие CommandStatusUpdated (любое)

**Риск:** Средний. Может пропустить нужные события, если они уже произошли до подписки или между проверками.

**Рекомендация:** 
- Использовать счетчик событий вместо простого wait
- Или увеличить таймауты
- Или добавить проверку, что событие действительно соответствует ожидаемому статусу

### 6. ⚠️ Проблема с получением zone_id и node_id
**Проблема:** В строках 22-23 используются `zones.data.data[0].id` и `nodes.data.data[0].id`, но нет проверки:
- Что массивы не пустые
- Что нужная зона/узел существуют
- Что используется правильный индекс

**Риск:** Высокий. Если в БД нет данных или структура ответа отличается, тест упадет.

**Рекомендация:** 
- Добавить проверку наличия данных
- Искать по uid (zn-test-1, nd-ph-test-1) вместо индекса
- Использовать fallback на автоматический резолв через setup

## Средние проблемы

### 7. ⚠️ Дублирование проверок статуса
**Проблема:** 
- Строка 53-60: Проверяет статус в БД (SENT или ACCEPTED)
- Строка 62-66: Снова проверяет тот же статус через assert
- Строка 76-82: Снова проверяет статус ACCEPTED в БД
- Строка 94-98: Проверяет финальный статус через API

**Рекомендация:** Можно упростить - оставить одну проверку через DB wait и финальную проверку через API.

### 8. ⚠️ Отсутствие проверки команды в zone_events
**Проблема:** Тест не проверяет, что команда записана в zone_events (как указано в DoD).

**DoD требует:** "команды: монотонный статус + WS событие + запись в zone_events"

**Рекомендация:** Добавить проверку записи в zone_events после выполнения команды.

## Мелкие проблемы

### 9. ℹ️ Комментарий в строке 27
**Проблема:** Комментарий указывает канал `private-commands.{zone_id}`, но в коде используется `commands.{zoneId}` (без `private-` префикса в broadcastOn()).

**Проверено:** В `CommandStatusUpdated.php` используется `PrivateChannel("commands.{$this->zoneId}")`, что создает канал `private-commands.{zoneId}` в Laravel Reverb.

**Статус:** Комментарий правильный, это просто информация.

## Рекомендации по приоритетам

**Критично:**
1. Исправить фильтр в строке 72-73 (проверить структуру payload)
2. Убрать/исправить ORDER BY в строке 102
3. Добавить проверку наличия данных перед использованием индексов

**Высокий приоритет:**
4. Использовать полное имя события для консистентности
5. Добавить проверку записи в zone_events

**Средний приоритет:**
6. Упростить логику ожидания событий
7. Улучшить получение zone_id/node_id

**Низкий приоритет:**
8. Упростить дублирующиеся проверки

