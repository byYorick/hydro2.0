# version: '3.8'  # Устарело в новых версиях docker-compose
networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
services:
  postgres:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-hydro_e2e}
      POSTGRES_USER: ${POSTGRES_USER:-hydro}
      POSTGRES_DB: ${POSTGRES_DB:-hydro_e2e}
    ports:
    - ${POSTGRES_PORT:-5433}:5432
    volumes:
    - postgres_e2e_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U hydro -d hydro_e2e
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      backend:
        aliases:
          - postgres
          - db
  redis:
    image: redis:7-alpine
    ports:
    - ${REDIS_PORT:-6380}:6379
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
    - backend
  mosquitto:
    image: eclipse-mosquitto:2
    ports:
    - ${MQTT_PORT:-1884}:1883
    volumes:
    - ./mosquitto.e2e.conf:/mosquitto/config/mosquitto.conf:ro
    - mqtt_e2e_data:/mosquitto/data
    - mqtt_e2e_logs:/mosquitto/log
    healthcheck:
      test:
      - CMD-SHELL
      - mosquitto_sub -h localhost -p 1883 -t '$$SYS/#' -C 1 > /dev/null 2>&1 || exit
        1
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
    - backend
  laravel:
    build:
      context: ../../backend/laravel
      dockerfile: Dockerfile
      args:
        INSTALL_DEV_DEPS: 'true'
        SKIP_FRONTEND_BUILD: 'true'
    working_dir: /app
    environment:
    - WEB_DOCUMENT_ROOT=/app/public
    - APP_ENV=testing
    - APP_DEBUG=true
    - APP_DEBUG_MODE=true
    - SESSION_DRIVER=file
    - CACHE_STORE=file
    - CACHE_DRIVER=file
    - LOG_CHANNEL=stderr
    - LOG_LEVEL=debug
    - PHP_DISPLAY_ERRORS=On
    - BROADCAST_CONNECTION=reverb
    - BROADCAST_CONNECTION_TESTING=reverb
    - QUEUE_CONNECTION=sync
    - DB_CONNECTION=pgsql
    - DB_HOST=postgres
    - DB_PORT=5432
    - DB_DATABASE=${POSTGRES_DB:-hydro_e2e}
    - DB_USERNAME=${POSTGRES_USER:-hydro}
    - DB_PASSWORD=${POSTGRES_PASSWORD:-hydro_e2e}
    - COMMAND_TIMEOUT_MINUTES=1
    - REDIS_HOST=redis
    - REDIS_PORT=6379
    - REVERB_APP_ID=app
    - REVERB_APP_KEY=${REVERB_APP_KEY:-local}
    - REVERB_APP_SECRET=${REVERB_APP_SECRET:-secret}
    - REVERB_SERVER_HOST=0.0.0.0
    - REVERB_SERVER_PORT=6001
    - REVERB_HOST=localhost
    - REVERB_PORT=6001
    - REVERB_SCHEME=http
    - REVERB_DEBUG=true
    - REVERB_AUTO_START=true
    - REVERB_ALLOWED_ORIGINS=*
    - MQTT_HOST=mosquitto
    - MQTT_PORT=1883
    - PY_API_TOKEN=${PY_API_TOKEN:-dev-token-12345}
    - PY_INGEST_TOKEN=${PY_INGEST_TOKEN:-dev-token-12345}
    - LARAVEL_API_TOKEN=${LARAVEL_API_TOKEN:-dev-token-12345}
    - PHP_OPCACHE_ENABLE=0
    - HISTORY_LOGGER_URL=http://history-logger:9300
    volumes:
    - ../../backend/laravel:/app
    ports:
    - ${LARAVEL_PORT:-8081}:80
    - ${REVERB_PORT:-6002}:6001
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
      history-logger:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - curl -f http://localhost:80/api/system/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
    - backend
  history-logger:
    build:
      context: ../../backend/services
      dockerfile: history-logger/Dockerfile
    environment:
    - APP_ENV=testing
    - LOG_LEVEL=DEBUG
    - PYTHONUNBUFFERED=1
    - MQTT_HOST=mosquitto
    - MQTT_PORT=1883
    - MQTT_TLS=0
    - MQTT_USER=${MQTT_HISTORY_LOGGER_USER:-history_logger}
    - MQTT_PASS=${MQTT_HISTORY_LOGGER_PASS:-logger_pass}
    - PG_HOST=postgres
    - PG_DB=${POSTGRES_DB:-hydro_e2e}
    - PG_USER=${POSTGRES_USER:-hydro}
    - PG_PASS=${POSTGRES_PASSWORD:-hydro_e2e}
    - LARAVEL_API_URL=http://laravel
    - PY_API_TOKEN=${PY_API_TOKEN:-dev-token-12345}
    - PY_INGEST_TOKEN=${PY_INGEST_TOKEN:-dev-token-12345}
    - TELEMETRY_MAX_AGE_MINUTES=${TELEMETRY_MAX_AGE_MINUTES:-5}
    - HISTORY_LOGGER_API_TOKEN=${HISTORY_LOGGER_API_TOKEN:-${PY_INGEST_TOKEN:-dev-token-12345}}
    - LARAVEL_API_TOKEN=${LARAVEL_API_TOKEN:-dev-token-12345}
    - REDIS_HOST=redis
    - REDIS_PORT=6379
    - MQTT_ZONE_FORMAT=uid
    depends_on:
      mosquitto:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
    - ${HISTORY_LOGGER_PORT:-9302}:9300
    - ${HISTORY_LOGGER_METRICS_PORT:-9303}:9301
    healthcheck:
      test:
      - CMD-SHELL
      - python -c 'import urllib.request; urllib.request.urlopen("http://localhost:9300/health").read()'
        || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
    - backend
  mqtt-bridge:
    build:
      context: ../../backend/services
      dockerfile: mqtt-bridge/Dockerfile
    environment:
    - APP_ENV=testing
    - LOG_LEVEL=DEBUG
    - PYTHONUNBUFFERED=1
    - MQTT_HOST=mosquitto
    - MQTT_PORT=1883
    - MQTT_TLS=0
    - MQTT_USER=${MQTT_MQTT_BRIDGE_USER:-mqtt_bridge}
    - MQTT_PASS=${MQTT_MQTT_BRIDGE_PASS:-bridge_pass}
    - PG_HOST=postgres
    - PG_DB=${POSTGRES_DB:-hydro_e2e}
    - PG_USER=${POSTGRES_USER:-hydro}
    - PG_PASS=${POSTGRES_PASSWORD:-hydro_e2e}
    - LARAVEL_API_URL=http://laravel
    - PY_API_TOKEN=${PY_API_TOKEN:-dev-token-12345}
    - LARAVEL_API_TOKEN=${LARAVEL_API_TOKEN:-dev-token-12345}
    depends_on:
      mosquitto:
        condition: service_healthy
      postgres:
        condition: service_healthy
      laravel:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect(("localhost",
        9000)); s.close()' || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
    - backend
  telemetry-aggregator:
    build:
      context: ../../backend/services
      dockerfile: telemetry-aggregator/Dockerfile
    environment:
    - APP_ENV=testing
    - LOG_LEVEL=DEBUG
    - PYTHONUNBUFFERED=1
    - PG_HOST=postgres
    - PG_PORT=5432
    - PG_DB=${POSTGRES_DB:-hydro_e2e}
    - PG_USER=${POSTGRES_USER:-hydro}
    - PG_PASS=${POSTGRES_PASSWORD:-hydro_e2e}
    - PYTHONPATH=/app
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect(("localhost",
        9404)); s.close()' || exit 1
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
    - backend
  automation-engine:
    build:
      context: ../../backend/services
      dockerfile: automation-engine/Dockerfile
    environment:
    - APP_ENV=testing
    - LOG_LEVEL=DEBUG
    - PYTHONUNBUFFERED=1
    - MQTT_HOST=mosquitto
    - MQTT_PORT=1883
    - MQTT_TLS=0
    - MQTT_USER=${MQTT_AUTOMATION_ENGINE_USER:-automation_engine}
    - MQTT_PASS=${MQTT_AUTOMATION_ENGINE_PASS:-automation_pass}
    - PG_HOST=postgres
    - PG_DB=${POSTGRES_DB:-hydro_e2e}
    - PG_USER=${POSTGRES_USER:-hydro}
    - PG_PASS=${POSTGRES_PASSWORD:-hydro_e2e}
    - LARAVEL_API_URL=http://laravel
    - PY_API_TOKEN=${PY_API_TOKEN:-dev-token-12345}
    - LARAVEL_API_TOKEN=${LARAVEL_API_TOKEN:-dev-token-12345}
    # Ускоренные настройки для E2E тестов
    - MAIN_LOOP_SLEEP_SECONDS=${MAIN_LOOP_SLEEP_SECONDS:-2}
    - INITIAL_BACKOFF_SECONDS=${INITIAL_BACKOFF_SECONDS:-5}
    - CONTROLLER_COOLDOWN_SECONDS=${CONTROLLER_COOLDOWN_SECONDS:-10}
    - TELEMETRY_MAX_AGE_MINUTES=${TELEMETRY_MAX_AGE_MINUTES:-5}
    - FRESHNESS_CHECK_FAILED_ALERT_THRESHOLD=${FRESHNESS_CHECK_FAILED_ALERT_THRESHOLD:-3}
    - CONFIG_FETCH_RETRY_SLEEP_SECONDS=${CONFIG_FETCH_RETRY_SLEEP_SECONDS:-2}
    # Test mode для детерминированных ошибок
    - AE_TEST_MODE=${AE_TEST_MODE:-1}
    depends_on:
      mosquitto:
        condition: service_healthy
      postgres:
        condition: service_healthy
      laravel:
        condition: service_healthy
    healthcheck:
      test:
      - CMD-SHELL
      - python -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect(("localhost",
        9500)); s.close()' || exit 1
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    # Убираем profiles для автоматического старта в E2E тестах
    # profiles:
    # - automation
    ports:
    - "9500:9500"
    - "9505:9505"
    networks:
    - backend
  node-sim:
    build:
      context: ../../tests/node_sim
      dockerfile: Dockerfile
    environment:
    - PYTHONUNBUFFERED=1
    - MQTT_HOST=mosquitto
    - MQTT_PORT=1883
    - NODE_SIM_CONFIG=${NODE_SIM_CONFIG:-/app/config/sim.yaml}
    volumes:
    - ../../tests/node_sim:/app
    - ./node-sim-config.yaml:/app/config/sim.yaml:ro
    depends_on:
      mosquitto:
        condition: service_healthy
    command: python -m node_sim.cli run --config /app/config/sim.yaml
    networks:
    - backend
volumes:
  postgres_e2e_data: null
  mqtt_e2e_data: null
  mqtt_e2e_logs: null
