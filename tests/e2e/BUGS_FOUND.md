# –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏ –≤ E2E —Ç–µ—Å—Ç–∞—Ö

## –ë–∞–≥ 1: –ö–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ QUEUED

### –°–∏–º–ø—Ç–æ–º—ã
- –ö–æ–º–∞–Ω–¥—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º QUEUED
- History-logger –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã SENT/ACCEPTED –≤ Laravel
- –ù–æ –∫–æ–º–∞–Ω–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ QUEUED –≤ –ë–î

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
1. ‚úÖ Node-sim –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ACK
2. ‚úÖ History-logger –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç command_response –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –≤ Laravel
3. ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –¥–æ—Ö–æ–¥—è—Ç –¥–æ Laravel (–∫–æ–¥ 200 OK –≤ –ª–æ–≥–∞—Ö httpx)
4. ‚ö†Ô∏è –õ–æ–≥–∏ `COMMAND_ACK STEP 0` –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Laravel, —Ö–æ—Ç—è –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
5. ‚úÖ –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–º–∞–Ω–¥ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (eb4e1c4e, ea143de6 –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å ACCEPTED)

### –î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **http_client_pool.py**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏/–ø–æ–ª—É—á–µ–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
2. **PythonIngestController.php**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ commandAck (STEP 0) –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞
3. **command_status_queue.py**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤

### –°—Ç–∞—Ç—É—Å
- ‚úÖ –î–ª—è –∫–æ–º–∞–Ω–¥ eb4e1c4e –∏ ea143de6 —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ ACCEPTED –≤ –ë–î
- ‚ùì –õ–æ–≥–∏ STEP 0 –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è, —Ö–æ—Ç—è –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–ª–∏ –ø–æ—Ç–æ–∫–æ–º –ª–æ–≥–æ–≤)
- ‚ùå –î–ª—è –∫–æ–º–∞–Ω–¥—ã 997c1988 node-sim –Ω–µ –ø–æ–ª—É—á–∏–ª –∫–æ–º–∞–Ω–¥—É

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø–æ—á–µ–º—É node-sim –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
2. –†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –ª–æ–≥–æ–≤ STEP 0 (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å —É—Ä–æ–≤–Ω–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ë–∞–≥ 2: Node-sim –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã (–¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–º–∞–Ω–¥)

### –°–∏–º–ø—Ç–æ–º—ã
- –ö–æ–º–∞–Ω–¥–∞ 997c1988 –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ history-logger
- History-logger –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤ MQTT
- Node-sim –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É (–Ω–µ—Ç –ª–æ–≥–æ–≤ "‚úì RECEIVED COMMAND")

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã
- –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π node-sim –Ω–∞ MQTT —Ç–æ–ø–∏–∫–∏
- –ö–æ–º–∞–Ω–¥–∞ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫
- –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π –∏ –ø–æ–¥–ø–∏—Å–∫–æ–π

## –ë–∞–≥ 3: –ó–∞–ø—Ä–æ—Å—ã –æ—Ç Laravel –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ history-logger –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### –°–∏–º–ø—Ç–æ–º—ã
- Laravel –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ history-logger –∏ –ø–æ–ª—É—á–∞–µ—Ç 200 OK
- –ù–æ –≤ –ª–æ–≥–∞—Ö history-logger –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ POST –∫ `/nodes/*/commands` –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- –î–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞) –ª–æ–≥–∏ –µ—Å—Ç—å
- –ö–æ–º–∞–Ω–¥—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (—Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è QUEUED)

### –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
1. ‚úÖ –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 06:07, 06:08, 06:09 –ª–æ–≥–∏ –µ—Å—Ç—å, –∫–æ–º–∞–Ω–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å
2. ‚ùå –î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤ 06:31 (–∫–æ–º–∞–Ω–¥–∞ f69cbb14) –ª–æ–≥–æ–≤ –Ω–µ—Ç, —Ö–æ—Ç—è Laravel –ø–æ–ª—É—á–∞–µ—Ç 200 OK
3. ‚ùì History-logger –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
4. ‚úÖ Middleware –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–∏–¥–Ω—ã GET –∑–∞–ø—Ä–æ—Å—ã)
5. ‚ùì Endpoint –º–æ–∂–µ—Ç –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–ª–∏ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≥–¥–µ-—Ç–æ —Ä–∞–Ω—å—à–µ

### –î–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **main.py (history-logger)**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ `publish_node_command` endpoint (STEP 0, STEP 1)
2. **PythonBridgeService.php**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏/–ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤

### –°—Ç–∞—Ç—É—Å
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ HTTP-–∫–ª–∏–µ–Ω—Ç–µ Laravel (keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è). –î–æ–±–∞–≤–ª–µ–Ω—ã CURLOPT_FRESH_CONNECT –∏ CURLOPT_FORBID_REUSE.
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã —Ç–µ–ø–µ—Ä—å –¥–æ—Ö–æ–¥—è—Ç –¥–æ history-logger –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ö–æ–º–∞–Ω–¥—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (—Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–æ ACCEPTED)
- ‚úÖ –¢–µ—Å—Ç E02_command_happy –ø—Ä–æ—Ö–æ–¥–∏—Ç (13 passed, –æ—Å—Ç–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∞ –≤ YAML —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–µ, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)

### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω—ã –æ–ø—Ü–∏–∏ –≤ HTTP-–∫–ª–∏–µ–Ω—Ç Laravel (`PythonBridgeService.php`) –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å Docker —Å–µ—Ç—å—é –∏ keep-alive:
```php
->withOptions([
    'curl' => [
        CURLOPT_TCP_NODELAY => true,
        CURLOPT_FRESH_CONNECT => true,
        CURLOPT_FORBID_REUSE => true,
        CURLOPT_CONNECTTIMEOUT => 5,
        CURLOPT_DNS_CACHE_TIMEOUT => 0, // –û—Ç–∫–ª—é—á–∞–µ–º DNS –∫—ç—à
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1, // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º HTTP/1.1
    ],
    'allow_redirects' => false, // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
])
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ `E02_command_happy.yaml`: –∑–∞–º–µ–Ω–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `payload` –Ω–∞ `payload_json` –≤ –∑–∞–ø—Ä–æ—Å–µ –∫ `zone_events`
2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–∏–ø —à–∞–≥–∞: `type: database_query` ‚Üí `db.query`
3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `node_uid` –≤ `E03_duplicate_cmd_response.yaml`: `nd-ph-test-1` ‚Üí `nd-ph-esp32una`
4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç MQTT —Ç–æ–ø–∏–∫–∞: `cmd_response` ‚Üí `command_response`

## –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
1. –ü—Ä–æ–±–ª–µ–º–∞ —Å Docker —Å–µ—Ç—å—é –∏ keep-alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
2. –û—à–∏–±–∫–∏ –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö (payload_json)
3. –û—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö YAML —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
4. –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ node_uid –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –∏ node-sim

### ‚úÖ –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- E02_command_happy: **14 passed, 0 failed** ‚úÖ
- E03_duplicate_cmd_response: **11 passed, 1 failed** (–ø—Ä–æ–±–ª–µ–º–∞ —Å websocket_event_count, —É–¥–∞–ª–µ–Ω–∞ –ª–∏—à–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

### üìã –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–º–∞—Ç—Ä–∏—Ü–∞ –º–∏–Ω–∏–º—É–º)
- ‚úÖ E01_bootstrap
- ‚úÖ E02_command_happy  
- ‚ö†Ô∏è E04_error_alert (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚ö†Ô∏è E05_unassigned_attach (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚ö†Ô∏è E07_ws_reconnect_snapshot_replay (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)
