# Найденные баги в E2E тестах

## Исправленные баги

### 1. ❌ Неправильный формат переменных в E03_duplicate_cmd_response.yaml
**Проблема:** Использовался формат `{zone_id}` вместо `${zone_id}` для подстановки переменных
**Места:**
- Строка 55: `channel: "private-commands.{zone_id}"` 
- Строка 61: `endpoint: "/api/nodes/{node_id}/commands"`
- Строка 131: `channel: "private-commands.{zone_id}"`

**Исправлено:** ✅ Все заменено на `${zone_id}` и `${node_id}`

### 2. ❌ Проблема с двойным добавлением /app/local в WS URL
**Проблема:** Если WS URL уже содержит `/app/local`, но с query параметрами, код может добавить путь еще раз
**Место:** `tests/e2e/runner/ws_client.py:54-58`

**Исправлено:** ✅ Добавлена проверка, которая учитывает query параметры при проверке окончания URL

### 3. ❌ Дублирующаяся проверка в E07_ws_reconnect_snapshot_replay.yaml
**Проблема:** Два одинаковых assertion с именем `replay_has_new_events` (строки 87-95 и 96-104)
**Исправлено:** ✅ Объединено в одну проверку `replay_returns_data`

## Потенциальные проблемы (требуют проверки)

### 4. ⚠️ Отсутствие zone_id и node_id в некоторых сценариях
**Проблема:** В E03, E04, E05, E07 переменные `zone_id` и `node_id` могут быть не установлены, если:
- API не готов при запуске теста
- Данные (zones/nodes) отсутствуют в БД
- Резолв через API не сработал

**Риск:** Средний. Код в `e2e_runner.py:622-645` пытается получить эти данные, но при ошибках просто игнорирует (except: pass)

**Рекомендация:** 
- Добавить явную проверку наличия `zone_id`/`node_id` перед использованием
- Добавить шаги создания тестовых данных в начале сценариев или отдельный setup-сценарий

### 5. ⚠️ Проблема с фильтром событий в websocket_event_count
**Проблема:** В E03 используется фильтр:
```yaml
filter:
  command.cmd_id: ${COMMAND_ID}
  command.status: "DONE"
```

**Риск:** Низкий. Код в `ws_client.py:257-273` поддерживает вложенные поля через точку, но может быть нестабильным для сложных структур.

**Рекомендация:** Протестировать фильтрацию событий с вложенными полями.

### 6. ⚠️ Отсутствие тестовых данных в БД
**Проблема:** Сценарии предполагают наличие:
- Теплицы с uid `gh-test-1`
- Зоны с uid `zn-test-1` 
- Узла с uid `nd-ph-test-1`

Но нет явного создания этих данных перед тестами.

**Риск:** Высокий. Тесты могут падать если БД чистая.

**Рекомендация:** 
- Создать seeder для E2E тестов
- Добавить шаги создания данных в начале сценариев
- Использовать миграции/seeders при старте docker-compose

### 7. ⚠️ Проблема с форматом событий в wait_event
**Проблема:** В разных местах используются разные форматы:
- `CommandStatusUpdated` (короткое имя)
- `.App\\Events\\CommandStatusUpdated` (полное имя с экранированием)

**Риск:** Средний. Код нормализует имена событий, но могут быть edge cases.

**Рекомендация:** Унифицировать формат во всех сценариях.

### 8. ⚠️ Отсутствие node_id в E03
**Проблема:** В E03 нет шага для получения `node_id`, хотя он используется в `endpoint: "/api/nodes/${node_id}/commands"`

**Риск:** Высокий. Если API не вернет node_id автоматически, тест упадет.

**Рекомендация:** Добавить явный шаг получения node_id из API или БД.

## Проблемы инфраструктуры

### 9. ⚠️ Docker network external: true → bridge
**Исправлено:** ✅ Изменено с `external: true` на `driver: bridge` в docker-compose.e2e.yml

### 10. ⚠️ Отсутствие .env.e2e.example
**Статус:** ✅ Файл существует (заблокирован для редактирования)

## Рекомендации по приоритетам исправления

**Критично (исправлено):**
1. ✅ Неправильный формат переменных в E03
2. ✅ Дублирующаяся проверка в E07
3. ✅ Проблема с WS URL

**Высокий приоритет:**
4. Отсутствие тестовых данных в БД
5. Отсутствие node_id в E03

**Средний приоритет:**
6. Проверка наличия zone_id/node_id
7. Унификация формата событий

**Низкий приоритет:**
8. Тестирование фильтрации событий

