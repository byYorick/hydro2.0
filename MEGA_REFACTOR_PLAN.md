# MEGA_REFACTOR_PLAN.md
# Hydro2.0 ‚Äî –ú–µ–≥–∞‚Äë–ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–¥ –Ω–æ–≤—É—é –¥–æ–º–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (–±–µ–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

–î–∞—Ç–∞: 2025‚Äë12‚Äë25

## üìä –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- ‚úÖ **–≠—Ç–∞–ø 0**: –ó–∞–≤–µ—Ä—à–µ–Ω (–≤–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, —Ç–µ—Å—Ç—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã)
- ‚úÖ **–≠—Ç–∞–ø 1**: –ó–∞–≤–µ—Ä—à–µ–Ω (–º–∏–≥—Ä–∞—Ü–∏–∏, constraints, —É–¥–∞–ª–µ–Ω–∏–µ legacy —Ç–∞–±–ª–∏—Ü)
- ‚úÖ **–≠—Ç–∞–ø 2.1**: –ó–∞–≤–µ—Ä—à–µ–Ω (Eloquent –º–æ–¥–µ–ª–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è)
- ‚úÖ **–≠—Ç–∞–ø 2.2**: –ó–∞–≤–µ—Ä—à–µ–Ω (EffectiveTargetsService –∏ –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã)
- ‚úÖ **–≠—Ç–∞–ø 2.3**: –ó–∞–≤–µ—Ä—à–µ–Ω (API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, —É–¥–∞–ª–µ–Ω—ã legacy endpoints)
- ‚úÖ **–≠—Ç–∞–ø 2.4**: –ó–∞–≤–µ—Ä—à–µ–Ω (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞, Policy –∫–ª–∞—Å—Å—ã)
- ‚è≥ **–≠—Ç–∞–ø 2.5**: –ß–∞—Å—Ç–∏—á–Ω–æ (—Å–æ–±—ã—Ç–∏—è –ø–∏—à—É—Ç—Å—è –≤ –ë–î, –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å WebSocket payload)
- ‚è≥ **–≠—Ç–∞–ø 3**: –ù–µ –Ω–∞—á–∞—Ç (Python services)
- ‚è≥ **–≠—Ç–∞–ø 4**: –ù–µ –Ω–∞—á–∞—Ç (Frontend)
- ‚è≥ **–≠—Ç–∞–ø 5**: –ù–µ –Ω–∞—á–∞—Ç (–û—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
- ‚è≥ **–≠—Ç–∞–ø 6**: –ù–µ –Ω–∞—á–∞—Ç (–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚è≥ **–≠—Ç–∞–ø 7**: –ù–µ –Ω–∞—á–∞—Ç (–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É —Ç–æ–Ω–∫–∏—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ (–≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ —Å–µ—Ä–≤–∏—Å—ã)

## 0) –¶–µ–ª—å (Definition of Done)
–°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –Ω–∞ –¥–æ–º–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å:

**–¢–µ–ø–ª–∏—Ü–∞ ‚Üí –ó–æ–Ω—ã ‚Üí –¶–∏–∫–ª –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è (—Ü–µ–Ω—Ç—Ä –∏—Å—Ç–∏–Ω—ã) ‚Üí –†–∞—Å—Ç–µ–Ω–∏–µ ‚Üí –†–µ—Ü–µ–ø—Ç—ã ‚Üí –§–∞–∑—ã (+ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–¥—à–∞–≥–∏)**

–∏ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é –æ—Å—å `zone_recipe_instances + recipe_phases.targets`.

**–ì–æ—Ç–æ–≤–æ**, –∫–æ–≥–¥–∞:
- –í –∫–∞–∂–¥–æ–π –∑–æ–Ω–µ enforced: **—Ä–æ–≤–Ω–æ 1 –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª** (RUNNING/PAUSED; –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ 1 PLANNED).
- Python‚Äë–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ Scheduler —á–∏—Ç–∞—é—Ç **—Ç–æ–ª—å–∫–æ** active `grow_cycles` –∏ **effective targets** —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã (—Å —É—á—ë—Ç–æ–º override‚Äô–æ–≤).
- UI ‚Äú–¶–µ–Ω—Ç—Ä —Ü–∏–∫–ª–æ–≤‚Äù + ‚Äú–ú–∞—Å—Ç–µ—Ä —Ü–∏–∫–ª–∞‚Äù —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏, –±–µ–∑ legacy‚Äë—Å—Ç—Ä–∞–Ω–∏—Ü/—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
- –†–µ—Ü–µ–ø—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç **—Ä–µ–≤–∏–∑–∏–∏**: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ DRAFT –∏ **–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** (create new from existing), –ø—É–±–ª–∏–∫–∞—Ü–∏—è/–∑–∞–º–æ—Ä–æ–∑–∫–∞.
- –ü–µ—Ä–µ—Ö–æ–¥—ã —Ñ–∞–∑ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –≤–æ–∑–º–æ–∂–Ω—ã: –∞–≤—Ç–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ + —Ä—É—á–Ω–æ–π switch —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.
- –ö–æ–º–∞–Ω–¥—ã –∏–º–µ—é—Ç **–¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** (ACK + DONE/ERROR) –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI/–ª–æ–≥–∞—Ö.
- –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏/–∞—Ä—Ö–∏–≤‚Äë—Ç–∞–±–ª–∏—Ü—ã, –≤–∫–ª—é—á–µ–Ω—ã retention/partitioning –ø–æ–ª–∏—Ç–∏–∫–∏; –∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –ø–∏—à–µ—Ç –≤ ‚Äú_archive‚Äù.

## 1) –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏–Ω—è—Ç—ã–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–∏–∑ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤)
### 1.1. –¢–æ–ø–æ–ª–æ–≥–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- **1 –∑–æ–Ω–∞ = 1 –∫–æ–Ω—Ç—É—Ä** –ø–æ–ª–∏–≤–∞/–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ä–∞—Å—Ç–≤–æ—Ä–∞; –∑–æ–Ω—ã **–Ω–µ –¥–µ–ª—è—Ç** –∫–æ–Ω—Ç—É—Ä—ã.
- –í –∑–æ–Ω–µ: **1 –ø–æ–ª–∏–≤**, **1 —Ç—É–º–∞–Ω**, **2 –±–∞–∫–∞** (—á–∏—Å—Ç–∞—è –≤–æ–¥–∞ + —Ä–∞–±–æ—á–∏–π —Ä–∞—Å—Ç–≤–æ—Ä).
- –¢—É–º–∞–Ω: –∏ –æ—Ä–æ—à–µ–Ω–∏–µ, –∏ –≤–Ω–µ—Å–µ–Ω–∏–µ –°–ó–† (–µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—É—Ä, —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã/—Ä–µ—Ü–µ–ø—Ç—ã).
- **1 —Å–∏—Å—Ç–µ–º–∞ –¥–æ—Å–≤–µ—á–∏–≤–∞–Ω–∏—è** –Ω–∞ –∑–æ–Ω—É.
- **–ö–ª–∏–º–∞—Ç (–≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è/–ø—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–Ω–∏–µ/–ø–æ–¥–æ–≥—Ä–µ–≤)** ‚Äî **–æ–±—â–∏–π –Ω–∞ —Ç–µ–ø–ª–∏—Ü—É**.

### 1.2. –°–µ–Ω—Å–æ—Ä—ã
- –í –∑–æ–Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è —Å–µ–Ω—Å–æ—Ä—ã T/RH/CO‚ÇÇ –∏ —Ç.–¥.
- –í —Ç–µ–ø–ª–∏—Ü–µ —Ç–∞–∫–∂–µ –µ—Å—Ç—å —Å–µ–Ω—Å–æ—Ä—ã –≤–Ω—É—Ç—Ä–∏ –∏ —Å–Ω–∞—Ä—É–∂–∏ + –¥–∞—Ç—á–∏–∫ –≤–µ—Ç—Ä–∞ —Å–Ω–∞—Ä—É–∂–∏.

### 1.3. –ù–æ–¥—ã –∏ –∑–Ω–∞–Ω–∏—è
- **1 –Ω–æ–¥–∞ = 1 –∑–æ–Ω–∞** (—Ü–µ–ª–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø).
- –ù–æ–¥—ã –∑–Ω–∞—é—Ç **—Ç–æ–ª—å–∫–æ** `{greenhouse_id/uid, zone_id/uid}`. –í—Å—è –ª–æ–≥–∏–∫–∞/—Ä–µ—Ü–µ–ø—Ç—ã/—Ü–∏–∫–ª—ã ‚Äî –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 1.4. –¶–∏–∫–ª—ã
- **1 –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª –Ω–∞ –∑–æ–Ω—É**.
- –¶–∏–∫–ª **–∂—ë—Å—Ç–∫–æ —Å–≤—è–∑–∞–Ω** —Å –æ–¥–Ω–∏–º —Ä–∞—Å—Ç–µ–Ω–∏–µ–º.
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: –ø–æ –≤—Ä–µ–º–µ–Ω–∏ + —Ä—É—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ (–∞–≥—Ä–æ–Ω–æ–º).
- –¢–µ–∫—É—â–∞—è —Ñ–∞–∑–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î.
- –†–µ—Ü–µ–ø—Ç –º–æ–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äú–Ω–∞ –ª–µ—Ç—É‚Äù.
- –£–ø—Ä–∞–≤–ª—è—Ç—å —Ü–∏–∫–ª–∞–º–∏ –º–æ–∂–µ—Ç **—Ç–æ–ª—å–∫–æ –∞–≥—Ä–æ–Ω–æ–º**.
- –î–æ–ø—É—Å–∫–∞—é—Ç—Å—è **–≤–Ω–µ—Ü–∏–∫–ª–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã**.
- –ö–æ–º–∞–Ω–¥–∞: **–¥–≤—É—Ö—Ñ–∞–∑–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

## 2) –ö–æ—Ä–æ—Ç–∫–∏–π –∞—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é ref_front)
–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã/–Ω–µ—Å–æ—Å—Ç—ã–∫–æ–≤–∫–∏ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ/–¥–æ–∫–∞—Ö:
1. **–î–≤–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ—Å–∏ –∏—Å—Ç–∏–Ω—ã**:  
   - legacy: `zone_recipe_instances.current_phase_index + recipe_phases.targets(JSONB)`  
   - –Ω–æ–≤–∞—è: `grow_cycles` + `grow_stage_templates/recipe_stage_maps`  
   –ü—Ä–∏ —ç—Ç–æ–º Python‚Äë—Å–µ—Ä–≤–∏—Å—ã (automation‚Äëengine, scheduler) –≤—Å—ë –µ—â—ë –º–∞—Å—Å–æ–≤–æ —á–∏—Ç–∞—é—Ç legacy‚Äë—Ç–∞–±–ª–∏—Ü—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç targets –∏–∑ JSON.
2. `grow_cycles` —Å–µ–π—á–∞—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ `zone_recipe_instance_id` –∏ ‚Äúfallback targets –∏–∑ —Ñ–∞–∑—ã‚Äù, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ü–∏–∫–ª –Ω–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–º.
3. `recipe_phases.targets` = JSONB ‚Üí —Å–ª–∞–±–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä—É–¥–Ω—ã–π UI, –Ω–µ—Ç —Å—Ç—Ä–æ–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–∏–Ω–¥–µ–∫—Å–æ–≤.
4. –ù–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π **–≤–µ—Ä—Å–∏–∏/—Ä–µ–≤–∏–∑–∏–π —Ä–µ—Ü–µ–ø—Ç–æ–≤**, –∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞—é—Ç `edit current` vs `clone new`.
5. –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–º–∞—Ç–∞ ‚Äú–æ–±—â–µ–≥–æ –Ω–∞ —Ç–µ–ø–ª–∏—Ü—É‚Äù –≤ –ë–î/–ø—Ä–∏–≤—è–∑–∫–∞—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–æ —Å–ª–∞–±–æ (–≤ –æ—Å–Ω–æ–≤–Ω–æ–º –≤—Å—ë zone‚Äëscoped).
6. –ï—Å—Ç—å ‚Äú–∞—Ä—Ö–∏–≤–Ω—ã–µ‚Äù —Ç–∞–±–ª–∏—Ü—ã/–¥—É–±–ª–∏ –≤ —Å–ª–æ—è—Ö —Ö—Ä–∞–Ω–µ–Ω–∏—è; retention/partitioning —á–∞—Å—Ç–∏—á–Ω–æ —É–∂–µ –≤–Ω–µ–¥—Ä–µ–Ω—ã, –Ω–æ —Ö–≤–æ—Å—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è.

## 3) –¶–µ–ª–µ–≤–∞—è –¥–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å (–Ω–æ–≤–∞—è, –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è)
### 3.1. ERD (–≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π)
- `greenhouses` 1‚ÄîN `zones`
- `zones` 1‚Äî1 `grow_cycles` (active) / 1‚ÄîN (history)
- `plants` 1‚ÄîN `recipes` (—á–µ—Ä–µ–∑ pivot `plant_recipe` –∏–ª–∏ –ø—Ä—è–º—É—é FK ‚Äî –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –∏ –∑–∞–∫—Ä–µ–ø–∏—Ç—å)
- `recipes` 1‚ÄîN `recipe_revisions`
- `recipe_revisions` 1‚ÄîN `recipe_revision_phases` 1‚ÄîN `recipe_revision_phase_steps`
- `grow_cycles` ‚Üí `recipe_revisions` (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–≤–∏–∑–∏—è, —á—Ç–æ–±—ã –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª –Ω–µ ‚Äú–ø–ª—ã–ª‚Äù)
- `grow_cycles` —Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É/—à–∞–≥ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏, overrides –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- `nodes` –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç `greenhouse`, (–æ–±—ã—á–Ω–æ) –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `zone`; 1 –∑–æ–Ω–∞ = 1 node (enforced)
- `infrastructure_instances` (–ø–æ–ª–∏–º–æ—Ä—Ñ–Ω—ã–π owner: zone|greenhouse) + `channel_bindings`
- `telemetry_*`, `commands`, `zone_events`, `alerts` –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ ‚Äú–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —à–∏–Ω–∞‚Äù, –Ω–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–¥ –Ω–æ–≤—ã–µ entity_type/type

### 3.2. –ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø: ‚Äú—Ü–µ–Ω—Ç—Ä –∏—Å—Ç–∏–Ω—ã‚Äù = GrowCycle
- Python‚Äë–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤—ã—á–∏—Å–ª—è—é—Ç —Ü–µ–ª–∏ **–Ω–µ –∏–∑ –∑–æ–Ω—ã**, –∞ –∏–∑:  
  `active_grow_cycle` ‚Üí `current_phase` ‚Üí `effective targets` (phase setpoints + overrides)
- –£ –∑–æ–Ω—ã –æ—Å—Ç–∞—é—Ç—Å—è: –ø—Ä–æ—Ñ–∏–ª—å –∂–µ–ª–µ–∑–∞/–∫–æ–Ω—Ç—É—Ä–æ–≤, capabilities, water_state, –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤.

## 4) –ü–ª–∞–Ω —Ä–∞–±–æ—Ç (–æ–¥–∏–Ω –º–µ–≥–∞‚Äë—Ç–∏–∫–µ—Ç, —Ä–∞–∑–±–∏—Ç—ã–π –Ω–∞ —ç—Ç–∞–ø—ã)
–ù–∏–∂–µ ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è‚Äë–ò–ò (–∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã), –±–µ–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

### ‚úÖ –≠—Ç–∞–ø 0. "–ó–∞–º–æ—Ä–æ–∑–∫–∞" –±–∞–∑–∏—Å–∞ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≤–µ—Ç–∫–∏
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É `refactor/grow-cycle-centric`.
2. ‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç—É—Ä:
   - `php artisan test` (—á—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç/–ø–∞–¥–∞–µ—Ç)
   - `pytest` –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º
   - e2e (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. ‚úÖ –í–≤–µ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ: –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –ø–æ–¥ `migrate:fresh` (—Ç.–∫. backward compat –Ω–µ –Ω—É–∂–Ω–∞).

‚úÖ Acceptance:
- –í–µ—Ç–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è, Docker –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è, –µ—Å—Ç—å –±–∞–∑–æ–≤—ã–π smoke‚Äëtest.

---

### ‚úÖ –≠—Ç–∞–ø 1. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å—Ö–µ–º—ã –ë–î –ø–æ–¥ –Ω–æ–≤—É—é –¥–æ–º–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
#### ‚úÖ 1.1. –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã/–ø–æ–ª—è (–º–∏–≥—Ä–∞—Ü–∏–∏ Laravel)
–°–¥–µ–ª–∞—Ç—å **–Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä –º–∏–≥—Ä–∞—Ü–∏–π** (–∏–ª–∏ 1 "mega migration" + –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ), –∫–æ—Ç–æ—Ä—ã–π:
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç:
  - ‚úÖ `recipe_revisions`
  - ‚úÖ `recipe_revision_phases` (targets "–ø–æ –∫–æ–ª–æ–Ω–∫–∞–º", JSON –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π)
  - ‚úÖ `recipe_revision_phase_steps` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - ‚úÖ `grow_cycle_overrides` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ª–∏–±–æ —Ç–∞–±–ª–∏—Ü–∞, –ª–∏–±–æ jsonb –≤ grow_cycles, –Ω–æ —Ç–∞–±–ª–∏—Ü–∞ –ª—É—á—à–µ –¥–ª—è –∞—É–¥–∏—Ç–∞)
  - ‚úÖ `grow_cycle_transitions`
- ‚úÖ –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç `grow_cycles`:
  - ‚úÖ —É–¥–∞–ª–∏—Ç—å `zone_recipe_instance_id`
  - ‚úÖ –¥–æ–±–∞–≤–∏—Ç—å `recipe_revision_id` (NOT NULL)
  - ‚úÖ –¥–æ–±–∞–≤–∏—Ç—å `current_phase_id` (FK ‚Üí recipe_revision_phases.id) –∏ `current_step_id` (FK nullable)
  - ‚úÖ –¥–æ–±–∞–≤–∏—Ç—å `phase_started_at`, `step_started_at`, `planting_at` (–µ—Å–ª–∏ –Ω–µ—Ç) –∏ `progress_meta jsonb` (–¥–ª—è temp/light –∫–æ—Ä—Ä–µ–∫—Ü–∏–π)
- ‚úÖ –ü–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
  - ‚úÖ –∑–∞–º–µ–Ω–∏—Ç—å `zone_infrastructure` + `infrastructure_assets` –Ω–∞ –µ–¥–∏–Ω—ã–π `infrastructure_instances`:
    - ‚úÖ `owner_type` ENUM('zone','greenhouse')
    - ‚úÖ `owner_id`
    - ‚úÖ `asset_type` (PUMP/MISTER/TANK_CLEAN/TANK_WORKING/LIGHT/VENT/HEATER/‚Ä¶)
    - ‚úÖ `label`, `specs`, `required`
  - ‚úÖ –∑–∞–º–µ–Ω–∏—Ç—å `zone_channel_bindings` –Ω–∞ `channel_bindings` (owner‚Äëagnostic):
    - ‚úÖ `infrastructure_instance_id`
    - ‚úÖ `node_id`
    - ‚úÖ `channel`
    - ‚úÖ `direction`, `role`
- ‚è≥ Enforce "1 node = 1 zone":
  - ‚è≥ —á–∞—Å—Ç–∏—á–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å: `nodes(zone_id) WHERE zone_id IS NOT NULL` (–∏–ª–∏ `unique` + –¥–æ–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è —á—Ç–æ —Ç–æ–ª—å–∫–æ 1 node –±—É–¥–µ—Ç –∏–º–µ—Ç—å zone_id).

#### ‚úÖ 1.2. –î—Ä–æ–ø legacy —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–ª–æ–Ω–æ–∫
‚úÖ –£–¥–∞–ª–∏—Ç—å –∏–∑ —Å—Ö–µ–º—ã (–∏ –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å –∫–æ–¥/–º–æ–¥–µ–ª–∏):
- ‚úÖ `zone_recipe_instances`
- ‚úÖ `recipe_phases` (legacy JSON targets)
- ‚úÖ `zone_cycles`
- ‚úÖ `plant_cycles` (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ü–∏–∫–ª–∞)
- ‚úÖ `commands_archive`, `zone_events_archive` (–∏ –ª—é–±—ã–µ *_archive –≥–¥–µ —ç—Ç–æ "–¥—É–±–ª–∏")
- ‚úÖ `recipe_stage_maps` ‚Äî —É–¥–∞–ª–µ–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç –ë)

#### ‚úÖ 1.3. Stage templates (UI)
‚úÖ –û—Å—Ç–∞–≤–∏—Ç—å `grow_stage_templates` –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ UI.  
‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç –ë: –≤ `recipe_revision_phases` –¥–æ–±–∞–≤–ª–µ–Ω `stage_template_id`

#### ‚úÖ 1.4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞:
  - ‚úÖ partial unique index –Ω–∞ `grow_cycles(zone_id)` WHERE `status IN ('RUNNING','PAUSED')`
  - ‚è≥ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å 1 PLANNED (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
- ‚úÖ –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–∑:
  - ‚úÖ `unique(recipe_revision_id, phase_index)`.

‚úÖ Acceptance:
- ‚úÖ `php artisan migrate:fresh` –ø—Ä–æ—Ö–æ–¥–∏—Ç.
- ‚úÖ –°—Ö–µ–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏, legacy —Ç–∞–±–ª–∏—Ü –Ω–µ—Ç.

---

### ‚úÖ –≠—Ç–∞–ø 2. Laravel Backend: –º–æ–¥–µ–ª–∏, —Å–µ—Ä–≤–∏—Å—ã, API, —Å–æ–±—ã—Ç–∏—è
#### ‚úÖ 2.1. Eloquent –º–æ–¥–µ–ª–∏ –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
‚úÖ –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å:
- ‚úÖ `Recipe`, `RecipeRevision`, `RecipeRevisionPhase`, `RecipeRevisionPhaseStep`
- ‚úÖ `GrowCycle` (—Ü–µ–Ω—Ç—Ä –∏—Å—Ç–∏–Ω—ã), `GrowCycleTransition`, `GrowCycleOverride`
- ‚úÖ `InfrastructureInstance`, `ChannelBinding`
- ‚úÖ —É–¥–∞–ª–∏—Ç—å `ZoneRecipeInstance`, `PlantCycle`, `ZoneCycle`

‚úÖ Acceptance:
- ‚úÖ Tinker: `Zone::with('activeGrowCycle.currentPhase')` —Ä–∞–±–æ—Ç–∞–µ—Ç.

#### ‚úÖ 2.2. "Effective targets" ‚Äî –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è Python
‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä `EffectiveTargetsService`) –∫–æ—Ç–æ—Ä—ã–π –ø–æ `grow_cycle_id` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
- ‚úÖ `phase_targets` (–∫–æ–ª–æ–Ω–∫–∏)
- ‚úÖ `overrides` (—Ç–∞–±–ª–∏—á–Ω—ã–µ + computed)
- ‚úÖ `effective` (—Å–ª–∏—è–Ω–∏–µ)
- ‚úÖ meta: `phase_id`, `phase_name`, `phase_due_at`, `progress_model`

‚úÖ –°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç JSON:
```json
{
  "cycle_id": 123,
  "zone_id": 5,
  "phase": { "id": 77, "code": "VEG", "started_at": "...", "due_at": "..." },
  "targets": {
    "ph": {"target": 5.8, "min": 5.6, "max": 6.0},
    "ec": {"target": 1.6, "min": 1.4, "max": 1.8},
    "irrigation": {...},
    "mist": {...},
    "lighting": {...},
    "climate_request": {...}
  }
}
```

#### ‚úÖ 2.3. API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–ø–µ—Ä–µ–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
‚úÖ –°–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏ —É–¥–∞–ª–∏—Ç—å legacy:

**–¶–∏–∫–ª—ã**
- ‚úÖ `GET /api/zones/{zone}/grow-cycle` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç active cycle + effective targets + –ø—Ä–æ–≥—Ä–µ—Å—Å
- ‚úÖ `POST /api/zones/{zone}/grow-cycles` ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª (–∞–≥—Ä–æ–Ω–æ–º)
- ‚úÖ `POST /api/grow-cycles/{id}/pause|resume|harvest|abort`
- ‚úÖ `POST /api/grow-cycles/{id}/set-phase` (manual, —Å comment)
- ‚úÖ `POST /api/grow-cycles/{id}/advance-phase` (next)
- ‚úÖ `POST /api/grow-cycles/{id}/change-recipe-revision` (apply now / at next phase)

**–†–µ—Ü–µ–ø—Ç—ã/—Ä–µ–≤–∏–∑–∏–∏**
- ‚è≥ `POST /api/recipes` / `PATCH /api/recipes/{id}` (–±–∞–∑–æ–≤—ã–µ CRUD, –Ω–µ –≤—Ö–æ–¥–∏–ª–∏ –≤ –≠—Ç–∞–ø 2)
- ‚úÖ `POST /api/recipes/{id}/revisions` (clone from revision_id)
- ‚úÖ `PATCH /api/recipe-revisions/{rev}` (edit draft)
- ‚úÖ `POST /api/recipe-revisions/{rev}/publish` (lock)
- ‚úÖ `GET /api/recipe-revisions/{rev}` (full with phases)

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
- ‚úÖ CRUD –¥–ª—è `infrastructure_instances` –∏ `channel_bindings`
- ‚úÖ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª "–∫–ª–∏–º–∞—Ç —Ç–µ–ø–ª–∏—Ü—ã" (greenhouse owner)

‚úÖ –£–¥–∞–ª–∏—Ç—å:
- ‚úÖ `/attach-recipe`, `/zone_recipe_instances/*`, –ª—é–±—ã–µ endpoints –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç targets –≤ JSON –Ω–∞–ø—Ä—è–º—É—é.

#### ‚úÖ 2.4. –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –¢–æ–ª—å–∫–æ —Ä–æ–ª—å/permission "agronomist":
  - ‚úÖ create/stop cycle
  - ‚úÖ edit recipes & publish
  - ‚úÖ manual phase switch
- ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ: read‚Äëonly + manual –≤–Ω–µ—Ü–∏–∫–ª–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (–ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã Policy: `GrowCyclePolicy`, `RecipeRevisionPolicy`
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –ø—Ä–∞–≤ —á–µ—Ä–µ–∑ `Gate::allows()`

#### 2.5. –°–æ–±—ã—Ç–∏—è –∏ –ª–æ–≥–∏
- –í—Å–µ transition‚Äô—ã —Ü–∏–∫–ª–∞ –ø–∏—Å–∞—Ç—å –≤:
  - `grow_cycle_transitions`
  - `zone_events` (entity_type='grow_cycle', type='CYCLE_*')
- WebSocket broadcast: `GrowCycleUpdated` —Ä–∞—Å—à–∏—Ä–∏—Ç—å payload (phase, targets summary).

Acceptance:
- Backend API –æ—Ç–¥–∞—ë—Ç active cycle –∏ effective targets.
- Legacy –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã/–º–∞—Ä—à—Ä—É—Ç—ã —É–¥–∞–ª–µ–Ω—ã, —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç.

---

### –≠—Ç–∞–ø 3. Python services: automation-engine, scheduler, history-logger, digital-twin
#### 3.1. –£–¥–∞–ª–∏—Ç—å —á—Ç–µ–Ω–∏–µ legacy —Ç–∞–±–ª–∏—Ü
–í–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö:
- –∑–∞–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã `zone_recipe_instances + recipe_phases` –Ω–∞:
  - `grow_cycles` + `recipe_revisions` + `recipe_revision_phases` (+ overrides)
  - –∏–ª–∏ –Ω–∞ –≤—ã–∑–æ–≤ Laravel endpoint ‚Äúeffective targets‚Äù (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –ª–æ–≥–∏–∫–∞ —Å–ª–∏—è–Ω–∏—è –±—ã–ª–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ)

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:  
- –í automation-engine: **batch‚Äëendpoint** –≤ Laravel:
  - `POST /api/internal/effective-targets/batch` —Å `zone_ids[]` ‚Üí –≤–µ—Ä–Ω—É—Ç—å targets –ø–æ –∑–æ–Ω–∞–º.

#### 3.2. Phase Progress Engine (–∞–≤—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å —Ñ–∞–∑)
–í–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:
- `TIME` (–ø–æ duration)
- `TIME_WITH_TEMP_CORRECTION` (–ø—Ä–æ—Å—Ç–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ avg temp)
- `GDD` (–≥—Ä–∞–¥—É—Å–æ‚Äë–¥–Ω–∏) –∏/–∏–ª–∏ `DLI` (–ø–æ–∑–∂–µ)

MVP —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- —Ö—Ä–∞–Ω–∏—Ç—å –≤ `grow_cycles.progress_meta`:
  - `temp_avg_24h`, `light_dli_24h`, `speed_factor`, `computed_due_at`
- –∞–≤—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ `computed_due_at`, –Ω–æ **–≤–æ–∑–º–æ–∂–Ω–∞ —Ä—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è**.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞:
- –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ –ª–æ–º–∞–µ—Ç)
- –∑–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫ (advisory lock –Ω–∞ `grow_cycle_id`)

#### 3.3. Scheduler
- `get_active_schedules()` ‚Üí –±—Ä–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ effective targets (irrigation/lighting/mist).
- –ö–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –ø—É—Ç—å (–∫–∞–∫ —Å–µ–π—á–∞—Å —á–µ—Ä–µ–∑ automation-engine), –Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
  - `cycle_id` (–µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤ —Ä–∞–º–∫–∞—Ö —Ü–∏–∫–ª–∞)
  - `source = cycle|manual|system`

#### 3.4. –î–≤—É—Ö—Ñ–∞–∑–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
  - `command.request_id` (uuid)
  - —Ç–æ–ø–∏–∫–∏ ACK –∏ RESULT (–∏–ª–∏ –æ–¥–∏–Ω status —Å state)
- history-logger:
  - –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ ACK ‚Üí `commands.ack_at`, `status='ACK'`
  - –ø—Ä–∏ RESULT ‚Üí `executed_at`, `status='DONE'|'ERROR'`, –∑–∞–ø–æ–ª–Ω–∏—Ç—å error_code/message, duration_ms
- automation-engine:
  - –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äú–æ–∂–∏–¥–∞—Ç—å‚Äù –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –¥–µ–ª–∞—Ç—å polling –ø–æ commands (–Ω–æ –ª—É—á—à–µ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å control loop)

#### 3.5. Digital Twin
- –ò–∑–º–µ–Ω–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã: twin —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–æ–Ω—ã –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å:
  - active cycle + phase + effective targets
  - last telemetry
  - last commands status

Acceptance:
- automation-engine –∏ scheduler —Å—Ç–∞—Ä—Ç—É—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫.
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ `zone_recipe_instances`/`recipe_phases`.

---

### –≠—Ç–∞–ø 4. Frontend (Inertia/Vue): –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ UI/UX –∫ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏
#### 4.1. –¶–µ–Ω—Ç—Ä —Ü–∏–∫–ª–æ–≤ (Cycles/Center.vue)
- –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å:
  - —Å–ø–∏—Å–æ–∫ –∑–æ–Ω
  - –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª (plant, recipe revision, phase, progress)
  - –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (pause/resume, manual phase switch, harvest)
- –¢–∞–π–º–ª–∞–π–Ω —Ñ–∞–∑: —Å—Ç—Ä–æ–∏—Ç—å –ø–æ `recipe_revision_phases` (stage_template_id –∫–∞–∫ UI‚Äë–ª–µ–π–±–ª).

#### 4.2. –ú–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è —Ü–∏–∫–ª–∞ (GrowCycles/Wizard.vue)
- –°—Ü–µ–Ω–∞—Ä–∏–π:
  1) –≤—ã–±—Ä–∞—Ç—å –∑–æ–Ω—É
  2) –≤—ã–±—Ä–∞—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ
  3) –≤—ã–±—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç ‚Üí –≤—ã–±—Ä–∞—Ç—å —Ä–µ–≤–∏–∑–∏—é (published)
  4) –ø–æ—Å–∞–¥–∫–∞/—Å—Ç–∞—Ä—Ç, batch_label, –∑–∞–º–µ—Ç–∫–∏
  5) –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Äú–≤ –∑–æ–Ω–µ –±—É–¥–µ—Ç 1 –∞–∫—Ç–∏–≤–Ω—ã–π —Ü–∏–∫–ª‚Äù
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è: —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ –¶–µ–Ω—Ç—Ä —Ü–∏–∫–ª–æ–≤.

#### 4.3. –†–µ–¥–∞–∫—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–æ–≤ —Å —Ä–µ–≤–∏–∑–∏—è–º–∏
- –°–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –ø–æ —Ä–∞—Å—Ç–µ–Ω–∏—é
- –î–ª—è —Ä–µ—Ü–µ–ø—Ç–∞: –≤–∫–ª–∞–¥–∫–∞ ‚Äú–†–µ–≤–∏–∑–∏–∏‚Äù:
  - Draft —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è
  - Published readonly
  - ‚Äú–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –Ω–∞ –æ—Å–Ω–æ–≤–µ‚Äù (clone)
  - ‚Äú–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å‚Äù (lock)
- –†–µ–¥–∞–∫—Ç–æ—Ä —Ñ–∞–∑:
  - ph/ec/irrigation ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  - –æ—Å—Ç–∞–ª—å–Ω–æ–µ optional
  - —à–∞–≥–∏ (optional): —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–¥—à–∞–≥–æ–≤ —Å offset –∏ action/task

#### 4.4. –£–¥–∞–ª–µ–Ω–∏–µ legacy UI
- —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `zone_recipe_instances`/`recipe_phases.targets`
- –æ–±–Ω–æ–≤–∏—Ç—å composables/api clients

#### 4.5. –†—É—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- Manual switch phase: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π comment.
- Change recipe on the fly:
  - –ª–∏–±–æ ‚Äú–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–≤–∏–∑–∏—é —Å–µ–π—á–∞—Å‚Äù (–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∞–∑—É –ø–æ mapping)
  - –ª–∏–±–æ ‚Äú—Å —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑—ã‚Äù.

Acceptance:
- UI –Ω–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ legacy API.
- –°–æ–∑–¥–∞–Ω–∏–µ/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç end‚Äëto‚Äëend.

---

### –≠—Ç–∞–ø 5. –û—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è, retention/partitioning, —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π
1. –£–¥–∞–ª–∏—Ç—å ‚Äú–∞—Ä—Ö–∏–≤–Ω—ã–µ‚Äù —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ç—É–¥–∞ –ø–∏—à–µ—Ç.
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Timescale retention policies:
   - telemetry_samples (90d) —É–∂–µ –µ—Å—Ç—å ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å/—Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–º
   - –∞–≥—Ä–µ–≥–∞—Ç—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è (–∏–Ω–∞—á–µ —É–¥–∞–ª–∏—Ç—å)
3. –î–ª—è `commands` –∏ `zone_events`:
   - –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (Postgres native partitions) **–∏–ª–∏** Timescale hypertable, –µ—Å–ª–∏ –æ–±—ä—ë–º—ã –±–æ–ª—å—à–∏–µ
   - policy retention (–Ω–∞–ø—Ä–∏–º–µ—Ä 365 –¥–Ω–µ–π) + –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ‚Äú—Å–≤–æ–¥–∫–∏‚Äù –¥–ª—è UI

Acceptance:
- –ù–µ—Ç –¥—É–±–ª–µ–π —Ç–∞–±–ª–∏—Ü.
- Retention —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏, –∞ –Ω–µ ‚Äú—Ä—É—á–Ω—ã–º–∏‚Äù archive‚Äë—Ç–∞–±–ª–∏—Ü–∞–º–∏.

---

### –≠—Ç–∞–ø 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è
1. Backend:
   - Feature tests: —Å–æ–∑–¥–∞–Ω–∏–µ —Ü–∏–∫–ª–∞, pause/resume, manual phase switch, change recipe revision, –ø—Ä–∞–≤–∞ –∞–≥—Ä–æ–Ω–æ–º–∞
   - Contract tests: effective targets shape
2. Python:
   - pytest: batch fetch targets, phase progression idempotency, command ack flow
3. E2E:
   - —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äú—Å–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç‚Üí—Ä–µ–≤–∏–∑–∏—é‚Üí—Ü–∏–∫–ª‚Üí–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ñ–∞–∑—É‚Üí–∑–∞–≤–µ—Ä—à–∏—Ç—å‚Äù

Acceptance:
- CI –∑–µ–ª—ë–Ω—ã–π.
- –ù–µ—Ç ‚Äú—Å–∫—Ä—ã—Ç—ã—Ö‚Äù –ø—É—Ç–µ–π, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö legacy —Å—É—â–Ω–æ—Å—Ç–∏.

---

### –≠—Ç–∞–ø 7. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å, –∏–Ω–∞—á–µ —Å–∏—Å—Ç–µ–º–∞ –æ–ø—è—Ç—å —Ä–∞—Å–ø–æ–ª–∑—ë—Ç—Å—è)
–û–±–Ω–æ–≤–∏—Ç—å –≤ `doc_ai` –º–∏–Ω–∏–º—É–º:
- `LOGIC_ARCH.md` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å GrowCycle –∫–∞–∫ —Ü–µ–Ω—Ç—Ä –∏—Å—Ç–∏–Ω—ã, —É–±—Ä–∞—Ç—å zone_recipe_instances
- `DATA_MODEL_REFERENCE.md` ‚Äî –Ω–æ–≤–∞—è —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü, —É–¥–∞–ª–∏—Ç—å legacy
- `RECIPE_ENGINE_FULL.md` + `HYDROPONIC_RECIPES_ENGINE.md` ‚Äî —Ä–µ–≤–∏–∑–∏–∏, —Ñ–∞–∑—ã –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º, —à–∞–≥–∏
- `FRONTEND_ARCH_FULL.md` ‚Äî –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã/–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
- `PYTHON_SERVICES_ARCH.md` ‚Äî –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ targets, batch endpoints
- –î–æ–±–∞–≤–∏—Ç—å ‚ÄúRFC‚Äù —Ñ–∞–π–ª: `doc_ai/00_RFC/GROW_CYCLE_CENTRIC_ARCH.md` —Å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏

Acceptance:
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞ —Å –∫–æ–¥–æ–º, –Ω–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π.

## 5) –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è `recipe_revision_phases`
–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (MVP):
- `ph_target`, `ph_min`, `ph_max`
- `ec_target`, `ec_min`, `ec_max`
- `irrigation_mode` ENUM('SUBSTRATE','RECIRC')
- `irrigation_interval_sec`, `irrigation_duration_sec`

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
- `lighting_photoperiod_hours`, `lighting_start_time`
- `mist_interval_sec`, `mist_duration_sec`, `mist_mode` (NORMAL|SPRAY)
- `temp_air_target`, `humidity_target`, `co2_target` (–∫–∞–∫ ‚Äú–∑–∞–ø—Ä–æ—Å –∑–æ–Ω—ã‚Äù –∫ –∫–ª–∏–º–∞—Ç—É —Ç–µ–ø–ª–∏—Ü—ã)
- `progress_model`, `duration_hours|days`, `base_temp_c`, `target_gdd`, `dli_target`

## 6) –°–ø–∏—Å–æ–∫ ‚Äú—á—Ç–æ —Ç–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ–¥–∞‚Äù (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π)
- –í—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è:
  - `zone_recipe_instances`
  - `recipe_phases.targets`
  - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã/—Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äúattach recipe to zone‚Äù
  - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ Python: `recipe_utils.py` –≤ legacy –≤–∞—Ä–∏–∞–Ω—Ç–µ, SQL JOIN –Ω–∞ zone_recipe_instances
- –¢–∞–±–ª–∏—Ü—ã/–º–æ–¥–µ–ª–∏:
  - `PlantCycle`, `ZoneCycle`, `ZoneRecipeInstance`
- –°—Ç–∞—Ä—ã–µ –¥–æ–∫–∏, –∑–∞–ø—Ä–µ—â–∞—é—â–∏–µ breaking changes (—Ç–µ–ø–µ—Ä—å breaking changes —Ä–∞–∑—Ä–µ—à–µ–Ω—ã, –Ω–æ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è RFC)

MD