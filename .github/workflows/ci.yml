name: ci

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:2.13.0-pg15
        env:
          POSTGRES_DB: hydro_test
          POSTGRES_USER: hydro
          POSTGRES_PASSWORD: hydro
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U hydro -d hydro_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    defaults:
      run:
        working-directory: backend/laravel
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/laravel/package-lock.json
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('backend/laravel/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-
      - name: Install PHP deps
        run: composer install --no-interaction --prefer-dist
      - name: Composer audit (security)
        continue-on-error: true
        run: composer audit --no-interaction || true
      - name: Prepare env
        run: |
          cp .env.example .env
          php artisan key:generate
          php -r "
            \$file = '.env';
            \$env = file_get_contents(\$file);
            // Используем in-memory cache в CI, чтобы не требовать таблицу cache
            if (preg_match('/^CACHE_STORE=.*/m', \$env)) {
              \$env = preg_replace('/^CACHE_STORE=.*/m', 'CACHE_STORE=array', \$env);
            } else {
              \$env .= PHP_EOL.'CACHE_STORE=array';
            }
            // Устанавливаем/обновляем параметры БД независимо от начальных значений
            \$env = preg_replace('/^DB_CONNECTION=.*/m', 'DB_CONNECTION=pgsql', \$env);
            if (preg_match('/^DB_DATABASE=.*/m', \$env)) {
              \$env = preg_replace('/^DB_DATABASE=.*/m', 'DB_DATABASE=hydro_test', \$env);
            } else {
              \$env .= PHP_EOL.'DB_DATABASE=hydro_test';
            }
            if (preg_match('/^DB_USERNAME=.*/m', \$env)) {
              \$env = preg_replace('/^DB_USERNAME=.*/m', 'DB_USERNAME=hydro', \$env);
            } else {
              \$env .= PHP_EOL.'DB_USERNAME=hydro';
            }
            if (preg_match('/^DB_PASSWORD=.*/m', \$env)) {
              \$env = preg_replace('/^DB_PASSWORD=.*/m', 'DB_PASSWORD=hydro', \$env);
            } else {
              \$env .= PHP_EOL.'DB_PASSWORD=hydro';
            }
            if (preg_match('/^DB_HOST=.*/m', \$env)) {
              \$env = preg_replace('/^DB_HOST=.*/m', 'DB_HOST=127.0.0.1', \$env);
            } else {
              \$env .= PHP_EOL.'DB_HOST=127.0.0.1';
            }
            if (preg_match('/^DB_PORT=.*/m', \$env)) {
              \$env = preg_replace('/^DB_PORT=.*/m', 'DB_PORT=5432', \$env);
            } else {
              \$env .= PHP_EOL.'DB_PORT=5432';
            }
            file_put_contents(\$file, \$env);
          "
      - name: Install Node deps
        run: npm install
      - name: Build (Vite manifest)
        run: npm run build
      - name: PHP configs cache
        run: |
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
      - name: PHP tests (phpunit via artisan)
        env:
          APP_ENV: testing
          DB_CONNECTION: pgsql
          DB_DATABASE: hydro_test
          DB_USERNAME: hydro
          DB_PASSWORD: hydro
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          BROADCAST_CONNECTION: log
          BROADCAST_DRIVER: log
          CACHE_STORE: array
          SESSION_DRIVER: array
          QUEUE_CONNECTION: sync
        run: |
          mkdir -p test-results
          php artisan test --testsuite=Unit,Feature --no-coverage --log-junit test-results/phpunit.xml
      - name: Upload PHPUnit JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-junit
          path: backend/laravel/test-results/phpunit.xml
          retention-days: 7
      - name: Typecheck (vue-tsc)
        run: npm run typecheck
      - name: Lint (ESLint)
        run: npm run lint
      - name: NPM audit (production)
        continue-on-error: true
        run: npm audit --omit=dev || true
      - name: Unit tests (vitest)
        run: |
          mkdir -p test-results
          npm run test -- --reporter=dot --reporter=junit --outputFile=test-results/junit.xml
      - name: Upload Vitest JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-junit
          path: backend/laravel/test-results/junit.xml
          retention-days: 7
      - name: Coverage (Vitest)
        run: npm run test -- --coverage --reporter=dot
      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-coverage
          path: backend/laravel/coverage
          retention-days: 7
      - name: Install Playwright
        run: npx playwright install --with-deps
      - name: E2E (Playwright)
        env:
          APP_ENV: testing
          DB_CONNECTION: pgsql
          DB_DATABASE: hydro_test
          DB_USERNAME: hydro
          DB_PASSWORD: hydro
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          BROADCAST_CONNECTION: log
          BROADCAST_DRIVER: log
        run: |
          # Trap to cleanup background processes on exit
          cleanup() {
            echo "Cleaning up background processes..."
            # Kill specific processes by PID if they exist
            [ -n "$MIGRATE_PID" ] && kill $MIGRATE_PID 2>/dev/null || true
            [ -n "$SERVE_PID" ] && kill $SERVE_PID 2>/dev/null || true
            # Fallback: kill any matching processes
            pkill -f "php artisan migrate" 2>/dev/null || true
            pkill -f "php artisan serve" 2>/dev/null || true
            # Wait a moment for processes to terminate
            sleep 2
          }
          trap cleanup EXIT INT TERM
          
          # Start background processes
          php artisan migrate --force &
          MIGRATE_PID=$!
          php artisan serve --host=127.0.0.1 --port=8000 --env=testing &
          SERVE_PID=$!
          
          # Wait for migration to complete
          wait $MIGRATE_PID || true
          
          # Wait for server to be ready with health check
          echo "Waiting for server to start..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            if curl -f -s http://127.0.0.1:8000 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $attempt/$max_attempts: Server not ready, waiting..."
            sleep 1
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "ERROR: Server failed to start after $max_attempts attempts"
            exit 1
          fi
          
          # Run Playwright tests (ошибки должны падать в CI)
          npx playwright test --reporter=list,html
          
          # Cleanup will be handled by trap
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: backend/laravel/playwright-report
          retention-days: 7
