name: ci

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: timescale/timescaledb:2.13.0-pg15
        env:
          POSTGRES_DB: hydro_test
          POSTGRES_USER: hydro
          POSTGRES_PASSWORD: hydro
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U hydro -d hydro_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    defaults:
      run:
        working-directory: backend/laravel
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/laravel/package-lock.json
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('backend/laravel/composer.lock') }}
          restore-keys: composer-${{ runner.os }}-
      - name: Install PHP deps
        run: composer install --no-interaction --prefer-dist
      - name: Composer audit (security)
        continue-on-error: true
        run: composer audit --no-interaction || true
      - name: Prepare env
        run: |
          cp .env.example .env
          php artisan key:generate
          php -r "
            \$file = '.env';
            \$env = file_get_contents(\$file);
            // Используем in-memory cache в CI, чтобы не требовать таблицу cache
            if (preg_match('/^CACHE_STORE=.*/m', \$env)) {
              \$env = preg_replace('/^CACHE_STORE=.*/m', 'CACHE_STORE=array', \$env);
            } else {
              \$env .= PHP_EOL.'CACHE_STORE=array';
            }
            // Явно включаем testing окружение для корректной регистрации тестовых маршрутов
            if (preg_match('/^APP_ENV=.*/m', \$env)) {
              \$env = preg_replace('/^APP_ENV=.*/m', 'APP_ENV=testing', \$env);
            } else {
              \$env .= PHP_EOL.'APP_ENV=testing';
            }
            // Сессии для E2E не должны требовать таблицу sessions
            if (preg_match('/^SESSION_DRIVER=.*/m', \$env)) {
              \$env = preg_replace('/^SESSION_DRIVER=.*/m', 'SESSION_DRIVER=file', \$env);
            } else {
              \$env .= PHP_EOL.'SESSION_DRIVER=file';
            }
            // Устанавливаем/обновляем параметры БД независимо от начальных значений
            \$env = preg_replace('/^DB_CONNECTION=.*/m', 'DB_CONNECTION=pgsql', \$env);
            if (preg_match('/^DB_DATABASE=.*/m', \$env)) {
              \$env = preg_replace('/^DB_DATABASE=.*/m', 'DB_DATABASE=hydro_test', \$env);
            } else {
              \$env .= PHP_EOL.'DB_DATABASE=hydro_test';
            }
            if (preg_match('/^DB_USERNAME=.*/m', \$env)) {
              \$env = preg_replace('/^DB_USERNAME=.*/m', 'DB_USERNAME=hydro', \$env);
            } else {
              \$env .= PHP_EOL.'DB_USERNAME=hydro';
            }
            if (preg_match('/^DB_PASSWORD=.*/m', \$env)) {
              \$env = preg_replace('/^DB_PASSWORD=.*/m', 'DB_PASSWORD=hydro', \$env);
            } else {
              \$env .= PHP_EOL.'DB_PASSWORD=hydro';
            }
            if (preg_match('/^DB_HOST=.*/m', \$env)) {
              \$env = preg_replace('/^DB_HOST=.*/m', 'DB_HOST=127.0.0.1', \$env);
            } else {
              \$env .= PHP_EOL.'DB_HOST=127.0.0.1';
            }
            if (preg_match('/^DB_PORT=.*/m', \$env)) {
              \$env = preg_replace('/^DB_PORT=.*/m', 'DB_PORT=5432', \$env);
            } else {
              \$env .= PHP_EOL.'DB_PORT=5432';
            }
            file_put_contents(\$file, \$env);
          "
      - name: Install Node deps
        run: npm install
      - name: File size guard
        run: ./scripts/check-file-size-guard.sh
      - name: Build (Vite manifest)
        run: npm run build
      - name: PHP configs cache
        env:
          APP_ENV: testing
          SESSION_DRIVER: file
          CACHE_STORE: array
          QUEUE_CONNECTION: sync
        run: |
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
      - name: PHP tests (phpunit via artisan)
        env:
          APP_ENV: testing
          DB_CONNECTION: pgsql
          DB_DATABASE: hydro_test
          DB_USERNAME: hydro
          DB_PASSWORD: hydro
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          BROADCAST_CONNECTION: log
          BROADCAST_DRIVER: log
          CACHE_STORE: array
          SESSION_DRIVER: array
          QUEUE_CONNECTION: sync
        run: |
          mkdir -p test-results
          php artisan test --testsuite=Unit,Feature --no-coverage --log-junit test-results/phpunit.xml
      - name: Upload PHPUnit JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-junit
          path: backend/laravel/test-results/phpunit.xml
          retention-days: 7
      - name: Typecheck (vue-tsc)
        run: npm run typecheck
      - name: Lint (ESLint)
        run: npm run lint
      - name: NPM audit (production)
        continue-on-error: true
        run: npm audit --omit=dev || true
      - name: Unit tests (vitest)
        run: |
          mkdir -p test-results
          npm run test -- --reporter=dot --reporter=junit --outputFile=test-results/junit.xml
      - name: Upload Vitest JUnit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-junit
          path: backend/laravel/test-results/junit.xml
          retention-days: 7
      - name: Coverage (Vitest)
        run: npm run test -- --coverage --reporter=dot
      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-coverage
          path: backend/laravel/coverage
          retention-days: 7
      - name: Install Playwright
        run: npx playwright install --with-deps
      - name: E2E (Playwright)
        env:
          APP_ENV: testing
          DB_CONNECTION: pgsql
          DB_DATABASE: hydro_test
          DB_USERNAME: hydro
          DB_PASSWORD: hydro
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          BROADCAST_CONNECTION: log
          BROADCAST_DRIVER: log
          SESSION_DRIVER: file
          CACHE_STORE: array
          QUEUE_CONNECTION: sync
        run: |
          # Trap to cleanup background processes on exit
          cleanup() {
            echo "Cleaning up background processes..."
            # Kill specific processes by PID if they exist
            if [ -n "$MIGRATE_PID" ]; then
              kill "$MIGRATE_PID" 2>/dev/null || true
            fi
            if [ -n "$SERVE_PID" ]; then
              kill "$SERVE_PID" 2>/dev/null || true
            fi
            # Fallback: kill any matching processes
            pkill -f "php artisan migrate" 2>/dev/null || true
            pkill -f "php artisan serve" 2>/dev/null || true
            # Wait a moment for processes to terminate
            sleep 2
          }
          trap cleanup EXIT INT TERM
          
          # Drop Timescale hypertables/views so migrate:fresh doesn't fail on bulk DROP TABLE
          php -r "
            require __DIR__.'/vendor/autoload.php';
            \$app = require __DIR__.'/bootstrap/app.php';
            \$app->make(Illuminate\\Contracts\\Console\\Kernel::class)->bootstrap();
            \$dropHypertables = false;
            try {
              \$exists = Illuminate\\Support\\Facades\\DB::selectOne(\"SELECT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'drop_hypertable') as exists\");
              \$dropHypertables = \$exists && \$exists->exists;
            } catch (Throwable \$e) {
              fwrite(STDERR, '[ci] '.\$e->getMessage().PHP_EOL);
            }
            \$statements = [
              'DROP VIEW IF EXISTS telemetry_raw',
            ];
            if (\$dropHypertables) {
              \$statements = array_merge(\$statements, [
                \"SELECT drop_hypertable('telemetry_samples'::regclass, if_exists => TRUE)\",
                \"SELECT drop_hypertable('telemetry_agg_1m'::regclass, if_exists => TRUE)\",
                \"SELECT drop_hypertable('telemetry_agg_1h'::regclass, if_exists => TRUE)\",
                \"SELECT drop_hypertable('commands'::regclass, if_exists => TRUE)\",
                \"SELECT drop_hypertable('zone_events'::regclass, if_exists => TRUE)\",
              ]);
            }
            foreach (\$statements as \$sql) {
              try {
                Illuminate\\Support\\Facades\\DB::statement(\$sql);
              } catch (Throwable \$e) {
                fwrite(STDERR, '[ci] '.\$e->getMessage().PHP_EOL);
              }
            }
          "

          # Ensure testing env config is active for backdoor routes
          php artisan config:clear
          php artisan cache:clear

          # Start background processes
          php artisan migrate:fresh --force &
          MIGRATE_PID=$!
          php artisan serve --host=127.0.0.1 --port=8000 --env=testing &
          SERVE_PID=$!
          
          # Wait for migration to complete
          if ! wait "$MIGRATE_PID"; then
            echo "ERROR: migrate:fresh failed"
            exit 1
          fi
          MIGRATE_PID=""
          php artisan db:seed --class=AdminUserSeeder --force
          
          # Wait for server to be ready with health check
          echo "Waiting for server to start..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            if curl -f -s http://127.0.0.1:8000 > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $attempt/$max_attempts: Server not ready, waiting..."
            sleep 1
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "ERROR: Server failed to start after $max_attempts attempts"
            exit 1
          fi
          
          # Run Playwright tests (ошибки должны падать в CI)
          npx playwright test --reporter=list,html
          
          # Cleanup will be handled by trap
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: backend/laravel/playwright-report
          retention-days: 7

  scheduler-chaos:
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Docker info
        run: |
          docker --version
          docker compose version
      - name: Run scheduler chaos scripts
        run: |
          mkdir -p test-results/scheduler-chaos
          export CHAOS_LOG_DIR="test-results/scheduler-chaos"

          set +e
          failures=0

          run_chaos() {
            local script="$1"
            echo "[ci][chaos] running ${script}"
            bash "${script}"
            local rc=$?
            if [ "${rc}" -ne 0 ]; then
              echo "[ci][chaos][FAIL] ${script} (exit=${rc})"
              failures=1
            else
              echo "[ci][chaos][PASS] ${script}"
            fi
          }

          run_chaos tests/e2e/scheduler/scheduler_leader_failover_chaos.sh
          run_chaos tests/e2e/scheduler/scheduler_restart_recovery_chaos.sh
          run_chaos tests/e2e/scheduler/automation_engine_restart_recovery_chaos.sh

          exit "${failures}"
      - name: Collect scheduler chaos logs
        if: always()
        run: |
          mkdir -p test-results/scheduler-chaos
          for c in backend-db-1 backend-redis-1 backend-mqtt-1 backend-laravel-1 backend-automation-engine-1 backend-scheduler-1; do
            docker logs "${c}" > "test-results/scheduler-chaos/${c}.log" 2>&1 || true
          done
          docker compose -f backend/docker-compose.dev.yml ps > test-results/scheduler-chaos/compose-ps.log 2>&1 || true
      - name: Upload scheduler chaos logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scheduler-chaos-logs
          path: test-results/scheduler-chaos
          retention-days: 7
      - name: Cleanup scheduler chaos environment
        if: always()
        run: docker compose -f backend/docker-compose.dev.yml down -v || true
