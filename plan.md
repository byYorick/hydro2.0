# План: расширение Digital Twin до полной симуляции боевого контура

## Цели
- Симуляция учитывает PID-контуры: pH, EC, температура (в Automation Engine).
- Команды идут по реальному пайплайну `ESP32 -> MQTT -> Python -> PostgreSQL -> Laravel -> Vue`.
- Сим-нод соответствует контрактам реальной прошивки и обрабатывает все команды.
- Automation Engine работает как в бою, но в режиме симуляции.
- UI показывает прогресс в реальном времени с описанием текущих действий.
- Симуляция поддерживает ускорение времени: пользователь задает длительность (например, 15 минут на весь цикл), коэффициент вычисляется автоматически.

## Ограничения и совместимость
- Обратная совместимость не требуется: единый формат без legacy.
- Команды к нодам только через Python/MQTT слой, не напрямую из Laravel.
- Все слои обновляются синхронно (MQTT -> Python -> PostgreSQL -> Laravel -> Vue).

## Источники истины
- MQTT контракт: `doc_ai/03_TRANSPORT_MQTT/*`
- Рецепты и фазы: `doc_ai/06_DOMAIN_ZONES_RECIPES/*`
- Digital Twin/Sim: `doc_ai/09_AI_AND_DIGITAL_TWIN/*`
- Node-sim стандарт: `tests/node_sim/*`

## Канонический стандарт команд (единый)
- Команда: `{"cmd_id","cmd","params","ts","sig"}`
- `cmd`: `dose` | `run_pump` | `set_relay` | `set_pwm`
- `dose` использует `params.ml`
- `run_pump` использует `params.duration_ms`
- Ответ: `{"cmd_id","status","ts","details"}`
- Статусы: `ACK|DONE|ERROR|INVALID|BUSY|NO_EFFECT`

## Статус выполнения (факт)
- Выполнено: единый формат команд/ответов внедрен в common schemas, history-logger, automation-engine, mqtt-bridge, node-sim.
- Выполнено: статусы команд обновлены в Laravel (модель, ingest, observer, метрики) и фронтенде (команды/WS/tests).
- Выполнено: node-sim поддерживает `dose`/`run_pump` с корректировкой телеметрии и случайными деградациями/офлайном.
- Выполнено: сидеры команд обновлены под новые статусы.
- В работе: обновление common docs/command transitions, e2e runner/assertions, оставшихся документов и тестов.

## Этапы
1. Аудит существующей симуляции и Automation Engine
   - Проверить AE: CorrectionController, PID state/config, CommandBus, порядок контроллеров.
   - Сопоставить команды AE с MQTT контрактом и реальной прошивкой.
   - Выявить несоответствия форматов (AE: `dose` + `dose_ml`, контракт: `DOSE` + `ml`/`run_pump`).
   - Убедиться, что node-sim публикует `command_response` и LWT/heartbeat в точных топиках контракта.
   - Подтвердить, что `tests/node_sim` покрывает нужные команды/ответы.
   - Аудит scheduler: сейчас ориентирован на реальные часы (проверка раз в минуту), нужен sim‑time режим.
   - Аудит node‑sim: нет поддержки `dose`/`DOSE`, нет реакции телеметрии на команды.
   - Аудит history-logger: командные ответы идут в Laravel, LWT/heartbeat важны для алертов — сим‑ноды должны корректно имитировать offline/timeout.
   - Аудит digital-twin: сейчас нет оркестрации сим‑сессии/ускоренного времени и связки с AE/scheduler.
   - Аудит node-sim: failure_mode только статический (delay/drop/duplicate), нет рандомных деградаций и имитации offline (LWT).
   - Аудит схем команд/ответов: `dose`/`DOSE`, `ml` vs `dose_ml`, `cmd_id` в params vs top-level, статусы `ACCEPTED/FAILED` vs `ACK/ERROR`.
   - [done] Аудит документации: примеры команд/ответов приведены к единому формату; legacy удален.
   - [done] Аудит кода: выявлены несовместимости AE/scheduler/node-sim, legacy поля/статусы в common schemas.
   - [todo] Актуализировать оставшиеся docs по статусам/переходам (COMMAND_INTEGRITY/COMMAND_STATUS_TRANSITIONS).

2. Интеграция PID-контуров (Automation Engine = единственный управляющий)
   - PID и управляющие решения полностью в AE (pH/EC/температура).
   - Digital Twin только запускает симуляцию, держит таймер, мониторит прогресс.
   - Сим-нод принимает команды AE и отражает корректировки в телеметрии.
   - При необходимости расширить AE: режим симуляции (флаг), без изменения боевой логики.

3. Виртуальные команды через MQTT
   - Сформировать команды в точном формате прод-пайплайна.
   - Обеспечить публикацию команд и получение `command_response`.
   - Проверить дедупликацию, timeouts, повторные ответы.
   - Команды дозирования остаются как в AE (`dose` + `dose_ml`), проверить согласованность с node-sim и контрактами.
   - [in progress] Единый формат команд/ответов: привести к нему AE, history-logger, node-sim, common-schemas, документы, тесты.

4. Сим-нод (node-sim) как источник телеметрии и ответов
   - Запуск node-sim инстансов для каждой зоны/ноды.
   - [done] Расширить node-sim, чтобы он корректно симулировал все типы нод.
   - [done] Смоделировать корректировки: дозировка pH/EC, управление температурой.
   - [done] Добавить деградации: случайные задержки ответов, потеря связи, пропуски команд/телеметрии.

5. Полный прогон Automation Engine
   - Симуляция работает в реальном времени и останавливается по таймеру.
   - AE работает в обычном режиме, но на сим‑зоне/сим‑нодах.
   - Проверить, что AE отправляет команды в pipeline.
   - Масштабирование фаз: длительность фаз из рецепта приводится к общей длительности запуска (например, 14 дней → 15 минут).
   - Расширить scheduler, чтобы он учитывал ускоренное время в режиме симуляции.
   - Выделить отдельную сим‑зону, полностью настроить и привязать к node‑sim.

6. Отображение в UI
   - Реальное время: текущая фаза, активные команды, PID-статусы.
   - Прогресс с описанием шагов и состояния сим-нод.
   - Отображение ошибок/таймаутов симуляции.

7. Тесты и приемка
   - После каждой правки сервиса запускать его тесты:
   - automation-engine: `pytest automation-engine/ -v`
   - scheduler: `pytest scheduler/test_main.py -v`
   - history-logger: `backend/services/history-logger/scripts/run_tests.sh`
   - node-sim: добавить/обновить тесты и запускать `pytest tests/node_sim/ -v`
   - digital-twin: добавить/обновить тесты и запускать `pytest digital-twin/ -v`
   - E2E сценарии с запуском node-sim.
   - Проверки: команды -> ответы -> изменение телеметрии -> реакции AE.
   - Критерий: симуляция проходит всю длительность без ошибок, метрики в пределах.

## План обновления тестов
- Обновить тесты automation-engine под `params.ml` и top-level `cmd_id`.
- Добавить тесты node-sim для `dose` и корректировки телеметрии по командам.
- Добавить тесты scheduler для sim-time (ускорение фаз, таймер симуляции).
- Добавить тесты history-logger для строгого формата команд/ответов.
- Добавить тесты digital-twin для оркестрации сим-сессии (таймер, ускорение, прогресс).

## Ожидаемые артефакты
- Digital Twin как оркестратор симуляции (запуск/таймер/статусы).
- Расширенный node-sim для всех команд и типов нод.
- Интеграция с Automation Engine в режиме симуляции.
- UI с реальным прогрессом и описанием.
- Набор E2E тестов на полный цикл симуляции.
